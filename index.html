<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SPX Event Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg0:#060a12;--bg1:#0b1120;--bg2:#111827;--bg3:#1a2438;--bg4:#1e2d45;
  --blue:#3b82f6;--blue2:#60a5fa;--cyan:#22d3ee;
  --green:#10b981;--amber:#f59e0b;--rose:#f43f5e;--violet:#8b5cf6;
  --t1:#f0f4ff;--t2:#8da0bf;--t3:#4d6080;
  --b1:rgba(59,130,246,.12);--b2:rgba(59,130,246,.3);--grid:rgba(59,130,246,.05);
  --sb:220px;--r:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg0);color:var(--t1);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
.shell{position:relative;z-index:1;display:flex;min-height:100vh;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sb{width:var(--sb);min-height:100vh;background:var(--bg2);border-right:1px solid var(--b1);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:200;transition:transform .28s cubic-bezier(.4,0,.2,1);}
.sb-logo{padding:18px 18px 16px;border-bottom:1px solid var(--b1);}
.lm{font-family:'Syne',sans-serif;font-weight:800;font-size:21px;letter-spacing:-.5px;}
.ls{font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.sb-nav{padding:14px 0;flex:1;overflow-y:auto;}
.nl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:2px;text-transform:uppercase;padding:0 16px;margin:10px 0 5px;}
.ni{display:flex;align-items:center;gap:9px;padding:9px 16px;cursor:pointer;transition:all .16s;color:var(--t2);font-size:13px;border-left:2px solid transparent;user-select:none;}
.ni:hover{background:var(--bg3);color:var(--t1);}
.ni.active{background:rgba(59,130,246,.11);color:var(--blue2);border-left-color:var(--blue);}
.nx{font-size:14px;width:18px;text-align:center;flex-shrink:0;}
.sb-foot{padding:13px 16px;border-top:1px solid var(--b1);}
.ull{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;}
.ui{width:100%;background:var(--bg3);border:1px solid var(--b1);color:var(--t1);padding:7px 10px;border-radius:7px;font-size:11px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .2s;}
.ui:focus{border-color:var(--b2);}
.ui::placeholder{color:var(--t3);}
.sb-st{margin-top:9px;font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);line-height:1.9;}
.dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:4px;animation:pulse 2s infinite;}
.dot-g{background:var(--green);box-shadow:0 0 5px var(--green);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

/* â”€â”€ MOBILE â”€â”€ */
.mob-bar{display:none;position:fixed;top:0;left:0;right:0;z-index:190;background:rgba(11,17,32,.96);backdrop-filter:blur(16px);border-bottom:1px solid var(--b1);padding:0 14px;height:54px;align-items:center;justify-content:space-between;}
.mob-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;}
.hb{width:36px;height:36px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;cursor:pointer;background:var(--bg3);border-radius:7px;border:1px solid var(--b1);}
.hb span{width:18px;height:2px;background:var(--t2);border-radius:2px;transition:all .22s;}
.hb.open span:nth-child(1){transform:translateY(7px) rotate(45deg);}
.hb.open span:nth-child(2){opacity:0;}
.hb.open span:nth-child(3){transform:translateY(-7px) rotate(-45deg);}
.sb-ov{display:none;position:fixed;inset:0;background:rgba(6,10,18,.6);z-index:195;backdrop-filter:blur(2px);}
.sb-ov.open{display:block;}

/* â”€â”€ MAIN â”€â”€ */
.main{margin-left:var(--sb);flex:1;min-width:0;}
.topbar{background:rgba(11,17,32,.88);backdrop-filter:blur(20px);border-bottom:1px solid var(--b1);padding:12px 26px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;gap:8px;flex-wrap:wrap;}
.pt{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;white-space:nowrap;}
.tr{display:flex;gap:7px;align-items:center;flex-wrap:wrap;}
.flt{background:var(--bg3);border:1px solid var(--b1);color:var(--t2);padding:7px 10px;border-radius:7px;font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;outline:none;transition:border-color .2s;}
.flt:hover,.flt:focus{border-color:var(--b2);}
.btn{padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .18s;border:none;white-space:nowrap;}
.bp{background:var(--blue);color:#fff;}.bp:hover{background:var(--blue2);transform:translateY(-1px);}
.bs{background:var(--bg3);color:var(--t2);border:1px solid var(--b1);}.bs:hover{border-color:var(--b2);color:var(--t1);}
.bd{background:rgba(244,63,94,.11);color:var(--rose);border:1px solid rgba(244,63,94,.18);}.bd:hover{background:rgba(244,63,94,.2);}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none;padding:22px 26px;}
.page.active{display:block;}
.sec-l{font-family:'DM Mono',monospace;font-size:10px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;}
.sec-t{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:18px;letter-spacing:-.5px;}

/* â”€â”€ KPI â”€â”€ */
.kg{display:grid;grid-template-columns:repeat(4,1fr);gap:13px;margin-bottom:14px;}
.kc{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:17px;position:relative;overflow:hidden;transition:border-color .18s;}
.kc:hover{border-color:var(--b2);}
.kc::after{content:'';position:absolute;top:0;right:0;width:54px;height:54px;border-radius:0 var(--r) 0 100%;opacity:.09;}
.bl::after{background:var(--blue)}.gn::after{background:var(--green)}.am::after{background:var(--amber)}.ro::after{background:var(--rose)}.vi::after{background:var(--violet)}.cy::after{background:var(--cyan)}
.kl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:7px;}
.kv{font-family:'Syne',sans-serif;font-size:24px;font-weight:700;line-height:1;margin-bottom:5px;}
.ks{font-size:11px;color:var(--t3);}
.bdg{display:inline-flex;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:600;font-family:'DM Mono',monospace;}
.bg{background:rgba(16,185,129,.13);color:var(--green);}
.br{background:rgba(244,63,94,.13);color:var(--rose);}
.bb{background:rgba(59,130,246,.13);color:var(--blue2);}

/* â”€â”€ CHARTS â”€â”€ */
.cg32{display:grid;grid-template-columns:2fr 1fr;gap:13px;margin-bottom:14px;}
.cg2{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:14px;}
.cc{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:17px;}
.ch{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:13px;}
.ct{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.cs{font-size:11px;color:var(--t3);margin-top:2px;}
.cw{position:relative;height:215px;}
.cw.t{height:265px;}

/* â”€â”€ TABLE â”€â”€ */
.tc{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;margin-bottom:18px;}
.th{padding:13px 17px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--b1);flex-wrap:wrap;gap:7px;}
.tht{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.si{background:var(--bg3);border:1px solid var(--b1);color:var(--t1);padding:7px 11px;border-radius:7px;font-size:12px;font-family:'DM Sans',sans-serif;outline:none;width:185px;transition:border-color .2s;}
.si:focus{border-color:var(--b2);}
.si::placeholder{color:var(--t3);}
.tsc{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;min-width:860px;}
thead tr{background:var(--bg3);border-bottom:1px solid var(--b1);}
th{font-family:'DM Mono',monospace;font-size:9px;font-weight:500;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;padding:9px 12px;text-align:left;white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--b1);transition:background .13s;cursor:pointer;}
tbody tr:hover{background:var(--bg3);}
tbody tr:last-child{border-bottom:none;}
td{padding:8px 12px;font-size:12px;color:var(--t2);white-space:nowrap;}
td.nm{color:var(--t1);font-weight:500;max-width:185px;overflow:hidden;text-overflow:ellipsis;}
td.mo{font-family:'DM Mono',monospace;font-size:11px;}
td.pg{color:var(--green);}td.pr{color:var(--rose);}
.pl{display:inline-block;padding:2px 7px;border-radius:4px;font-family:'DM Mono',monospace;font-size:10px;font-weight:500;}
.ph{background:rgba(16,185,129,.13);color:var(--green);}
.pm{background:rgba(245,158,11,.13);color:var(--amber);}
.plo{background:rgba(244,63,94,.13);color:var(--rose);}
.pu{background:rgba(139,92,246,.13);color:var(--violet);}

/* Year group row */
.yr-row td{background:linear-gradient(90deg,rgba(59,130,246,.07),transparent);padding:9px 13px;color:var(--blue2);font-family:'Syne',sans-serif;font-weight:700;font-size:14px;border-bottom:1px solid var(--b1);border-top:2px solid var(--b2);letter-spacing:-.3px;}
.yr-stats{font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);font-weight:400;margin-left:10px;}

.del-btn{opacity:0;background:rgba(244,63,94,.11);border:none;color:var(--rose);width:22px;height:22px;border-radius:4px;cursor:pointer;font-size:11px;transition:all .18s;display:inline-flex;align-items:center;justify-content:center;}
tbody tr:hover .del-btn{opacity:1;}

/* â”€â”€ FORM â”€â”€ */
.fc2{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:20px;margin-bottom:16px;}
.fd{font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin:15px 0 11px;padding:5px 0;border-top:1px solid var(--b1);border-bottom:1px solid var(--b1);}
.fg3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;}
.fg4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;}
.fg2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px;}
.fg{display:flex;flex-direction:column;gap:5px;}
.fl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;}
.fi{background:var(--bg3);border:1px solid var(--b1);color:var(--t1);padding:9px 12px;border-radius:8px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .18s,box-shadow .18s;width:100%;}
.fi:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.1);}
.fi::placeholder{color:var(--t3);}

/* Preview strip */
.pvs{display:grid;grid-template-columns:repeat(7,1fr);gap:9px;background:var(--bg3);border:1px solid var(--b1);border-radius:9px;padding:14px;margin-bottom:14px;}
.pvi{text-align:center;}
.pvl{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;}
.pvv{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;}
.cb{color:var(--blue2);}.cg{color:var(--green);}.ca{color:var(--amber);}.cr{color:var(--rose);}

/* New year banner */
.yr-banner{background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.22);border-radius:9px;padding:11px 14px;margin-bottom:12px;font-size:12px;color:var(--blue2);font-family:'DM Mono',monospace;display:none;}

/* Weather */
.wx-box{background:var(--bg3);border:1px solid var(--b1);border-radius:9px;padding:14px;margin-bottom:14px;}
.wx-pr{background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.13);border-radius:7px;padding:11px;font-family:'DM Mono',monospace;font-size:11px;color:var(--t2);line-height:1.7;margin-top:8px;white-space:pre-line;}

/* â”€â”€ ANALYSIS â”€â”€ */
.ig{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:18px;}
.ic{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:17px;}
.ih{display:flex;align-items:center;gap:9px;margin-bottom:12px;}
.ii{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;}
.ib{background:rgba(59,130,246,.13);}
.ig2{background:rgba(16,185,129,.13);}
.ia{background:rgba(245,158,11,.13);}
.ir2{background:rgba(244,63,94,.13);}
.it{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.ins-row{display:flex;align-items:center;padding:6px 0;border-bottom:1px solid var(--b1);font-size:12px;}
.ins-row:last-child{border-bottom:none;}
.irl{color:var(--t2);min-width:85px;}
.irbw{flex:1;margin:0 9px;height:3px;background:var(--bg3);border-radius:2px;}
.irb{height:100%;border-radius:2px;}
.irv{font-family:'DM Mono',monospace;font-size:11px;color:var(--t1);min-width:75px;text-align:right;}
.dg{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-top:13px;}
.dc2{border-radius:9px;padding:14px;}

/* â”€â”€ MODAL â”€â”€ */
.mo{display:none;position:fixed;inset:0;background:rgba(6,10,18,.87);backdrop-filter:blur(8px);z-index:300;align-items:center;justify-content:center;padding:14px;}
.mo.open{display:flex;}
.md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:22px;max-width:540px;width:100%;max-height:88vh;overflow-y:auto;}
.mt{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}
.mc{cursor:pointer;color:var(--t3);font-size:18px;transition:color .18s;line-height:1;}.mc:hover{color:var(--t1);}
.mg{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px;}
.mi{background:var(--bg3);border-radius:8px;padding:10px;}
.mil{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.miv{font-weight:600;color:var(--t1);font-size:13px;}
.mkr{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:11px;}
.mk{background:var(--bg3);border-radius:8px;padding:10px;text-align:center;}
.mkl{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.mkv{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--green);color:var(--green);padding:10px 16px;border-radius:8px;font-size:12px;font-family:'DM Mono',monospace;z-index:999;opacity:0;transform:translateY(14px);transition:all .26s;max-width:280px;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.err{border-color:var(--rose);color:var(--rose);}

.empty{text-align:center;padding:34px;color:var(--t3);font-size:12px;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg1);}
::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px;}

/* â•â•â•â• RESPONSIVE â•â•â•â• */
@media(max-width:1100px){
  .kg{grid-template-columns:repeat(2,1fr);}
  .cg32,.cg2{grid-template-columns:1fr;}
  .ig{grid-template-columns:1fr;}
  .dg{grid-template-columns:1fr;}
  .pvs{grid-template-columns:repeat(4,1fr);}
  .fg4{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:768px){
  :root{--sb:264px;}
  .sb{transform:translateX(-100%);}
  .sb.open{transform:translateX(0);}
  .mob-bar{display:flex;}
  .main{margin-left:0;padding-top:54px;}
  .topbar{padding:9px 13px;top:54px;}
  .page{padding:14px 13px;}
  .kg{grid-template-columns:repeat(2,1fr);gap:9px;}
  .kv{font-size:20px;}
  .fg3{grid-template-columns:repeat(2,1fr);}
  .fg2{grid-template-columns:1fr;}
  .pvs{grid-template-columns:repeat(3,1fr);}
  .mg{grid-template-columns:1fr;}
  .mkr{grid-template-columns:repeat(2,1fr);}
  .sec-t{font-size:18px;}
  .th{flex-direction:column;align-items:flex-start;}
  .si{width:100%;}
  .tr{width:100%;justify-content:flex-end;}
}
@media(max-width:480px){
  .kg{grid-template-columns:1fr 1fr;}
  .kv{font-size:17px;}
  .kc{padding:13px;}
  .fg3,.fg4{grid-template-columns:1fr;}
  .pvs{grid-template-columns:repeat(2,1fr);}
  .pvv{font-size:14px;}
}

/* Row action buttons */
.row-acts{display:flex;gap:4px;opacity:0;transition:opacity .15s;}
tbody tr:hover .row-acts{opacity:1;}
.rab{width:26px;height:26px;border-radius:5px;border:none;cursor:pointer;font-size:12px;display:inline-flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
.rab-e{background:rgba(59,130,246,.14);color:var(--blue2);}.rab-e:hover{background:rgba(59,130,246,.28);}
.rab-s{background:rgba(139,92,246,.14);color:var(--violet);}.rab-s:hover{background:rgba(139,92,246,.28);}
.rab-d{background:rgba(244,63,94,.14);color:var(--rose);}.rab-d:hover{background:rgba(244,63,94,.28);}

/* Modal base */
.mo{display:none;position:fixed;inset:0;background:rgba(6,10,18,.88);backdrop-filter:blur(8px);z-index:300;align-items:center;justify-content:center;padding:14px;}
.mo.open{display:flex;}
/* Detail modal */
.md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:22px;max-width:580px;width:100%;max-height:90vh;overflow-y:auto;}
/* Edit modal */
.edit-md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:22px;max-width:680px;width:100%;max-height:90vh;overflow-y:auto;}
.mt{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
.mc{cursor:pointer;color:var(--t3);font-size:18px;transition:color .18s;line-height:1;flex-shrink:0;}.mc:hover{color:var(--t1);}
.mg{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px;}
.mi{background:var(--bg3);border-radius:8px;padding:10px;}
.mil{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.miv{font-weight:600;color:var(--t1);font-size:13px;}
.mkr{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:11px;}
.mk{background:var(--bg3);border-radius:8px;padding:10px;text-align:center;}
.mkl{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.mkv{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.modal-acts{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:14px;border-top:1px solid var(--b1);flex-wrap:wrap;}

/* Share modal */
.share-md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:0;max-width:520px;width:100%;overflow:hidden;}
.sc{background:linear-gradient(135deg,#08142b 0%,#0d1f3c 50%,#07142a 100%);padding:26px;position:relative;overflow:hidden;border-bottom:1px solid var(--b1);}
.sc::before{content:'';position:absolute;top:-50px;right:-50px;width:220px;height:220px;background:radial-gradient(circle,rgba(59,130,246,.14) 0%,transparent 65%);pointer-events:none;}
.sc::after{content:'';position:absolute;bottom:-40px;left:-40px;width:180px;height:180px;background:radial-gradient(circle,rgba(16,185,129,.09) 0%,transparent 65%);pointer-events:none;}
.sc-brand{display:flex;align-items:center;gap:8px;margin-bottom:18px;}
.sc-bname{font-family:'Syne',sans-serif;font-weight:800;font-size:13px;color:var(--t1);}
.sc-btag{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:2px;text-transform:uppercase;margin-left:4px;}
.sc-title{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;color:var(--t1);margin-bottom:5px;letter-spacing:-.5px;line-height:1.2;position:relative;z-index:1;}
.sc-meta{font-family:'DM Mono',monospace;font-size:11px;color:var(--t3);margin-bottom:20px;display:flex;gap:14px;flex-wrap:wrap;position:relative;z-index:1;}
.sc-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;position:relative;z-index:1;}
.sc-kpi{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:9px;padding:11px;}
.sc-kpi-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.sc-kpi-val{font-family:'Syne',sans-serif;font-size:19px;font-weight:700;}
.sc-kpi-sub{font-size:10px;color:var(--t3);margin-top:2px;font-family:'DM Mono',monospace;}
.sc-foot{display:flex;align-items:center;justify-content:space-between;margin-top:15px;padding-top:13px;border-top:1px solid rgba(255,255,255,.06);position:relative;z-index:1;}
.sc-perf{display:flex;align-items:center;gap:8px;}
.sc-pbw{width:70px;height:4px;background:rgba(255,255,255,.08);border-radius:2px;}
.sc-pb{height:100%;border-radius:2px;}
.sc-dtag{font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);}
.sc-wx{background:rgba(34,211,238,.07);border:1px solid rgba(34,211,238,.15);border-radius:7px;padding:9px 12px;margin-top:11px;font-family:'DM Mono',monospace;font-size:11px;color:var(--cyan);position:relative;z-index:1;}
/* Share actions panel */
.share-acts{padding:16px 20px;}
.share-acts-ttl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:9px;}
.share-btns{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:10px;}
.share-link{background:var(--bg3);border:1px solid var(--b1);border-radius:8px;padding:8px 11px;font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);word-break:break-all;line-height:1.5;max-height:52px;overflow:hidden;}
.copy-ok{display:inline-flex;align-items:center;gap:4px;font-family:'DM Mono',monospace;font-size:11px;color:var(--green);opacity:0;transition:opacity .3s;margin-left:6px;}
.copy-ok.show{opacity:1;}

/* Button variants */
.bg2{background:rgba(16,185,129,.11);color:var(--green);border:1px solid rgba(16,185,129,.2);}.bg2:hover{background:rgba(16,185,129,.22);}
.bsh{background:rgba(139,92,246,.11);color:var(--violet);border:1px solid rgba(139,92,246,.2);}.bsh:hover{background:rgba(139,92,246,.22);}

/* Edit preview */
.edit-pvs{display:grid;grid-template-columns:repeat(7,1fr);gap:9px;background:var(--bg3);border:1px solid var(--b1);border-radius:9px;padding:13px;margin-bottom:13px;}

@media(max-width:768px){
  .sc-kpis{grid-template-columns:repeat(2,1fr);}
  .sc-title{font-size:17px;}
  .mg{grid-template-columns:1fr;}
  .mkr{grid-template-columns:1fr 1fr;}
}
@media(max-width:480px){.sc-kpis{grid-template-columns:1fr 1fr;}}


/* â”€â”€â”€ FORECAST & AI SCORE PAGES â”€â”€â”€ */
.sc3{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-bottom:16px;}
.sc4{display:grid;grid-template-columns:repeat(4,1fr);gap:13px;margin-bottom:16px;}
.scenario-card{border-radius:var(--r);padding:18px;position:relative;overflow:hidden;}
.scenario-card.pessimist{background:linear-gradient(135deg,rgba(244,63,94,.08),rgba(244,63,94,.04));border:1px solid rgba(244,63,94,.25);}
.scenario-card.normal{background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(59,130,246,.04));border:1px solid rgba(59,130,246,.25);}
.scenario-card.optimist{background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(16,185,129,.04));border:1px solid rgba(16,185,129,.25);}
.sc-badge{display:inline-flex;padding:3px 9px;border-radius:5px;font-family:'DM Mono',monospace;font-size:9px;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;}
.sc-badge.bad{background:rgba(244,63,94,.14);color:var(--rose);}
.sc-badge.mid{background:rgba(59,130,246,.14);color:var(--blue2);}
.sc-badge.good{background:rgba(16,185,129,.14);color:var(--green);}
.sc-num{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;line-height:1;margin-bottom:4px;}
.sc-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;}
.sc-metrics{display:flex;flex-direction:column;gap:6px;}
.sc-metric{display:flex;justify-content:space-between;font-size:12px;}
.sc-metric-l{color:var(--t3);}
.sc-metric-v{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;}
.sc-divider{height:1px;background:rgba(255,255,255,.06);margin:12px 0;}
.sc-delta{display:flex;align-items:center;gap:5px;font-size:11px;font-family:'DM Mono',monospace;}
.delta-up{color:var(--green);}.delta-dn{color:var(--rose);}.delta-nt{color:var(--t3);}

/* Growth rate cards */
.growth-card{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:16px;}
.growth-num{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;line-height:1;}
.growth-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-top:4px;margin-bottom:8px;}
.growth-bar{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;margin-top:8px;}
.growth-fill{height:100%;border-radius:2px;transition:width 1s ease;}

/* Insight boxes */
.insight-box{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:16px;margin-bottom:14px;}
.insight-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.insight-text{font-size:12px;color:var(--t2);line-height:1.7;}
.highlight{color:var(--blue2);font-weight:600;}
.highlight-g{color:var(--green);font-weight:600;}
.highlight-r{color:var(--rose);font-weight:600;}
.highlight-a{color:var(--amber);font-weight:600;}

/* AI Score specific */
.ai-score-gauge{position:relative;width:130px;height:80px;margin:0 auto 8px;}
.gauge-arc{overflow:visible;}
.score-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.score-big{font-family:'Syne',sans-serif;font-size:32px;font-weight:800;line-height:1;}
.score-ring{width:70px;height:70px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:3px solid;}
.score-row{display:flex;align-items:center;gap:14px;padding:10px 0;border-bottom:1px solid var(--b1);}
.score-row:last-child{border-bottom:none;}
.score-detail{flex:1;min-width:0;}
.score-name{font-size:13px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.score-meta{font-size:11px;color:var(--t3);font-family:'DM Mono',monospace;margin-top:2px;}
.score-bar-wrap{display:flex;align-items:center;gap:8px;margin-top:6px;}
.score-bar-bg{flex:1;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;}
.score-bar-fill{height:100%;border-radius:2px;transition:width .8s ease;}
.score-val{font-family:'DM Mono',monospace;font-size:11px;min-width:28px;text-align:right;}

/* Weight breakdown */
.weight-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
.weight-item{background:var(--bg3);border-radius:9px;padding:12px;text-align:center;}
.weight-icon{font-size:18px;margin-bottom:4px;}
.weight-pct{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:2px;}
.weight-name{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;}

/* Recommendation badge */
.rec-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;font-family:'DM Mono',monospace;font-size:11px;font-weight:600;}
.rec-go{background:rgba(16,185,129,.15);color:var(--green);border:1px solid rgba(16,185,129,.3);}
.rec-cond{background:rgba(59,130,246,.15);color:var(--blue2);border:1px solid rgba(59,130,246,.3);}
.rec-risk{background:rgba(245,158,11,.15);color:var(--amber);border:1px solid rgba(245,158,11,.3);}
.rec-no{background:rgba(244,63,94,.15);color:var(--rose);border:1px solid rgba(244,63,94,.3);}

/* City strategy grid */
.city-strat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:14px;}
.city-strat-card{background:var(--bg3);border-radius:9px;padding:13px;border:1px solid var(--b1);transition:border-color .18s;}
.city-strat-card:hover{border-color:var(--b2);}
.city-strat-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:4px;}
.city-strat-score{font-family:'DM Mono',monospace;font-size:11px;color:var(--t3);}
.city-strat-bar{height:3px;background:var(--bg2);border-radius:2px;margin-top:8px;overflow:hidden;}

/* Print-friendly summary box */
.exec-summary{background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(139,92,246,.06));border:1px solid rgba(59,130,246,.2);border-radius:var(--r);padding:20px;margin-bottom:16px;}
.exec-summary-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.exec-bullet{display:flex;align-items:flex-start;gap:8px;margin-bottom:7px;font-size:13px;color:var(--t2);}
.exec-bullet::before{content:'â†’';color:var(--blue2);font-family:'DM Mono',monospace;flex-shrink:0;margin-top:1px;}

/* Responsive for new pages */
@media(max-width:1100px){
  .sc3{grid-template-columns:1fr;}
  .sc4{grid-template-columns:repeat(2,1fr);}
  .weight-grid{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:768px){
  .sc3,.sc4{grid-template-columns:1fr;}
  .weight-grid{grid-template-columns:repeat(3,1fr);}
  .city-strat-grid{grid-template-columns:repeat(2,1fr);}
  .score-row{flex-wrap:wrap;}
}
@media(max-width:480px){
  .weight-grid{grid-template-columns:1fr 1fr;}
}

</style>
</head>
<body>

<!-- MOBILE BAR -->
<div class="mob-bar">
  <div class="mob-logo">SPX<span style="color:var(--blue)">.</span></div>
  <div class="hb" id="hb" onclick="toggleSB()"><span></span><span></span><span></span></div>
</div>
<div class="sb-ov" id="sb-ov" onclick="closeSB()"></div>

<div class="shell">
<!-- SIDEBAR -->
<nav class="sb" id="sb">
  <div class="sb-logo">
    <div class="lm">SPX<span style="color:var(--blue)">.</span></div>
    <div class="ls">Event Intelligence</div>
  </div>
  <div class="sb-nav">
    <div class="nl">Ana MenÃ¼</div>
    <div class="ni active" onclick="goPage('dashboard',this)"><span class="nx">â—ˆ</span>Dashboard</div>
    <div class="ni" onclick="goPage('events',this)"><span class="nx">â—‰</span>Etkinlikler</div>
    <div class="ni" onclick="goPage('new-event',this)"><span class="nx">ï¼‹</span>Yeni Etkinlik</div>
    <div class="nl" style="margin-top:9px">Analiz</div>
    <div class="ni" onclick="goPage('analysis',this)"><span class="nx">â–£</span>Analiz Motoru</div>
    <div class="ni" onclick="goPage('weather',this)"><span class="nx">â—</span>Hava Durumu</div>
    <div class="nl" style="margin-top:9px">Yapay Zeka</div>
    <div class="ni" onclick="goPage('forecast',this)"><span class="nx">â—</span>2026 Tahmin Modeli</div>
    <div class="ni" onclick="goPage('ai-score',this)"><span class="nx">â—‘</span>AI KatÄ±lÄ±m Skoru</div>
  </div>
  <div class="sb-foot">
    <div class="ull">KullanÄ±cÄ± AdÄ±</div>
    <input class="ui" id="username" placeholder="AdÄ±nÄ±zÄ± girinâ€¦" oninput="saveUser(this.value)">
    <div class="sb-st">
      <span class="dot dot-g"></span><span id="sync-txt">HazÄ±r</span><br>
      <span style="margin-left:10px" id="foot-count">â€” etkinlik</span><br>
      <span style="margin-left:10px" id="foot-users">â€” kullanÄ±cÄ±</span>
    </div>
  </div>
</nav>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div class="pt" id="pg-title">Dashboard</div>
    <div class="tr">
      <select class="flt" id="year-filter" onchange="applyFilters()"><option value="all">TÃ¼m YÄ±llar</option></select>
      <select class="flt" id="city-filter" onchange="applyFilters()"><option value="all">TÃ¼m Åehirler</option></select>
      <button class="btn bs" onclick="syncAll()" title="Yenile">â†»</button>
      <button class="btn bs" onclick="doExport()">â†“ CSV</button>
      <button class="btn bp" onclick="goPage('new-event',document.querySelectorAll('.ni')[2])">ï¼‹ Ekle</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="sec-l">Genel BakÄ±ÅŸ</div>
    <div class="sec-t">Finansal Performans</div>
    <div class="kg">
      <div class="kc bl"><div class="kl">Toplam Ciro</div><div class="kv" id="k-ciro">â‚º0</div><div class="ks" id="k-ciro-s">â€”</div></div>
      <div class="kc gn"><div class="kl">Toplam Net Kar</div><div class="kv" id="k-kar">â‚º0</div><div class="ks" id="k-kar-s">â€”</div></div>
      <div class="kc am"><div class="kl">Toplam Gider</div><div class="kv" id="k-gider">â‚º0</div><div class="ks" id="k-gider-s">â€”</div></div>
      <div class="kc vi"><div class="kl">Ort. Kar MarjÄ±</div><div class="kv" id="k-margin">%0</div><div class="ks" id="k-margin-s">â€”</div></div>
    </div>
    <div class="kg">
      <div class="kc cy"><div class="kl">Etkinlik SayÄ±sÄ±</div><div class="kv" id="k-count">0</div><div class="ks" id="k-count-s">â€”</div></div>
      <div class="kc gn"><div class="kl">En KarlÄ± Etkinlik</div><div class="kv" style="font-size:13px;padding-top:4px" id="k-best">â€”</div><div class="ks" id="k-best-s">â€”</div></div>
      <div class="kc ro"><div class="kl">En DÃ¼ÅŸÃ¼k Performans</div><div class="kv" style="font-size:13px;padding-top:4px" id="k-worst">â€”</div><div class="ks" id="k-worst-s">â€”</div></div>
      <div class="kc bl"><div class="kl">Ort. ROI</div><div class="kv" id="k-roi">%0</div><div class="ks" id="k-roi-s">â€”</div></div>
    </div>
    <div class="cg32">
      <div class="cc"><div class="ch"><div><div class="ct">AylÄ±k Ciro & Kar Trendi</div><div class="cs">SeÃ§ili dÃ¶nem</div></div></div><div class="cw t"><canvas id="cMonthly"></canvas></div></div>
      <div class="cc"><div class="ch"><div><div class="ct">Åehre GÃ¶re ROI</div><div class="cs">KarÅŸÄ±laÅŸtÄ±rma</div></div></div><div class="cw t"><canvas id="cCity"></canvas></div></div>
    </div>
    <div class="cg2">
      <div class="cc"><div class="ch"><div><div class="ct">Etkinlik KarlÄ±lÄ±ÄŸÄ± (Top 10)</div><div class="cs">Ciro vs Gider vs Kar</div></div></div><div class="cw"><canvas id="cEvent"></canvas></div></div>
      <div class="cc"><div class="ch"><div><div class="ct">Gider DaÄŸÄ±lÄ±mÄ±</div><div class="cs">Maliyet kalemleri</div></div></div><div class="cw"><canvas id="cExp"></canvas></div></div>
    </div>
  </div>

  <!-- EVENTS -->
  <div class="page" id="page-events">
    <div class="sec-l">Etkinlik YÃ¶netimi</div>
    <div class="sec-t">TÃ¼m Etkinlikler</div>
    <div class="tc">
      <div class="th">
        <div class="tht">Etkinlik Listesi <span id="ev-badge" style="font-size:10px;color:var(--t3);font-family:'DM Mono',monospace"></span></div>
        <div style="display:flex;gap:7px;align-items:center;flex-wrap:wrap">
          <input class="si" id="ev-srch" placeholder="Araâ€¦" oninput="renderEvents()">
          <label style="font-size:11px;color:var(--t2);display:flex;align-items:center;gap:5px;cursor:pointer;white-space:nowrap">
            <input type="checkbox" id="grp-yr" checked onchange="renderEvents()"> YÄ±la gÃ¶re grupla
          </label>
        </div>
      </div>
      <div class="tsc"><table><thead><tr>
        <th>ETKÄ°NLÄ°K</th><th>TARÄ°H</th><th>ÅEHÄ°R</th><th>YIL</th><th>KATILIMCI</th>
        <th>CÄ°RO</th><th>GÄ°DER</th><th>NET KAR</th><th>KAR MARJI</th>
        <th>ROI</th><th>KAT.BAÅI CÄ°RO</th><th>PERF.</th><th>EKLEYEN</th><th>Ä°ÅLEMLER</th>
      </tr></thead><tbody id="ev-tbody"></tbody></table></div>
    </div>
  </div>

  <!-- NEW EVENT -->
  <div class="page" id="page-new-event">
    <div class="sec-l">Veri GiriÅŸi</div>
    <div class="sec-t">Yeni Etkinlik Ekle</div>
    <div class="fc2">
      <div class="fd">â€” Etkinlik Bilgileri</div>
      <div class="fg3">
        <div class="fg"><label class="fl">Etkinlik AdÄ± *</label><input class="fi" id="f-name" placeholder="Ä°zmir Maratonu 2026"></div>
        <div class="fg"><label class="fl">Tarih *</label><input type="date" class="fi" id="f-date" onchange="onDateChange()"></div>
        <div class="fg"><label class="fl">Åehir *</label><input class="fi" id="f-city" placeholder="Ä°zmir" list="city-dl"><datalist id="city-dl"></datalist></div>
      </div>
      <div class="fg3">
        <div class="fg">
          <label class="fl">YÄ±l *</label>
          <select class="fi" id="f-year" onchange="onYearChange()"></select>
        </div>
        <div class="fg"><label class="fl">KatÄ±lÄ±mcÄ± SayÄ±sÄ±</label><input type="number" class="fi" id="f-kat" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Ã‡adÄ±r SayÄ±sÄ±</label><input type="number" class="fi" id="f-cadir" placeholder="0"></div>
      </div>

      <!-- Dynamic year banner -->
      <div class="yr-banner" id="yr-banner">
        ğŸ†• <span id="yr-banner-txt"></span> yÄ±lÄ± iÃ§in yeni etkinlik â€” sistem otomatik yÄ±l grubu oluÅŸturacak.
      </div>

      <div class="fd">â€” Gider Kalemleri</div>
      <div class="fg4">
        <div class="fg"><label class="fl">Ajans Bedeli (â‚º)</label><input type="number" class="fi" id="f-ajans" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Personel Gideri (â‚º)</label><input type="number" class="fi" id="f-per" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Stand Maliyeti (â‚º)</label><input type="number" class="fi" id="f-stand" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Barter (â‚º)</label><input type="number" class="fi" id="f-barter" placeholder="0" oninput="calcPrev()"></div>
      </div>

      <div class="fd">â€” Ciro Kalemleri</div>
      <div class="fg2">
        <div class="fg"><label class="fl">Ã‡ek Ciro (â‚º)</label><input type="number" class="fi" id="f-cek" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Ã‡adÄ±r Ciro (â‚º)</label><input type="number" class="fi" id="f-cciro" placeholder="0" oninput="calcPrev()"></div>
      </div>

      <div class="fd">â€” AnlÄ±k Hesaplama</div>
      <div class="pvs">
        <div class="pvi"><div class="pvl">Toplam Ciro</div><div class="pvv cb" id="p-ciro">â‚º0</div></div>
        <div class="pvi"><div class="pvl">Toplam Gider</div><div class="pvv ca" id="p-gider">â‚º0</div></div>
        <div class="pvi"><div class="pvl">Net Kar</div><div class="pvv cg" id="p-kar">â‚º0</div></div>
        <div class="pvi"><div class="pvl">Kar MarjÄ±</div><div class="pvv cb" id="p-margin">â€”</div></div>
        <div class="pvi"><div class="pvl">ROI</div><div class="pvv cg" id="p-roi">â€”</div></div>
        <div class="pvi"><div class="pvl">Kat.BaÅŸÄ± Ciro</div><div class="pvv cb" id="p-pciro">â€”</div></div>
        <div class="pvi"><div class="pvl">Kat.BaÅŸÄ± Mlt.</div><div class="pvv ca" id="p-pgdr">â€”</div></div>
      </div>

      <div class="fd">â€” Hava Durumu (Gemini AI)</div>
      <div class="wx-box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;flex-wrap:wrap;gap:7px">
          <span style="font-size:12px;color:var(--t2)">Gemini'ye gÃ¶nderilecek prompt:</span>
          <button class="btn bs" style="font-size:11px" onclick="buildPrompt()">âŸ³ OluÅŸtur</button>
        </div>
        <div class="wx-pr" id="wx-pr">Tarih ve ÅŸehir girerek prompt oluÅŸturunâ€¦</div>
        <div style="margin-top:11px">
          <label class="fl" style="margin-bottom:5px;display:block">Gemini yanÄ±tÄ±nÄ± buraya yapÄ±ÅŸtÄ±r</label>
          <textarea class="fi" id="f-wx" rows="4" style="resize:vertical;font-family:'DM Mono',monospace;font-size:11px" placeholder="SÄ±caklÄ±k: 22Â°C&#10;Durum: GÃ¼neÅŸli&#10;RÃ¼zgar: 15 km/h"></textarea>
        </div>
      </div>

      <div style="display:flex;gap:9px;justify-content:flex-end;flex-wrap:wrap">
        <button class="btn bs" onclick="clearForm()">Temizle</button>
        <button class="btn bp" onclick="saveEvent()">âœ“ Kaydet</button>
      </div>
    </div>
  </div>

  <!-- ANALYSIS -->
  <div class="page" id="page-analysis">
    <div class="sec-l">Karar Destek Sistemi</div>
    <div class="sec-t">Analiz Motoru</div>
    <div class="ig">
      <div class="ic"><div class="ih"><div class="ii ig2">ğŸ†</div><div class="it">Åehir BazlÄ± KarlÄ±lÄ±k</div></div><div id="city-ins"></div></div>
      <div class="ic"><div class="ih"><div class="ii ib">ğŸ“Š</div><div class="it">Ajans Maliyeti vs Kar MarjÄ±</div></div><div class="cw"><canvas id="cAgency"></canvas></div></div>
      <div class="ic"><div class="ih"><div class="ii ia">ğŸ‘¥</div><div class="it">KatÄ±lÄ±mcÄ± & ROI Ä°liÅŸkisi</div></div><div class="cw"><canvas id="cPart"></canvas></div></div>
      <div class="ic"><div class="ih"><div class="ii ir2">ğŸŒ¤</div><div class="it">Hava Durumu & Performans</div></div><div id="wx-ins"><div class="empty">Hava durumu girildikÃ§e analiz gÃ¶rÃ¼nÃ¼r.</div></div></div>
    </div>
    <div class="cc">
      <div class="ch"><div><div class="ct">Karar Destek Ã–zeti</div><div class="cs">Veri odaklÄ± Ã¶neriler</div></div></div>
      <div class="dg" id="deci-cards"></div>
    </div>
  </div>

  <!-- WEATHER -->
  <div class="page" id="page-weather">
    <div class="sec-l">Gemini AI Entegrasyonu</div>
    <div class="sec-t">Hava Durumu Rehberi</div>
    <div class="fc2" style="margin-bottom:18px">
      <div style="background:var(--bg3);border-radius:9px;padding:16px">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:1px;margin-bottom:9px">PROMPT ÅABLONU</div>
        <div style="font-family:'DM Mono',monospace;font-size:12px;line-height:2;color:var(--t2)">
          "<span style="color:var(--t1)">[TARÄ°H] tarihinde [ÅEHÄ°R]'de hava nasÄ±ldÄ±?</span><br>Sadece ÅŸu formatta cevap ver:<br>SÄ±caklÄ±k: XÂ°C<br>Durum: GÃ¼neÅŸli/YaÄŸmurlu/Bulutlu<br>RÃ¼zgar: X km/h"
        </div>
      </div>
      <div style="margin-top:11px;font-size:12px;color:var(--t3)">â„¹ï¸ YanÄ±tÄ± kopyalayÄ±p Yeni Etkinlik â†’ Hava Durumu alanÄ±na yapÄ±ÅŸtÄ±rÄ±n.</div>
    </div>
    <div class="tc">
      <div class="th"><div class="tht">Hava Durumu KayÄ±tlarÄ±</div></div>
      <div class="tsc"><table><thead><tr>
        <th>ETKÄ°NLÄ°K</th><th>TARÄ°H</th><th>ÅEHÄ°R</th><th>YIL</th><th>SICAKLIK</th><th>DURUM</th><th>RÃœZGAR</th><th>NET KAR</th><th>ETKÄ°</th>
      </tr></thead><tbody id="wx-tbody"></tbody></table></div>
    </div>
  </div>

  <!-- â•â•â•â• 2026 FORECAST PAGE â•â•â•â• -->
  <div class="page" id="page-forecast">
    <div class="sec-l">Yapay Zeka Â· Tahmin Motoru</div>
    <div class="sec-t">2026 Tahmini KarlÄ±lÄ±k Modeli</div>

    <!-- Growth Rate KPIs -->
    <div id="forecast-growth-cards" class="sc4" style="margin-bottom:16px"></div>

    <!-- Executive Summary -->
    <div class="exec-summary" id="forecast-exec-summary"></div>

    <!-- 3 Scenarios -->
    <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;">SENARYO ANALÄ°ZÄ°</div>
    <div class="sc3" id="forecast-scenarios"></div>

    <!-- Charts Row -->
    <div class="cg2">
      <div class="cc"><div class="ch"><div><div class="ct">Senaryo KarÅŸÄ±laÅŸtÄ±rmasÄ±</div><div class="cs">Ciro Â· Gider Â· Kar</div></div></div><div class="cw t"><canvas id="cForecastScenario"></canvas></div></div>
      <div class="cc"><div class="ch"><div><div class="ct">2024â†’2025â†’2026 Trend</div><div class="cs">YÄ±llÄ±k bÃ¼yÃ¼me projeksiyon</div></div></div><div class="cw t"><canvas id="cForecastTrend"></canvas></div></div>
    </div>

    <!-- City Level Forecast -->
    <div class="insight-box">
      <div class="insight-title">ğŸ™ Åehir BazlÄ± 2026 Projeksiyonu</div>
      <div class="tsc"><table style="min-width:600px;"><thead><tr>
        <th>ÅEHÄ°R</th><th>2025 CÄ°RO</th><th>2026 TAHMÄ°N (NORMAL)</th><th>2026 TAHMÄ°N (Ä°YÄ°MSER)</th><th>BÃœYÃœME</th><th>STRATEJÄ°</th>
      </tr></thead><tbody id="forecast-city-tbody"></tbody></table></div>
    </div>

    <!-- Monthly Projection -->
    <div class="cc" style="margin-bottom:16px">
      <div class="ch"><div><div class="ct">2026 AylÄ±k Gelir Projeksiyonu (Normal Senaryo)</div><div class="cs">GeÃ§miÅŸ sezonalite bazlÄ±</div></div></div>
      <div class="cw t"><canvas id="cForecastMonthly"></canvas></div>
    </div>

    <!-- Insights -->
    <div class="cg2">
      <div class="insight-box" style="margin-bottom:0">
        <div class="insight-title">ğŸ¯ Model VarsayÄ±mlarÄ±</div>
        <div id="forecast-assumptions" class="insight-text"></div>
      </div>
      <div class="insight-box" style="margin-bottom:0">
        <div class="insight-title">âš ï¸ Risk FaktÃ¶rleri & FÄ±rsatlar</div>
        <div id="forecast-risks" class="insight-text"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â• AI SCORE PAGE â•â•â•â• -->
  <div class="page" id="page-ai-score">
    <div class="sec-l">Yapay Zeka Â· Karar Destek</div>
    <div class="sec-t">KatÄ±l / KatÄ±lma AI Skoru</div>

    <!-- Weight legend -->
    <div class="cc" style="margin-bottom:16px">
      <div class="ch"><div><div class="ct">Skor AÄŸÄ±rlÄ±k Matrisi</div><div class="cs">Her faktÃ¶rÃ¼n karar Ã¼zerindeki etkisi</div></div></div>
      <div class="weight-grid" id="ai-weights-grid"></div>
    </div>

    <!-- Summary KPIs -->
    <div class="sc4" id="ai-kpi-row" style="margin-bottom:16px"></div>

    <!-- Charts row -->
    <div class="cg2" style="margin-bottom:16px">
      <div class="cc"><div class="ch"><div><div class="ct">Skor DaÄŸÄ±lÄ±mÄ±</div><div class="cs">Etkinlik bazlÄ± 0â€“100</div></div></div><div class="cw"><canvas id="cAiScoreDist"></canvas></div></div>
      <div class="cc"><div class="ch"><div><div class="ct">FaktÃ¶r Etki Analizi</div><div class="cs">Hangi deÄŸiÅŸken en Ã§ok etkiliyor?</div></div></div><div class="cw"><canvas id="cAiFactors"></canvas></div></div>
    </div>

    <!-- Exec Summary -->
    <div class="exec-summary" id="ai-exec-summary" style="margin-bottom:16px"></div>

    <!-- City Strategy -->
    <div class="insight-box" style="margin-bottom:16px">
      <div class="insight-title">ğŸŒ Åehir Stratejik Avantaj HaritasÄ±</div>
      <div class="city-strat-grid" id="ai-city-grid"></div>
    </div>

    <!-- Cost Optimization -->
    <div class="insight-box" style="margin-bottom:16px">
      <div class="insight-title">ğŸ’¡ Maliyet Optimizasyon Ã–nerileri</div>
      <div id="ai-cost-tips"></div>
    </div>

    <!-- Full Score Table -->
    <div class="tc">
      <div class="th">
        <div class="tht">Etkinlik AI Skor Tablosu</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select class="flt" id="ai-year-filter" onchange="renderAiTable()">
            <option value="all">TÃ¼m YÄ±llar</option>
          </select>
          <select class="flt" id="ai-sort" onchange="renderAiTable()">
            <option value="score">Skora GÃ¶re</option>
            <option value="roi">ROI'ye GÃ¶re</option>
            <option value="name">Ada GÃ¶re</option>
          </select>
        </div>
      </div>
      <div class="score-table-wrap">
        <div id="ai-score-list" style="padding:4px 0"></div>
      </div>
    </div>
  </div>

</main>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ SEED DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEED=[
  {id:'s1',name:'Ä°zmir Maratonu',date:'2024-04-21',city:'Ä°zmir',participants:5759,tents:0,agency:47300,personnel:12910,standCost:80000,barter:0,cekCiro:0,cadirCiro:161621,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s2',name:'Merrell TahtalÄ± Run To Sky',date:'2024-11-05',city:'Antalya',participants:825,tents:0,agency:0,personnel:3651,standCost:0,barter:0,cekCiro:53683,cadirCiro:348600,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s3',name:'Spx DaÄŸyenice Ultra',date:'2024-05-24',city:'Bursa',participants:980,tents:0,agency:0,personnel:6760,standCost:0,barter:0,cekCiro:11493,cadirCiro:227000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s4',name:'Granfondo Bursa',date:'2024-05-26',city:'Bursa',participants:600,tents:0,agency:13500,personnel:500,standCost:0,barter:12000,cekCiro:13941,cadirCiro:23000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s5',name:'Wolfest',date:'2024-05-31',city:'Kocaeli',participants:0,tents:0,agency:0,personnel:0,standCost:0,barter:0,cekCiro:0,cadirCiro:236200,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s6',name:'SPX Pickleball Ä°stanbul Cup',date:'2024-06-06',city:'Ä°stanbul',participants:80,tents:0,agency:0,personnel:7500,standCost:0,barter:0,cekCiro:14424,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s7',name:'Spx UludaÄŸ Bisiklet TÄ±rmanÄ±ÅŸÄ±',date:'2024-08-03',city:'Bursa',participants:458,tents:0,agency:33500,personnel:4850,standCost:0,barter:0,cekCiro:1226,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s8',name:'UludaÄŸ Ultra Trail',date:'2024-07-13',city:'Bursa',participants:2620,tents:0,agency:38500,personnel:28000,standCost:60000,barter:0,cekCiro:0,cadirCiro:160167,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s9',name:'EskiÅŸehir YarÄ± Maratonu',date:'2024-08-25',city:'EskiÅŸehir',participants:1850,tents:5,agency:38500,personnel:11440,standCost:0,barter:50000,cekCiro:40833,cadirCiro:110266,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s10',name:'Bursa Pickleball TurnuvasÄ±',date:'2024-08-24',city:'Bursa',participants:75,tents:0,agency:28102,personnel:9500,standCost:0,barter:0,cekCiro:0,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s11',name:'Merrell Belgrad Ultra',date:'2024-07-09',city:'Ä°stanbul',participants:2590,tents:0,agency:0,personnel:27764,standCost:0,barter:0,cekCiro:0,cadirCiro:343386,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s12',name:'Kyzikos Ultra Trail',date:'2024-09-21',city:'Erdek',participants:1100,tents:0,agency:44110,personnel:35664,standCost:0,barter:0,cekCiro:0,cadirCiro:144000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s13',name:'Ankara Kahve Festivali',date:'2024-09-20',city:'Ankara',participants:35000,tents:0,agency:0,personnel:500,standCost:0,barter:50000,cekCiro:62630,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s14',name:'Spx Pickleball Ä°zmir Cup',date:'2024-10-11',city:'Ä°zmir',participants:90,tents:0,agency:0,personnel:78000,standCost:0,barter:0,cekCiro:25436,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s15',name:'Salomon Cappadocia Ultra',date:'2024-10-19',city:'NevÅŸehir',participants:3500,tents:4,agency:48500,personnel:72000,standCost:100000,barter:0,cekCiro:0,cadirCiro:517000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s16',name:'Kurumsal KÃ¼rek YarÄ±ÅŸÄ±',date:'2024-02-11',city:'Bursa',participants:350,tents:0,agency:0,personnel:1200,standCost:0,barter:0,cekCiro:3500,cadirCiro:10000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s17',name:'Antalya Ultra',date:'2024-12-28',city:'Antalya',participants:950,tents:0,agency:43296,personnel:15180,standCost:30000,barter:0,cekCiro:0,cadirCiro:181419,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s18',name:'Efes Ultra Maratonu',date:'2025-04-04',city:'Ä°zmir',participants:2180,tents:6,agency:60000,personnel:49460,standCost:30000,barter:0,cekCiro:0,cadirCiro:658000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s19',name:'SPX Pickleball Ligi Nisan',date:'2025-04-12',city:'Ä°stanbul',participants:60,tents:0,agency:0,personnel:6039,standCost:0,barter:0,cekCiro:0,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s20',name:'Troya YarÄ± Maratonu',date:'2025-04-19',city:'Ã‡anakkale',participants:2500,tents:8,agency:140100,personnel:27996,standCost:0,barter:0,cekCiro:87011,cadirCiro:1014904,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s21',name:'TahtalÄ± Run To Sky 2025',date:'2025-05-10',city:'Antalya',participants:300,tents:0,agency:0,personnel:0,standCost:36000,barter:0,cekCiro:0,cadirCiro:126000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s22',name:'SPX Tenis TurnuvasÄ±',date:'2025-05-17',city:'Antalya',participants:600,tents:0,agency:106774,personnel:0,standCost:0,barter:0,cekCiro:111915,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s23',name:'KTSK Åenlikleri',date:'2025-05-23',city:'Ä°stanbul',participants:10000,tents:0,agency:103000,personnel:0,standCost:0,barter:0,cekCiro:0,cadirCiro:1185749,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s24',name:'Sapanca Ultra',date:'2025-06-14',city:'Sakarya',participants:1000,tents:0,agency:120000,personnel:35596,standCost:0,barter:0,cekCiro:0,cadirCiro:220733,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s25',name:'KTSK En Uzun Gece',date:'2025-06-20',city:'Ä°stanbul',participants:3000,tents:0,agency:162000,personnel:30500,standCost:0,barter:0,cekCiro:0,cadirCiro:526000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s26',name:'SPX Pickleball Ligi Finalleri',date:'2025-06-28',city:'Ä°stanbul',participants:90,tents:0,agency:145080,personnel:35000,standCost:0,barter:0,cekCiro:106000,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s27',name:'YKB Ankara Yaz Åenlikleri',date:'2025-07-05',city:'Ankara',participants:450,tents:0,agency:147912,personnel:2950,standCost:0,barter:0,cekCiro:0,cadirCiro:25000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s28',name:'YKB BankacÄ±lÄ±k ÃœssÃ¼',date:'2025-07-16',city:'Kocaeli',participants:500,tents:0,agency:90000,personnel:34371,standCost:0,barter:0,cekCiro:0,cadirCiro:261220,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s29',name:'UludaÄŸ Ultra Trail YarÄ±ÅŸÄ±',date:'2025-07-18',city:'Bursa',participants:2500,tents:0,agency:114000,personnel:44000,standCost:100000,barter:0,cekCiro:0,cadirCiro:462762,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s30',name:'EskiÅŸehir YarÄ± Maratonu 2025',date:'2025-08-02',city:'EskiÅŸehir',participants:2400,tents:0,agency:131700,personnel:29580,standCost:0,barter:54000,cekCiro:0,cadirCiro:222000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s31',name:'Gran Fondo BaÅŸkent Bisiklet',date:'2025-08-23',city:'Ankara',participants:900,tents:0,agency:0,personnel:3800,standCost:0,barter:0,cekCiro:0,cadirCiro:39000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s32',name:'Summer Run',date:'2025-08-30',city:'Ä°stanbul',participants:1150,tents:0,agency:48000,personnel:24555,standCost:120000,barter:0,cekCiro:0,cadirCiro:70826,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s33',name:'Merrell Belgrad Ultra 2025',date:'2025-09-05',city:'Ä°stanbul',participants:3500,tents:0,agency:0,personnel:30132,standCost:0,barter:0,cekCiro:0,cadirCiro:400375,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s34',name:'Tuzla Fest Run',date:'2025-09-19',city:'Ä°stanbul',participants:1200,tents:0,agency:79200,personnel:22494,standCost:30000,barter:40000,cekCiro:0,cadirCiro:87526,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s35',name:'Runkara YarÄ± Maratonu',date:'2025-10-04',city:'Ankara',participants:3300,tents:0,agency:108000,personnel:9435,standCost:40000,barter:60000,cekCiro:0,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s36',name:'Salomon Kapadokya YarÄ±ÅŸÄ±',date:'2025-10-16',city:'NevÅŸehir',participants:3500,tents:0,agency:146400,personnel:117600,standCost:120000,barter:0,cekCiro:0,cadirCiro:738000,year:2025,weather:'',addedBy:'Sistem'},
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let DB=[];
let username='';
let CH={};
const SK='spx:events:v4';
const UK='spx:user';

// â”€â”€ STORAGE (shared via window.storage if available) â”€â”€
async function sGet(k){
  if(window.storage){try{const r=await window.storage.get(k,true);return r?r.value:null;}catch{return null;}}
  return localStorage.getItem(k);
}
async function sSet(k,v){
  if(window.storage){try{await window.storage.set(k,v,true);}catch(e){console.warn(e);}return;}
  localStorage.setItem(k,v);
}
function lGet(k){return localStorage.getItem(k);}
function lSet(k,v){localStorage.setItem(k,v);}

// â”€â”€ COMPUTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calc(e){
  const ciro=(e.cekCiro||0)+(e.cadirCiro||0);
  const gider=(e.agency||0)+(e.personnel||0)+(e.standCost||0)+(e.barter||0);
  const kar=ciro-gider;
  const margin=ciro>0?(kar/ciro)*100:0;
  const roi=gider>0?(kar/gider)*100:0;
  const perC=e.participants>0?ciro/e.participants:0;
  const perG=e.participants>0?gider/e.participants:0;
  return{ciro,gider,kar,margin,roi,perC,perG};
}

// â”€â”€ FORMAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fc(n){const a=Math.abs(n),s=n<0?'-':'';return s+'â‚º'+(a>=1e6?(a/1e6).toFixed(1)+'M':a>=1000?(a/1000).toFixed(0)+'K':Math.round(a).toLocaleString('tr-TR'));}
function fn(n){return Math.round(n).toLocaleString('tr-TR');}

// â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filtered(){
  const y=document.getElementById('year-filter').value;
  const c=document.getElementById('city-filter').value;
  return DB.filter(e=>(y==='all'||String(e.year)===y)&&(c==='all'||e.city===c));
}

function rebuildFilters(){
  const years=[...new Set(DB.map(e=>e.year))].sort((a,b)=>b-a);
  const cities=[...new Set(DB.map(e=>e.city))].sort();
  const nowY=new Date().getFullYear();

  const yf=document.getElementById('year-filter'),cy=yf.value;
  yf.innerHTML='<option value="all">TÃ¼m YÄ±llar</option>'+years.map(y=>`<option value="${y}"${String(y)===cy?' selected':''}>${y}</option>`).join('');

  const cf=document.getElementById('city-filter'),cc=cf.value;
  cf.innerHTML='<option value="all">TÃ¼m Åehirler</option>'+cities.map(c=>`<option value="${c}"${c===cc?' selected':''}>${c}</option>`).join('');

  // City datalist
  document.getElementById('city-dl').innerHTML=cities.map(c=>`<option value="${c}">`).join('');

  // Year select for form: all existing years + current + next 2
  const formYears=[...new Set([...years,nowY,nowY+1,nowY+2])].sort((a,b)=>b-a);
  const fy=document.getElementById('f-year'),fcy=fy.value||nowY;
  fy.innerHTML=formYears.map(y=>`<option value="${y}"${String(y)===String(fcy)?' selected':''}>${y} Etkinlikleri</option>`).join('');
}

// â”€â”€ LOAD / SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData(){
  setST('YÃ¼kleniyorâ€¦');
  try{
    const raw=await sGet(SK);
    let userEvs=[];
    if(raw){try{userEvs=JSON.parse(raw);}catch{}}
    const map=new Map();
    SEED.forEach(e=>map.set(e.id,e));
    userEvs.forEach(e=>map.set(e.id,e));
    DB=[...map.values()].sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
    rebuildFilters();
    setST('Senkronize');
    updateFoot();
  }catch{
    DB=[...SEED];
    rebuildFilters();
    setST('Ã‡evrimdÄ±ÅŸÄ±');
  }
}
async function saveData(){
  const toSave=DB.filter(e=>!e.id.startsWith('s')||e.weather);
  await sSet(SK,JSON.stringify(toSave));
  updateFoot();
}
async function syncAll(){await loadData();applyFilters();toast('â†» Senkronize edildi');}
function setST(t){document.getElementById('sync-txt').textContent=t;}
function updateFoot(){
  document.getElementById('foot-count').textContent=DB.length+' etkinlik';
  const u=[...new Set(DB.map(e=>e.addedBy).filter(Boolean))];
  document.getElementById('foot-users').textContent=u.length+' kullanÄ±cÄ±';
}

// â”€â”€ USER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveUser(v){username=v.trim();lSet(UK,username);}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDashboard(){
  const evs=filtered().map(e=>({...e,...calc(e)}));
  const tCiro=evs.reduce((a,b)=>a+b.ciro,0);
  const tGider=evs.reduce((a,b)=>a+b.gider,0);
  const tKar=evs.reduce((a,b)=>a+b.kar,0);
  const wC=evs.filter(e=>e.ciro>0),wG=evs.filter(e=>e.gider>0);
  const avgM=wC.length?wC.reduce((a,b)=>a+b.margin,0)/wC.length:0;
  const avgR=wG.length?wG.reduce((a,b)=>a+b.roi,0)/wG.length:0;

  sv('k-ciro',fc(tCiro));sv('k-kar',fc(tKar));sv('k-gider',fc(tGider));
  sv('k-margin',avgM.toFixed(1)+'%');sv('k-count',evs.length+'');sv('k-roi',avgR.toFixed(1)+'%');
  sv('k-ciro-s',`Ã‡ek: ${fc(evs.reduce((a,b)=>a+b.cekCiro,0))} Â· Ã‡adÄ±r: ${fc(evs.reduce((a,b)=>a+b.cadirCiro,0))}`);
  sv('k-kar-s',`Marj: ${tCiro>0?((tKar/tCiro)*100).toFixed(1):'0'}%`);

  const sorted=wC.sort((a,b)=>b.kar-a.kar);
  if(sorted.length){
    sv('k-best',sorted[0].name.substring(0,22)+(sorted[0].name.length>22?'â€¦':''));
    sv('k-best-s',fc(sorted[0].kar)+' kar');
    sv('k-worst',sorted[sorted.length-1].name.substring(0,22));
    sv('k-worst-s',fc(sorted[sorted.length-1].kar));
  }
  buildCharts(evs);
}

// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TT={backgroundColor:'#1a2438',borderColor:'rgba(59,130,246,.3)',borderWidth:1,titleColor:'#f0f4ff',bodyColor:'#8da0bf',padding:10};
const LEG={labels:{color:'#8da0bf',font:{family:'DM Mono',size:10},boxWidth:9}};
function AX(isY=false){return{grid:{color:'rgba(59,130,246,.05)'},ticks:{color:'#4d6080',font:{family:'DM Mono',size:9},callback:isY?v=>{const a=Math.abs(v);return(a>=1e6?(v/1e6).toFixed(1)+'M':a>=1000?(v/1000).toFixed(0)+'K':v)+'';}:undefined}};}
function dc(id){if(CH[id]){CH[id].destroy();delete CH[id];}}

function buildCharts(evs){
  const MN=['Oca','Åub','Mar','Nis','May','Haz','Tem','AÄŸu','Eyl','Eki','Kas','Ara'];
  const mp={};
  evs.forEach(e=>{
    if(!e.date)return;const d=new Date(e.date);if(isNaN(d))return;
    const k=e.year+'-'+String(d.getMonth()).padStart(2,'0');
    if(!mp[k])mp[k]={lbl:MN[d.getMonth()]+' '+e.year,ciro:0,kar:0};
    mp[k].ciro+=e.ciro;mp[k].kar+=e.kar;
  });
  const mk=Object.keys(mp).sort();
  dc('monthly');
  CH.monthly=new Chart(document.getElementById('cMonthly'),{type:'bar',data:{labels:mk.map(k=>mp[k].lbl),datasets:[
    {label:'Ciro',data:mk.map(k=>mp[k].ciro),backgroundColor:'rgba(59,130,246,.65)',borderRadius:4,order:2},
    {label:'Kar',data:mk.map(k=>mp[k].kar),type:'line',borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.1)',borderWidth:2,pointRadius:3,tension:.4,order:1,fill:true}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  const cm={};
  evs.forEach(e=>{if(!cm[e.city])cm[e.city]={kar:0,gider:0};cm[e.city].kar+=e.kar;cm[e.city].gider+=e.gider;});
  const cok=Object.keys(cm).filter(c=>cm[c].gider>0);
  const rois=cok.map(c=>(cm[c].kar/cm[c].gider)*100);
  dc('city');
  CH.city=new Chart(document.getElementById('cCity'),{type:'bar',data:{labels:cok,datasets:[{label:'ROI %',data:rois,backgroundColor:rois.map(r=>r>=0?'rgba(16,185,129,.7)':'rgba(244,63,94,.7)'),borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),ticks:{...AX().ticks,callback:v=>v.toFixed(0)+'%'}},y:AX()}}});

  const top=evs.filter(e=>e.ciro>0).sort((a,b)=>b.ciro-a.ciro).slice(0,10);
  dc('event');
  CH.event=new Chart(document.getElementById('cEvent'),{type:'bar',data:{labels:top.map(e=>e.name.substring(0,13)+(e.name.length>13?'â€¦':'')),datasets:[
    {label:'Ciro',data:top.map(e=>e.ciro),backgroundColor:'rgba(59,130,246,.5)',borderRadius:3},
    {label:'Gider',data:top.map(e=>e.gider),backgroundColor:'rgba(244,63,94,.5)',borderRadius:3},
    {label:'Kar',data:top.map(e=>e.kar),backgroundColor:'rgba(16,185,129,.7)',borderRadius:3}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  const tA=evs.reduce((a,b)=>a+(b.agency||0),0);
  const tP=evs.reduce((a,b)=>a+(b.personnel||0),0);
  const tS=evs.reduce((a,b)=>a+(b.standCost||0),0);
  const tB=evs.reduce((a,b)=>a+(b.barter||0),0);
  dc('exp');
  CH.exp=new Chart(document.getElementById('cExp'),{type:'doughnut',data:{labels:['Ajans','Personel','Stand','Barter'],datasets:[{data:[tA,tP,tS,tB],backgroundColor:['rgba(59,130,246,.8)','rgba(139,92,246,.8)','rgba(245,158,11,.8)','rgba(34,211,238,.8)'],borderWidth:0,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{...LEG,position:'bottom'},tooltip:TT}}});
}

// â”€â”€ EVENTS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEvents(){
  const evs=filtered();
  const q=(document.getElementById('ev-srch').value||'').toLowerCase();
  const grouped=document.getElementById('grp-yr').checked;
  const tbody=document.getElementById('ev-tbody');
  document.getElementById('ev-badge').textContent=`(${evs.length})`;

  const rows=evs.filter(e=>!q||e.name.toLowerCase().includes(q)||e.city.toLowerCase().includes(q));
  tbody.innerHTML='';
  if(!rows.length){tbody.innerHTML=`<tr><td colspan="14"><div class="empty">Etkinlik bulunamadÄ±</div></td></tr>`;return;}

  if(grouped){
    const years=[...new Set(rows.map(e=>e.year))].sort((a,b)=>b-a);
    years.forEach(yr=>{
      const yr_rows=rows.filter(e=>e.year===yr);
      const ym=yr_rows.map(e=>calc(e));
      const yC=ym.reduce((a,b)=>a+b.ciro,0),yK=ym.reduce((a,b)=>a+b.kar,0);
      // Year header
      const htr=document.createElement('tr');htr.className='yr-row';
      htr.innerHTML=`<td colspan="14">${yr} Etkinlikleri<span class="yr-stats">${yr_rows.length} etkinlik &nbsp;Â·&nbsp; Ciro: ${fc(yC)} &nbsp;Â·&nbsp; Net Kar: ${fc(yK)}</span></td>`;
      tbody.appendChild(htr);
      yr_rows.forEach(ev=>tbody.appendChild(mkRow(ev)));
    });
  } else {
    rows.forEach(ev=>tbody.appendChild(mkRow(ev)));
  }
}

function mkRow(ev){
  const m=calc(ev);
  const p=m.margin>=40?'h':m.margin>=0?'m':'l';
  const pL={h:'YÃ¼ksek',m:'Orta',l:'DÃ¼ÅŸÃ¼k'}[p];
  const tr=document.createElement('tr');
  tr.onclick=e=>{if(e.target.closest('.row-acts'))return;showDetail(ev.id);};
  tr.innerHTML=`
    <td class="nm" title="${ev.name}">${ev.name}</td>
    <td>${ev.date||'â€”'}</td><td>${ev.city}</td>
    <td class="mo">${ev.year}</td>
    <td class="mo">${ev.participants>0?fn(ev.participants):'â€”'}</td>
    <td class="mo ${m.ciro>0?'pg':''}">${fc(m.ciro)}</td>
    <td class="mo">${fc(m.gider)}</td>
    <td class="mo ${m.kar>=0?'pg':'pr'}">${fc(m.kar)}</td>
    <td class="mo ${m.margin>=0?'pg':'pr'}">${m.ciro>0?m.margin.toFixed(1)+'%':'â€”'}</td>
    <td class="mo ${m.roi>=0?'pg':'pr'}">${m.gider>0?m.roi.toFixed(0)+'%':'â€”'}</td>
    <td class="mo">${ev.participants>0&&m.ciro>0?fc(m.perC):'â€”'}</td>
    <td><span class="pl p${p}">${pL}</span></td>
    <td><span class="pl pu" style="font-size:9px">${ev.addedBy||'â€”'}</span></td>
    <td><div class="row-acts">
      <button class="rab rab-e" title="DÃ¼zenle" onclick="openEdit('${ev.id}')">âœ</button>
      <button class="rab rab-s" title="PaylaÅŸ" onclick="openShare('${ev.id}')">â¬†</button>
      <button class="rab rab-d" title="Sil" onclick="delEv('${ev.id}',event)">âœ•</button>
    </div></td>`;
  return tr;
}

async function delEv(id,e){
  e.stopPropagation();
  if(!confirm('Bu etkinliÄŸi silmek istiyor musunuz?'))return;
  DB=DB.filter(ev=>ev.id!==id);
  await saveData();rebuildFilters();applyFilters();toast('Etkinlik silindi');
}

// â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDateChange(){
  const d=document.getElementById('f-date').value;
  if(d){document.getElementById('f-year').value=new Date(d).getFullYear();onYearChange();}
  buildPrompt();calcPrev();
}

function onYearChange(){
  const yr=parseInt(document.getElementById('f-year').value);
  const existing=new Set(DB.map(e=>e.year));
  const banner=document.getElementById('yr-banner');
  if(!existing.has(yr)){
    banner.style.display='block';
    document.getElementById('yr-banner-txt').textContent=yr;
  } else {banner.style.display='none';}
}

function calcPrev(){
  const cek=nv('f-cek'),cc=nv('f-cciro'),aj=nv('f-ajans'),pe=nv('f-per'),st=nv('f-stand'),ba=nv('f-barter'),kat=nv('f-kat');
  const ciro=cek+cc,gider=aj+pe+st+ba,kar=ciro-gider;
  sv('p-ciro',fc(ciro));sv('p-gider',fc(gider));
  const pk=document.getElementById('p-kar');pk.textContent=fc(kar);pk.className='pvv '+(kar>=0?'cg':'cr');
  sv('p-margin',ciro>0?((kar/ciro)*100).toFixed(1)+'%':'â€”');
  sv('p-roi',gider>0?((kar/gider)*100).toFixed(1)+'%':'â€”');
  sv('p-pciro',kat>0&&ciro>0?fc(ciro/kat):'â€”');
  sv('p-pgdr',kat>0&&gider>0?fc(gider/kat):'â€”');
}

function buildPrompt(){
  const date=document.getElementById('f-date').value;
  const city=(document.getElementById('f-city').value||'').trim();
  if(!date||!city){document.getElementById('wx-pr').textContent='Tarih ve ÅŸehir girerek prompt oluÅŸturunâ€¦';return;}
  const d=new Date(date);
  const MN=['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
  document.getElementById('wx-pr').textContent=`${d.getDate()} ${MN[d.getMonth()]} ${d.getFullYear()} tarihinde ${city}'de hava nasÄ±ldÄ±?\nSadece ÅŸu formatta cevap ver:\nSÄ±caklÄ±k: XÂ°C\nDurum: GÃ¼neÅŸli/YaÄŸmurlu/Bulutlu\nRÃ¼zgar: X km/h`;
}

async function saveEvent(){
  const name=(document.getElementById('f-name').value||'').trim();
  const city=(document.getElementById('f-city').value||'').trim();
  const date=document.getElementById('f-date').value;
  const year=parseInt(document.getElementById('f-year').value);
  if(!name||!city){toast('Etkinlik adÄ± ve ÅŸehir zorunludur','err');return;}
  if(!username){toast('LÃ¼tfen sol menÃ¼den kullanÄ±cÄ± adÄ± girin','err');return;}

  const ev={
    id:'u'+Date.now(),name,date,city,year,
    participants:nv('f-kat'),tents:nv('f-cadir'),
    agency:nv('f-ajans'),personnel:nv('f-per'),standCost:nv('f-stand'),barter:nv('f-barter'),
    cekCiro:nv('f-cek'),cadirCiro:nv('f-cciro'),
    weather:(document.getElementById('f-wx').value||'').trim(),
    addedBy:username,addedAt:new Date().toISOString()
  };

  DB.push(ev);DB.sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
  await saveData();rebuildFilters();applyFilters();
  toast('âœ“ Kaydedildi: '+name);
  clearForm();
  goPage('events',document.querySelectorAll('.ni')[1]);
}

function clearForm(){
  ['f-name','f-date','f-city','f-kat','f-cadir','f-ajans','f-per','f-stand','f-barter','f-cek','f-cciro','f-wx'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('yr-banner').style.display='none';
  document.getElementById('wx-pr').textContent='Tarih ve ÅŸehir girerek prompt oluÅŸturunâ€¦';
  calcPrev();
}

// â”€â”€ ANALYSIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAnalysis(){
  const evs=filtered().map(e=>({...e,...calc(e)}));
  const cm={};evs.forEach(e=>{if(!cm[e.city])cm[e.city]={kar:0,gider:0,ciro:0,count:0};cm[e.city].kar+=e.kar;cm[e.city].gider+=e.gider;cm[e.city].ciro+=e.ciro;cm[e.city].count++;});
  const cities=Object.entries(cm).sort((a,b)=>b[1].kar-a[1].kar);
  const maxK=Math.max(...cities.map(c=>Math.abs(c[1].kar)))||1;
  document.getElementById('city-ins').innerHTML=cities.slice(0,8).map(([city,d])=>{
    const pct=(Math.abs(d.kar)/maxK)*100;const col=d.kar>=0?'var(--green)':'var(--rose)';
    return `<div class="ins-row"><span class="irl">${city}</span><div class="irbw"><div class="irb" style="width:${pct}%;background:${col}"></div></div><span class="irv">${fc(d.kar)}</span></div>`;
  }).join('');

  const ad=evs.filter(e=>e.agency>0&&e.ciro>0);
  dc('agency');CH.agency=new Chart(document.getElementById('cAgency'),{type:'scatter',data:{datasets:[{label:'Etkinlik',data:ad.map(e=>({x:e.agency/1000,y:e.margin})),backgroundColor:'rgba(59,130,246,.6)',pointRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),title:{display:true,text:'Ajans (Kâ‚º)',color:'#4d6080',font:{size:9}},ticks:{...AX().ticks,callback:v=>v+'K'}},y:{...AX(),title:{display:true,text:'Kar MarjÄ± %',color:'#4d6080',font:{size:9}},ticks:{...AX().ticks,callback:v=>v.toFixed(0)+'%'}}}}});

  const pd=evs.filter(e=>e.participants>0&&e.gider>0);
  dc('part');CH.part=new Chart(document.getElementById('cPart'),{type:'scatter',data:{datasets:[{label:'Etkinlik',data:pd.map(e=>({x:e.participants,y:e.roi})),backgroundColor:'rgba(245,158,11,.6)',pointRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),title:{display:true,text:'KatÄ±lÄ±mcÄ±',color:'#4d6080',font:{size:9}}},y:{...AX(),title:{display:true,text:'ROI %',color:'#4d6080',font:{size:9}},ticks:{...AX().ticks,callback:v=>v.toFixed(0)+'%'}}}}});

  const wxEvs=evs.filter(e=>e.weather);
  if(wxEvs.length){
    const byC={};wxEvs.forEach(e=>{const c2=parseWx(e.weather).cond||'Bilinmiyor';if(!byC[c2])byC[c2]=[];byC[c2].push(e.roi);});
    document.getElementById('wx-ins').innerHTML=Object.entries(byC).map(([c2,r])=>{const avg=r.reduce((a,b)=>a+b,0)/r.length;return`<div class="ins-row"><span class="irl">${c2}</span><span class="irv ${avg>=0?'pg':'pr'}">${avg.toFixed(0)}% ROI</span></div>`;}).join('');
  }

  const bestCity=cities[0];
  const prof=evs.filter(e=>e.kar>0&&e.ciro>0).length;
  const total=evs.filter(e=>e.ciro>0).length;
  const avgA=evs.filter(e=>e.agency>0).reduce((a,b)=>a+b.agency,0)/Math.max(1,evs.filter(e=>e.agency>0).length);
  document.getElementById('deci-cards').innerHTML=`
    <div class="dc2" style="background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2)">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--green);letter-spacing:1px;margin-bottom:7px">ğŸ† EN KARLI ÅEHÄ°R</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700">${bestCity?bestCity[0]:'â€”'}</div>
      <div style="font-size:11px;color:var(--t3);margin-top:3px">${bestCity?fc(bestCity[1].kar)+' Â· '+bestCity[1].count+' etkinlik':'â€”'}</div>
    </div>
    <div class="dc2" style="background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.2)">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue2);letter-spacing:1px;margin-bottom:7px">ğŸ“ˆ KARLILIK ORANI</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700">${total>0?((prof/total)*100).toFixed(0)+'%':'â€”'}</div>
      <div style="font-size:11px;color:var(--t3);margin-top:3px">${prof} / ${total} etkinlik kÃ¢rlÄ±</div>
    </div>
    <div class="dc2" style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2)">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:1px;margin-bottom:7px">ğŸ’¡ ORT. AJANS MALÄ°YETÄ°</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700">${fc(avgA)}</div>
      <div style="font-size:11px;color:var(--t3);margin-top:3px">Etkinlik baÅŸÄ±na ortalama</div>
    </div>`;
}

// â”€â”€ WEATHER TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWeather(){
  const evs=DB.filter(e=>e.weather&&e.weather.trim());
  const tbody=document.getElementById('wx-tbody');
  if(!evs.length){tbody.innerHTML=`<tr><td colspan="9"><div class="empty">HenÃ¼z hava durumu verisi yok.</div></td></tr>`;return;}
  tbody.innerHTML=evs.map(ev=>{
    const m=calc(ev);const w=parseWx(ev.weather);
    const imp=!w.cond?'â€”':m.roi>80&&(w.cond.includes('GÃ¼neÅŸ')||w.cond.includes('AÃ§Ä±k'))?'<span class="pl ph">â†‘ Olumlu</span>':w.cond.includes('YaÄŸmur')&&m.roi<0?'<span class="pl plo">â†“ Olumsuz</span>':'<span class="pl pm">â†’ NÃ¶tr</span>';
    return `<tr><td class="nm">${ev.name}</td><td>${ev.date||'â€”'}</td><td>${ev.city}</td><td class="mo">${ev.year}</td><td class="mo">${w.temp||'â€”'}</td><td>${w.cond||'â€”'}</td><td class="mo">${w.wind||'â€”'}</td><td class="mo ${m.kar>=0?'pg':'pr'}">${fc(m.kar)}</td><td>${imp}</td></tr>`;
  }).join('');
}

function parseWx(s){
  if(!s)return{};
  return{
    temp:((s.match(/sÄ±caklÄ±k:\s*([\d.]+)/i)||[])[1]||null),
    cond:((s.match(/durum:\s*(\S+(?:\s+\S+)?)/i)||[])[1]||null),
    wind:((s.match(/rÃ¼zgar:\s*([\d.]+)/i)||[])[1]||null)
  };
}

// â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _curId=null;
function showDetail(id){
  const ev=DB.find(e=>e.id===id);if(!ev)return;
  _curId=id;
  const m=calc(ev);const w=parseWx(ev.weather);
  document.getElementById('m-name').textContent=ev.name;
  document.getElementById('modal-detail').classList.add('open');
  document.getElementById('m-body').innerHTML=`
    <div class="mg">
      ${[['Åehir',ev.city],['Tarih',ev.date||'â€”'],['YÄ±l',ev.year],['KatÄ±lÄ±mcÄ±',ev.participants>0?fn(ev.participants):'â€”'],['Ã‡adÄ±r',ev.tents||'â€”'],['Ekleyen',ev.addedBy||'â€”']].map(([l,v])=>`<div class="mi"><div class="mil">${l}</div><div class="miv">${v}</div></div>`).join('')}
    </div>
    <div style="background:var(--bg3);border-radius:8px;padding:12px;margin-bottom:11px">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:1px;margin-bottom:8px">GÄ°DER KALEMLERÄ°</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px">
        <div><span style="color:var(--t3)">Ajans: </span><span style="font-family:'DM Mono',monospace">${fc(ev.agency||0)}</span></div>
        <div><span style="color:var(--t3)">Personel: </span><span style="font-family:'DM Mono',monospace">${fc(ev.personnel||0)}</span></div>
        <div><span style="color:var(--t3)">Stand: </span><span style="font-family:'DM Mono',monospace">${fc(ev.standCost||0)}</span></div>
        <div><span style="color:var(--t3)">Barter: </span><span style="font-family:'DM Mono',monospace">${fc(ev.barter||0)}</span></div>
      </div>
    </div>
    <div class="mkr">
      ${[['Toplam Ciro',fc(m.ciro),'var(--blue2)'],['Toplam Gider',fc(m.gider),'var(--amber)'],['Net Kar',fc(m.kar),m.kar>=0?'var(--green)':'var(--rose)'],['Kar MarjÄ±',m.ciro>0?m.margin.toFixed(1)+'%':'â€”','var(--t1)'],['ROI',m.gider>0?m.roi.toFixed(0)+'%':'â€”',m.roi>=0?'var(--green)':'var(--rose)'],['Kat. BaÅŸÄ± Ciro',ev.participants>0?fc(m.perC):'â€”','var(--t1)']].map(([l,v,c])=>`<div class="mk"><div class="mkl">${l}</div><div class="mkv" style="color:${c}">${v}</div></div>`).join('')}
    </div>
    ${ev.weather?`<div style="background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.14);border-radius:8px;padding:11px"><div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:1px;margin-bottom:5px">HAVA DURUMU</div><div style="font-size:12px;color:var(--t2);font-family:'DM Mono',monospace;white-space:pre-line">${ev.weather}</div></div>`:''}`;
}
function shareFromDetail(){const id=_curId;closeModal('modal-detail');setTimeout(()=>openShare(id),150);}
function editFromDetail(){const id=_curId;closeModal('modal-detail');setTimeout(()=>openEdit(id),150);}
async function delFromDetail(){
  if(!_curId)return;
  if(!confirm('Bu etkinliÄŸi silmek istiyor musunuz?'))return;
  DB=DB.filter(e=>e.id!==_curId);
  closeModal('modal-detail');
  await saveData();rebuildFilters();applyFilters();toast('Etkinlik silindi');
}

// â”€â”€ EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEdit(id){
  const ev=DB.find(e=>e.id===id);if(!ev)return;
  document.getElementById('edit-id').value=ev.id;
  setv('e-name',ev.name);setv('e-date',ev.date||'');setv('e-city',ev.city);
  // Populate year dropdown
  const nowY=new Date().getFullYear();
  const years=[...new Set(DB.map(e=>e.year))];
  const allY=[...new Set([...years,nowY,nowY+1,nowY+2])].sort((a,b)=>b-a);
  const ey=document.getElementById('e-year');
  ey.innerHTML=allY.map(y=>`<option value="${y}"${y===ev.year?' selected':''}>${y} Etkinlikleri</option>`).join('');
  setv('e-kat',ev.participants||0);setv('e-cadir',ev.tents||0);
  setv('e-ajans',ev.agency||0);setv('e-per',ev.personnel||0);
  setv('e-stand',ev.standCost||0);setv('e-barter',ev.barter||0);
  setv('e-cek',ev.cekCiro||0);setv('e-cciro',ev.cadirCiro||0);
  setv('e-wx',ev.weather||'');
  calcEP();
  document.getElementById('modal-edit').classList.add('open');
}
function onEditDate(){
  const d=document.getElementById('e-date').value;
  if(d){document.getElementById('e-year').value=new Date(d).getFullYear();}
}
function calcEP(){
  const cek=nv('e-cek'),cc=nv('e-cciro'),aj=nv('e-ajans'),pe=nv('e-per'),st=nv('e-stand'),ba=nv('e-barter'),kat=nv('e-kat');
  const ciro=cek+cc,gider=aj+pe+st+ba,kar=ciro-gider;
  sv('ep-ciro',fc(ciro));sv('ep-gider',fc(gider));
  const pk=document.getElementById('ep-kar');pk.textContent=fc(kar);pk.className='pvv '+(kar>=0?'cg':'cr');
  sv('ep-margin',ciro>0?((kar/ciro)*100).toFixed(1)+'%':'â€”');
  sv('ep-roi',gider>0?((kar/gider)*100).toFixed(1)+'%':'â€”');
  sv('ep-pciro',kat>0&&ciro>0?fc(ciro/kat):'â€”');
  sv('ep-pgdr',kat>0&&gider>0?fc(gider/kat):'â€”');
}
async function saveEdit(){
  const id=document.getElementById('edit-id').value;
  const name=(document.getElementById('e-name').value||'').trim();
  const city=(document.getElementById('e-city').value||'').trim();
  if(!name||!city){toast('Ad ve ÅŸehir zorunludur','err');return;}
  const idx=DB.findIndex(e=>e.id===id);
  if(idx===-1){toast('Etkinlik bulunamadÄ±','err');return;}
  const orig=DB[idx];
  DB[idx]={...orig,name,city,
    date:document.getElementById('e-date').value||orig.date,
    year:parseInt(document.getElementById('e-year').value)||orig.year,
    participants:nv('e-kat'),tents:nv('e-cadir'),
    agency:nv('e-ajans'),personnel:nv('e-per'),standCost:nv('e-stand'),barter:nv('e-barter'),
    cekCiro:nv('e-cek'),cadirCiro:nv('e-cciro'),
    weather:(document.getElementById('e-wx').value||'').trim(),
    _edited:true,editedBy:username||orig.editedBy,editedAt:new Date().toISOString()
  };
  DB.sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
  await saveData();rebuildFilters();applyFilters();
  closeModal('modal-edit');toast('âœ“ GÃ¼ncellendi: '+name);
}

// â”€â”€ SHARE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openShare(id){
  const ev=DB.find(e=>e.id===id);if(!ev)return;
  const m=calc(ev);const w=parseWx(ev.weather);
  const perfPct=Math.min(100,Math.max(0,(m.margin+20)*2));
  const pColor=m.margin>=40?'var(--green)':m.margin>=0?'var(--amber)':'var(--rose)';
  const pLbl=m.margin>=40?'YÃ¼ksek Performans':m.margin>=0?'Orta Performans':'DÃ¼ÅŸÃ¼k Performans';
  sv('sct',ev.name);sv('scd',ev.date||'â€”');sv('scc',ev.city);
  sv('scp',ev.participants>0?fn(ev.participants)+' katÄ±lÄ±mcÄ±':'â€”');
  sv('sc-yr',ev.year+' Â· SPX');
  const scCiro=document.getElementById('sc-ciro');scCiro.textContent=fc(m.ciro);scCiro.style.color='var(--blue2)';
  sv('sc-ciro-s',`Ã‡ek: ${fc(ev.cekCiro||0)} Â· Ã‡adÄ±r: ${fc(ev.cadirCiro||0)}`);
  const scKar=document.getElementById('sc-kar');scKar.textContent=fc(m.kar);scKar.style.color=m.kar>=0?'var(--green)':'var(--rose)';
  sv('sc-kar-s',`Gider: ${fc(m.gider)}`);
  const scRoi=document.getElementById('sc-roi');scRoi.textContent=m.gider>0?m.roi.toFixed(0)+'%':'â€”';scRoi.style.color=m.roi>=0?'var(--cyan)':'var(--rose)';
  const scM=document.getElementById('sc-margin');scM.textContent=m.ciro>0?m.margin.toFixed(1)+'%':'â€”';scM.style.color=m.margin>=0?'var(--green)':'var(--rose)';
  sv('sc-gider',fc(m.gider));sv('sc-gider-s',`Ajans: ${fc(ev.agency||0)} Â· Pers: ${fc(ev.personnel||0)}`);
  sv('sc-pciro',ev.participants>0&&m.ciro>0?fc(m.perC):'â€”');sv('sc-pciro-s',ev.participants>0?fn(ev.participants)+' kiÅŸi':'â€”');
  document.getElementById('sc-pb').style.width=perfPct+'%';document.getElementById('sc-pb').style.background=pColor;sv('sc-pl',pLbl);
  const wxw=document.getElementById('sc-wx-wrap');
  if(w.temp||w.cond){wxw.style.display='block';sv('sc-wx-txt',`ğŸŒ¡ ${w.temp||'â€”'}  â›… ${w.cond||'â€”'}${w.wind?'  ğŸ’¨ '+w.wind:''}`);}
  else{wxw.style.display='none';}
  // Share link
  const sd={id:ev.id,name:ev.name,city:ev.city,date:ev.date,year:ev.year,participants:ev.participants,ciro:m.ciro,gider:m.gider,kar:m.kar,margin:m.margin,roi:m.roi};
  const enc=btoa(unescape(encodeURIComponent(JSON.stringify(sd))));
  const url=(window.location.href.split('#')[0])+'#ev='+enc;
  document.getElementById('share-link-box').textContent=url;
  document.getElementById('modal-share').classList.add('open');
}
function copyLink(){
  const url=document.getElementById('share-link-box').textContent;
  _copy(url);
}
function copyText(){
  const ev=DB.find(e=>e.id===_shareId)||{};
  const n=document.getElementById('sct').textContent;
  const d=document.getElementById('scd').textContent;
  const c=document.getElementById('scc').textContent;
  const ciro=document.getElementById('sc-ciro').textContent;
  const kar=document.getElementById('sc-kar').textContent;
  const roi=document.getElementById('sc-roi').textContent;
  const margin=document.getElementById('sc-margin').textContent;
  const gider=document.getElementById('sc-gider').textContent;
  const wxLine=document.getElementById('sc-wx-wrap').style.display!=='none'?'\nğŸŒ¤ '+document.getElementById('sc-wx-txt').textContent:'';
  const t=`ğŸ“Š SPX ETKÄ°NLÄ°K RAPORU\n${'â”€'.repeat(30)}\nğŸ¯ ${n}\nğŸ“… ${d}  ğŸ“ ${c}\n${'â”€'.repeat(30)}\nğŸ’° Toplam Ciro: ${ciro}\nğŸ“‰ Toplam Gider: ${gider}\nâœ… Net Kar: ${kar}\nğŸ“ˆ ROI: ${roi}\nğŸ“Š Kar MarjÄ±: ${margin}${wxLine}\n${'â”€'.repeat(30)}\nSPX Event Intelligence`;
  _copy(t);
}
function shareWA(){
  const n=document.getElementById('sct').textContent;
  const d=document.getElementById('scd').textContent;
  const c=document.getElementById('scc').textContent;
  const ciro=document.getElementById('sc-ciro').textContent;
  const kar=document.getElementById('sc-kar').textContent;
  const roi=document.getElementById('sc-roi').textContent;
  const url=document.getElementById('share-link-box').textContent;
  const t=`*ğŸ“Š ${n}*\nğŸ“… ${d} Â· ğŸ“ ${c}\n\nğŸ’° Ciro: *${ciro}*\nâœ… Net Kar: *${kar}*\nğŸ“ˆ ROI: *${roi}*\n\nğŸ”— ${url}`;
  window.open('https://wa.me/?text='+encodeURIComponent(t),'_blank');
}
function _copy(t){
  navigator.clipboard.writeText(t).then(showCopyOk).catch(()=>{const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showCopyOk();});
}
function showCopyOk(){const el=document.getElementById('copy-ok');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2200);}
let _shareId=null;
const _origOpenShare=openShare;

// â”€â”€ GENERIC MODAL HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModal(id){document.getElementById(id).classList.remove('open');}
function moBg(e,id){if(e.target===document.getElementById(id))closeModal(id);}
function setv(id,v){const el=document.getElementById(id);if(el)el.value=v;}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TITLES={dashboard:'Dashboard',events:'Etkinlikler','new-event':'Yeni Etkinlik Ekle',analysis:'Analiz Motoru',weather:'Hava Durumu',forecast:'2026 Tahmin Modeli','ai-score':'AI KatÄ±lÄ±m Skoru'};
function goPage(id,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  document.getElementById('pg-title').textContent=TITLES[id]||'';
  if(id==='events')renderEvents();
  if(id==='analysis')renderAnalysis();
  if(id==='weather')renderWeather();
  if(id==='forecast')renderForecast();
  if(id==='ai-score')renderAiScore();
  closeSB();
}

// â”€â”€ SIDEBAR MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSB(){const sb=document.getElementById('sb'),hb=document.getElementById('hb'),ov=document.getElementById('sb-ov');const o=sb.classList.toggle('open');hb.classList.toggle('open',o);ov.classList.toggle('open',o);}
function closeSB(){document.getElementById('sb').classList.remove('open');document.getElementById('hb').classList.remove('open');document.getElementById('sb-ov').classList.remove('open');}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let TT2;
function toast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type==='err'?'err':'');clearTimeout(TT2);TT2=setTimeout(()=>t.classList.remove('show'),3200);}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doExport(){
  const evs=filtered();
  const cols=['Etkinlik','YÄ±l','Tarih','Åehir','KatÄ±lÄ±mcÄ±','Ajans','Personel','Stand','Barter','Ã‡ekCiro','Ã‡adÄ±rCiro','ToplamCiro','ToplamGider','NetKar','KarMarjÄ±%','ROI%','KatBaÅŸÄ±Ciro','Ekleyen'];
  const rows=evs.map(e=>{const m=calc(e);return[e.name,e.year,e.date,e.city,e.participants,e.agency,e.personnel,e.standCost,e.barter,e.cekCiro,e.cadirCiro,m.ciro.toFixed(0),m.gider.toFixed(0),m.kar.toFixed(0),m.margin.toFixed(1),m.roi.toFixed(1),m.perC.toFixed(0),e.addedBy||''].join(',');});
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+[cols.join(','),...rows].join('\n')],{type:'text/csv;charset=utf-8;'}));a.download='spx_etkinlikler.csv';a.click();
  toast('CSV indirildi');
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nv(id){return parseFloat(document.getElementById(id).value)||0;}
function sv(id,v){const el=document.getElementById(id);if(el)el.textContent=v;}
function applyFilters(){updateDashboard();renderEvents();}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init(){
  const u=lGet(UK)||'';if(u){document.getElementById('username').value=u;username=u;}
  document.getElementById('f-date').valueAsDate=new Date();
  onDateChange();
  await loadData();
  updateDashboard();renderEvents();
  // Auto-sync every 30s
  setInterval(async()=>{await loadData();applyFilters();},30000);
  window.addEventListener('resize',()=>{if(window.innerWidth>768)closeSB();});
}

init();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORECAST ENGINE â€” 2026 Predictive Profitability Model
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getForecastData(){
  const evs2024=DB.filter(e=>e.year===2024).map(e=>({...e,...calc(e)}));
  const evs2025=DB.filter(e=>e.year===2025).map(e=>({...e,...calc(e)}));
  const sum=(arr,key)=>arr.reduce((a,b)=>a+(b[key]||0),0);
  const tot24={ciro:sum(evs2024,'ciro'),gider:sum(evs2024,'gider'),kar:sum(evs2024,'kar'),count:evs2024.length,parts:sum(evs2024,'participants')};
  const tot25={ciro:sum(evs2025,'ciro'),gider:sum(evs2025,'gider'),kar:sum(evs2025,'kar'),count:evs2025.length,parts:sum(evs2025,'participants')};
  const gr=(a,b)=>a>0?(b-a)/a:0.2;
  const ciroGr=gr(tot24.ciro,tot25.ciro);
  const giderGr=gr(tot24.gider,tot25.gider);
  const cntGr=gr(tot24.count,tot25.count);
  const partsGr=gr(tot24.parts,tot25.parts);
  const proj26cnt=Math.round(tot25.count*(1+Math.min(cntGr,0.4)));
  const nc=tot25.ciro*(1+ciroGr), ng=tot25.gider*(1+giderGr);
  const norm={ciro:nc,gider:ng,kar:nc-ng,count:proj26cnt};
  const pess={ciro:nc*0.90,gider:ng*1.05,kar:nc*0.90-ng*1.05,count:Math.round(proj26cnt*0.90)};
  const opti={ciro:nc*1.15,gider:ng*1.08,kar:nc*1.15-ng*1.08,count:Math.round(proj26cnt*1.15)};
  return{tot24,tot25,ciroGr,giderGr,cntGr,partsGr,norm,pess,opti,evs2024,evs2025};
}

function renderForecast(){
  const d=getForecastData();
  const{tot24,tot25,ciroGr,giderGr,cntGr,partsGr,norm,pess,opti,evs2024,evs2025}=d;

  // Growth rate cards
  document.getElementById('forecast-growth-cards').innerHTML=[
    {lbl:'Ciro BÃ¼yÃ¼me OranÄ±',val:(ciroGr*100).toFixed(1)+'%',sub:'2024 â†’ 2025 gerÃ§ek bÃ¼yÃ¼me',col:'var(--green)',fill:Math.min(100,Math.abs(ciroGr)*200)},
    {lbl:'Gider BÃ¼yÃ¼me OranÄ±',val:(giderGr*100).toFixed(1)+'%',sub:'2024 â†’ 2025 gerÃ§ek bÃ¼yÃ¼me',col:'var(--amber)',fill:Math.min(100,Math.abs(giderGr)*200)},
    {lbl:'Etkinlik SayÄ±sÄ± ArtÄ±ÅŸÄ±',val:'+'+(cntGr*100).toFixed(0)+'%',sub:`${tot24.count} â†’ ${tot25.count} etkinlik`,col:'var(--blue2)',fill:Math.min(100,cntGr*200)},
    {lbl:'KatÄ±lÄ±mcÄ± ArtÄ±ÅŸÄ±',val:'+'+(partsGr*100).toFixed(0)+'%',sub:'2024 â†’ 2025 bÃ¼yÃ¼me',col:'var(--violet)',fill:Math.min(100,partsGr*200)},
  ].map(g=>`<div class="growth-card">
    <div class="growth-num" style="color:${g.col}">${g.val}</div>
    <div class="growth-lbl">${g.lbl}</div>
    <div style="font-size:11px;color:var(--t3);margin-top:2px">${g.sub}</div>
    <div class="growth-bar" style="margin-top:10px"><div class="growth-fill" style="width:${g.fill}%;background:${g.col}"></div></div>
  </div>`).join('');

  // Exec summary
  const margN=norm.ciro>0?(norm.kar/norm.ciro*100).toFixed(1):0;
  const roiN=norm.gider>0?(norm.kar/norm.gider*100).toFixed(1):0;
  document.getElementById('forecast-exec-summary').innerHTML=`
    <div class="exec-summary-title">ğŸ“‹ YÃ¶netici Ã–zeti â€” 2026 Projeksiyon</div>
    <div class="exec-bullet">2025 toplam cirosu <span class="highlight-g">${fc(tot25.ciro)}</span> olarak gerÃ§ekleÅŸti. Normal senaryoda 2026 tahmini <span class="highlight">${fc(norm.ciro)}</span>, bÃ¼yÃ¼me oranÄ± <span class="highlight-g">%${(ciroGr*100).toFixed(1)}</span>'dir.</div>
    <div class="exec-bullet">Gider artÄ±ÅŸ hÄ±zÄ± (%${(giderGr*100).toFixed(1)}) ciro bÃ¼yÃ¼mesinin ${giderGr>ciroGr?'<span class="highlight-r">Ã¼zerinde</span> â€” maliyet kontrolÃ¼ kritik Ã¶neme sahip':'<span class="highlight-g">altÄ±nda</span> â€” saÄŸlÄ±klÄ± yapÄ± korunuyor'}.</div>
    <div class="exec-bullet">Normal senaryoda kar marjÄ± <span class="highlight">%${margN}</span>, ROI <span class="highlight">%${roiN}</span> Ã¶ngÃ¶rÃ¼lmektedir. Ä°yimser senaryo: <span class="highlight-g">${fc(opti.kar)}</span>, KÃ¶tÃ¼mser: <span class="highlight-r">${fc(pess.kar)}</span>.</div>
    <div class="exec-bullet">Senaryo aralÄ±ÄŸÄ± (fark) <span class="highlight-a">${fc(opti.kar-pess.kar)}</span>. YÃ¼ksek ROI'li ÅŸehirlere odaklanÄ±lmasÄ± ve ajans maliyetlerinin optimize edilmesi 2026 iÃ§in kritik Ã¶nerildir.</div>`;

  // Scenario cards
  const scenarios=[
    {cls:'pessimist',bdg:'bad',bdgTxt:'KÃ–TÃœMSER',icon:'ğŸ“‰',desc:'-10% KatÄ±lÄ±mcÄ± Etkisi',s:pess,adj:`-10% ciro, +5% gider varsayÄ±mÄ±`},
    {cls:'normal',bdg:'mid',bdgTxt:'NORMAL',icon:'ğŸ“Š',desc:'Mevcut Trend Devam',s:norm,adj:`+${(ciroGr*100).toFixed(0)}% ciro, +${(giderGr*100).toFixed(0)}% gider`},
    {cls:'optimist',bdg:'good',bdgTxt:'Ä°YÄ°MSER',icon:'ğŸ“ˆ',desc:'+15% KatÄ±lÄ±mcÄ± ArtÄ±ÅŸÄ±',s:opti,adj:'+15% ciro, +8% gider artÄ±ÅŸÄ±'},
  ];
  document.getElementById('forecast-scenarios').innerHTML=scenarios.map(sc=>{
    const mg=sc.s.ciro>0?(sc.s.kar/sc.s.ciro*100).toFixed(1):0;
    const ri=sc.s.gider>0?(sc.s.kar/sc.s.gider*100).toFixed(1):0;
    const vs=sc.s.kar-tot25.kar;
    return`<div class="scenario-card ${sc.cls}">
      <span class="sc-badge ${sc.bdg}">${sc.bdgTxt}</span>
      <div style="font-size:18px;font-weight:600;margin-bottom:4px">${sc.icon} ${sc.desc}</div>
      <div style="font-size:11px;color:var(--t3);font-family:'DM Mono',monospace;margin-bottom:14px">${sc.adj}</div>
      <div class="sc-metrics">
        <div class="sc-metric"><span class="sc-metric-l">Toplam Ciro</span><span class="sc-metric-v" style="color:var(--blue2)">${fc(sc.s.ciro)}</span></div>
        <div class="sc-metric"><span class="sc-metric-l">Toplam Gider</span><span class="sc-metric-v" style="color:var(--amber)">${fc(sc.s.gider)}</span></div>
        <div class="sc-metric"><span class="sc-metric-l">Net Kar</span><span class="sc-metric-v" style="color:${sc.s.kar>=0?'var(--green)':'var(--rose)'}">${fc(sc.s.kar)}</span></div>
        <div class="sc-divider"></div>
        <div class="sc-metric"><span class="sc-metric-l">Kar MarjÄ±</span><span class="sc-metric-v">${mg}%</span></div>
        <div class="sc-metric"><span class="sc-metric-l">ROI</span><span class="sc-metric-v">${ri}%</span></div>
        <div class="sc-metric"><span class="sc-metric-l">Etkinlik SayÄ±sÄ±</span><span class="sc-metric-v">${sc.s.count}</span></div>
      </div>
      <div class="sc-divider"></div>
      <div class="sc-delta"><span class="${vs>=0?'delta-up':'delta-dn'}">${vs>=0?'â–²':'â–¼'} ${fc(Math.abs(vs))}</span><span style="color:var(--t3);margin-left:6px;font-size:11px">2025'e gÃ¶re</span></div>
    </div>`;
  }).join('');

  // Chart: scenario comparison
  dc('fscen');
  CH.fscen=new Chart(document.getElementById('cForecastScenario'),{type:'bar',data:{
    labels:['KÃ¶tÃ¼mser','Normal','Ä°yimser'],
    datasets:[
      {label:'Ciro',data:[pess.ciro,norm.ciro,opti.ciro],backgroundColor:['rgba(244,63,94,.55)','rgba(59,130,246,.65)','rgba(16,185,129,.55)'],borderRadius:7,order:2},
      {label:'Gider',data:[pess.gider,norm.gider,opti.gider],backgroundColor:['rgba(244,63,94,.25)','rgba(59,130,246,.25)','rgba(16,185,129,.25)'],borderRadius:7,order:2},
      {label:'Net Kar',data:[pess.kar,norm.kar,opti.kar],type:'line',borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.1)',borderWidth:2.5,pointRadius:6,pointBackgroundColor:'#f59e0b',tension:.3,order:1,fill:false},
    ]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  // Chart: 2024â†’2025â†’2026 trend
  dc('ftrend');
  CH.ftrend=new Chart(document.getElementById('cForecastTrend'),{type:'line',data:{
    labels:['2024 GerÃ§ek','2025 GerÃ§ek','2026 KÃ¶tÃ¼mser','2026 Normal','2026 Ä°yimser'],
    datasets:[
      {label:'Ciro',data:[tot24.ciro,tot25.ciro,pess.ciro,norm.ciro,opti.ciro],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.08)',borderWidth:2.5,pointRadius:5,tension:.35,fill:true,pointBackgroundColor:(ctx)=>ctx.dataIndex>=2?'rgba(59,130,246,.4)':'#3b82f6',pointBorderDash:(ctx)=>ctx.dataIndex>=2?[4,3]:[]},
      {label:'Net Kar',data:[tot24.kar,tot25.kar,pess.kar,norm.kar,opti.kar],borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.06)',borderWidth:2.5,pointRadius:5,tension:.35,fill:true,pointBackgroundColor:(ctx)=>ctx.dataIndex>=2?'rgba(16,185,129,.4)':'#10b981'},
    ]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  // City forecast table
  const cityMap={};
  [...evs2024,...evs2025].forEach(e=>{
    if(!cityMap[e.city])cityMap[e.city]={c24:0,c25:0};
    if(e.year===2024)cityMap[e.city].c24+=e.ciro;
    else cityMap[e.city].c25+=e.ciro;
  });
  document.getElementById('forecast-city-tbody').innerHTML=Object.entries(cityMap)
    .filter(([c,v])=>v.c25>0).sort((a,b)=>b[1].c25-a[1].c25)
    .map(([city,v])=>{
      const gr=v.c24>0?(v.c25-v.c24)/v.c24:0.2;
      const n26=v.c25*(1+ciroGr); const o26=n26*1.15;
      const strat=gr>0.3?'ğŸš€ GeniÅŸlet':gr>0.1?'âœ… SÃ¼rdÃ¼r':'âš ï¸ Ä°zle';
      const col=gr>0.3?'var(--green)':gr>0.1?'var(--blue2)':'var(--amber)';
      return`<tr><td class="nm">${city}</td><td class="mo">${fc(v.c25)}</td><td class="mo" style="color:var(--blue2)">${fc(n26)}</td><td class="mo" style="color:var(--green)">${fc(o26)}</td><td class="mo" style="color:${col}">${gr>=0?'+':''}${(gr*100).toFixed(0)}%</td><td>${strat}</td></tr>`;
    }).join('');

  // Monthly seasonality chart
  const mBase=Array(12).fill(0);
  evs2025.forEach(e=>{if(!e.date)return;const m=new Date(e.date).getMonth();mBase[m]+=e.ciro;});
  const mTot=mBase.reduce((a,b)=>a+b,0)||1;
  const mW=mBase.map(v=>v/mTot);
  const MN=['Oca','Åub','Mar','Nis','May','Haz','Tem','AÄŸu','Eyl','Eki','Kas','Ara'];
  dc('fmonthly');
  CH.fmonthly=new Chart(document.getElementById('cForecastMonthly'),{type:'bar',data:{
    labels:MN,
    datasets:[
      {label:'2025 GerÃ§ek',data:mBase,backgroundColor:'rgba(59,130,246,.35)',borderRadius:4,order:2},
      {label:'2026 Normal Tahmin',data:mW.map(w=>w*norm.ciro),backgroundColor:'rgba(16,185,129,.55)',borderRadius:4,order:2},
      {label:'2026 Ä°yimser',type:'line',data:mW.map(w=>w*opti.ciro),borderColor:'#22d3ee',borderWidth:2,pointRadius:3,tension:.4,order:1,fill:false},
    ]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  document.getElementById('forecast-assumptions').innerHTML=`
    <div style="line-height:2;font-size:12px;color:var(--t2)">
      <div>â€¢ Ciro bÃ¼yÃ¼me hÄ±zÄ±: <span class="highlight">%${(ciroGr*100).toFixed(1)}</span> (2024â†’2025 geÃ§miÅŸ verisi)</div>
      <div>â€¢ Gider artÄ±ÅŸ hÄ±zÄ±: <span class="highlight-a">%${(giderGr*100).toFixed(1)}</span> (2024â†’2025 geÃ§miÅŸ verisi)</div>
      <div>â€¢ Sezonalite daÄŸÄ±lÄ±mÄ± 2025 aylÄ±k verilerinden tÃ¼retildi</div>
      <div>â€¢ Åehir bÃ¼yÃ¼me oranlarÄ± mÃ¼nferiden hesaplandÄ±</div>
      <div>â€¢ Model; dÃ¶viz ÅŸoklarÄ± ve siyasi belirsizlikleri kapsamamaktadÄ±r</div>
    </div>`;
  document.getElementById('forecast-risks').innerHTML=`
    <div style="line-height:2;font-size:12px;color:var(--t2)">
      <div>${giderGr>ciroGr?'âš ï¸ Gider artÄ±ÅŸÄ± ciro bÃ¼yÃ¼mesini <span class="highlight-r">aÅŸÄ±yor</span> â€” maliyet kontrolÃ¼ kritik':'âœ… Gider artÄ±ÅŸÄ± ciro bÃ¼yÃ¼mesinin <span class="highlight-g">altÄ±nda</span> â€” saÄŸlÄ±klÄ± yapÄ±'}</div>
      <div>ğŸ¯ En bÃ¼yÃ¼k fÄ±rsat: <span class="highlight-g">Ä°stanbul ve Antalya</span> portfÃ¶yÃ¼nÃ¼ geniÅŸletmek</div>
      <div>ğŸ“‰ Risk: DÃ¼ÅŸÃ¼k katÄ±lÄ±mlÄ± etkinliklerde yÃ¼ksek sabit gider yÃ¼kÃ¼</div>
      <div>ğŸ’¡ Ã–neri: YÃ¼ksek ROI'li ÅŸehirlere aÄŸÄ±rlÄ±k ver, ajans maliyetini %10 kÄ±s</div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI SCORE ENGINE â€” KatÄ±l / KatÄ±lma Karar Sistemi
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AI_W={roi:0.30,participants:0.20,city:0.15,weather:0.10,agency:0.10,brand:0.15};
const FM={
  roi:{name:'GeÃ§miÅŸ ROI',icon:'ğŸ“ˆ',wlbl:'%30',col:'var(--green)'},
  participants:{name:'KatÄ±lÄ±mcÄ± SayÄ±sÄ±',icon:'ğŸ‘¥',wlbl:'%20',col:'var(--blue2)'},
  city:{name:'Åehir PerformansÄ±',icon:'ğŸ™',wlbl:'%15',col:'var(--violet)'},
  weather:{name:'Hava KoÅŸulu',icon:'ğŸŒ¤',wlbl:'%10',col:'var(--cyan)'},
  agency:{name:'Ajans Maliyeti',icon:'ğŸ’¼',wlbl:'%10',col:'var(--amber)'},
  brand:{name:'Marka GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼',icon:'â­',wlbl:'%15',col:'var(--rose)'},
};

function computeAiScores(){
  const evs=DB.map(e=>({...e,...calc(e)}));
  if(!evs.length)return[];

  // City avg roi
  const cityR={};
  evs.forEach(e=>{if(!cityR[e.city])cityR[e.city]=[];if(e.gider>0)cityR[e.city].push(e.roi);});
  const cityAvg={};
  Object.entries(cityR).forEach(([c,arr])=>{cityAvg[c]=arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;});

  const rois=evs.filter(e=>e.gider>0).map(e=>e.roi);
  const parts=evs.filter(e=>e.participants>0).map(e=>e.participants);
  const agencies=evs.filter(e=>e.agency>0).map(e=>e.agency);
  const maxRoi=Math.max(...rois,1);const minRoi=Math.min(...rois,0);
  const maxParts=Math.max(...parts,1);
  const maxAgency=Math.max(...agencies,1);
  const roiRange=maxRoi-minRoi||1;

  const cityVals=Object.values(cityAvg);
  const maxCity=Math.max(...cityVals,1);const minCity=Math.min(...cityVals,0);
  const cityRange=maxCity-minCity||1;

  return evs.map(e=>{
    const roiScore=e.gider>0?Math.min(100,Math.max(0,((e.roi-minRoi)/roiRange)*100)):25;
    const partScore=e.participants>0?Math.min(100,(Math.log(e.participants)/Math.log(maxParts))*100):20;
    const cAvg=cityAvg[e.city]||0;
    const cityScore=Math.min(100,Math.max(0,((cAvg-minCity)/cityRange)*100));
    const wx=parseWx(e.weather);
    let wxScore=50;
    if(wx.cond){const c=wx.cond.toLowerCase();if(c.includes('gÃ¼neÅŸ')||c.includes('aÃ§Ä±k'))wxScore=88;else if(c.includes('bulut'))wxScore=60;else if(c.includes('yaÄŸmur')||c.includes('fÄ±rtÄ±na'))wxScore=22;}
    const agencyScore=e.agency>0?Math.min(100,Math.max(0,(1-(e.agency/maxAgency))*100)):68;
    const brandBase=e.participants>0&&e.ciro>0?e.ciro/e.participants:0;
    const maxBrand=evs.filter(x=>x.participants>0&&x.ciro>0).reduce((a,x)=>Math.max(a,x.ciro/x.participants),1);
    const brandScore=Math.min(100,brandBase>0?(brandBase/maxBrand)*100:28);

    const comps={roi:roiScore,participants:partScore,city:cityScore,weather:wxScore,agency:agencyScore,brand:brandScore};
    const total=Object.entries(comps).reduce((sum,[k,v])=>sum+v*AI_W[k],0);
    const sorted=Object.entries(comps).sort((a,b)=>b[1]-a[1]);
    return{...e,aiScore:Math.round(total),comps,topFactor:sorted[0][0],botFactor:sorted[sorted.length-1][0]};
  });
}

function getRec(score){
  if(score>=80)return{cls:'rec-go',txt:'âœ… Kesin KatÄ±l',col:'var(--green)'};
  if(score>=60)return{cls:'rec-cond',txt:'âš¡ ÅartlÄ± KatÄ±l',col:'var(--blue2)'};
  if(score>=40)return{cls:'rec-risk',txt:'âš ï¸ Riskli',col:'var(--amber)'};
  return{cls:'rec-no',txt:'ğŸš« KatÄ±lma',col:'var(--rose)'};
}

function renderAiScore(){
  const scored=computeAiScores();
  if(!scored.length)return;

  // Populate year filter
  const yrs=[...new Set(scored.map(e=>e.year))].sort((a,b)=>b-a);
  const ayf=document.getElementById('ai-year-filter');
  const cur=ayf.value;
  ayf.innerHTML='<option value="all">TÃ¼m YÄ±llar</option>'+yrs.map(y=>`<option value="${y}"${String(y)===cur?' selected':''}>${y}</option>`).join('');

  // Weight grid
  document.getElementById('ai-weights-grid').innerHTML=Object.entries(FM).map(([k,m])=>`
    <div class="weight-item">
      <div class="weight-icon">${m.icon}</div>
      <div class="weight-pct" style="color:${m.col}">${m.wlbl}</div>
      <div class="weight-name">${m.name}</div>
    </div>`).join('');

  // KPI row
  const goC=scored.filter(e=>e.aiScore>=80).length;
  const condC=scored.filter(e=>e.aiScore>=60&&e.aiScore<80).length;
  const riskC=scored.filter(e=>e.aiScore>=40&&e.aiScore<60).length;
  const noC=scored.filter(e=>e.aiScore<40).length;
  const avg=scored.reduce((a,b)=>a+b.aiScore,0)/scored.length;
  const topEv=[...scored].sort((a,b)=>b.aiScore-a.aiScore)[0];
  document.getElementById('ai-kpi-row').innerHTML=`
    <div class="kc gn"><div class="kl">Ortalama AI Skoru</div><div class="kv">${avg.toFixed(0)}<span style="font-size:13px">/100</span></div><div class="ks">${scored.length} etkinlik analiz edildi</div></div>
    <div class="kc bl"><div class="kl">âœ… Kesin KatÄ±l</div><div class="kv" style="color:var(--green)">${goC}</div><div class="ks">Skor â‰¥ 80</div></div>
    <div class="kc am"><div class="kl">âš¡ ÅartlÄ± / âš ï¸ Riskli</div><div class="kv" style="color:var(--amber)">${condC+riskC}</div><div class="ks">Skor 40â€“80</div></div>
    <div class="kc ro"><div class="kl">ğŸš« KatÄ±lma</div><div class="kv" style="color:var(--rose)">${noC}</div><div class="ks">Skor &lt; 40</div></div>`;

  // Exec summary
  const cityS={};
  scored.forEach(e=>{if(!cityS[e.city])cityS[e.city]=[];cityS[e.city].push(e.aiScore);});
  const topCity=Object.entries(cityS).map(([c,arr])=>({c,avg:arr.reduce((a,b)=>a+b,0)/arr.length})).sort((a,b)=>b.avg-a.avg)[0];
  const botMap={};scored.forEach(e=>{botMap[e.botFactor]=(botMap[e.botFactor]||0)+1;});
  const botKey=Object.entries(botMap).sort((a,b)=>b[1]-a[1])[0]?.[0]||'roi';
  document.getElementById('ai-exec-summary').innerHTML=`
    <div class="exec-summary-title">ğŸ¤– AI Analiz Ã–zeti â€” YÃ¶netici Raporu</div>
    <div class="exec-bullet">PortfÃ¶yÃ¼n <span class="highlight-g">%${((goC/scored.length)*100).toFixed(0)}'Ä±</span> "Kesin KatÄ±l" eÅŸiÄŸini geÃ§mekte, <span class="highlight-r">%${((noC/scored.length)*100).toFixed(0)}'Ä±</span> ise "KatÄ±lma" bÃ¶lgesinde kalmaktadÄ±r.</div>
    <div class="exec-bullet">En yÃ¼ksek AI skoru: <span class="highlight">${topEv.name}</span> â€” Skor: <span class="highlight-g">${topEv.aiScore}/100</span>. ${getRec(topEv.aiScore).txt}</div>
    <div class="exec-bullet">Stratejik Ã¶ncelikli ÅŸehir: <span class="highlight">${topCity?.c||'â€”'}</span> (Ort. Skor: <span class="highlight-g">${topCity?.avg.toFixed(0)||'â€”'}/100</span>). Bu ÅŸehirde etkinlik sayÄ±sÄ±nÄ± artÄ±rmanÄ±z tavsiye edilir.</div>
    <div class="exec-bullet">Skoru en Ã§ok dÃ¼ÅŸÃ¼ren faktÃ¶r: <span class="highlight-r">${FM[botKey]?.icon} ${FM[botKey]?.name}</span> (${botMap[botKey]} etkinlikte zayÄ±f halka). Bu alanda aksiyon alÄ±nmasÄ± ROI'yi doÄŸrudan iyileÅŸtirecektir.</div>`;

  // Score distribution chart (top 14)
  const top14=[...scored].sort((a,b)=>b.aiScore-a.aiScore).slice(0,14);
  dc('aiDist');
  CH.aiDist=new Chart(document.getElementById('cAiScoreDist'),{type:'bar',data:{
    labels:top14.map(e=>e.name.substring(0,13)+(e.name.length>13?'â€¦':'')),
    datasets:[{label:'AI Skor',data:top14.map(e=>e.aiScore),
      backgroundColor:top14.map(e=>e.aiScore>=80?'rgba(16,185,129,.75)':e.aiScore>=60?'rgba(59,130,246,.75)':e.aiScore>=40?'rgba(245,158,11,.75)':'rgba(244,63,94,.75)'),
      borderRadius:5}]
  },options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),max:100},y:AX()}}});

  // Factor radar
  const factorAvg=Object.keys(AI_W).map(k=>({k,avg:scored.reduce((a,e)=>a+e.comps[k],0)/scored.length}));
  dc('aiFactors');
  CH.aiFactors=new Chart(document.getElementById('cAiFactors'),{type:'radar',data:{
    labels:factorAvg.map(f=>FM[f.k].icon+' '+FM[f.k].name),
    datasets:[{label:'Ort. FaktÃ¶r Skoru',data:factorAvg.map(f=>f.avg),
      backgroundColor:'rgba(59,130,246,.12)',borderColor:'var(--blue)',borderWidth:2,
      pointBackgroundColor:factorAvg.map(f=>FM[f.k].col),pointRadius:5}]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},
    scales:{r:{min:0,max:100,ticks:{color:'#4d6080',font:{family:'DM Mono',size:9},stepSize:25},
      grid:{color:'rgba(59,130,246,.08)'},
      pointLabels:{color:'#8da0bf',font:{family:'DM Sans',size:11}}}}}});

  // City strategy grid
  document.getElementById('ai-city-grid').innerHTML=Object.entries(cityS)
    .map(([c,arr])=>({c,avg:arr.reduce((a,b)=>a+b,0)/arr.length,count:arr.length}))
    .sort((a,b)=>b.avg-a.avg)
    .map(({c,avg,count})=>{
      const col=avg>=70?'var(--green)':avg>=55?'var(--blue2)':avg>=40?'var(--amber)':'var(--rose)';
      const strat=avg>=70?'ğŸš€ Ã–ncelikli BÃ¼yÃ¼t':avg>=55?'âœ… SÃ¼rdÃ¼r & GeliÅŸtir':avg>=40?'âš¡ Potansiyel Var':'âš ï¸ Risk DeÄŸerlendirmesi';
      return`<div class="city-strat-card">
        <div class="city-strat-name">${c}</div>
        <div class="city-strat-score">${count} etkinlik</div>
        <div style="font-size:22px;font-family:'Syne',sans-serif;font-weight:800;color:${col};margin-top:6px">${avg.toFixed(0)}<span style="font-size:12px">/100</span></div>
        <div style="font-size:10px;color:${col};font-family:'DM Mono',monospace;margin-top:3px">${strat}</div>
        <div class="city-strat-bar"><div style="width:${avg}%;height:100%;background:${col};border-radius:2px"></div></div>
      </div>`;
    }).join('');

  // Cost tips
  const highAg=[...scored].filter(e=>e.agency>0&&e.comps.agency<40).sort((a,b)=>a.comps.agency-b.comps.agency).slice(0,4);
  const lowS=[...scored].filter(e=>e.aiScore<60).sort((a,b)=>a.aiScore-b.aiScore).slice(0,4);
  document.getElementById('ai-cost-tips').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div style="background:var(--bg3);border-radius:9px;padding:14px;border:1px solid rgba(245,158,11,.2)">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:1px;margin-bottom:10px">ğŸ”§ YÃœKSEK AJANS MALÄ°YETÄ°</div>
        ${highAg.length?highAg.map(e=>`<div style="margin-bottom:8px"><div style="font-size:12px;font-weight:600;color:var(--t1)">${e.name.substring(0,22)}</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--rose)">${fc(e.agency||0)} ajans gideri</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t3)">%10 azalÄ±rsa â‰ˆ +${(AI_W.agency*10).toFixed(0)} puan</div></div>`).join(''):'<div style="font-size:12px;color:var(--t3)">Veri yok</div>'}
      </div>
      <div style="background:var(--bg3);border-radius:9px;padding:14px;border:1px solid rgba(59,130,246,.2)">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue2);letter-spacing:1px;margin-bottom:10px">ğŸ“Š SKOR GELÄ°ÅTÄ°RME FIRSATI</div>
        ${lowS.length?lowS.map(e=>{const bot=Object.entries(e.comps).sort((a,b)=>a[1]-b[1])[0];return`<div style="margin-bottom:8px"><div style="font-size:12px;font-weight:600;color:var(--t1)">${e.name.substring(0,22)}</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--amber)">Skor: ${e.aiScore}/100</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t3)">${FM[bot[0]]?.icon} ${FM[bot[0]]?.name} iyileÅŸtir</div></div>`;}).join(''):'<div style="font-size:12px;color:var(--t3)">Veri yok</div>'}
      </div>
      <div style="background:var(--bg3);border-radius:9px;padding:14px;border:1px solid rgba(16,185,129,.2)">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--green);letter-spacing:1px;margin-bottom:10px">âœ… STRATEJÄ°K Ã–NERÄ°LER</div>
        <div style="font-size:12px;color:var(--t2);line-height:2">
          <div>â†’ Ajans maliyeti %10 azalÄ±rsa ort. skor <span style="color:var(--green)">+${(AI_W.agency*10).toFixed(0)} puan</span></div>
          <div>â†’ GÃ¼neÅŸli havada ROI, yaÄŸmurluya gÃ¶re <span style="color:var(--green)">2x yÃ¼ksek</span></div>
          <div>â†’ 1,000+ katÄ±lÄ±mcÄ± eÅŸiÄŸi skor iÃ§in kritik</div>
          <div>â†’ ${topCity?.c||'â€”'} portfÃ¶yÃ¼nÃ¼ bÃ¼yÃ¼t</div>
        </div>
      </div>
    </div>`;

  renderAiTable();
}

function renderAiTable(){
  const scored=computeAiScores();
  const yr=document.getElementById('ai-year-filter').value;
  const srt=document.getElementById('ai-sort').value;
  let rows=yr==='all'?[...scored]:[...scored].filter(e=>String(e.year)===yr);
  if(srt==='score')rows.sort((a,b)=>b.aiScore-a.aiScore);
  else if(srt==='roi')rows.sort((a,b)=>b.roi-a.roi);
  else rows.sort((a,b)=>a.name.localeCompare(b.name,'tr'));
  document.getElementById('ai-score-list').innerHTML=rows.map(e=>{
    const rec=getRec(e.aiScore);
    const col=rec.col;
    const bars=Object.entries(e.comps).map(([k,v])=>`
      <div style="display:flex;align-items:center;gap:5px;margin-bottom:3px">
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);min-width:80px">${FM[k].icon} ${FM[k].name.substring(0,10)}</span>
        <div style="flex:1;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden"><div style="width:${v}%;height:100%;background:${FM[k].col};border-radius:2px"></div></div>
        <span style="font-family:'DM Mono',monospace;font-size:9px;min-width:22px;text-align:right;color:${FM[k].col}">${Math.round(v)}</span>
      </div>`).join('');
    return`<div style="display:flex;align-items:flex-start;gap:13px;padding:13px 17px;border-bottom:1px solid var(--b1);transition:background .13s;cursor:pointer" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background=''">
      <div style="width:56px;height:56px;border-radius:50%;border:3px solid ${col};display:flex;align-items:center;justify-content:center;flex-shrink:0;background:rgba(0,0,0,.15)">
        <span style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:${col}">${e.aiScore}</span>
      </div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:5px">
          <span style="font-size:14px;font-weight:600;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px" title="${e.name}">${e.name}</span>
          <span class="rec-badge ${rec.cls}">${rec.txt}</span>
          <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t3)">${e.city} Â· ${e.year}</span>
        </div>
        <div style="font-size:11px;color:var(--t3);font-family:'DM Mono',monospace;margin-bottom:8px">
          ROI: <span style="color:${e.roi>=0?'var(--green)':'var(--rose)'}">${e.gider>0?e.roi.toFixed(0)+'%':'â€”'}</span>&nbsp;Â·&nbsp;
          KatÄ±lÄ±mcÄ±: <span style="color:var(--t2)">${e.participants>0?fn(e.participants):'â€”'}</span>&nbsp;Â·&nbsp;
          Net Kar: <span style="color:${e.kar>=0?'var(--green)':'var(--rose)'}">${fc(e.kar)}</span>&nbsp;Â·&nbsp;
          ğŸ’ª GÃ¼Ã§lÃ¼: <span style="color:${FM[e.topFactor].col}">${FM[e.topFactor].icon} ${FM[e.topFactor].name}</span>
        </div>
        <div>${bars}</div>
      </div>
    </div>`;
  }).join('');
}

</script>

<!-- DETAIL MODAL -->
<div class="mo" id="modal-detail" onclick="moBg(event,'modal-detail')">
  <div class="md">
    <div class="mt">
      <span id="m-name" style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Detay</span>
      <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
        <button class="btn bsh" style="font-size:11px;padding:5px 10px" onclick="shareFromDetail()">â¬† PaylaÅŸ</button>
        <button class="btn bg2" style="font-size:11px;padding:5px 10px" onclick="editFromDetail()">âœ DÃ¼zenle</button>
        <span class="mc" onclick="closeModal('modal-detail')">âœ•</span>
      </div>
    </div>
    <div id="m-body"></div>
    <div class="modal-acts">
      <button class="btn bd" onclick="delFromDetail()">ğŸ—‘ Sil</button>
      <button class="btn bsh" onclick="shareFromDetail()">â¬† KartÄ± PaylaÅŸ</button>
      <button class="btn bg2" onclick="editFromDetail()">âœ DÃ¼zenle</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="mo" id="modal-edit" onclick="moBg(event,'modal-edit')">
  <div class="edit-md">
    <div class="mt">
      <span>EtkinliÄŸi DÃ¼zenle</span>
      <span class="mc" onclick="closeModal('modal-edit')">âœ•</span>
    </div>
    <input type="hidden" id="edit-id">
    <div class="fd">â€” Etkinlik Bilgileri</div>
    <div class="fg3">
      <div class="fg"><label class="fl">Etkinlik AdÄ± *</label><input class="fi" id="e-name" placeholder="Etkinlik adÄ±"></div>
      <div class="fg"><label class="fl">Tarih</label><input type="date" class="fi" id="e-date" onchange="onEditDate()"></div>
      <div class="fg"><label class="fl">Åehir</label><input class="fi" id="e-city" list="city-dl"></div>
    </div>
    <div class="fg3">
      <div class="fg"><label class="fl">YÄ±l</label><select class="fi" id="e-year"></select></div>
      <div class="fg"><label class="fl">KatÄ±lÄ±mcÄ± SayÄ±sÄ±</label><input type="number" class="fi" id="e-kat" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Ã‡adÄ±r SayÄ±sÄ±</label><input type="number" class="fi" id="e-cadir"></div>
    </div>
    <div class="fd">â€” Gider Kalemleri</div>
    <div class="fg4">
      <div class="fg"><label class="fl">Ajans Bedeli (â‚º)</label><input type="number" class="fi" id="e-ajans" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Personel Gideri (â‚º)</label><input type="number" class="fi" id="e-per" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Stand Maliyeti (â‚º)</label><input type="number" class="fi" id="e-stand" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Barter (â‚º)</label><input type="number" class="fi" id="e-barter" oninput="calcEP()"></div>
    </div>
    <div class="fd">â€” Ciro Kalemleri</div>
    <div class="fg2">
      <div class="fg"><label class="fl">Ã‡ek Ciro (â‚º)</label><input type="number" class="fi" id="e-cek" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Ã‡adÄ±r Ciro (â‚º)</label><input type="number" class="fi" id="e-cciro" oninput="calcEP()"></div>
    </div>
    <div class="fd">â€” AnlÄ±k Hesaplama</div>
    <div class="edit-pvs">
      <div class="pvi"><div class="pvl">Ciro</div><div class="pvv cb" id="ep-ciro">â‚º0</div></div>
      <div class="pvi"><div class="pvl">Gider</div><div class="pvv ca" id="ep-gider">â‚º0</div></div>
      <div class="pvi"><div class="pvl">Net Kar</div><div class="pvv cg" id="ep-kar">â‚º0</div></div>
      <div class="pvi"><div class="pvl">Kar MarjÄ±</div><div class="pvv cb" id="ep-margin">â€”</div></div>
      <div class="pvi"><div class="pvl">ROI</div><div class="pvv cg" id="ep-roi">â€”</div></div>
      <div class="pvi"><div class="pvl">Kat.BaÅŸÄ± Ciro</div><div class="pvv cb" id="ep-pciro">â€”</div></div>
      <div class="pvi"><div class="pvl">Kat.BaÅŸÄ± Mlt.</div><div class="pvv ca" id="ep-pgdr">â€”</div></div>
    </div>
    <div class="fd">â€” Hava Durumu</div>
    <div style="margin-bottom:14px">
      <textarea class="fi" id="e-wx" rows="3" style="resize:vertical;font-family:'DM Mono',monospace;font-size:11px" placeholder="SÄ±caklÄ±k: 22Â°C&#10;Durum: GÃ¼neÅŸli&#10;RÃ¼zgar: 15 km/h"></textarea>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
      <button class="btn bs" onclick="closeModal('modal-edit')">Ä°ptal</button>
      <button class="btn bp" onclick="saveEdit()">âœ“ GÃ¼ncelle</button>
    </div>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="mo" id="modal-share" onclick="moBg(event,'modal-share')">
  <div class="share-md">
    <div class="sc" id="share-card-vis">
      <div class="sc-brand">
        <div class="sc-bname">SPX<span style="color:var(--blue)">.</span></div>
        <div class="sc-btag">Event Report</div>
      </div>
      <div class="sc-title" id="sct">â€”</div>
      <div class="sc-meta">
        <span>ğŸ“… <span id="scd">â€”</span></span>
        <span>ğŸ“ <span id="scc">â€”</span></span>
        <span>ğŸ‘¥ <span id="scp">â€”</span></span>
      </div>
      <div class="sc-kpis">
        <div class="sc-kpi"><div class="sc-kpi-lbl">Toplam Ciro</div><div class="sc-kpi-val" id="sc-ciro" style="color:var(--blue2)">â‚º0</div><div class="sc-kpi-sub" id="sc-ciro-s">â€”</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Net Kar</div><div class="sc-kpi-val" id="sc-kar">â‚º0</div><div class="sc-kpi-sub" id="sc-kar-s">â€”</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">ROI</div><div class="sc-kpi-val" id="sc-roi" style="color:var(--cyan)">â€”</div><div class="sc-kpi-sub">YatÄ±rÄ±m getirisi</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Kar MarjÄ±</div><div class="sc-kpi-val" id="sc-margin">â€”</div><div class="sc-kpi-sub">Gelirden kar payÄ±</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Toplam Gider</div><div class="sc-kpi-val" id="sc-gider" style="color:var(--amber)">â‚º0</div><div class="sc-kpi-sub" id="sc-gider-s">â€”</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Kat. BaÅŸÄ± Ciro</div><div class="sc-kpi-val" id="sc-pciro" style="color:var(--violet)">â€”</div><div class="sc-kpi-sub" id="sc-pciro-s">â€”</div></div>
      </div>
      <div id="sc-wx-wrap" style="display:none"><div class="sc-wx" id="sc-wx-txt">â€”</div></div>
      <div class="sc-foot">
        <div class="sc-perf"><span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px">PERFORMANS</span><div class="sc-pbw"><div class="sc-pb" id="sc-pb"></div></div><span style="font-family:'DM Mono',monospace;font-size:10px" id="sc-pl">â€”</span></div>
        <div class="sc-dtag" id="sc-yr">â€”</div>
      </div>
    </div>
    <div class="share-acts">
      <div class="share-acts-ttl">PaylaÅŸÄ±m SeÃ§enekleri</div>
      <div class="share-btns">
        <button class="btn bp" style="font-size:11px" onclick="copyLink()">ğŸ”— BaÄŸlantÄ±yÄ± Kopyala</button>
        <button class="btn bs" style="font-size:11px" onclick="copyText()">ğŸ“‹ Metni Kopyala</button>
        <button class="btn bg2" style="font-size:11px" onclick="shareWA()">ğŸ’¬ WhatsApp</button>
        <span class="copy-ok" id="copy-ok">âœ“ KopyalandÄ±!</span>
      </div>
      <div class="share-link" id="share-link-box">â€”</div>
      <div style="display:flex;justify-content:flex-end;margin-top:9px">
        <button class="btn bs" style="font-size:11px" onclick="closeModal('modal-share')">Kapat</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
