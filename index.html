<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SPX Event Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  /* Dark theme (default) */
  --bg0:#060a12;--bg1:#0b1120;--bg2:#111827;--bg3:#1a2438;--bg4:#1e2d45;
  --blue:#3b82f6;--blue2:#60a5fa;--cyan:#22d3ee;
  --green:#10b981;--amber:#f59e0b;--rose:#f43f5e;--violet:#8b5cf6;
  --t1:#f0f4ff;--t2:#8da0bf;--t3:#4d6080;
  --b1:rgba(59,130,246,.12);--b2:rgba(59,130,246,.3);--grid:rgba(59,130,246,.05);
  --sb:220px;--r:12px;
  --shadow:0 2px 12px rgba(0,0,0,.35);
  --inp-bg:#1a2438;
}

/* ‚îÄ‚îÄ LIGHT THEME ‚îÄ‚îÄ */
body.light{
  --bg0:#f0f2f8;--bg1:#e8eaf2;--bg2:#ffffff;--bg3:#f4f6fc;--bg4:#eaecf7;
  --t1:#0f172a;--t2:#475569;--t3:#94a3b8;
  --b1:rgba(59,130,246,.15);--b2:rgba(59,130,246,.35);--grid:rgba(59,130,246,.07);
  --shadow:0 2px 12px rgba(0,0,0,.08);
  --inp-bg:#f4f6fc;
  /* Keep accent colors same for both themes */
}
body.light body::before{opacity:.5;}
body.light .sb{box-shadow:2px 0 16px rgba(0,0,0,.06);}
body.light .topbar{background:#f0f2f8;}
body.light .mob-bar{background:#f0f2f8;}
body.light .toast{box-shadow:0 4px 16px rgba(0,0,0,.1);}
body.light table thead tr{background:var(--bg3);}
body.light .kc{box-shadow:var(--shadow);}
body.light .cc{box-shadow:var(--shadow);}
body.light .tc{box-shadow:var(--shadow);}
body.light .fc2{box-shadow:var(--shadow);}
body.light .cal-box{box-shadow:var(--shadow);}
body.light .cal-list{box-shadow:var(--shadow);}
body.light .insight-box{box-shadow:var(--shadow);}
body.light .exec-summary{background:rgba(59,130,246,.05);border-color:rgba(59,130,246,.2);}
body.light .share-card,.body.light .sc{background:linear-gradient(135deg,#1a237e 0%,#283593 50%,#1a237e 100%);}
body.light .md,.body.light .edit-md,.body.light .share-md,.body.light .cal-edit-modal{background:#fff;}
body.light .fi,.body.light .flt,.body.light .si,.body.light .ui{background:var(--inp-bg);}
body.light .wx-box{background:var(--bg3);}
body.light .wx-pr{background:rgba(59,130,246,.05);}
body.light .pvs{background:var(--bg3);}
body.light .yr-banner{background:rgba(59,130,246,.06);}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg0);color:var(--t1);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
.shell{position:relative;z-index:1;display:flex;min-height:100vh;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sb{width:var(--sb);height:100vh;height:100dvh;background:var(--bg2);border-right:1px solid var(--b1);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:400;transition:transform .28s cubic-bezier(.4,0,.2,1);overflow:hidden;}
.sb-logo{padding:18px 18px 16px;border-bottom:1px solid var(--b1);}
.lm{font-family:'Syne',sans-serif;font-weight:800;font-size:21px;letter-spacing:-.5px;}
.ls{font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.sb-nav{padding:14px 0;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;}
.nl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:2px;text-transform:uppercase;padding:0 16px;margin:10px 0 5px;}
.ni{display:flex;align-items:center;gap:9px;padding:9px 16px;cursor:pointer;transition:all .16s;color:var(--t2);font-size:13px;border-left:2px solid transparent;user-select:none;}
.ni:hover{background:var(--bg3);color:var(--t1);}
.ni.active{background:rgba(59,130,246,.11);color:var(--blue2);border-left-color:var(--blue);}
.nx{font-size:14px;width:18px;text-align:center;flex-shrink:0;}
.sb-foot{padding:13px 16px;border-top:1px solid var(--b1);}
.ull{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;}
.ui{width:100%;background:var(--bg3);border:1px solid var(--b1);color:var(--t1);padding:7px 10px;border-radius:7px;font-size:11px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .2s;}
.ui:focus{border-color:var(--b2);}
.ui::placeholder{color:var(--t3);}
.sb-st{margin-top:9px;font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);line-height:1.9;}
.dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:4px;animation:pulse 2s infinite;}
.dot-g{background:var(--green);box-shadow:0 0 5px var(--green);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
.mob-bar{display:none;position:fixed;top:0;left:0;right:0;z-index:190;background:var(--bg1);border-bottom:1px solid var(--b1);padding:0 14px;height:54px;align-items:center;justify-content:space-between;}
.mob-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;}
.hb{width:36px;height:36px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;cursor:pointer;background:var(--bg3);border-radius:7px;border:1px solid var(--b1);}
.hb span{width:18px;height:2px;background:var(--t2);border-radius:2px;transition:all .22s;}
.hb.open span:nth-child(1){transform:translateY(7px) rotate(45deg);}
.hb.open span:nth-child(2){opacity:0;}
.hb.open span:nth-child(3){transform:translateY(-7px) rotate(-45deg);}
.sb-ov{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.58);z-index:350;cursor:pointer;}
.sb-ov.open{display:block;}
/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{margin-left:var(--sb);flex:1;min-width:0;}
.topbar{background:rgba(11,17,32,.98);border-bottom:1px solid var(--b1);padding:12px 26px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;gap:8px;flex-wrap:wrap;}
.pt{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;white-space:nowrap;}
.tr{display:flex;gap:7px;align-items:center;flex-wrap:wrap;}
.flt{background:var(--bg3);border:1px solid var(--b1);color:var(--t2);padding:7px 10px;border-radius:7px;font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;outline:none;transition:border-color .2s;}
.flt:hover,.flt:focus{border-color:var(--b2);}
.btn{padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .18s;border:none;white-space:nowrap;}
.bp{background:var(--blue);color:#fff;}.bp:hover{background:var(--blue2);transform:translateY(-1px);}
.bs{background:var(--bg3);color:var(--t2);border:1px solid var(--b1);}.bs:hover{border-color:var(--b2);color:var(--t1);}
.bd{background:rgba(244,63,94,.11);color:var(--rose);border:1px solid rgba(244,63,94,.18);}.bd:hover{background:rgba(244,63,94,.2);}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{display:none;padding:22px 26px;}
.page.active{display:block;}
.sec-l{font-family:'DM Mono',monospace;font-size:10px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;}
.sec-t{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:18px;letter-spacing:-.5px;}

/* ‚îÄ‚îÄ KPI ‚îÄ‚îÄ */
.kg{display:grid;grid-template-columns:repeat(4,1fr);gap:13px;margin-bottom:14px;}
.kc{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:17px;position:relative;overflow:hidden;transition:border-color .18s;}
.kc:hover{border-color:var(--b2);}
.kc::after{content:'';position:absolute;top:0;right:0;width:54px;height:54px;border-radius:0 var(--r) 0 100%;opacity:.09;}
.bl::after{background:var(--blue)}.gn::after{background:var(--green)}.am::after{background:var(--amber)}.ro::after{background:var(--rose)}.vi::after{background:var(--violet)}.cy::after{background:var(--cyan)}
.kl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:7px;}
.kv{font-family:'Syne',sans-serif;font-size:24px;font-weight:700;line-height:1;margin-bottom:5px;}
.ks{font-size:11px;color:var(--t3);}
.bdg{display:inline-flex;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:600;font-family:'DM Mono',monospace;}
.bg{background:rgba(16,185,129,.13);color:var(--green);}
.br{background:rgba(244,63,94,.13);color:var(--rose);}
.bb{background:rgba(59,130,246,.13);color:var(--blue2);}

/* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
.cg32{display:grid;grid-template-columns:2fr 1fr;gap:13px;margin-bottom:14px;}
.cg2{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:14px;}
.cc{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:17px;}
.ch{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:13px;}
.ct{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.cs{font-size:11px;color:var(--t3);margin-top:2px;}
.cw{position:relative;height:215px;}
.cw.t{height:265px;}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.tc{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;margin-bottom:18px;}
.th{padding:13px 17px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--b1);flex-wrap:wrap;gap:7px;}
.tht{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.si{background:var(--bg3);border:1px solid var(--b1);color:var(--t1);padding:7px 11px;border-radius:7px;font-size:12px;font-family:'DM Sans',sans-serif;outline:none;width:185px;transition:border-color .2s;}
.si:focus{border-color:var(--b2);}
.si::placeholder{color:var(--t3);}
.tsc{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;min-width:860px;}
thead tr{background:var(--bg3);border-bottom:1px solid var(--b1);}
th{font-family:'DM Mono',monospace;font-size:9px;font-weight:500;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;padding:9px 12px;text-align:left;white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--b1);transition:background .13s;cursor:pointer;}
tbody tr:hover{background:var(--bg3);}
tbody tr:last-child{border-bottom:none;}
td{padding:8px 12px;font-size:12px;color:var(--t2);white-space:nowrap;}
td.nm{color:var(--t1);font-weight:500;max-width:185px;overflow:hidden;text-overflow:ellipsis;}
td.mo{font-family:'DM Mono',monospace;font-size:11px;}
td.pg{color:var(--green);}td.pr{color:var(--rose);}
.pl{display:inline-block;padding:2px 7px;border-radius:4px;font-family:'DM Mono',monospace;font-size:10px;font-weight:500;}
.ph{background:rgba(16,185,129,.13);color:var(--green);}
.pm{background:rgba(245,158,11,.13);color:var(--amber);}
.plo{background:rgba(244,63,94,.13);color:var(--rose);}
.pu{background:rgba(139,92,246,.13);color:var(--violet);}

/* Year group row */
.yr-row td{background:linear-gradient(90deg,rgba(59,130,246,.07),transparent);padding:9px 13px;color:var(--blue2);font-family:'Syne',sans-serif;font-weight:700;font-size:14px;border-bottom:1px solid var(--b1);border-top:2px solid var(--b2);letter-spacing:-.3px;}
.yr-stats{font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);font-weight:400;margin-left:10px;}

.del-btn{opacity:0;background:rgba(244,63,94,.11);border:none;color:var(--rose);width:22px;height:22px;border-radius:4px;cursor:pointer;font-size:11px;transition:all .18s;display:inline-flex;align-items:center;justify-content:center;}
tbody tr:hover .del-btn{opacity:1;}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.fc2{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:20px;margin-bottom:16px;}
.fd{font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin:15px 0 11px;padding:5px 0;border-top:1px solid var(--b1);border-bottom:1px solid var(--b1);}
.fg3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;}
.fg4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;}
.fg2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px;}
.fg{display:flex;flex-direction:column;gap:5px;}
.fl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;}
.fi{background:var(--bg3);border:1px solid var(--b1);color:var(--t1);padding:9px 12px;border-radius:8px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .18s,box-shadow .18s;width:100%;}
.fi:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.1);}
.fi::placeholder{color:var(--t3);}

/* Preview strip */
.pvs{display:grid;grid-template-columns:repeat(7,1fr);gap:9px;background:var(--bg3);border:1px solid var(--b1);border-radius:9px;padding:14px;margin-bottom:14px;}
.pvi{text-align:center;}
.pvl{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;}
.pvv{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;}
.cb{color:var(--blue2);}.cg{color:var(--green);}.ca{color:var(--amber);}.cr{color:var(--rose);}

/* New year banner */
.yr-banner{background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.22);border-radius:9px;padding:11px 14px;margin-bottom:12px;font-size:12px;color:var(--blue2);font-family:'DM Mono',monospace;display:none;}

/* Weather */
.wx-box{background:var(--bg3);border:1px solid var(--b1);border-radius:9px;padding:14px;margin-bottom:14px;}
.wx-pr{background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.13);border-radius:7px;padding:11px;font-family:'DM Mono',monospace;font-size:11px;color:var(--t2);line-height:1.7;margin-top:8px;white-space:pre-line;}

/* ‚îÄ‚îÄ ANALYSIS ‚îÄ‚îÄ */
.ig{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:18px;}
.ic{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:17px;}
.ih{display:flex;align-items:center;gap:9px;margin-bottom:12px;}
.ii{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;}
.ib{background:rgba(59,130,246,.13);}
.ig2{background:rgba(16,185,129,.13);}
.ia{background:rgba(245,158,11,.13);}
.ir2{background:rgba(244,63,94,.13);}
.it{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.ins-row{display:flex;align-items:center;padding:6px 0;border-bottom:1px solid var(--b1);font-size:12px;}
.ins-row:last-child{border-bottom:none;}
.irl{color:var(--t2);min-width:85px;}
.irbw{flex:1;margin:0 9px;height:3px;background:var(--bg3);border-radius:2px;}
.irb{height:100%;border-radius:2px;}
.irv{font-family:'DM Mono',monospace;font-size:11px;color:var(--t1);min-width:75px;text-align:right;}
.dg{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-top:13px;}
.dc2{border-radius:9px;padding:14px;}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.mo{display:none;position:fixed;inset:0;background:rgba(6,10,18,.92);z-index:300;align-items:center;justify-content:center;padding:14px;}
.mo.open{display:flex;}
.md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:22px;max-width:540px;width:100%;max-height:88vh;overflow-y:auto;}
.mt{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}
.mc{cursor:pointer;color:var(--t3);font-size:18px;transition:color .18s;line-height:1;}.mc:hover{color:var(--t1);}
.mg{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px;}
.mi{background:var(--bg3);border-radius:8px;padding:10px;}
.mil{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.miv{font-weight:600;color:var(--t1);font-size:13px;}
.mkr{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:11px;}
.mk{background:var(--bg3);border-radius:8px;padding:10px;text-align:center;}
.mkl{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.mkv{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--green);color:var(--green);padding:10px 16px;border-radius:8px;font-size:12px;font-family:'DM Mono',monospace;z-index:999;opacity:0;transform:translateY(14px);transition:all .26s;max-width:280px;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.err{border-color:var(--rose);color:var(--rose);}

.empty{text-align:center;padding:34px;color:var(--t3);font-size:12px;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg1);}
::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px;}

/* ‚ïê‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê‚ïê */
@media(max-width:1100px){
  .kg{grid-template-columns:repeat(2,1fr);}
  .cg32,.cg2{grid-template-columns:1fr;}
  .ig{grid-template-columns:1fr;}
  .dg{grid-template-columns:1fr;}
  .pvs{grid-template-columns:repeat(4,1fr);}
  .fg4{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:768px){
  :root{--sb:264px;}
  /* MOBILE SIDEBAR: full-height, scrollable, high z-index, NO backdrop-filter */
  .sb{
    transform:translateX(-100%);
    height:100%;
    height:100dvh;
    max-height:100vh;
    overflow-y:auto;
    overflow-x:hidden;
    -webkit-overflow-scrolling:touch;
    position:fixed;
    top:0;left:0;
    z-index:400;
  }
  .sb.open{transform:translateX(0);}
  /* Overlay starts after sidebar ‚Äî sidebar fully tappable */
  .sb-ov.open{left:var(--sb);}
  .mob-bar{display:flex;z-index:380;}
  .main{margin-left:0;padding-top:54px;}
  /* No backdrop-filter on topbar in mobile ‚Äî causes paint issues */
  .topbar{padding:9px 13px;top:54px;background:var(--bg1);}
  .page{padding:14px 13px;}
  .kg{grid-template-columns:repeat(2,1fr);gap:9px;}
  .kv{font-size:20px;}
  .fg3{grid-template-columns:repeat(2,1fr);}
  .fg2{grid-template-columns:1fr;}
  .pvs{grid-template-columns:repeat(3,1fr);}
  .mg{grid-template-columns:1fr;}
  .mkr{grid-template-columns:repeat(2,1fr);}
  .sec-t{font-size:18px;}
  .th{flex-direction:column;align-items:flex-start;}
  .si{width:100%;}
  .tr{width:100%;justify-content:flex-end;}
}
@media(max-width:480px){
  .kg{grid-template-columns:1fr 1fr;}
  .kv{font-size:17px;}
  .kc{padding:13px;}
  .fg3,.fg4{grid-template-columns:1fr;}
  .pvs{grid-template-columns:repeat(2,1fr);}
  .pvv{font-size:14px;}
}

/* Row action buttons */
.row-acts{display:flex;gap:4px;opacity:0;transition:opacity .15s;}
tbody tr:hover .row-acts{opacity:1;}
.rab{width:26px;height:26px;border-radius:5px;border:none;cursor:pointer;font-size:12px;display:inline-flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
.rab-e{background:rgba(59,130,246,.14);color:var(--blue2);}.rab-e:hover{background:rgba(59,130,246,.28);}
.rab-s{background:rgba(139,92,246,.14);color:var(--violet);}.rab-s:hover{background:rgba(139,92,246,.28);}
.rab-d{background:rgba(244,63,94,.14);color:var(--rose);}.rab-d:hover{background:rgba(244,63,94,.28);}

/* Modal base */
.mo{display:none;position:fixed;inset:0;background:rgba(6,10,18,.92);z-index:300;align-items:center;justify-content:center;padding:14px;}
.mo.open{display:flex;}
/* Detail modal */
.md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:22px;max-width:580px;width:100%;max-height:90vh;overflow-y:auto;}
/* Edit modal */
.edit-md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:22px;max-width:680px;width:100%;max-height:90vh;overflow-y:auto;}
.mt{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
.mc{cursor:pointer;color:var(--t3);font-size:18px;transition:color .18s;line-height:1;flex-shrink:0;}.mc:hover{color:var(--t1);}
.mg{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px;}
.mi{background:var(--bg3);border-radius:8px;padding:10px;}
.mil{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.miv{font-weight:600;color:var(--t1);font-size:13px;}
.mkr{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:11px;}
.mk{background:var(--bg3);border-radius:8px;padding:10px;text-align:center;}
.mkl{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.mkv{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.modal-acts{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:14px;border-top:1px solid var(--b1);flex-wrap:wrap;}

/* Share modal */
.share-md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:0;max-width:520px;width:100%;overflow:hidden;}
.sc{background:linear-gradient(135deg,#08142b 0%,#0d1f3c 50%,#07142a 100%);padding:26px;position:relative;overflow:hidden;border-bottom:1px solid var(--b1);}
.sc::before{content:'';position:absolute;top:-50px;right:-50px;width:220px;height:220px;background:radial-gradient(circle,rgba(59,130,246,.14) 0%,transparent 65%);pointer-events:none;}
.sc::after{content:'';position:absolute;bottom:-40px;left:-40px;width:180px;height:180px;background:radial-gradient(circle,rgba(16,185,129,.09) 0%,transparent 65%);pointer-events:none;}
.sc-brand{display:flex;align-items:center;gap:8px;margin-bottom:18px;}
.sc-bname{font-family:'Syne',sans-serif;font-weight:800;font-size:13px;color:var(--t1);}
.sc-btag{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:2px;text-transform:uppercase;margin-left:4px;}
.sc-title{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;color:var(--t1);margin-bottom:5px;letter-spacing:-.5px;line-height:1.2;position:relative;z-index:1;}
.sc-meta{font-family:'DM Mono',monospace;font-size:11px;color:var(--t3);margin-bottom:20px;display:flex;gap:14px;flex-wrap:wrap;position:relative;z-index:1;}
.sc-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;position:relative;z-index:1;}
.sc-kpi{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:9px;padding:11px;}
.sc-kpi-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.sc-kpi-val{font-family:'Syne',sans-serif;font-size:19px;font-weight:700;}
.sc-kpi-sub{font-size:10px;color:var(--t3);margin-top:2px;font-family:'DM Mono',monospace;}
.sc-foot{display:flex;align-items:center;justify-content:space-between;margin-top:15px;padding-top:13px;border-top:1px solid rgba(255,255,255,.06);position:relative;z-index:1;}
.sc-perf{display:flex;align-items:center;gap:8px;}
.sc-pbw{width:70px;height:4px;background:rgba(255,255,255,.08);border-radius:2px;}
.sc-pb{height:100%;border-radius:2px;}
.sc-dtag{font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);}
.sc-wx{background:rgba(34,211,238,.07);border:1px solid rgba(34,211,238,.15);border-radius:7px;padding:9px 12px;margin-top:11px;font-family:'DM Mono',monospace;font-size:11px;color:var(--cyan);position:relative;z-index:1;}
/* Share actions panel */
.share-acts{padding:16px 20px;}
.share-acts-ttl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:9px;}
.share-btns{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:10px;}
.share-link{background:var(--bg3);border:1px solid var(--b1);border-radius:8px;padding:8px 11px;font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);word-break:break-all;line-height:1.5;max-height:52px;overflow:hidden;}
.copy-ok{display:inline-flex;align-items:center;gap:4px;font-family:'DM Mono',monospace;font-size:11px;color:var(--green);opacity:0;transition:opacity .3s;margin-left:6px;}
.copy-ok.show{opacity:1;}

/* Button variants */
.bg2{background:rgba(16,185,129,.11);color:var(--green);border:1px solid rgba(16,185,129,.2);}.bg2:hover{background:rgba(16,185,129,.22);}
.bsh{background:rgba(139,92,246,.11);color:var(--violet);border:1px solid rgba(139,92,246,.2);}.bsh:hover{background:rgba(139,92,246,.22);}

/* Edit preview */
.edit-pvs{display:grid;grid-template-columns:repeat(7,1fr);gap:9px;background:var(--bg3);border:1px solid var(--b1);border-radius:9px;padding:13px;margin-bottom:13px;}

@media(max-width:768px){
  .sc-kpis{grid-template-columns:repeat(2,1fr);}
  .sc-title{font-size:17px;}
  .mg{grid-template-columns:1fr;}
  .mkr{grid-template-columns:1fr 1fr;}
}
@media(max-width:480px){.sc-kpis{grid-template-columns:1fr 1fr;}}


/* ‚îÄ‚îÄ‚îÄ FORECAST & AI SCORE PAGES ‚îÄ‚îÄ‚îÄ */
.sc3{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-bottom:16px;}
.sc4{display:grid;grid-template-columns:repeat(4,1fr);gap:13px;margin-bottom:16px;}
.scenario-card{border-radius:var(--r);padding:18px;position:relative;overflow:hidden;}
.scenario-card.pessimist{background:linear-gradient(135deg,rgba(244,63,94,.08),rgba(244,63,94,.04));border:1px solid rgba(244,63,94,.25);}
.scenario-card.normal{background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(59,130,246,.04));border:1px solid rgba(59,130,246,.25);}
.scenario-card.optimist{background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(16,185,129,.04));border:1px solid rgba(16,185,129,.25);}
.sc-badge{display:inline-flex;padding:3px 9px;border-radius:5px;font-family:'DM Mono',monospace;font-size:9px;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;}
.sc-badge.bad{background:rgba(244,63,94,.14);color:var(--rose);}
.sc-badge.mid{background:rgba(59,130,246,.14);color:var(--blue2);}
.sc-badge.good{background:rgba(16,185,129,.14);color:var(--green);}
.sc-num{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;line-height:1;margin-bottom:4px;}
.sc-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;}
.sc-metrics{display:flex;flex-direction:column;gap:6px;}
.sc-metric{display:flex;justify-content:space-between;font-size:12px;}
.sc-metric-l{color:var(--t3);}
.sc-metric-v{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;}
.sc-divider{height:1px;background:rgba(255,255,255,.06);margin:12px 0;}
.sc-delta{display:flex;align-items:center;gap:5px;font-size:11px;font-family:'DM Mono',monospace;}
.delta-up{color:var(--green);}.delta-dn{color:var(--rose);}.delta-nt{color:var(--t3);}

/* Growth rate cards */
.growth-card{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:16px;}
.growth-num{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;line-height:1;}
.growth-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-top:4px;margin-bottom:8px;}
.growth-bar{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;margin-top:8px;}
.growth-fill{height:100%;border-radius:2px;transition:width 1s ease;}

/* Insight boxes */
.insight-box{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:16px;margin-bottom:14px;}
.insight-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.insight-text{font-size:12px;color:var(--t2);line-height:1.7;}
.highlight{color:var(--blue2);font-weight:600;}
.highlight-g{color:var(--green);font-weight:600;}
.highlight-r{color:var(--rose);font-weight:600;}
.highlight-a{color:var(--amber);font-weight:600;}

/* AI Score specific */
.ai-score-gauge{position:relative;width:130px;height:80px;margin:0 auto 8px;}
.gauge-arc{overflow:visible;}
.score-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.score-big{font-family:'Syne',sans-serif;font-size:32px;font-weight:800;line-height:1;}
.score-ring{width:70px;height:70px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:3px solid;}
.score-row{display:flex;align-items:center;gap:14px;padding:10px 0;border-bottom:1px solid var(--b1);}
.score-row:last-child{border-bottom:none;}
.score-detail{flex:1;min-width:0;}
.score-name{font-size:13px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.score-meta{font-size:11px;color:var(--t3);font-family:'DM Mono',monospace;margin-top:2px;}
.score-bar-wrap{display:flex;align-items:center;gap:8px;margin-top:6px;}
.score-bar-bg{flex:1;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;}
.score-bar-fill{height:100%;border-radius:2px;transition:width .8s ease;}
.score-val{font-family:'DM Mono',monospace;font-size:11px;min-width:28px;text-align:right;}

/* Weight breakdown */
.weight-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
.weight-item{background:var(--bg3);border-radius:9px;padding:12px;text-align:center;}
.weight-icon{font-size:18px;margin-bottom:4px;}
.weight-pct{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:2px;}
.weight-name{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;}

/* Recommendation badge */
.rec-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;font-family:'DM Mono',monospace;font-size:11px;font-weight:600;}
.rec-go{background:rgba(16,185,129,.15);color:var(--green);border:1px solid rgba(16,185,129,.3);}
.rec-cond{background:rgba(59,130,246,.15);color:var(--blue2);border:1px solid rgba(59,130,246,.3);}
.rec-risk{background:rgba(245,158,11,.15);color:var(--amber);border:1px solid rgba(245,158,11,.3);}
.rec-no{background:rgba(244,63,94,.15);color:var(--rose);border:1px solid rgba(244,63,94,.3);}

/* City strategy grid */
.city-strat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:14px;}
.city-strat-card{background:var(--bg3);border-radius:9px;padding:13px;border:1px solid var(--b1);transition:border-color .18s;}
.city-strat-card:hover{border-color:var(--b2);}
.city-strat-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:4px;}
.city-strat-score{font-family:'DM Mono',monospace;font-size:11px;color:var(--t3);}
.city-strat-bar{height:3px;background:var(--bg2);border-radius:2px;margin-top:8px;overflow:hidden;}

/* Print-friendly summary box */
.exec-summary{background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(139,92,246,.06));border:1px solid rgba(59,130,246,.2);border-radius:var(--r);padding:20px;margin-bottom:16px;}
.exec-summary-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.exec-bullet{display:flex;align-items:flex-start;gap:8px;margin-bottom:7px;font-size:13px;color:var(--t2);}
.exec-bullet::before{content:'‚Üí';color:var(--blue2);font-family:'DM Mono',monospace;flex-shrink:0;margin-top:1px;}

/* Responsive for new pages */
@media(max-width:1100px){
  .sc3{grid-template-columns:1fr;}
  .sc4{grid-template-columns:repeat(2,1fr);}
  .weight-grid{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:768px){
  .sc3,.sc4{grid-template-columns:1fr;}
  .weight-grid{grid-template-columns:repeat(3,1fr);}
  .city-strat-grid{grid-template-columns:repeat(2,1fr);}
  .score-row{flex-wrap:wrap;}
}
@media(max-width:480px){
  .weight-grid{grid-template-columns:1fr 1fr;}
}


/* ‚îÄ‚îÄ‚îÄ CALENDAR PAGE ‚îÄ‚îÄ‚îÄ */
.cal-grid{display:grid;grid-template-columns:340px 1fr;gap:16px;align-items:start;}
.cal-box{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;}
/* Mini calendar */
.cal-header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--b1);}
.cal-nav{display:flex;align-items:center;gap:8px;}
.cal-nav-btn{width:28px;height:28px;border-radius:6px;border:1px solid var(--b1);background:var(--bg3);color:var(--t2);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.cal-nav-btn:hover{border-color:var(--b2);color:var(--t1);}
.cal-month-lbl{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;min-width:130px;text-align:center;}
.cal-dow{display:grid;grid-template-columns:repeat(7,1fr);padding:8px 12px 4px;}
.cal-dow span{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-align:center;padding:4px 0;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);padding:4px 12px 12px;gap:2px;}
.cal-day{aspect-ratio:1;border-radius:7px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;position:relative;min-height:34px;}
.cal-day:hover{background:var(--bg3);}
.cal-day.other-month{opacity:.28;}
.cal-day.today{background:rgba(59,130,246,.14);border:1px solid rgba(59,130,246,.3);}
.cal-day.selected{background:var(--blue);color:#fff;}
.cal-day.has-event::after{content:'';position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--amber);}
.cal-day.selected.has-event::after{background:#fff;}
.cal-day-num{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;}
/* Add event form */
.cal-form{padding:16px;}
.cal-form-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:13px;display:flex;align-items:center;gap:7px;}
/* Event list */
.cal-list{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;}
.cal-list-header{padding:13px 17px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
.cal-list-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.ev-item{display:flex;align-items:flex-start;gap:12px;padding:13px 16px;border-bottom:1px solid var(--b1);transition:background .13s;cursor:pointer;}
.ev-item:last-child{border-bottom:none;}
.ev-item:hover{background:var(--bg3);}
.ev-item:hover .ev-actions{opacity:1;}
/* Date badge */
.ev-date-badge{flex-shrink:0;width:48px;text-align:center;background:var(--bg3);border-radius:8px;padding:6px 4px;border:1px solid var(--b1);}
.ev-date-day{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;line-height:1;}
.ev-date-month{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;}
.ev-date-badge.soon{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.07);}
.ev-date-badge.soon .ev-date-day{color:var(--amber);}
.ev-date-badge.today-badge{border-color:rgba(59,130,246,.4);background:rgba(59,130,246,.1);}
.ev-date-badge.today-badge .ev-date-day{color:var(--blue2);}
.ev-date-badge.past{opacity:.45;}
/* Event info */
.ev-info{flex:1;min-width:0;}
.ev-name{font-size:14px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ev-meta{font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);margin-top:3px;display:flex;gap:10px;flex-wrap:wrap;}
.ev-tags{display:flex;gap:5px;flex-wrap:wrap;margin-top:6px;}
.ev-tag{display:inline-flex;padding:2px 7px;border-radius:4px;font-family:'DM Mono',monospace;font-size:9px;font-weight:500;}
.ev-tag-city{background:rgba(59,130,246,.12);color:var(--blue2);}
.ev-tag-type{background:rgba(139,92,246,.12);color:var(--violet);}
.ev-tag-note{background:rgba(245,158,11,.12);color:var(--amber);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ev-countdown{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;flex-shrink:0;text-align:right;}
.ev-actions{display:flex;gap:4px;opacity:0;transition:opacity .15s;flex-shrink:0;}
/* Urgency rings */
.urgency-7{color:var(--rose);}
.urgency-30{color:var(--amber);}
.urgency-future{color:var(--green);}
.urgency-past{color:var(--t3);}
/* Filter chips */
.filter-chips{display:flex;gap:6px;flex-wrap:wrap;}
.chip{padding:4px 10px;border-radius:20px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;border:1px solid var(--b1);background:var(--bg3);color:var(--t2);transition:all .15s;}
.chip.active{background:var(--blue);border-color:var(--blue);color:#fff;}
/* Timeline stripe */
.cal-timeline{padding:0 16px 12px;}
.timeline-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;padding:10px 0 6px;border-top:1px solid var(--b1);margin-top:2px;}
.timeline-label:first-child{border-top:none;padding-top:2px;}
/* Edit inline modal for calendar events */
.cal-edit-modal{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:22px;max-width:500px;width:100%;max-height:88vh;overflow-y:auto;}
/* Stats strip */
.cal-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;}
@media(max-width:1100px){
  .cal-grid{grid-template-columns:1fr;}
  .cal-stats{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:768px){
  .cal-stats{grid-template-columns:repeat(2,1fr);}
  .ev-actions{opacity:1;}
}
@media(max-width:480px){
  .cal-stats{grid-template-columns:1fr 1fr;}
}


/* ‚îÄ‚îÄ THEME TOGGLE ‚îÄ‚îÄ */
.theme-toggle{
  display:flex;align-items:center;gap:8px;
  padding:10px 16px;border-top:1px solid var(--b1);
  margin-top:auto;
}
.theme-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;flex:1;}
.toggle-track{
  width:42px;height:22px;border-radius:11px;
  background:var(--bg3);border:1px solid var(--b1);
  position:relative;cursor:pointer;transition:background .25s,border-color .25s;
  flex-shrink:0;
}
.toggle-track.on{background:var(--blue);border-color:var(--blue);}
.toggle-thumb{
  position:absolute;top:2px;left:2px;
  width:16px;height:16px;border-radius:50%;
  background:var(--t2);transition:transform .25s,background .25s;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;line-height:1;
}
.toggle-track.on .toggle-thumb{transform:translateX(20px);background:#fff;}
.theme-icon-light{opacity:0;transition:opacity .2s;position:absolute;}
.theme-icon-dark{opacity:1;transition:opacity .2s;position:absolute;}
.toggle-track.on .theme-icon-light{opacity:1;}
.toggle-track.on .theme-icon-dark{opacity:0;}


/* ‚îÄ‚îÄ LANDSCAPE MOBILE FIX ‚îÄ‚îÄ */
@media(max-width:900px) and (orientation:landscape){
  .sb{
    height:100vh;
    max-height:100vh;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    z-index:400;
  }
  .sb-nav{overflow-y:auto;-webkit-overflow-scrolling:touch;}
  .mob-bar{height:46px;padding:0 12px;}
  .main{padding-top:46px;}
  .topbar{top:46px;}
}


/* ‚îÄ‚îÄ‚îÄ NOTIFICATION SYSTEM ‚îÄ‚îÄ‚îÄ */
.notif-panel{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;margin-bottom:16px;}
.notif-header{padding:13px 17px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
.notif-header-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;}
.notif-body{padding:16px 17px;}

/* Permission banner */
.notif-perm-banner{
  display:flex;align-items:center;gap:12px;padding:14px 16px;
  border-radius:9px;margin-bottom:14px;flex-wrap:wrap;gap:10px;
}
.notif-perm-banner.ask{background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.2);}
.notif-perm-banner.granted{background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2);}
.notif-perm-banner.denied{background:rgba(244,63,94,.07);border:1px solid rgba(244,63,94,.2);}
.notif-perm-icon{font-size:22px;flex-shrink:0;}
.notif-perm-txt{flex:1;min-width:180px;}
.notif-perm-title{font-size:13px;font-weight:600;color:var(--t1);margin-bottom:2px;}
.notif-perm-sub{font-size:11px;color:var(--t3);font-family:'DM Mono',monospace;}

/* Reminder timing grid */
.reminder-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:14px 0;}
.reminder-chip{
  padding:10px 8px;border-radius:9px;text-align:center;cursor:pointer;
  border:1px solid var(--b1);background:var(--bg3);transition:all .18s;
  user-select:none;
}
.reminder-chip:hover{border-color:var(--b2);}
.reminder-chip.active{background:rgba(59,130,246,.12);border-color:var(--blue);color:var(--blue2);}
.reminder-chip-num{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;line-height:1;margin-bottom:2px;}
.reminder-chip-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;}
.reminder-chip.active .reminder-chip-lbl{color:var(--blue2);}

/* Notification log */
.notif-log{max-height:260px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.notif-log-item{
  display:flex;align-items:flex-start;gap:10px;
  padding:9px 0;border-bottom:1px solid var(--b1);
}
.notif-log-item:last-child{border-bottom:none;}
.notif-log-icon{
  width:32px;height:32px;border-radius:8px;display:flex;align-items:center;
  justify-content:center;font-size:14px;flex-shrink:0;margin-top:1px;
}
.notif-log-icon.sent{background:rgba(16,185,129,.12);}
.notif-log-icon.pending{background:rgba(245,158,11,.12);}
.notif-log-icon.missed{background:rgba(244,63,94,.12);}
.notif-log-name{font-size:13px;font-weight:600;color:var(--t1);margin-bottom:2px;}
.notif-log-meta{font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);}
.notif-log-badge{font-family:'DM Mono',monospace;font-size:9px;padding:2px 6px;border-radius:4px;margin-left:auto;flex-shrink:0;white-space:nowrap;}
.nlb-sent{background:rgba(16,185,129,.12);color:var(--green);}
.nlb-pending{background:rgba(245,158,11,.12);color:var(--amber);}
.nlb-today{background:rgba(244,63,94,.12);color:var(--rose);}

/* Notification sound toggle */
.sound-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-top:1px solid var(--b1);margin-top:10px;}
.sound-lbl{flex:1;font-size:12px;color:var(--t2);}

/* Pulse animation for active notif indicator */
@keyframes notif-pulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.4);}70%{box-shadow:0 0 0 8px rgba(16,185,129,0);}100%{box-shadow:0 0 0 0 rgba(16,185,129,0);}}
.notif-active-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;animation:notif-pulse 2s infinite;}

@media(max-width:768px){
  .reminder-grid{grid-template-columns:repeat(2,1fr);}
}


/* sidebar dimming: handled by sb-ov */


/* ‚îÄ‚îÄ CALENDAR MOBILE REORDER ‚îÄ‚îÄ */
@media(max-width:768px){
  /* Stack: notification, stats already single col */
  .cal-grid{display:flex;flex-direction:column;gap:14px;}
  /* Show event list FIRST on mobile */
  .cal-list{order:1;}
  /* Add form section SECOND */
  .cal-left-panel{order:2;}
  /* Limit mini cal height on mobile */
  .cal-days{grid-template-columns:repeat(7,1fr);}
  /* Event list: full height on mobile, no max-height cap */
  #cal-event-list{max-height:none !important;overflow-y:visible;}
  /* Notification panel: collapse by default on mobile */
}

</style>
</head>
<body>

<!-- MOBILE BAR -->
<div class="mob-bar">
  <div class="mob-logo">SPX<span style="color:var(--blue)">.</span></div>
  <div class="hb" id="hb" onclick="toggleSB()"><span></span><span></span><span></span></div>
</div>
<div class="sb-ov" id="sb-ov" onclick="closeSB()"></div>

<div class="shell">
<!-- SIDEBAR -->
<nav class="sb" id="sb">
  <div class="sb-logo">
    <div class="lm">SPX<span style="color:var(--blue)">.</span></div>
    <div class="ls">Event Intelligence</div>
  </div>
  <div class="sb-nav">
    <div class="nl">Ana Men√º</div>
    <div class="ni active" onclick="goPage('dashboard',this)"><span class="nx">‚óà</span>Dashboard</div>
    <div class="ni" onclick="goPage('events',this)"><span class="nx">‚óâ</span>Etkinlikler</div>
    <div class="ni" onclick="goPage('new-event',this)"><span class="nx">Ôºã</span>Yeni Etkinlik</div>
    <div class="nl" style="margin-top:9px">Analiz</div>
    <div class="ni" onclick="goPage('analysis',this)"><span class="nx">‚ñ£</span>Analiz Motoru</div>
    <div class="ni" onclick="goPage('weather',this)"><span class="nx">‚óé</span>Hava Durumu</div>
    <div class="nl" style="margin-top:9px">Planlama</div>
    <div class="ni" onclick="goPage('calendar',this)"><span class="nx">‚ä°</span>Etkinlik Takvimi</div>
    <div class="nl" style="margin-top:9px">Yapay Zeka</div>
    <div class="ni" onclick="goPage('forecast',this)"><span class="nx">‚óê</span>2026 Tahmin Modeli</div>
    <div class="ni" onclick="goPage('ai-score',this)"><span class="nx">‚óë</span>AI Katƒ±lƒ±m Skoru</div>
  </div>
  <div class="theme-toggle">
    <span class="theme-lbl">Tema</span>
    <span id="theme-lbl-mode" style="font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);margin-right:4px">Koyu</span>
    <div class="toggle-track" id="theme-track" onclick="toggleTheme()">
      <div class="toggle-thumb">
        <span class="theme-icon-dark">üåô</span>
        <span class="theme-icon-light">‚òÄÔ∏è</span>
      </div>
    </div>
  </div>
  <div class="sb-foot">
    <div class="ull">Kullanƒ±cƒ± Adƒ±</div>
    <input class="ui" id="username" placeholder="Adƒ±nƒ±zƒ± girin‚Ä¶" oninput="saveUser(this.value)">
    <div class="sb-st">
      <span class="dot dot-g"></span><span id="sync-txt">Hazƒ±r</span><br>
      <span style="margin-left:10px" id="foot-count">‚Äî etkinlik</span><br>
      <span style="margin-left:10px" id="foot-users">‚Äî kullanƒ±cƒ±</span>
    </div>
  </div>
</nav>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div class="pt" id="pg-title">Dashboard</div>
    <div class="tr">
      <select class="flt" id="year-filter" onchange="applyFilters()"><option value="all">T√ºm Yƒ±llar</option></select>
      <select class="flt" id="city-filter" onchange="applyFilters()"><option value="all">T√ºm ≈ûehirler</option></select>
      <button class="btn bs" onclick="syncAll()" title="Yenile">‚Üª</button>
      <button class="btn bs" onclick="doExport()">‚Üì CSV</button>
      <button class="btn bp" onclick="goPage('new-event',document.querySelectorAll('.ni')[2])">Ôºã Ekle</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="sec-l">Genel Bakƒ±≈ü</div>
    <div class="sec-t">Finansal Performans</div>
    <div class="kg">
      <div class="kc bl"><div class="kl">Toplam Ciro</div><div class="kv" id="k-ciro">‚Ç∫0</div><div class="ks" id="k-ciro-s">‚Äî</div></div>
      <div class="kc gn"><div class="kl">Toplam Net Kar</div><div class="kv" id="k-kar">‚Ç∫0</div><div class="ks" id="k-kar-s">‚Äî</div></div>
      <div class="kc am"><div class="kl">Toplam Gider</div><div class="kv" id="k-gider">‚Ç∫0</div><div class="ks" id="k-gider-s">‚Äî</div></div>
      <div class="kc vi"><div class="kl">Ort. Kar Marjƒ±</div><div class="kv" id="k-margin">%0</div><div class="ks" id="k-margin-s">‚Äî</div></div>
    </div>
    <div class="kg">
      <div class="kc cy"><div class="kl">Etkinlik Sayƒ±sƒ±</div><div class="kv" id="k-count">0</div><div class="ks" id="k-count-s">‚Äî</div></div>
      <div class="kc gn"><div class="kl">En Karlƒ± Etkinlik</div><div class="kv" style="font-size:13px;padding-top:4px" id="k-best">‚Äî</div><div class="ks" id="k-best-s">‚Äî</div></div>
      <div class="kc ro"><div class="kl">En D√º≈ü√ºk Performans</div><div class="kv" style="font-size:13px;padding-top:4px" id="k-worst">‚Äî</div><div class="ks" id="k-worst-s">‚Äî</div></div>
      <div class="kc bl"><div class="kl">Ort. ROI</div><div class="kv" id="k-roi">%0</div><div class="ks" id="k-roi-s">‚Äî</div></div>
    </div>
    <div class="cg32">
      <div class="cc"><div class="ch"><div><div class="ct">Aylƒ±k Ciro & Kar Trendi</div><div class="cs">Se√ßili d√∂nem</div></div></div><div class="cw t"><canvas id="cMonthly"></canvas></div></div>
      <div class="cc"><div class="ch"><div><div class="ct">≈ûehre G√∂re ROI</div><div class="cs">Kar≈üƒ±la≈ütƒ±rma</div></div></div><div class="cw t"><canvas id="cCity"></canvas></div></div>
    </div>
    <div class="cg2">
      <div class="cc"><div class="ch"><div><div class="ct">Etkinlik Karlƒ±lƒ±ƒüƒ± (Top 10)</div><div class="cs">Ciro vs Gider vs Kar</div></div></div><div class="cw"><canvas id="cEvent"></canvas></div></div>
      <div class="cc"><div class="ch"><div><div class="ct">Gider Daƒüƒ±lƒ±mƒ±</div><div class="cs">Maliyet kalemleri</div></div></div><div class="cw"><canvas id="cExp"></canvas></div></div>
    </div>
  </div>

  <!-- EVENTS -->
  <div class="page" id="page-events">
    <div class="sec-l">Etkinlik Y√∂netimi</div>
    <div class="sec-t">T√ºm Etkinlikler</div>
    <div class="tc">
      <div class="th">
        <div class="tht">Etkinlik Listesi <span id="ev-badge" style="font-size:10px;color:var(--t3);font-family:'DM Mono',monospace"></span></div>
        <div style="display:flex;gap:7px;align-items:center;flex-wrap:wrap">
          <input class="si" id="ev-srch" placeholder="Ara‚Ä¶" oninput="renderEvents()">
          <label style="font-size:11px;color:var(--t2);display:flex;align-items:center;gap:5px;cursor:pointer;white-space:nowrap">
            <input type="checkbox" id="grp-yr" checked onchange="renderEvents()"> Yƒ±la g√∂re grupla
          </label>
        </div>
      </div>
      <div class="tsc"><table><thead><tr>
        <th>ETKƒ∞NLƒ∞K</th><th>TARƒ∞H</th><th>≈ûEHƒ∞R</th><th>YIL</th><th>KATILIMCI</th>
        <th>Cƒ∞RO</th><th>Gƒ∞DER</th><th>NET KAR</th><th>KAR MARJI</th>
        <th>ROI</th><th>KAT.BA≈ûI Cƒ∞RO</th><th>PERF.</th><th>EKLEYEN</th><th>ƒ∞≈ûLEMLER</th>
      </tr></thead><tbody id="ev-tbody"></tbody></table></div>
    </div>
  </div>

  <!-- NEW EVENT -->
  <div class="page" id="page-new-event">
    <div class="sec-l">Veri Giri≈üi</div>
    <div class="sec-t">Yeni Etkinlik Ekle</div>
    <div class="fc2">
      <div class="fd">‚Äî Etkinlik Bilgileri</div>
      <div class="fg3">
        <div class="fg"><label class="fl">Etkinlik Adƒ± *</label><input class="fi" id="f-name" placeholder="ƒ∞zmir Maratonu 2026"></div>
        <div class="fg"><label class="fl">Tarih *</label><input type="date" class="fi" id="f-date" onchange="onDateChange()"></div>
        <div class="fg"><label class="fl">≈ûehir *</label><input class="fi" id="f-city" placeholder="ƒ∞zmir" list="city-dl"><datalist id="city-dl"></datalist></div>
      </div>
      <div class="fg3">
        <div class="fg">
          <label class="fl">Yƒ±l *</label>
          <select class="fi" id="f-year" onchange="onYearChange()"></select>
        </div>
        <div class="fg"><label class="fl">Katƒ±lƒ±mcƒ± Sayƒ±sƒ±</label><input type="number" class="fi" id="f-kat" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">√áadƒ±r Sayƒ±sƒ±</label><input type="number" class="fi" id="f-cadir" placeholder="0"></div>
      </div>

      <!-- Dynamic year banner -->
      <div class="yr-banner" id="yr-banner">
        üÜï <span id="yr-banner-txt"></span> yƒ±lƒ± i√ßin yeni etkinlik ‚Äî sistem otomatik yƒ±l grubu olu≈üturacak.
      </div>

      <div class="fd">‚Äî Gider Kalemleri</div>
      <div class="fg4">
        <div class="fg"><label class="fl">Ajans Bedeli (‚Ç∫)</label><input type="number" class="fi" id="f-ajans" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Personel Gideri (‚Ç∫)</label><input type="number" class="fi" id="f-per" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Stand Maliyeti (‚Ç∫)</label><input type="number" class="fi" id="f-stand" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Barter (‚Ç∫)</label><input type="number" class="fi" id="f-barter" placeholder="0" oninput="calcPrev()"></div>
      </div>

      <div class="fd">‚Äî Ciro Kalemleri</div>
      <div class="fg2">
        <div class="fg"><label class="fl">√áek Ciro (‚Ç∫)</label><input type="number" class="fi" id="f-cek" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">√áadƒ±r Ciro (‚Ç∫)</label><input type="number" class="fi" id="f-cciro" placeholder="0" oninput="calcPrev()"></div>
      </div>

      <div class="fd">‚Äî Anlƒ±k Hesaplama</div>
      <div class="pvs">
        <div class="pvi"><div class="pvl">Toplam Ciro</div><div class="pvv cb" id="p-ciro">‚Ç∫0</div></div>
        <div class="pvi"><div class="pvl">Toplam Gider</div><div class="pvv ca" id="p-gider">‚Ç∫0</div></div>
        <div class="pvi"><div class="pvl">Net Kar</div><div class="pvv cg" id="p-kar">‚Ç∫0</div></div>
        <div class="pvi"><div class="pvl">Kar Marjƒ±</div><div class="pvv cb" id="p-margin">‚Äî</div></div>
        <div class="pvi"><div class="pvl">ROI</div><div class="pvv cg" id="p-roi">‚Äî</div></div>
        <div class="pvi"><div class="pvl">Kat.Ba≈üƒ± Ciro</div><div class="pvv cb" id="p-pciro">‚Äî</div></div>
        <div class="pvi"><div class="pvl">Kat.Ba≈üƒ± Mlt.</div><div class="pvv ca" id="p-pgdr">‚Äî</div></div>
      </div>

      <div class="fd">‚Äî Hava Durumu (Gemini AI)</div>
      <div class="wx-box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;flex-wrap:wrap;gap:7px">
          <span style="font-size:12px;color:var(--t2)">Gemini'ye g√∂nderilecek prompt:</span>
          <button class="btn bs" style="font-size:11px" onclick="buildPrompt()">‚ü≥ Olu≈ütur</button>
        </div>
        <div class="wx-pr" id="wx-pr">Tarih ve ≈üehir girerek prompt olu≈üturun‚Ä¶</div>
        <div style="margin-top:11px">
          <label class="fl" style="margin-bottom:5px;display:block">Gemini yanƒ±tƒ±nƒ± buraya yapƒ±≈ütƒ±r</label>
          <textarea class="fi" id="f-wx" rows="4" style="resize:vertical;font-family:'DM Mono',monospace;font-size:11px" placeholder="Sƒ±caklƒ±k: 22¬∞C&#10;Durum: G√ºne≈üli&#10;R√ºzgar: 15 km/h"></textarea>
        </div>
      </div>

      <div style="display:flex;gap:9px;justify-content:flex-end;flex-wrap:wrap">
        <button class="btn bs" onclick="clearForm()">Temizle</button>
        <button class="btn bp" onclick="saveEvent()">‚úì Kaydet</button>
      </div>
    </div>
  </div>

  <!-- ANALYSIS -->
  <div class="page" id="page-analysis">
    <div class="sec-l">Karar Destek Sistemi</div>
    <div class="sec-t">Analiz Motoru</div>
    <div class="ig">
      <div class="ic"><div class="ih"><div class="ii ig2">üèÜ</div><div class="it">≈ûehir Bazlƒ± Karlƒ±lƒ±k</div></div><div id="city-ins"></div></div>
      <div class="ic"><div class="ih"><div class="ii ib">üìä</div><div class="it">Ajans Maliyeti vs Kar Marjƒ±</div></div><div class="cw"><canvas id="cAgency"></canvas></div></div>
      <div class="ic"><div class="ih"><div class="ii ia">üë•</div><div class="it">Katƒ±lƒ±mcƒ± & ROI ƒ∞li≈ükisi</div></div><div class="cw"><canvas id="cPart"></canvas></div></div>
      <div class="ic"><div class="ih"><div class="ii ir2">üå§</div><div class="it">Hava Durumu & Performans</div></div><div id="wx-ins"><div class="empty">Hava durumu girildik√ße analiz g√∂r√ºn√ºr.</div></div></div>
    </div>
    <div class="cc">
      <div class="ch"><div><div class="ct">Karar Destek √ñzeti</div><div class="cs">Veri odaklƒ± √∂neriler</div></div></div>
      <div class="dg" id="deci-cards"></div>
    </div>
  </div>

  <!-- WEATHER -->
  <div class="page" id="page-weather">
    <div class="sec-l">Gemini AI Entegrasyonu</div>
    <div class="sec-t">Hava Durumu Rehberi</div>
    <div class="fc2" style="margin-bottom:18px">
      <div style="background:var(--bg3);border-radius:9px;padding:16px">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:1px;margin-bottom:9px">PROMPT ≈ûABLONU</div>
        <div style="font-family:'DM Mono',monospace;font-size:12px;line-height:2;color:var(--t2)">
          "<span style="color:var(--t1)">[TARƒ∞H] tarihinde [≈ûEHƒ∞R]'de hava nasƒ±ldƒ±?</span><br>Sadece ≈üu formatta cevap ver:<br>Sƒ±caklƒ±k: X¬∞C<br>Durum: G√ºne≈üli/Yaƒümurlu/Bulutlu<br>R√ºzgar: X km/h"
        </div>
      </div>
      <div style="margin-top:11px;font-size:12px;color:var(--t3)">‚ÑπÔ∏è Yanƒ±tƒ± kopyalayƒ±p Yeni Etkinlik ‚Üí Hava Durumu alanƒ±na yapƒ±≈ütƒ±rƒ±n.</div>
    </div>
    <div class="tc">
      <div class="th"><div class="tht">Hava Durumu Kayƒ±tlarƒ±</div></div>
      <div class="tsc"><table><thead><tr>
        <th>ETKƒ∞NLƒ∞K</th><th>TARƒ∞H</th><th>≈ûEHƒ∞R</th><th>YIL</th><th>SICAKLIK</th><th>DURUM</th><th>R√úZGAR</th><th>NET KAR</th><th>ETKƒ∞</th>
      </tr></thead><tbody id="wx-tbody"></tbody></table></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê 2026 FORECAST PAGE ‚ïê‚ïê‚ïê‚ïê -->
  <div class="page" id="page-forecast">
    <div class="sec-l">Yapay Zeka ¬∑ Tahmin Motoru</div>
    <div class="sec-t">2026 Tahmini Karlƒ±lƒ±k Modeli</div>

    <!-- Growth Rate KPIs -->
    <div id="forecast-growth-cards" class="sc4" style="margin-bottom:16px"></div>

    <!-- Executive Summary -->
    <div class="exec-summary" id="forecast-exec-summary"></div>

    <!-- 3 Scenarios -->
    <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;">SENARYO ANALƒ∞Zƒ∞</div>
    <div class="sc3" id="forecast-scenarios"></div>

    <!-- Charts Row -->
    <div class="cg2">
      <div class="cc"><div class="ch"><div><div class="ct">Senaryo Kar≈üƒ±la≈ütƒ±rmasƒ±</div><div class="cs">Ciro ¬∑ Gider ¬∑ Kar</div></div></div><div class="cw t"><canvas id="cForecastScenario"></canvas></div></div>
      <div class="cc"><div class="ch"><div><div class="ct">2024‚Üí2025‚Üí2026 Trend</div><div class="cs">Yƒ±llƒ±k b√ºy√ºme projeksiyon</div></div></div><div class="cw t"><canvas id="cForecastTrend"></canvas></div></div>
    </div>

    <!-- City Level Forecast -->
    <div class="insight-box">
      <div class="insight-title">üèô ≈ûehir Bazlƒ± 2026 Projeksiyonu</div>
      <div class="tsc"><table style="min-width:600px;"><thead><tr>
        <th>≈ûEHƒ∞R</th><th>2025 Cƒ∞RO</th><th>2026 TAHMƒ∞N (NORMAL)</th><th>2026 TAHMƒ∞N (ƒ∞Yƒ∞MSER)</th><th>B√úY√úME</th><th>STRATEJƒ∞</th>
      </tr></thead><tbody id="forecast-city-tbody"></tbody></table></div>
    </div>

    <!-- Monthly Projection -->
    <div class="cc" style="margin-bottom:16px">
      <div class="ch"><div><div class="ct">2026 Aylƒ±k Gelir Projeksiyonu (Normal Senaryo)</div><div class="cs">Ge√ßmi≈ü sezonalite bazlƒ±</div></div></div>
      <div class="cw t"><canvas id="cForecastMonthly"></canvas></div>
    </div>

    <!-- Insights -->
    <div class="cg2">
      <div class="insight-box" style="margin-bottom:0">
        <div class="insight-title">üéØ Model Varsayƒ±mlarƒ±</div>
        <div id="forecast-assumptions" class="insight-text"></div>
      </div>
      <div class="insight-box" style="margin-bottom:0">
        <div class="insight-title">‚ö†Ô∏è Risk Fakt√∂rleri & Fƒ±rsatlar</div>
        <div id="forecast-risks" class="insight-text"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê AI SCORE PAGE ‚ïê‚ïê‚ïê‚ïê -->
  <div class="page" id="page-ai-score">
    <div class="sec-l">Yapay Zeka ¬∑ Karar Destek</div>
    <div class="sec-t">Katƒ±l / Katƒ±lma AI Skoru</div>

    <!-- Weight legend -->
    <div class="cc" style="margin-bottom:16px">
      <div class="ch"><div><div class="ct">Skor Aƒüƒ±rlƒ±k Matrisi</div><div class="cs">Her fakt√∂r√ºn karar √ºzerindeki etkisi</div></div></div>
      <div class="weight-grid" id="ai-weights-grid"></div>
    </div>

    <!-- Summary KPIs -->
    <div class="sc4" id="ai-kpi-row" style="margin-bottom:16px"></div>

    <!-- Charts row -->
    <div class="cg2" style="margin-bottom:16px">
      <div class="cc"><div class="ch"><div><div class="ct">Skor Daƒüƒ±lƒ±mƒ±</div><div class="cs">Etkinlik bazlƒ± 0‚Äì100</div></div></div><div class="cw"><canvas id="cAiScoreDist"></canvas></div></div>
      <div class="cc"><div class="ch"><div><div class="ct">Fakt√∂r Etki Analizi</div><div class="cs">Hangi deƒüi≈üken en √ßok etkiliyor?</div></div></div><div class="cw"><canvas id="cAiFactors"></canvas></div></div>
    </div>

    <!-- Exec Summary -->
    <div class="exec-summary" id="ai-exec-summary" style="margin-bottom:16px"></div>

    <!-- City Strategy -->
    <div class="insight-box" style="margin-bottom:16px">
      <div class="insight-title">üåç ≈ûehir Stratejik Avantaj Haritasƒ±</div>
      <div class="city-strat-grid" id="ai-city-grid"></div>
    </div>

    <!-- Cost Optimization -->
    <div class="insight-box" style="margin-bottom:16px">
      <div class="insight-title">üí° Maliyet Optimizasyon √ñnerileri</div>
      <div id="ai-cost-tips"></div>
    </div>

    <!-- Full Score Table -->
    <div class="tc">
      <div class="th">
        <div class="tht">Etkinlik AI Skor Tablosu</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select class="flt" id="ai-year-filter" onchange="renderAiTable()">
            <option value="all">T√ºm Yƒ±llar</option>
          </select>
          <select class="flt" id="ai-sort" onchange="renderAiTable()">
            <option value="score">Skora G√∂re</option>
            <option value="roi">ROI'ye G√∂re</option>
            <option value="name">Ada G√∂re</option>
          </select>
        </div>
      </div>
      <div class="score-table-wrap">
        <div id="ai-score-list" style="padding:4px 0"></div>
      </div>
    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê CALENDAR PAGE ‚ïê‚ïê‚ïê‚ïê -->
  <div class="page" id="page-calendar">
    <div class="sec-l">Planlama & Takvim</div>
    <div class="sec-t">Etkinlik Takvimi</div>

    <!-- Stats strip -->
    <div class="cal-stats" id="cal-stats-strip"></div>

    <!-- NOTIFICATION PANEL -->
    <div class="notif-panel" id="notif-panel">
      <div class="notif-header">
        <div class="notif-header-title">
          <span id="notif-active-indicator"></span>
          üîî Hatƒ±rlatma Sistemi
        </div>
        <div style="display:flex;gap:7px;align-items:center;flex-wrap:wrap">
          <button class="btn bs" style="font-size:11px;padding:5px 10px" onclick="notifTest()">üß™ Test</button>
          <button class="btn bs" style="font-size:11px;padding:5px 10px" onclick="toggleNotifPanel()">Gizle ‚Üë</button>
        </div>
      </div>
      <div class="notif-body" id="notif-panel-body">
        <!-- Permission banner -->
        <div class="notif-perm-banner ask" id="notif-perm-banner">
          <div class="notif-perm-icon" id="notif-perm-icon">üîî</div>
          <div class="notif-perm-txt">
            <div class="notif-perm-title" id="notif-perm-title">Bildirim ƒ∞zni Gerekli</div>
            <div class="notif-perm-sub" id="notif-perm-sub">Yakla≈üan etkinlikler i√ßin uyarƒ± almak i√ßin izin verin</div>
          </div>
          <button class="btn bp" id="notif-perm-btn" style="font-size:11px" onclick="requestNotifPermission()">ƒ∞zin Ver</button>
        </div>

        <!-- Reminder timing settings -->
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;">NE KADAR √ñNCE UYARILMAK ƒ∞STERSƒ∞Nƒ∞Z?</div>
        <div class="reminder-grid" id="reminder-grid">
          <div class="reminder-chip" data-days="0" onclick="toggleReminderDay(0,this)">
            <div class="reminder-chip-num">0</div>
            <div class="reminder-chip-lbl">G√ºn √∂nce (sabah)</div>
          </div>
          <div class="reminder-chip active" data-days="1" onclick="toggleReminderDay(1,this)">
            <div class="reminder-chip-num">1</div>
            <div class="reminder-chip-lbl">G√ºn √∂nce</div>
          </div>
          <div class="reminder-chip active" data-days="3" onclick="toggleReminderDay(3,this)">
            <div class="reminder-chip-num">3</div>
            <div class="reminder-chip-lbl">G√ºn √∂nce</div>
          </div>
          <div class="reminder-chip active" data-days="7" onclick="toggleReminderDay(7,this)">
            <div class="reminder-chip-num">7</div>
            <div class="reminder-chip-lbl">G√ºn √∂nce</div>
          </div>
        </div>

        <!-- Notification time setting -->
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap">
          <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;">G√úNL√úK HATIRLATMA SAATƒ∞</div>
          <input type="time" class="fi" id="notif-time" value="09:00" style="width:110px;font-family:'DM Mono',monospace" onchange="saveNotifSettings()">
          <span style="font-size:11px;color:var(--t3)">Her g√ºn bu saatte kontrol edilir</span>
        </div>

        <!-- Sound + vibration -->
        <div class="sound-row">
          <span style="font-size:16px">üîä</span>
          <span class="sound-lbl">Bildirim sesi</span>
          <div class="toggle-track" id="sound-track" onclick="toggleSound()">
            <div class="toggle-thumb">
              <span class="theme-icon-dark">üîá</span>
              <span class="theme-icon-light">üîä</span>
            </div>
          </div>
        </div>

        <!-- Upcoming notifications log -->
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;margin:14px 0 8px;">YAKLA≈ûAN HATIRLATMALAR</div>
        <div class="notif-log" id="notif-log-list"></div>
      </div>
    </div>

    <div class="cal-grid">
      <!-- Left: Mini calendar + Add form -->
      <div class="cal-left-panel" style="display:flex;flex-direction:column;gap:14px;">
        <!-- Mini calendar -->
        <div class="cal-box">
          <div class="cal-header">
            <div class="cal-nav">
              <button class="cal-nav-btn" onclick="calPrevMonth()">‚Äπ</button>
              <div class="cal-month-lbl" id="cal-month-lbl">‚Äî</div>
              <button class="cal-nav-btn" onclick="calNextMonth()">‚Ä∫</button>
            </div>
            <button class="btn bs" style="font-size:11px;padding:5px 10px" onclick="calGoToday()">Bug√ºn</button>
          </div>
          <div class="cal-dow">
            <span>Pt</span><span>Sa</span><span>√áa</span><span>Pe</span><span>Cu</span><span>Ct</span><span>Pz</span>
          </div>
          <div class="cal-days" id="cal-days"></div>
        </div>

        <!-- Add / Edit form -->
        <div class="cal-box">
          <div class="cal-form">
            <div class="cal-form-title">
              <span id="cal-form-title-txt">Ôºã Yeni Etkinlik Ekle</span>
            </div>
            <input type="hidden" id="cal-edit-id">
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div class="fg"><label class="fl">Etkinlik Adƒ± *</label><input class="fi" id="cal-name" placeholder="Etkinlik adƒ±nƒ± girin‚Ä¶"></div>
              <div class="fg"><label class="fl">Tarih *</label><input type="date" class="fi" id="cal-date"></div>
              <div class="fg"><label class="fl">Biti≈ü Tarihi (Opsiyonel)</label><input type="date" class="fi" id="cal-end-date"></div>
              <div class="fg"><label class="fl">≈ûehir</label><input class="fi" id="cal-city" placeholder="ƒ∞stanbul" list="city-dl"></div>
              <div class="fg"><label class="fl">T√ºr</label>
                <select class="fi" id="cal-type">
                  <option value="Yarƒ± Maraton">Yarƒ± Maraton</option>
                  <option value="Ultra Trail">Ultra Trail</option>
                  <option value="Maraton">Maraton</option>
                  <option value="Bisiklet">Bisiklet</option>
                  <option value="Triatlon">Triatlon</option>
                  <option value="Festival">Festival</option>
                  <option value="Kurumsal">Kurumsal</option>
                  <option value="Pickleball">Pickleball</option>
                  <option value="Tenis">Tenis</option>
                  <option value="Diƒüer">Diƒüer</option>
                </select>
              </div>
              <div class="fg"><label class="fl">Tahmini Katƒ±lƒ±mcƒ±</label><input type="number" class="fi" id="cal-participants" placeholder="0"></div>
              <div class="fg"><label class="fl">Not / A√ßƒ±klama</label><textarea class="fi" id="cal-note" rows="2" style="resize:vertical;font-size:12px" placeholder="√ñnemli detaylar‚Ä¶"></textarea></div>
            </div>
            <div style="display:flex;gap:8px;margin-top:13px;justify-content:flex-end;flex-wrap:wrap">
              <button class="btn bs" id="cal-cancel-btn" style="display:none" onclick="calCancelEdit()">ƒ∞ptal</button>
              <button class="btn bp" id="cal-save-btn" onclick="calSaveEvent()">Ôºã Ekle</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Event list -->
      <div class="cal-list">
        <div class="cal-list-header">
          <div class="cal-list-title">Etkinlik Listesi <span id="cal-badge" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t3)"></span></div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input class="si" id="cal-search" placeholder="Ara‚Ä¶" oninput="renderCalendarList()" style="width:140px">
            <div class="filter-chips">
              <div class="chip active" data-filter="all" onclick="calSetFilter('all',this)">T√ºm√º</div>
              <div class="chip" data-filter="upcoming" onclick="calSetFilter('upcoming',this)">Yakla≈üan</div>
              <div class="chip" data-filter="past" onclick="calSetFilter('past',this)">Ge√ßmi≈ü</div>
            </div>
            <button class="btn bs" style="font-size:11px;padding:5px 9px" onclick="calExport()" title="JSON olarak dƒ±≈üa aktar">‚¨á Dƒ±≈üa</button>
            <button class="btn bs" style="font-size:11px;padding:5px 9px" onclick="calImport()" title="JSON i√ße aktar">‚¨Ü ƒ∞√ße</button>
          </div>
        </div>
        <div id="cal-event-list" style="max-height:600px;overflow-y:auto;-webkit-overflow-scrolling:touch;"></div>
      </div>
    </div>
  </div>

</main>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ SEED DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SEED=[
  {id:'s1',name:'ƒ∞zmir Maratonu',date:'2024-04-21',city:'ƒ∞zmir',participants:5759,tents:0,agency:47300,personnel:12910,standCost:80000,barter:0,cekCiro:0,cadirCiro:161621,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s2',name:'Merrell Tahtalƒ± Run To Sky',date:'2024-11-05',city:'Antalya',participants:825,tents:0,agency:0,personnel:3651,standCost:0,barter:0,cekCiro:53683,cadirCiro:348600,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s3',name:'Spx Daƒüyenice Ultra',date:'2024-05-24',city:'Bursa',participants:980,tents:0,agency:0,personnel:6760,standCost:0,barter:0,cekCiro:11493,cadirCiro:227000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s4',name:'Granfondo Bursa',date:'2024-05-26',city:'Bursa',participants:600,tents:0,agency:13500,personnel:500,standCost:0,barter:12000,cekCiro:13941,cadirCiro:23000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s5',name:'Wolfest',date:'2024-05-31',city:'Kocaeli',participants:0,tents:0,agency:0,personnel:0,standCost:0,barter:0,cekCiro:0,cadirCiro:236200,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s6',name:'SPX Pickleball ƒ∞stanbul Cup',date:'2024-06-06',city:'ƒ∞stanbul',participants:80,tents:0,agency:0,personnel:7500,standCost:0,barter:0,cekCiro:14424,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s7',name:'Spx Uludaƒü Bisiklet Tƒ±rmanƒ±≈üƒ±',date:'2024-08-03',city:'Bursa',participants:458,tents:0,agency:33500,personnel:4850,standCost:0,barter:0,cekCiro:1226,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s8',name:'Uludaƒü Ultra Trail',date:'2024-07-13',city:'Bursa',participants:2620,tents:0,agency:38500,personnel:28000,standCost:60000,barter:0,cekCiro:0,cadirCiro:160167,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s9',name:'Eski≈üehir Yarƒ± Maratonu',date:'2024-08-25',city:'Eski≈üehir',participants:1850,tents:5,agency:38500,personnel:11440,standCost:0,barter:50000,cekCiro:40833,cadirCiro:110266,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s10',name:'Bursa Pickleball Turnuvasƒ±',date:'2024-08-24',city:'Bursa',participants:75,tents:0,agency:28102,personnel:9500,standCost:0,barter:0,cekCiro:0,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s11',name:'Merrell Belgrad Ultra',date:'2024-07-09',city:'ƒ∞stanbul',participants:2590,tents:0,agency:0,personnel:27764,standCost:0,barter:0,cekCiro:0,cadirCiro:343386,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s12',name:'Kyzikos Ultra Trail',date:'2024-09-21',city:'Erdek',participants:1100,tents:0,agency:44110,personnel:35664,standCost:0,barter:0,cekCiro:0,cadirCiro:144000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s13',name:'Ankara Kahve Festivali',date:'2024-09-20',city:'Ankara',participants:35000,tents:0,agency:0,personnel:500,standCost:0,barter:50000,cekCiro:62630,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s14',name:'Spx Pickleball ƒ∞zmir Cup',date:'2024-10-11',city:'ƒ∞zmir',participants:90,tents:0,agency:0,personnel:78000,standCost:0,barter:0,cekCiro:25436,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s15',name:'Salomon Cappadocia Ultra',date:'2024-10-19',city:'Nev≈üehir',participants:3500,tents:4,agency:48500,personnel:72000,standCost:100000,barter:0,cekCiro:0,cadirCiro:517000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s16',name:'Kurumsal K√ºrek Yarƒ±≈üƒ±',date:'2024-02-11',city:'Bursa',participants:350,tents:0,agency:0,personnel:1200,standCost:0,barter:0,cekCiro:3500,cadirCiro:10000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s17',name:'Antalya Ultra',date:'2024-12-28',city:'Antalya',participants:950,tents:0,agency:43296,personnel:15180,standCost:30000,barter:0,cekCiro:0,cadirCiro:181419,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s18',name:'Efes Ultra Maratonu',date:'2025-04-04',city:'ƒ∞zmir',participants:2180,tents:6,agency:60000,personnel:49460,standCost:30000,barter:0,cekCiro:0,cadirCiro:658000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s19',name:'SPX Pickleball Ligi Nisan',date:'2025-04-12',city:'ƒ∞stanbul',participants:60,tents:0,agency:0,personnel:6039,standCost:0,barter:0,cekCiro:0,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s20',name:'Troya Yarƒ± Maratonu',date:'2025-04-19',city:'√áanakkale',participants:2500,tents:8,agency:140100,personnel:27996,standCost:0,barter:0,cekCiro:87011,cadirCiro:1014904,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s21',name:'Tahtalƒ± Run To Sky 2025',date:'2025-05-10',city:'Antalya',participants:300,tents:0,agency:0,personnel:0,standCost:36000,barter:0,cekCiro:0,cadirCiro:126000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s22',name:'SPX Tenis Turnuvasƒ±',date:'2025-05-17',city:'Antalya',participants:600,tents:0,agency:106774,personnel:0,standCost:0,barter:0,cekCiro:111915,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s23',name:'KTSK ≈ûenlikleri',date:'2025-05-23',city:'ƒ∞stanbul',participants:10000,tents:0,agency:103000,personnel:0,standCost:0,barter:0,cekCiro:0,cadirCiro:1185749,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s24',name:'Sapanca Ultra',date:'2025-06-14',city:'Sakarya',participants:1000,tents:0,agency:120000,personnel:35596,standCost:0,barter:0,cekCiro:0,cadirCiro:220733,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s25',name:'KTSK En Uzun Gece',date:'2025-06-20',city:'ƒ∞stanbul',participants:3000,tents:0,agency:162000,personnel:30500,standCost:0,barter:0,cekCiro:0,cadirCiro:526000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s26',name:'SPX Pickleball Ligi Finalleri',date:'2025-06-28',city:'ƒ∞stanbul',participants:90,tents:0,agency:145080,personnel:35000,standCost:0,barter:0,cekCiro:106000,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s27',name:'YKB Ankara Yaz ≈ûenlikleri',date:'2025-07-05',city:'Ankara',participants:450,tents:0,agency:147912,personnel:2950,standCost:0,barter:0,cekCiro:0,cadirCiro:25000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s28',name:'YKB Bankacƒ±lƒ±k √úss√º',date:'2025-07-16',city:'Kocaeli',participants:500,tents:0,agency:90000,personnel:34371,standCost:0,barter:0,cekCiro:0,cadirCiro:261220,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s29',name:'Uludaƒü Ultra Trail Yarƒ±≈üƒ±',date:'2025-07-18',city:'Bursa',participants:2500,tents:0,agency:114000,personnel:44000,standCost:100000,barter:0,cekCiro:0,cadirCiro:462762,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s30',name:'Eski≈üehir Yarƒ± Maratonu 2025',date:'2025-08-02',city:'Eski≈üehir',participants:2400,tents:0,agency:131700,personnel:29580,standCost:0,barter:54000,cekCiro:0,cadirCiro:222000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s31',name:'Gran Fondo Ba≈ükent Bisiklet',date:'2025-08-23',city:'Ankara',participants:900,tents:0,agency:0,personnel:3800,standCost:0,barter:0,cekCiro:0,cadirCiro:39000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s32',name:'Summer Run',date:'2025-08-30',city:'ƒ∞stanbul',participants:1150,tents:0,agency:48000,personnel:24555,standCost:120000,barter:0,cekCiro:0,cadirCiro:70826,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s33',name:'Merrell Belgrad Ultra 2025',date:'2025-09-05',city:'ƒ∞stanbul',participants:3500,tents:0,agency:0,personnel:30132,standCost:0,barter:0,cekCiro:0,cadirCiro:400375,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s34',name:'Tuzla Fest Run',date:'2025-09-19',city:'ƒ∞stanbul',participants:1200,tents:0,agency:79200,personnel:22494,standCost:30000,barter:40000,cekCiro:0,cadirCiro:87526,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s35',name:'Runkara Yarƒ± Maratonu',date:'2025-10-04',city:'Ankara',participants:3300,tents:0,agency:108000,personnel:9435,standCost:40000,barter:60000,cekCiro:0,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s36',name:'Salomon Kapadokya Yarƒ±≈üƒ±',date:'2025-10-16',city:'Nev≈üehir',participants:3500,tents:0,agency:146400,personnel:117600,standCost:120000,barter:0,cekCiro:0,cadirCiro:738000,year:2025,weather:'',addedBy:'Sistem'},
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let DB=[];
let username='';
let CH={};
const SK='spx:events:v4';
const UK='spx:user';

// ‚îÄ‚îÄ STORAGE (shared via window.storage if available) ‚îÄ‚îÄ
async function sGet(k){
  if(window.storage){try{const r=await window.storage.get(k,true);return r?r.value:null;}catch{return null;}}
  return localStorage.getItem(k);
}
async function sSet(k,v){
  if(window.storage){try{await window.storage.set(k,v,true);}catch(e){console.warn(e);}return;}
  localStorage.setItem(k,v);
}
function lGet(k){return localStorage.getItem(k);}
function lSet(k,v){localStorage.setItem(k,v);}

// ‚îÄ‚îÄ COMPUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calc(e){
  const ciro=(e.cekCiro||0)+(e.cadirCiro||0);
  const gider=(e.agency||0)+(e.personnel||0)+(e.standCost||0)+(e.barter||0);
  const kar=ciro-gider;
  const margin=ciro>0?(kar/ciro)*100:0;
  const roi=gider>0?(kar/gider)*100:0;
  const perC=e.participants>0?ciro/e.participants:0;
  const perG=e.participants>0?gider/e.participants:0;
  return{ciro,gider,kar,margin,roi,perC,perG};
}

// ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fc(n){const a=Math.abs(n),s=n<0?'-':'';return s+'‚Ç∫'+(a>=1e6?(a/1e6).toFixed(1)+'M':a>=1000?(a/1000).toFixed(0)+'K':Math.round(a).toLocaleString('tr-TR'));}
function fn(n){return Math.round(n).toLocaleString('tr-TR');}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filtered(){
  const y=document.getElementById('year-filter').value;
  const c=document.getElementById('city-filter').value;
  return DB.filter(e=>(y==='all'||String(e.year)===y)&&(c==='all'||e.city===c));
}

function rebuildFilters(){
  const years=[...new Set(DB.map(e=>e.year))].sort((a,b)=>b-a);
  const cities=[...new Set(DB.map(e=>e.city))].sort();
  const nowY=new Date().getFullYear();

  const yf=document.getElementById('year-filter'),cy=yf.value;
  yf.innerHTML='<option value="all">T√ºm Yƒ±llar</option>'+years.map(y=>`<option value="${y}"${String(y)===cy?' selected':''}>${y}</option>`).join('');

  const cf=document.getElementById('city-filter'),cc=cf.value;
  cf.innerHTML='<option value="all">T√ºm ≈ûehirler</option>'+cities.map(c=>`<option value="${c}"${c===cc?' selected':''}>${c}</option>`).join('');

  // City datalist
  document.getElementById('city-dl').innerHTML=cities.map(c=>`<option value="${c}">`).join('');

  // Year select for form: all existing years + current + next 2
  const formYears=[...new Set([...years,nowY,nowY+1,nowY+2])].sort((a,b)=>b-a);
  const fy=document.getElementById('f-year'),fcy=fy.value||nowY;
  fy.innerHTML=formYears.map(y=>`<option value="${y}"${String(y)===String(fcy)?' selected':''}>${y} Etkinlikleri</option>`).join('');
}

// ‚îÄ‚îÄ LOAD / SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData(){
  setST('Y√ºkleniyor‚Ä¶');
  try{
    const raw=await sGet(SK);
    let userEvs=[];
    if(raw){try{userEvs=JSON.parse(raw);}catch{}}
    const map=new Map();
    SEED.forEach(e=>map.set(e.id,e));
    userEvs.forEach(e=>map.set(e.id,e));
    DB=[...map.values()].sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
    rebuildFilters();
    setST('Senkronize');
    updateFoot();
  }catch{
    DB=[...SEED];
    rebuildFilters();
    setST('√áevrimdƒ±≈üƒ±');
  }
}
async function saveData(){
  const toSave=DB.filter(e=>!e.id.startsWith('s')||e.weather);
  await sSet(SK,JSON.stringify(toSave));
  updateFoot();
}
async function syncAll(){await loadData();applyFilters();toast('‚Üª Senkronize edildi');}
function setST(t){document.getElementById('sync-txt').textContent=t;}
function updateFoot(){
  document.getElementById('foot-count').textContent=DB.length+' etkinlik';
  const u=[...new Set(DB.map(e=>e.addedBy).filter(Boolean))];
  document.getElementById('foot-users').textContent=u.length+' kullanƒ±cƒ±';
}

// ‚îÄ‚îÄ USER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveUser(v){username=v.trim();lSet(UK,username);}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateDashboard(){
  const evs=filtered().map(e=>({...e,...calc(e)}));
  const tCiro=evs.reduce((a,b)=>a+b.ciro,0);
  const tGider=evs.reduce((a,b)=>a+b.gider,0);
  const tKar=evs.reduce((a,b)=>a+b.kar,0);
  const wC=evs.filter(e=>e.ciro>0),wG=evs.filter(e=>e.gider>0);
  const avgM=wC.length?wC.reduce((a,b)=>a+b.margin,0)/wC.length:0;
  const avgR=wG.length?wG.reduce((a,b)=>a+b.roi,0)/wG.length:0;

  sv('k-ciro',fc(tCiro));sv('k-kar',fc(tKar));sv('k-gider',fc(tGider));
  sv('k-margin',avgM.toFixed(1)+'%');sv('k-count',evs.length+'');sv('k-roi',avgR.toFixed(1)+'%');
  sv('k-ciro-s',`√áek: ${fc(evs.reduce((a,b)=>a+b.cekCiro,0))} ¬∑ √áadƒ±r: ${fc(evs.reduce((a,b)=>a+b.cadirCiro,0))}`);
  sv('k-kar-s',`Marj: ${tCiro>0?((tKar/tCiro)*100).toFixed(1):'0'}%`);

  const sorted=wC.sort((a,b)=>b.kar-a.kar);
  if(sorted.length){
    sv('k-best',sorted[0].name.substring(0,22)+(sorted[0].name.length>22?'‚Ä¶':''));
    sv('k-best-s',fc(sorted[0].kar)+' kar');
    sv('k-worst',sorted[sorted.length-1].name.substring(0,22));
    sv('k-worst-s',fc(sorted[sorted.length-1].kar));
  }
  buildCharts(evs);
}

// ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TT={backgroundColor:'#1a2438',borderColor:'rgba(59,130,246,.3)',borderWidth:1,titleColor:'#f0f4ff',bodyColor:'#8da0bf',padding:10};
const LEG={labels:{color:'#8da0bf',font:{family:'DM Mono',size:10},boxWidth:9}};
function AX(isY=false){return{grid:{color:'rgba(59,130,246,.05)'},ticks:{color:'#4d6080',font:{family:'DM Mono',size:9},callback:isY?v=>{const a=Math.abs(v);return(a>=1e6?(v/1e6).toFixed(1)+'M':a>=1000?(v/1000).toFixed(0)+'K':v)+'';}:undefined}};}
function dc(id){if(CH[id]){CH[id].destroy();delete CH[id];}}

function buildCharts(evs){
  const MN=['Oca','≈ûub','Mar','Nis','May','Haz','Tem','Aƒüu','Eyl','Eki','Kas','Ara'];
  const mp={};
  evs.forEach(e=>{
    if(!e.date)return;const d=new Date(e.date);if(isNaN(d))return;
    const k=e.year+'-'+String(d.getMonth()).padStart(2,'0');
    if(!mp[k])mp[k]={lbl:MN[d.getMonth()]+' '+e.year,ciro:0,kar:0};
    mp[k].ciro+=e.ciro;mp[k].kar+=e.kar;
  });
  const mk=Object.keys(mp).sort();
  dc('monthly');
  CH.monthly=new Chart(document.getElementById('cMonthly'),{type:'bar',data:{labels:mk.map(k=>mp[k].lbl),datasets:[
    {label:'Ciro',data:mk.map(k=>mp[k].ciro),backgroundColor:'rgba(59,130,246,.65)',borderRadius:4,order:2},
    {label:'Kar',data:mk.map(k=>mp[k].kar),type:'line',borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.1)',borderWidth:2,pointRadius:3,tension:.4,order:1,fill:true}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  const cm={};
  evs.forEach(e=>{if(!cm[e.city])cm[e.city]={kar:0,gider:0};cm[e.city].kar+=e.kar;cm[e.city].gider+=e.gider;});
  const cok=Object.keys(cm).filter(c=>cm[c].gider>0);
  const rois=cok.map(c=>(cm[c].kar/cm[c].gider)*100);
  dc('city');
  CH.city=new Chart(document.getElementById('cCity'),{type:'bar',data:{labels:cok,datasets:[{label:'ROI %',data:rois,backgroundColor:rois.map(r=>r>=0?'rgba(16,185,129,.7)':'rgba(244,63,94,.7)'),borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),ticks:{...AX().ticks,callback:v=>v.toFixed(0)+'%'}},y:AX()}}});

  const top=evs.filter(e=>e.ciro>0).sort((a,b)=>b.ciro-a.ciro).slice(0,10);
  dc('event');
  CH.event=new Chart(document.getElementById('cEvent'),{type:'bar',data:{labels:top.map(e=>e.name.substring(0,13)+(e.name.length>13?'‚Ä¶':'')),datasets:[
    {label:'Ciro',data:top.map(e=>e.ciro),backgroundColor:'rgba(59,130,246,.5)',borderRadius:3},
    {label:'Gider',data:top.map(e=>e.gider),backgroundColor:'rgba(244,63,94,.5)',borderRadius:3},
    {label:'Kar',data:top.map(e=>e.kar),backgroundColor:'rgba(16,185,129,.7)',borderRadius:3}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  const tA=evs.reduce((a,b)=>a+(b.agency||0),0);
  const tP=evs.reduce((a,b)=>a+(b.personnel||0),0);
  const tS=evs.reduce((a,b)=>a+(b.standCost||0),0);
  const tB=evs.reduce((a,b)=>a+(b.barter||0),0);
  dc('exp');
  CH.exp=new Chart(document.getElementById('cExp'),{type:'doughnut',data:{labels:['Ajans','Personel','Stand','Barter'],datasets:[{data:[tA,tP,tS,tB],backgroundColor:['rgba(59,130,246,.8)','rgba(139,92,246,.8)','rgba(245,158,11,.8)','rgba(34,211,238,.8)'],borderWidth:0,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{...LEG,position:'bottom'},tooltip:TT}}});
}

// ‚îÄ‚îÄ EVENTS TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEvents(){
  const evs=filtered();
  const q=(document.getElementById('ev-srch').value||'').toLowerCase();
  const grouped=document.getElementById('grp-yr').checked;
  const tbody=document.getElementById('ev-tbody');
  document.getElementById('ev-badge').textContent=`(${evs.length})`;

  const rows=evs.filter(e=>!q||e.name.toLowerCase().includes(q)||e.city.toLowerCase().includes(q));
  tbody.innerHTML='';
  if(!rows.length){tbody.innerHTML=`<tr><td colspan="14"><div class="empty">Etkinlik bulunamadƒ±</div></td></tr>`;return;}

  if(grouped){
    const years=[...new Set(rows.map(e=>e.year))].sort((a,b)=>b-a);
    years.forEach(yr=>{
      const yr_rows=rows.filter(e=>e.year===yr);
      const ym=yr_rows.map(e=>calc(e));
      const yC=ym.reduce((a,b)=>a+b.ciro,0),yK=ym.reduce((a,b)=>a+b.kar,0);
      // Year header
      const htr=document.createElement('tr');htr.className='yr-row';
      htr.innerHTML=`<td colspan="14">${yr} Etkinlikleri<span class="yr-stats">${yr_rows.length} etkinlik &nbsp;¬∑&nbsp; Ciro: ${fc(yC)} &nbsp;¬∑&nbsp; Net Kar: ${fc(yK)}</span></td>`;
      tbody.appendChild(htr);
      yr_rows.forEach(ev=>tbody.appendChild(mkRow(ev)));
    });
  } else {
    rows.forEach(ev=>tbody.appendChild(mkRow(ev)));
  }
}

function mkRow(ev){
  const m=calc(ev);
  const p=m.margin>=40?'h':m.margin>=0?'m':'l';
  const pL={h:'Y√ºksek',m:'Orta',l:'D√º≈ü√ºk'}[p];
  const tr=document.createElement('tr');
  tr.onclick=e=>{if(e.target.closest('.row-acts'))return;showDetail(ev.id);};
  tr.innerHTML=`
    <td class="nm" title="${ev.name}">${ev.name}</td>
    <td>${ev.date||'‚Äî'}</td><td>${ev.city}</td>
    <td class="mo">${ev.year}</td>
    <td class="mo">${ev.participants>0?fn(ev.participants):'‚Äî'}</td>
    <td class="mo ${m.ciro>0?'pg':''}">${fc(m.ciro)}</td>
    <td class="mo">${fc(m.gider)}</td>
    <td class="mo ${m.kar>=0?'pg':'pr'}">${fc(m.kar)}</td>
    <td class="mo ${m.margin>=0?'pg':'pr'}">${m.ciro>0?m.margin.toFixed(1)+'%':'‚Äî'}</td>
    <td class="mo ${m.roi>=0?'pg':'pr'}">${m.gider>0?m.roi.toFixed(0)+'%':'‚Äî'}</td>
    <td class="mo">${ev.participants>0&&m.ciro>0?fc(m.perC):'‚Äî'}</td>
    <td><span class="pl p${p}">${pL}</span></td>
    <td><span class="pl pu" style="font-size:9px">${ev.addedBy||'‚Äî'}</span></td>
    <td><div class="row-acts">
      <button class="rab rab-e" title="D√ºzenle" onclick="openEdit('${ev.id}')">‚úé</button>
      <button class="rab rab-s" title="Payla≈ü" onclick="openShare('${ev.id}')">‚¨Ü</button>
      <button class="rab rab-d" title="Sil" onclick="delEv('${ev.id}',event)">‚úï</button>
    </div></td>`;
  return tr;
}

async function delEv(id,e){
  e.stopPropagation();
  if(!confirm('Bu etkinliƒüi silmek istiyor musunuz?'))return;
  DB=DB.filter(ev=>ev.id!==id);
  await saveData();rebuildFilters();applyFilters();toast('Etkinlik silindi');
}

// ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onDateChange(){
  const d=document.getElementById('f-date').value;
  if(d){document.getElementById('f-year').value=new Date(d).getFullYear();onYearChange();}
  buildPrompt();calcPrev();
}

function onYearChange(){
  const yr=parseInt(document.getElementById('f-year').value);
  const existing=new Set(DB.map(e=>e.year));
  const banner=document.getElementById('yr-banner');
  if(!existing.has(yr)){
    banner.style.display='block';
    document.getElementById('yr-banner-txt').textContent=yr;
  } else {banner.style.display='none';}
}

function calcPrev(){
  const cek=nv('f-cek'),cc=nv('f-cciro'),aj=nv('f-ajans'),pe=nv('f-per'),st=nv('f-stand'),ba=nv('f-barter'),kat=nv('f-kat');
  const ciro=cek+cc,gider=aj+pe+st+ba,kar=ciro-gider;
  sv('p-ciro',fc(ciro));sv('p-gider',fc(gider));
  const pk=document.getElementById('p-kar');pk.textContent=fc(kar);pk.className='pvv '+(kar>=0?'cg':'cr');
  sv('p-margin',ciro>0?((kar/ciro)*100).toFixed(1)+'%':'‚Äî');
  sv('p-roi',gider>0?((kar/gider)*100).toFixed(1)+'%':'‚Äî');
  sv('p-pciro',kat>0&&ciro>0?fc(ciro/kat):'‚Äî');
  sv('p-pgdr',kat>0&&gider>0?fc(gider/kat):'‚Äî');
}

function buildPrompt(){
  const date=document.getElementById('f-date').value;
  const city=(document.getElementById('f-city').value||'').trim();
  if(!date||!city){document.getElementById('wx-pr').textContent='Tarih ve ≈üehir girerek prompt olu≈üturun‚Ä¶';return;}
  const d=new Date(date);
  const MN=['Ocak','≈ûubat','Mart','Nisan','Mayƒ±s','Haziran','Temmuz','Aƒüustos','Eyl√ºl','Ekim','Kasƒ±m','Aralƒ±k'];
  document.getElementById('wx-pr').textContent=`${d.getDate()} ${MN[d.getMonth()]} ${d.getFullYear()} tarihinde ${city}'de hava nasƒ±ldƒ±?\nSadece ≈üu formatta cevap ver:\nSƒ±caklƒ±k: X¬∞C\nDurum: G√ºne≈üli/Yaƒümurlu/Bulutlu\nR√ºzgar: X km/h`;
}

async function saveEvent(){
  const name=(document.getElementById('f-name').value||'').trim();
  const city=(document.getElementById('f-city').value||'').trim();
  const date=document.getElementById('f-date').value;
  const year=parseInt(document.getElementById('f-year').value);
  if(!name||!city){toast('Etkinlik adƒ± ve ≈üehir zorunludur','err');return;}
  if(!username){toast('L√ºtfen sol men√ºden kullanƒ±cƒ± adƒ± girin','err');return;}

  const ev={
    id:'u'+Date.now(),name,date,city,year,
    participants:nv('f-kat'),tents:nv('f-cadir'),
    agency:nv('f-ajans'),personnel:nv('f-per'),standCost:nv('f-stand'),barter:nv('f-barter'),
    cekCiro:nv('f-cek'),cadirCiro:nv('f-cciro'),
    weather:(document.getElementById('f-wx').value||'').trim(),
    addedBy:username,addedAt:new Date().toISOString()
  };

  DB.push(ev);DB.sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
  await saveData();rebuildFilters();applyFilters();
  toast('‚úì Kaydedildi: '+name);
  clearForm();
  goPage('events',document.querySelectorAll('.ni')[1]);
}

function clearForm(){
  ['f-name','f-date','f-city','f-kat','f-cadir','f-ajans','f-per','f-stand','f-barter','f-cek','f-cciro','f-wx'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('yr-banner').style.display='none';
  document.getElementById('wx-pr').textContent='Tarih ve ≈üehir girerek prompt olu≈üturun‚Ä¶';
  calcPrev();
}

// ‚îÄ‚îÄ ANALYSIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAnalysis(){
  const evs=filtered().map(e=>({...e,...calc(e)}));
  const cm={};evs.forEach(e=>{if(!cm[e.city])cm[e.city]={kar:0,gider:0,ciro:0,count:0};cm[e.city].kar+=e.kar;cm[e.city].gider+=e.gider;cm[e.city].ciro+=e.ciro;cm[e.city].count++;});
  const cities=Object.entries(cm).sort((a,b)=>b[1].kar-a[1].kar);
  const maxK=Math.max(...cities.map(c=>Math.abs(c[1].kar)))||1;
  document.getElementById('city-ins').innerHTML=cities.slice(0,8).map(([city,d])=>{
    const pct=(Math.abs(d.kar)/maxK)*100;const col=d.kar>=0?'var(--green)':'var(--rose)';
    return `<div class="ins-row"><span class="irl">${city}</span><div class="irbw"><div class="irb" style="width:${pct}%;background:${col}"></div></div><span class="irv">${fc(d.kar)}</span></div>`;
  }).join('');

  const ad=evs.filter(e=>e.agency>0&&e.ciro>0);
  dc('agency');CH.agency=new Chart(document.getElementById('cAgency'),{type:'scatter',data:{datasets:[{label:'Etkinlik',data:ad.map(e=>({x:e.agency/1000,y:e.margin})),backgroundColor:'rgba(59,130,246,.6)',pointRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),title:{display:true,text:'Ajans (K‚Ç∫)',color:'#4d6080',font:{size:9}},ticks:{...AX().ticks,callback:v=>v+'K'}},y:{...AX(),title:{display:true,text:'Kar Marjƒ± %',color:'#4d6080',font:{size:9}},ticks:{...AX().ticks,callback:v=>v.toFixed(0)+'%'}}}}});

  const pd=evs.filter(e=>e.participants>0&&e.gider>0);
  dc('part');CH.part=new Chart(document.getElementById('cPart'),{type:'scatter',data:{datasets:[{label:'Etkinlik',data:pd.map(e=>({x:e.participants,y:e.roi})),backgroundColor:'rgba(245,158,11,.6)',pointRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),title:{display:true,text:'Katƒ±lƒ±mcƒ±',color:'#4d6080',font:{size:9}}},y:{...AX(),title:{display:true,text:'ROI %',color:'#4d6080',font:{size:9}},ticks:{...AX().ticks,callback:v=>v.toFixed(0)+'%'}}}}});

  const wxEvs=evs.filter(e=>e.weather);
  if(wxEvs.length){
    const byC={};wxEvs.forEach(e=>{const c2=parseWx(e.weather).cond||'Bilinmiyor';if(!byC[c2])byC[c2]=[];byC[c2].push(e.roi);});
    document.getElementById('wx-ins').innerHTML=Object.entries(byC).map(([c2,r])=>{const avg=r.reduce((a,b)=>a+b,0)/r.length;return`<div class="ins-row"><span class="irl">${c2}</span><span class="irv ${avg>=0?'pg':'pr'}">${avg.toFixed(0)}% ROI</span></div>`;}).join('');
  }

  const bestCity=cities[0];
  const prof=evs.filter(e=>e.kar>0&&e.ciro>0).length;
  const total=evs.filter(e=>e.ciro>0).length;
  const avgA=evs.filter(e=>e.agency>0).reduce((a,b)=>a+b.agency,0)/Math.max(1,evs.filter(e=>e.agency>0).length);
  document.getElementById('deci-cards').innerHTML=`
    <div class="dc2" style="background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2)">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--green);letter-spacing:1px;margin-bottom:7px">üèÜ EN KARLI ≈ûEHƒ∞R</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700">${bestCity?bestCity[0]:'‚Äî'}</div>
      <div style="font-size:11px;color:var(--t3);margin-top:3px">${bestCity?fc(bestCity[1].kar)+' ¬∑ '+bestCity[1].count+' etkinlik':'‚Äî'}</div>
    </div>
    <div class="dc2" style="background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.2)">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue2);letter-spacing:1px;margin-bottom:7px">üìà KARLILIK ORANI</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700">${total>0?((prof/total)*100).toFixed(0)+'%':'‚Äî'}</div>
      <div style="font-size:11px;color:var(--t3);margin-top:3px">${prof} / ${total} etkinlik k√¢rlƒ±</div>
    </div>
    <div class="dc2" style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2)">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:1px;margin-bottom:7px">üí° ORT. AJANS MALƒ∞YETƒ∞</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700">${fc(avgA)}</div>
      <div style="font-size:11px;color:var(--t3);margin-top:3px">Etkinlik ba≈üƒ±na ortalama</div>
    </div>`;
}

// ‚îÄ‚îÄ WEATHER TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWeather(){
  const evs=DB.filter(e=>e.weather&&e.weather.trim());
  const tbody=document.getElementById('wx-tbody');
  if(!evs.length){tbody.innerHTML=`<tr><td colspan="9"><div class="empty">Hen√ºz hava durumu verisi yok.</div></td></tr>`;return;}
  tbody.innerHTML=evs.map(ev=>{
    const m=calc(ev);const w=parseWx(ev.weather);
    const imp=!w.cond?'‚Äî':m.roi>80&&(w.cond.includes('G√ºne≈ü')||w.cond.includes('A√ßƒ±k'))?'<span class="pl ph">‚Üë Olumlu</span>':w.cond.includes('Yaƒümur')&&m.roi<0?'<span class="pl plo">‚Üì Olumsuz</span>':'<span class="pl pm">‚Üí N√∂tr</span>';
    return `<tr><td class="nm">${ev.name}</td><td>${ev.date||'‚Äî'}</td><td>${ev.city}</td><td class="mo">${ev.year}</td><td class="mo">${w.temp||'‚Äî'}</td><td>${w.cond||'‚Äî'}</td><td class="mo">${w.wind||'‚Äî'}</td><td class="mo ${m.kar>=0?'pg':'pr'}">${fc(m.kar)}</td><td>${imp}</td></tr>`;
  }).join('');
}

function parseWx(s){
  if(!s)return{};
  return{
    temp:((s.match(/sƒ±caklƒ±k:\s*([\d.]+)/i)||[])[1]||null),
    cond:((s.match(/durum:\s*(\S+(?:\s+\S+)?)/i)||[])[1]||null),
    wind:((s.match(/r√ºzgar:\s*([\d.]+)/i)||[])[1]||null)
  };
}

// ‚îÄ‚îÄ DETAIL MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _curId=null;
function showDetail(id){
  const ev=DB.find(e=>e.id===id);if(!ev)return;
  _curId=id;
  const m=calc(ev);const w=parseWx(ev.weather);
  document.getElementById('m-name').textContent=ev.name;
  document.getElementById('modal-detail').classList.add('open');
  document.getElementById('m-body').innerHTML=`
    <div class="mg">
      ${[['≈ûehir',ev.city],['Tarih',ev.date||'‚Äî'],['Yƒ±l',ev.year],['Katƒ±lƒ±mcƒ±',ev.participants>0?fn(ev.participants):'‚Äî'],['√áadƒ±r',ev.tents||'‚Äî'],['Ekleyen',ev.addedBy||'‚Äî']].map(([l,v])=>`<div class="mi"><div class="mil">${l}</div><div class="miv">${v}</div></div>`).join('')}
    </div>
    <div style="background:var(--bg3);border-radius:8px;padding:12px;margin-bottom:11px">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:1px;margin-bottom:8px">Gƒ∞DER KALEMLERƒ∞</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px">
        <div><span style="color:var(--t3)">Ajans: </span><span style="font-family:'DM Mono',monospace">${fc(ev.agency||0)}</span></div>
        <div><span style="color:var(--t3)">Personel: </span><span style="font-family:'DM Mono',monospace">${fc(ev.personnel||0)}</span></div>
        <div><span style="color:var(--t3)">Stand: </span><span style="font-family:'DM Mono',monospace">${fc(ev.standCost||0)}</span></div>
        <div><span style="color:var(--t3)">Barter: </span><span style="font-family:'DM Mono',monospace">${fc(ev.barter||0)}</span></div>
      </div>
    </div>
    <div class="mkr">
      ${[['Toplam Ciro',fc(m.ciro),'var(--blue2)'],['Toplam Gider',fc(m.gider),'var(--amber)'],['Net Kar',fc(m.kar),m.kar>=0?'var(--green)':'var(--rose)'],['Kar Marjƒ±',m.ciro>0?m.margin.toFixed(1)+'%':'‚Äî','var(--t1)'],['ROI',m.gider>0?m.roi.toFixed(0)+'%':'‚Äî',m.roi>=0?'var(--green)':'var(--rose)'],['Kat. Ba≈üƒ± Ciro',ev.participants>0?fc(m.perC):'‚Äî','var(--t1)']].map(([l,v,c])=>`<div class="mk"><div class="mkl">${l}</div><div class="mkv" style="color:${c}">${v}</div></div>`).join('')}
    </div>
    ${ev.weather?`<div style="background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.14);border-radius:8px;padding:11px"><div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:1px;margin-bottom:5px">HAVA DURUMU</div><div style="font-size:12px;color:var(--t2);font-family:'DM Mono',monospace;white-space:pre-line">${ev.weather}</div></div>`:''}`;
}
function shareFromDetail(){const id=_curId;closeModal('modal-detail');setTimeout(()=>openShare(id),150);}
function editFromDetail(){const id=_curId;closeModal('modal-detail');setTimeout(()=>openEdit(id),150);}
async function delFromDetail(){
  if(!_curId)return;
  if(!confirm('Bu etkinliƒüi silmek istiyor musunuz?'))return;
  DB=DB.filter(e=>e.id!==_curId);
  closeModal('modal-detail');
  await saveData();rebuildFilters();applyFilters();toast('Etkinlik silindi');
}

// ‚îÄ‚îÄ EDIT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEdit(id){
  const ev=DB.find(e=>e.id===id);if(!ev)return;
  document.getElementById('edit-id').value=ev.id;
  setv('e-name',ev.name);setv('e-date',ev.date||'');setv('e-city',ev.city);
  // Populate year dropdown
  const nowY=new Date().getFullYear();
  const years=[...new Set(DB.map(e=>e.year))];
  const allY=[...new Set([...years,nowY,nowY+1,nowY+2])].sort((a,b)=>b-a);
  const ey=document.getElementById('e-year');
  ey.innerHTML=allY.map(y=>`<option value="${y}"${y===ev.year?' selected':''}>${y} Etkinlikleri</option>`).join('');
  setv('e-kat',ev.participants||0);setv('e-cadir',ev.tents||0);
  setv('e-ajans',ev.agency||0);setv('e-per',ev.personnel||0);
  setv('e-stand',ev.standCost||0);setv('e-barter',ev.barter||0);
  setv('e-cek',ev.cekCiro||0);setv('e-cciro',ev.cadirCiro||0);
  setv('e-wx',ev.weather||'');
  calcEP();
  document.getElementById('modal-edit').classList.add('open');
}
function onEditDate(){
  const d=document.getElementById('e-date').value;
  if(d){document.getElementById('e-year').value=new Date(d).getFullYear();}
}
function calcEP(){
  const cek=nv('e-cek'),cc=nv('e-cciro'),aj=nv('e-ajans'),pe=nv('e-per'),st=nv('e-stand'),ba=nv('e-barter'),kat=nv('e-kat');
  const ciro=cek+cc,gider=aj+pe+st+ba,kar=ciro-gider;
  sv('ep-ciro',fc(ciro));sv('ep-gider',fc(gider));
  const pk=document.getElementById('ep-kar');pk.textContent=fc(kar);pk.className='pvv '+(kar>=0?'cg':'cr');
  sv('ep-margin',ciro>0?((kar/ciro)*100).toFixed(1)+'%':'‚Äî');
  sv('ep-roi',gider>0?((kar/gider)*100).toFixed(1)+'%':'‚Äî');
  sv('ep-pciro',kat>0&&ciro>0?fc(ciro/kat):'‚Äî');
  sv('ep-pgdr',kat>0&&gider>0?fc(gider/kat):'‚Äî');
}
async function saveEdit(){
  const id=document.getElementById('edit-id').value;
  const name=(document.getElementById('e-name').value||'').trim();
  const city=(document.getElementById('e-city').value||'').trim();
  if(!name||!city){toast('Ad ve ≈üehir zorunludur','err');return;}
  const idx=DB.findIndex(e=>e.id===id);
  if(idx===-1){toast('Etkinlik bulunamadƒ±','err');return;}
  const orig=DB[idx];
  DB[idx]={...orig,name,city,
    date:document.getElementById('e-date').value||orig.date,
    year:parseInt(document.getElementById('e-year').value)||orig.year,
    participants:nv('e-kat'),tents:nv('e-cadir'),
    agency:nv('e-ajans'),personnel:nv('e-per'),standCost:nv('e-stand'),barter:nv('e-barter'),
    cekCiro:nv('e-cek'),cadirCiro:nv('e-cciro'),
    weather:(document.getElementById('e-wx').value||'').trim(),
    _edited:true,editedBy:username||orig.editedBy,editedAt:new Date().toISOString()
  };
  DB.sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
  await saveData();rebuildFilters();applyFilters();
  closeModal('modal-edit');toast('‚úì G√ºncellendi: '+name);
}

// ‚îÄ‚îÄ SHARE MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openShare(id){
  const ev=DB.find(e=>e.id===id);if(!ev)return;
  const m=calc(ev);const w=parseWx(ev.weather);
  const perfPct=Math.min(100,Math.max(0,(m.margin+20)*2));
  const pColor=m.margin>=40?'var(--green)':m.margin>=0?'var(--amber)':'var(--rose)';
  const pLbl=m.margin>=40?'Y√ºksek Performans':m.margin>=0?'Orta Performans':'D√º≈ü√ºk Performans';
  sv('sct',ev.name);sv('scd',ev.date||'‚Äî');sv('scc',ev.city);
  sv('scp',ev.participants>0?fn(ev.participants)+' katƒ±lƒ±mcƒ±':'‚Äî');
  sv('sc-yr',ev.year+' ¬∑ SPX');
  const scCiro=document.getElementById('sc-ciro');scCiro.textContent=fc(m.ciro);scCiro.style.color='var(--blue2)';
  sv('sc-ciro-s',`√áek: ${fc(ev.cekCiro||0)} ¬∑ √áadƒ±r: ${fc(ev.cadirCiro||0)}`);
  const scKar=document.getElementById('sc-kar');scKar.textContent=fc(m.kar);scKar.style.color=m.kar>=0?'var(--green)':'var(--rose)';
  sv('sc-kar-s',`Gider: ${fc(m.gider)}`);
  const scRoi=document.getElementById('sc-roi');scRoi.textContent=m.gider>0?m.roi.toFixed(0)+'%':'‚Äî';scRoi.style.color=m.roi>=0?'var(--cyan)':'var(--rose)';
  const scM=document.getElementById('sc-margin');scM.textContent=m.ciro>0?m.margin.toFixed(1)+'%':'‚Äî';scM.style.color=m.margin>=0?'var(--green)':'var(--rose)';
  sv('sc-gider',fc(m.gider));sv('sc-gider-s',`Ajans: ${fc(ev.agency||0)} ¬∑ Pers: ${fc(ev.personnel||0)}`);
  sv('sc-pciro',ev.participants>0&&m.ciro>0?fc(m.perC):'‚Äî');sv('sc-pciro-s',ev.participants>0?fn(ev.participants)+' ki≈üi':'‚Äî');
  document.getElementById('sc-pb').style.width=perfPct+'%';document.getElementById('sc-pb').style.background=pColor;sv('sc-pl',pLbl);
  const wxw=document.getElementById('sc-wx-wrap');
  if(w.temp||w.cond){wxw.style.display='block';sv('sc-wx-txt',`üå° ${w.temp||'‚Äî'}  ‚õÖ ${w.cond||'‚Äî'}${w.wind?'  üí® '+w.wind:''}`);}
  else{wxw.style.display='none';}
  // Share link
  const sd={id:ev.id,name:ev.name,city:ev.city,date:ev.date,year:ev.year,participants:ev.participants,ciro:m.ciro,gider:m.gider,kar:m.kar,margin:m.margin,roi:m.roi};
  const enc=btoa(unescape(encodeURIComponent(JSON.stringify(sd))));
  const url=(window.location.href.split('#')[0])+'#ev='+enc;
  document.getElementById('share-link-box').textContent=url;
  document.getElementById('modal-share').classList.add('open');
}
function copyLink(){
  const url=document.getElementById('share-link-box').textContent;
  _copy(url);
}
function copyText(){
  const ev=DB.find(e=>e.id===_shareId)||{};
  const n=document.getElementById('sct').textContent;
  const d=document.getElementById('scd').textContent;
  const c=document.getElementById('scc').textContent;
  const ciro=document.getElementById('sc-ciro').textContent;
  const kar=document.getElementById('sc-kar').textContent;
  const roi=document.getElementById('sc-roi').textContent;
  const margin=document.getElementById('sc-margin').textContent;
  const gider=document.getElementById('sc-gider').textContent;
  const wxLine=document.getElementById('sc-wx-wrap').style.display!=='none'?'\nüå§ '+document.getElementById('sc-wx-txt').textContent:'';
  const t=`üìä SPX ETKƒ∞NLƒ∞K RAPORU\n${'‚îÄ'.repeat(30)}\nüéØ ${n}\nüìÖ ${d}  üìç ${c}\n${'‚îÄ'.repeat(30)}\nüí∞ Toplam Ciro: ${ciro}\nüìâ Toplam Gider: ${gider}\n‚úÖ Net Kar: ${kar}\nüìà ROI: ${roi}\nüìä Kar Marjƒ±: ${margin}${wxLine}\n${'‚îÄ'.repeat(30)}\nSPX Event Intelligence`;
  _copy(t);
}
function shareWA(){
  const n=document.getElementById('sct').textContent;
  const d=document.getElementById('scd').textContent;
  const c=document.getElementById('scc').textContent;
  const ciro=document.getElementById('sc-ciro').textContent;
  const kar=document.getElementById('sc-kar').textContent;
  const roi=document.getElementById('sc-roi').textContent;
  const url=document.getElementById('share-link-box').textContent;
  const t=`*üìä ${n}*\nüìÖ ${d} ¬∑ üìç ${c}\n\nüí∞ Ciro: *${ciro}*\n‚úÖ Net Kar: *${kar}*\nüìà ROI: *${roi}*\n\nüîó ${url}`;
  window.open('https://wa.me/?text='+encodeURIComponent(t),'_blank');
}
function _copy(t){
  navigator.clipboard.writeText(t).then(showCopyOk).catch(()=>{const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showCopyOk();});
}
function showCopyOk(){const el=document.getElementById('copy-ok');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2200);}
let _shareId=null;
const _origOpenShare=openShare;

// ‚îÄ‚îÄ GENERIC MODAL HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeModal(id){document.getElementById(id).classList.remove('open');}
function moBg(e,id){if(e.target===document.getElementById(id))closeModal(id);}
function setv(id,v){const el=document.getElementById(id);if(el)el.value=v;}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TITLES={dashboard:'Dashboard',events:'Etkinlikler','new-event':'Yeni Etkinlik Ekle',analysis:'Analiz Motoru',weather:'Hava Durumu',forecast:'2026 Tahmin Modeli','ai-score':'AI Katƒ±lƒ±m Skoru',calendar:'Etkinlik Takvimi'};
function goPage(id,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  document.getElementById('pg-title').textContent=TITLES[id]||'';
  if(id==='events')renderEvents();
  if(id==='analysis')renderAnalysis();
  if(id==='weather')renderWeather();
  if(id==='forecast')renderForecast();
  if(id==='ai-score')renderAiScore();
  if(id==='calendar'){renderCalendar();setTimeout(()=>renderNotifLog(),100);}
  closeSB();
}

// ‚îÄ‚îÄ SIDEBAR MOBILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleSB(){
  const sb=document.getElementById('sb'),hb=document.getElementById('hb'),ov=document.getElementById('sb-ov');
  const o=sb.classList.toggle('open');
  hb.classList.toggle('open',o);
  ov.classList.toggle('open',o);
  document.body.style.overflow=o?'hidden':'';
}
function closeSB(){
  document.getElementById('sb').classList.remove('open');
  document.getElementById('hb').classList.remove('open');
  document.getElementById('sb-ov').classList.remove('open');
  document.body.style.overflow='';
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let TT2;
function toast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type==='err'?'err':'');clearTimeout(TT2);TT2=setTimeout(()=>t.classList.remove('show'),3200);}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doExport(){
  const evs=filtered();
  const cols=['Etkinlik','Yƒ±l','Tarih','≈ûehir','Katƒ±lƒ±mcƒ±','Ajans','Personel','Stand','Barter','√áekCiro','√áadƒ±rCiro','ToplamCiro','ToplamGider','NetKar','KarMarjƒ±%','ROI%','KatBa≈üƒ±Ciro','Ekleyen'];
  const rows=evs.map(e=>{const m=calc(e);return[e.name,e.year,e.date,e.city,e.participants,e.agency,e.personnel,e.standCost,e.barter,e.cekCiro,e.cadirCiro,m.ciro.toFixed(0),m.gider.toFixed(0),m.kar.toFixed(0),m.margin.toFixed(1),m.roi.toFixed(1),m.perC.toFixed(0),e.addedBy||''].join(',');});
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+[cols.join(','),...rows].join('\n')],{type:'text/csv;charset=utf-8;'}));a.download='spx_etkinlikler.csv';a.click();
  toast('CSV indirildi');
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function nv(id){return parseFloat(document.getElementById(id).value)||0;}
function sv(id,v){const el=document.getElementById(id);if(el)el.textContent=v;}
function applyFilters(){updateDashboard();renderEvents();}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TK='spx:theme';
let isLight=false;

function applyTheme(light){
  isLight=light;
  document.body.classList.toggle('light',light);
  const track=document.getElementById('theme-track');
  const lbl=document.getElementById('theme-lbl-mode');
  if(track)track.classList.toggle('on',light);
  if(lbl)lbl.textContent=light?'A√ßƒ±k':'Koyu';
  lSet(TK,light?'light':'dark');
  // Rebuild charts with new theme colors after short delay
  setTimeout(()=>{
    if(document.getElementById('page-dashboard').classList.contains('active'))updateDashboard();
    if(document.getElementById('page-analysis').classList.contains('active'))renderAnalysis();
  },80);
}

function toggleTheme(){applyTheme(!isLight);}

async function init(){
  const savedTheme=lGet(TK);
  applyTheme(savedTheme==='light');
  const u=lGet(UK)||'';if(u){document.getElementById('username').value=u;username=u;}
  document.getElementById('f-date').valueAsDate=new Date();
  onDateChange();
  await loadData();
  updateDashboard();renderEvents();
  // Auto-sync every 30s
  await loadCalendar();
  initNotifications();
  setInterval(async()=>{await loadData();applyFilters();},30000);
  window.addEventListener('resize',()=>{if(window.innerWidth>768)closeSB();});
}

init();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CK='spx:calendar:v1';
let CAL_EVENTS=[]; // upcoming/planned events (separate from DB financials)
let calYear=new Date().getFullYear();
let calMonth=new Date().getMonth();
let calSelectedDate=null;
let calFilter='all';

async function loadCalendar(){
  try{
    // Try shared storage first (claude.ai), then localStorage
    let raw=null;
    if(window.storage){try{const r=await window.storage.get(CK,true);raw=r?.value;}catch{}}
    if(!raw) raw=localStorage.getItem(CK); // Always check localStorage
    if(raw)CAL_EVENTS=JSON.parse(raw);
    else CAL_EVENTS=[];
  }catch{CAL_EVENTS=[];}
}
async function saveCalendar(){
  const str=JSON.stringify(CAL_EVENTS);
  localStorage.setItem(CK,str); // ALWAYS save to localStorage (cross-device backup)
  if(window.storage){try{await window.storage.set(CK,str,true);}catch{}}
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCalendar(){
  renderMiniCal();
  renderCalStats();
  renderCalendarList();
  // Pre-fill date if a date is selected
  if(calSelectedDate){
    const d=calSelectedDate;
    document.getElementById('cal-date').value=`${d.y}-${String(d.m+1).padStart(2,'0')}-${String(d.d).padStart(2,'0')}`;
  } else {
    document.getElementById('cal-date').valueAsDate=new Date();
  }
}

function renderMiniCal(){
  const MN_TR=['Ocak','≈ûubat','Mart','Nisan','Mayƒ±s','Haziran','Temmuz','Aƒüustos','Eyl√ºl','Ekim','Kasƒ±m','Aralƒ±k'];
  document.getElementById('cal-month-lbl').textContent=MN_TR[calMonth]+' '+calYear;
  const today=new Date();today.setHours(0,0,0,0);
  const firstDay=new Date(calYear,calMonth,1);
  // Monday-first: 0=Mon..6=Sun
  let startDow=firstDay.getDay()-1; if(startDow<0)startDow=6;
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const daysInPrev=new Date(calYear,calMonth,0).getDate();
  // Event dates set for quick lookup
  const eventDates=new Set(CAL_EVENTS.map(e=>{
    const d=new Date(e.date);return`${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
  }));
  let cells='';
  let totalCells=Math.ceil((startDow+daysInMonth)/7)*7;
  for(let i=0;i<totalCells;i++){
    let dayNum,mo=calMonth,yr=calYear,cls='cal-day';
    if(i<startDow){dayNum=daysInPrev-startDow+i+1;mo=calMonth-1;if(mo<0){mo=11;yr=calYear-1;}cls+=' other-month';}
    else if(i>=startDow+daysInMonth){dayNum=i-startDow-daysInMonth+1;mo=calMonth+1;if(mo>11){mo=0;yr=calYear+1;}cls+=' other-month';}
    else{dayNum=i-startDow+1;}
    const thisDate=new Date(yr,mo,dayNum);thisDate.setHours(0,0,0,0);
    const key=`${thisDate.getFullYear()}-${thisDate.getMonth()}-${thisDate.getDate()}`;
    if(thisDate.getTime()===today.getTime())cls+=' today';
    if(calSelectedDate&&calSelectedDate.y===thisDate.getFullYear()&&calSelectedDate.m===thisDate.getMonth()&&calSelectedDate.d===dayNum&&!(i<startDow||i>=startDow+daysInMonth))cls+=' selected';
    if(eventDates.has(key))cls+=' has-event';
    cells+=`<div class="${cls}" onclick="calSelectDay(${thisDate.getFullYear()},${thisDate.getMonth()},${dayNum},${i<startDow||i>=startDow+daysInMonth})"><span class="cal-day-num">${dayNum}</span></div>`;
  }
  document.getElementById('cal-days').innerHTML=cells;
}

function calSelectDay(y,m,d,other){
  if(other){calYear=y;calMonth=m;renderMiniCal();return;}
  calSelectedDate={y,m,d};
  renderMiniCal();
  // Pre-fill form date
  document.getElementById('cal-date').value=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  document.getElementById('cal-name').focus();
  // Scroll to form
  document.querySelector('.cal-form').scrollIntoView({behavior:'smooth',block:'nearest'});
}

function calPrevMonth(){calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderMiniCal();}
function calNextMonth(){calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderMiniCal();}
function calGoToday(){const n=new Date();calYear=n.getFullYear();calMonth=n.getMonth();calSelectedDate=null;renderMiniCal();}

function calSetFilter(f,el){
  calFilter=f;
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderCalendarList();
}

function renderCalStats(){
  const now=new Date();now.setHours(0,0,0,0);
  const upcoming=CAL_EVENTS.filter(e=>new Date(e.date)>=now&&e.status!=='cancelled');
  const in7=upcoming.filter(e=>{const diff=(new Date(e.date)-now)/86400000;return diff<=7;});
  const in30=upcoming.filter(e=>{const diff=(new Date(e.date)-now)/86400000;return diff<=30;});
  const confirmed=CAL_EVENTS.filter(e=>e.status==='confirmed'&&new Date(e.date)>=now);
  document.getElementById('cal-stats-strip').innerHTML=`
    <div class="kc bl"><div class="kl">Toplam Planlanan</div><div class="kv">${CAL_EVENTS.length}</div><div class="ks">${upcoming.length} yakla≈üan etkinlik</div></div>
    <div class="kc ro"><div class="kl">7 G√ºn ƒ∞√ßinde</div><div class="kv" style="color:${in7.length>0?'var(--rose)':'var(--t2)'}">${in7.length}</div><div class="ks">Kritik yakla≈üan</div></div>
    <div class="kc am"><div class="kl">30 G√ºn ƒ∞√ßinde</div><div class="kv" style="color:${in30.length>0?'var(--amber)':'var(--t2)'}">${in30.length}</div><div class="ks">Bu ay i√ßinde</div></div>
    <div class="kc gn"><div class="kl">Onaylandƒ±</div><div class="kv" style="color:var(--green)">${confirmed.length}</div><div class="ks">Kesinle≈ümi≈ü etkinlik</div></div>`;
}

function renderCalendarList(){
  const q=(document.getElementById('cal-search').value||'').toLowerCase();
  const now=new Date();now.setHours(0,0,0,0);
  let evs=[...CAL_EVENTS].sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(q)evs=evs.filter(e=>e.name.toLowerCase().includes(q)||(e.city||'').toLowerCase().includes(q)||(e.type||'').toLowerCase().includes(q));
  if(calFilter==='upcoming')evs=evs.filter(e=>new Date(e.date)>=now);
  else if(calFilter==='past')evs=evs.filter(e=>new Date(e.date)<now);
  document.getElementById('cal-badge').textContent=`(${evs.length})`;
  if(!evs.length){
    document.getElementById('cal-event-list').innerHTML=`<div class="empty">Etkinlik bulunamadƒ±.<br><span style="font-size:11px">Sol formu kullanarak yeni etkinlik ekleyin.</span></div>`;
    return;
  }
  const MN=['Oca','≈ûub','Mar','Nis','May','Haz','Tem','Aƒüu','Eyl','Eki','Kas','Ara'];
  // Group by month
  const groups={};
  evs.forEach(e=>{
    const d=new Date(e.date);
    const key=`${d.getFullYear()}-${String(d.getMonth()).padStart(2,'0')}`;
    if(!groups[key])groups[key]={label:MN[d.getMonth()]+' '+d.getFullYear(),items:[]};
    groups[key].items.push(e);
  });
  let html='<div class="cal-timeline">';
  Object.entries(groups).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([k,g])=>{
    html+=`<div class="timeline-label">${g.label}</div>`;
    g.items.forEach(e=>html+=buildEvItem(e,now,MN));
  });
  html+='</div>';
  document.getElementById('cal-event-list').innerHTML=html;
}

function buildEvItem(e,now,MN){
  const d=new Date(e.date);d.setHours(0,0,0,0);
  const diff=Math.round((d-now)/86400000);
  const dayNum=d.getDate();
  const mon=MN[d.getMonth()];
  // Badge class
  let bdgCls='ev-date-badge';
  if(diff<0)bdgCls+=' past';
  else if(diff===0)bdgCls+=' today-badge';
  else if(diff<=7)bdgCls+=' soon';
  // Countdown
  let countdown='',cntCls='ev-countdown';
  if(diff<0){countdown=Math.abs(diff)+'g √∂nce';cntCls+=' urgency-past';}
  else if(diff===0){countdown='BUG√úN';cntCls+=' urgency-7';}
  else if(diff<=7){countdown=diff+'g kaldƒ±';cntCls+=' urgency-7';}
  else if(diff<=30){countdown=diff+'g kaldƒ±';cntCls+=' urgency-30';}
  else{countdown=diff+'g kaldƒ±';cntCls+=' urgency-future';}
  // Status badge
  const statusMap={planned:'Planlandƒ±',confirmed:'‚úÖ Onaylandƒ±',tentative:'‚ùì Belirsiz',cancelled:'üö´ ƒ∞ptal'};
  const statusCol={planned:'var(--t3)',confirmed:'var(--green)',tentative:'var(--amber)',cancelled:'var(--rose)'};
  // status styling handled inline below
  const safeId=e.id.replace(/'/g,"\\'");
  return `<div class="ev-item" onclick="calItemClick('${safeId}')">
    <div class="${bdgCls}">
      <div class="ev-date-day">${dayNum}</div>
      <div class="ev-date-month">${mon}</div>
    </div>
    <div class="ev-info">
      <div class="ev-name" title="${e.name}">${e.name}</div>
      <div class="ev-meta">
        ${e.city?'üìç '+e.city:''}
        ${e.type?'¬∑ '+e.type:''}
        ${e.participants>0?'¬∑ üë• '+fn(e.participants):''}
        ${e.endDate?'¬∑ Biti≈ü: '+e.endDate:''}
      </div>
      <div class="ev-tags">
        ${e.status&&e.status!=='planned'?`<span class="ev-tag" style="background:${e.status==='confirmed'?'rgba(16,185,129,.12)':e.status==='tentative'?'rgba(245,158,11,.12)':'rgba(244,63,94,.12)'};color:${statusCol[e.status]||'var(--t3)'}">${statusMap[e.status]||e.status}</span>`:''}
        ${e.note?`<span class="ev-tag ev-tag-note" title="${e.note}">üìù ${e.note}</span>`:''}
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;flex-shrink:0">
      <div class="${cntCls}">${countdown}</div>
      <div class="ev-actions">
        <button class="rab rab-e" title="D√ºzenle" onclick="calOpenEdit('${safeId}',event)">‚úé</button>
        <button class="rab rab-d" title="Sil" onclick="calDeleteEv('${safeId}',event)">‚úï</button>
      </div>
    </div>
  </div>`;
}

function calItemClick(id){
  // Fill form with this event for quick edit
  calOpenEdit(id,{stopPropagation:()=>{}});
}

// ‚îÄ‚îÄ ADD EVENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function calSaveEvent(){
  const name=(document.getElementById('cal-name').value||'').trim();
  const date=document.getElementById('cal-date').value;
  if(!name||!date){toast('Etkinlik adƒ± ve tarih zorunludur','err');return;}
  const editId=document.getElementById('cal-edit-id').value;
  if(editId){
    // Update inline
    const idx=CAL_EVENTS.findIndex(e=>e.id===editId);
    if(idx>=0){
      CAL_EVENTS[idx]={...CAL_EVENTS[idx],
        name,date,
        endDate:document.getElementById('cal-end-date').value||'',
        city:(document.getElementById('cal-city').value||'').trim(),
        type:document.getElementById('cal-type').value,
        participants:parseFloat(document.getElementById('cal-participants').value)||0,
        note:(document.getElementById('cal-note').value||'').trim(),
        updatedAt:new Date().toISOString()
      };
      toast('‚úì G√ºncellendi: '+name);
    }
    calCancelEdit();
  } else {
    const ev={
      id:'c'+Date.now(),name,date,
      endDate:document.getElementById('cal-end-date').value||'',
      city:(document.getElementById('cal-city').value||'').trim(),
      type:document.getElementById('cal-type').value,
      participants:parseFloat(document.getElementById('cal-participants').value)||0,
      note:(document.getElementById('cal-note').value||'').trim(),
      status:'planned',
      createdAt:new Date().toISOString()
    };
    CAL_EVENTS.push(ev);
    toast('‚úì Takvime eklendi: '+name);
    // Update mini calendar for new month if needed
    const nd=new Date(date);calYear=nd.getFullYear();calMonth=nd.getMonth();
    calClearForm();
  }
  await saveCalendar();
  renderCalendar();
}

function calClearForm(){
  document.getElementById('cal-name').value='';
  document.getElementById('cal-end-date').value='';
  document.getElementById('cal-city').value='';
  document.getElementById('cal-participants').value='';
  document.getElementById('cal-note').value='';
  document.getElementById('cal-type').value='Yarƒ± Maraton';
  document.getElementById('cal-date').valueAsDate=new Date();
  calSelectedDate=null;
}

// ‚îÄ‚îÄ INLINE EDIT (fill left form) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calOpenEdit(id,e){
  if(e&&e.stopPropagation)e.stopPropagation();
  const ev=CAL_EVENTS.find(x=>x.id===id);if(!ev)return;
  document.getElementById('cal-edit-id').value=ev.id;
  document.getElementById('cal-name').value=ev.name;
  document.getElementById('cal-date').value=ev.date;
  document.getElementById('cal-end-date').value=ev.endDate||'';
  document.getElementById('cal-city').value=ev.city||'';
  document.getElementById('cal-type').value=ev.type||'Diƒüer';
  document.getElementById('cal-participants').value=ev.participants||'';
  document.getElementById('cal-note').value=ev.note||'';
  document.getElementById('cal-form-title-txt').textContent='‚úé Etkinliƒüi D√ºzenle';
  document.getElementById('cal-save-btn').textContent='‚úì G√ºncelle';
  document.getElementById('cal-cancel-btn').style.display='flex';
  // Navigate calendar to event month
  const d=new Date(ev.date);calYear=d.getFullYear();calMonth=d.getMonth();
  calSelectedDate={y:d.getFullYear(),m:d.getMonth(),d:d.getDate()};
  renderMiniCal();
  // Scroll to form
  document.querySelector('.cal-form').scrollIntoView({behavior:'smooth',block:'start'});
}

function calCancelEdit(){
  document.getElementById('cal-edit-id').value='';
  document.getElementById('cal-form-title-txt').textContent='Ôºã Yeni Etkinlik Ekle';
  document.getElementById('cal-save-btn').textContent='Ôºã Ekle';
  document.getElementById('cal-cancel-btn').style.display='none';
  calClearForm();
}

// ‚îÄ‚îÄ MODAL EDIT (alternative detailed edit) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calOpenModalEdit(id){
  const ev=CAL_EVENTS.find(x=>x.id===id);if(!ev)return;
  document.getElementById('mce-id').value=ev.id;
  document.getElementById('mce-name').value=ev.name;
  document.getElementById('mce-date').value=ev.date;
  document.getElementById('mce-end-date').value=ev.endDate||'';
  document.getElementById('mce-city').value=ev.city||'';
  document.getElementById('mce-type').value=ev.type||'Diƒüer';
  document.getElementById('mce-participants').value=ev.participants||'';
  document.getElementById('mce-status').value=ev.status||'planned';
  document.getElementById('mce-note').value=ev.note||'';
  document.getElementById('modal-cal-edit').classList.add('open');
}
async function calSaveModalEdit(){
  const id=document.getElementById('mce-id').value;
  const name=(document.getElementById('mce-name').value||'').trim();
  const date=document.getElementById('mce-date').value;
  if(!name||!date){toast('Ad ve tarih zorunludur','err');return;}
  const idx=CAL_EVENTS.findIndex(e=>e.id===id);
  if(idx<0){toast('Etkinlik bulunamadƒ±','err');return;}
  CAL_EVENTS[idx]={...CAL_EVENTS[idx],name,date,
    endDate:document.getElementById('mce-end-date').value||'',
    city:(document.getElementById('mce-city').value||'').trim(),
    type:document.getElementById('mce-type').value,
    participants:parseFloat(document.getElementById('mce-participants').value)||0,
    status:document.getElementById('mce-status').value,
    note:(document.getElementById('mce-note').value||'').trim(),
    updatedAt:new Date().toISOString()
  };
  await saveCalendar();
  closeModal('modal-cal-edit');
  renderCalendar();
  toast('‚úì G√ºncellendi: '+name);
}

async function calDeleteEv(id,e){
  if(e)e.stopPropagation();
  const ev=CAL_EVENTS.find(x=>x.id===id);if(!ev)return;
  if(!confirm(`"${ev.name}" etkinliƒüini silmek istiyor musunuz?`))return;
  CAL_EVENTS=CAL_EVENTS.filter(x=>x.id!==id);
  await saveCalendar();
  renderCalendar();
  toast('Etkinlik silindi');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORECAST ENGINE ‚Äî 2026 Predictive Profitability Model
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getForecastData(){
  const evs2024=DB.filter(e=>e.year===2024).map(e=>({...e,...calc(e)}));
  const evs2025=DB.filter(e=>e.year===2025).map(e=>({...e,...calc(e)}));
  const sum=(arr,key)=>arr.reduce((a,b)=>a+(b[key]||0),0);
  const tot24={ciro:sum(evs2024,'ciro'),gider:sum(evs2024,'gider'),kar:sum(evs2024,'kar'),count:evs2024.length,parts:sum(evs2024,'participants')};
  const tot25={ciro:sum(evs2025,'ciro'),gider:sum(evs2025,'gider'),kar:sum(evs2025,'kar'),count:evs2025.length,parts:sum(evs2025,'participants')};
  const gr=(a,b)=>a>0?(b-a)/a:0.2;
  const ciroGr=gr(tot24.ciro,tot25.ciro);
  const giderGr=gr(tot24.gider,tot25.gider);
  const cntGr=gr(tot24.count,tot25.count);
  const partsGr=gr(tot24.parts,tot25.parts);
  const proj26cnt=Math.round(tot25.count*(1+Math.min(cntGr,0.4)));
  const nc=tot25.ciro*(1+ciroGr), ng=tot25.gider*(1+giderGr);
  const norm={ciro:nc,gider:ng,kar:nc-ng,count:proj26cnt};
  const pess={ciro:nc*0.90,gider:ng*1.05,kar:nc*0.90-ng*1.05,count:Math.round(proj26cnt*0.90)};
  const opti={ciro:nc*1.15,gider:ng*1.08,kar:nc*1.15-ng*1.08,count:Math.round(proj26cnt*1.15)};
  return{tot24,tot25,ciroGr,giderGr,cntGr,partsGr,norm,pess,opti,evs2024,evs2025};
}

function renderForecast(){
  const d=getForecastData();
  const{tot24,tot25,ciroGr,giderGr,cntGr,partsGr,norm,pess,opti,evs2024,evs2025}=d;

  // Growth rate cards
  document.getElementById('forecast-growth-cards').innerHTML=[
    {lbl:'Ciro B√ºy√ºme Oranƒ±',val:(ciroGr*100).toFixed(1)+'%',sub:'2024 ‚Üí 2025 ger√ßek b√ºy√ºme',col:'var(--green)',fill:Math.min(100,Math.abs(ciroGr)*200)},
    {lbl:'Gider B√ºy√ºme Oranƒ±',val:(giderGr*100).toFixed(1)+'%',sub:'2024 ‚Üí 2025 ger√ßek b√ºy√ºme',col:'var(--amber)',fill:Math.min(100,Math.abs(giderGr)*200)},
    {lbl:'Etkinlik Sayƒ±sƒ± Artƒ±≈üƒ±',val:'+'+(cntGr*100).toFixed(0)+'%',sub:`${tot24.count} ‚Üí ${tot25.count} etkinlik`,col:'var(--blue2)',fill:Math.min(100,cntGr*200)},
    {lbl:'Katƒ±lƒ±mcƒ± Artƒ±≈üƒ±',val:'+'+(partsGr*100).toFixed(0)+'%',sub:'2024 ‚Üí 2025 b√ºy√ºme',col:'var(--violet)',fill:Math.min(100,partsGr*200)},
  ].map(g=>`<div class="growth-card">
    <div class="growth-num" style="color:${g.col}">${g.val}</div>
    <div class="growth-lbl">${g.lbl}</div>
    <div style="font-size:11px;color:var(--t3);margin-top:2px">${g.sub}</div>
    <div class="growth-bar" style="margin-top:10px"><div class="growth-fill" style="width:${g.fill}%;background:${g.col}"></div></div>
  </div>`).join('');

  // Exec summary
  const margN=norm.ciro>0?(norm.kar/norm.ciro*100).toFixed(1):0;
  const roiN=norm.gider>0?(norm.kar/norm.gider*100).toFixed(1):0;
  document.getElementById('forecast-exec-summary').innerHTML=`
    <div class="exec-summary-title">üìã Y√∂netici √ñzeti ‚Äî 2026 Projeksiyon</div>
    <div class="exec-bullet">2025 toplam cirosu <span class="highlight-g">${fc(tot25.ciro)}</span> olarak ger√ßekle≈üti. Normal senaryoda 2026 tahmini <span class="highlight">${fc(norm.ciro)}</span>, b√ºy√ºme oranƒ± <span class="highlight-g">%${(ciroGr*100).toFixed(1)}</span>'dir.</div>
    <div class="exec-bullet">Gider artƒ±≈ü hƒ±zƒ± (%${(giderGr*100).toFixed(1)}) ciro b√ºy√ºmesinin ${giderGr>ciroGr?'<span class="highlight-r">√ºzerinde</span> ‚Äî maliyet kontrol√º kritik √∂neme sahip':'<span class="highlight-g">altƒ±nda</span> ‚Äî saƒülƒ±klƒ± yapƒ± korunuyor'}.</div>
    <div class="exec-bullet">Normal senaryoda kar marjƒ± <span class="highlight">%${margN}</span>, ROI <span class="highlight">%${roiN}</span> √∂ng√∂r√ºlmektedir. ƒ∞yimser senaryo: <span class="highlight-g">${fc(opti.kar)}</span>, K√∂t√ºmser: <span class="highlight-r">${fc(pess.kar)}</span>.</div>
    <div class="exec-bullet">Senaryo aralƒ±ƒüƒ± (fark) <span class="highlight-a">${fc(opti.kar-pess.kar)}</span>. Y√ºksek ROI'li ≈üehirlere odaklanƒ±lmasƒ± ve ajans maliyetlerinin optimize edilmesi 2026 i√ßin kritik √∂nerildir.</div>`;

  // Scenario cards
  const scenarios=[
    {cls:'pessimist',bdg:'bad',bdgTxt:'K√ñT√úMSER',icon:'üìâ',desc:'-10% Katƒ±lƒ±mcƒ± Etkisi',s:pess,adj:`-10% ciro, +5% gider varsayƒ±mƒ±`},
    {cls:'normal',bdg:'mid',bdgTxt:'NORMAL',icon:'üìä',desc:'Mevcut Trend Devam',s:norm,adj:`+${(ciroGr*100).toFixed(0)}% ciro, +${(giderGr*100).toFixed(0)}% gider`},
    {cls:'optimist',bdg:'good',bdgTxt:'ƒ∞Yƒ∞MSER',icon:'üìà',desc:'+15% Katƒ±lƒ±mcƒ± Artƒ±≈üƒ±',s:opti,adj:'+15% ciro, +8% gider artƒ±≈üƒ±'},
  ];
  document.getElementById('forecast-scenarios').innerHTML=scenarios.map(sc=>{
    const mg=sc.s.ciro>0?(sc.s.kar/sc.s.ciro*100).toFixed(1):0;
    const ri=sc.s.gider>0?(sc.s.kar/sc.s.gider*100).toFixed(1):0;
    const vs=sc.s.kar-tot25.kar;
    return`<div class="scenario-card ${sc.cls}">
      <span class="sc-badge ${sc.bdg}">${sc.bdgTxt}</span>
      <div style="font-size:18px;font-weight:600;margin-bottom:4px">${sc.icon} ${sc.desc}</div>
      <div style="font-size:11px;color:var(--t3);font-family:'DM Mono',monospace;margin-bottom:14px">${sc.adj}</div>
      <div class="sc-metrics">
        <div class="sc-metric"><span class="sc-metric-l">Toplam Ciro</span><span class="sc-metric-v" style="color:var(--blue2)">${fc(sc.s.ciro)}</span></div>
        <div class="sc-metric"><span class="sc-metric-l">Toplam Gider</span><span class="sc-metric-v" style="color:var(--amber)">${fc(sc.s.gider)}</span></div>
        <div class="sc-metric"><span class="sc-metric-l">Net Kar</span><span class="sc-metric-v" style="color:${sc.s.kar>=0?'var(--green)':'var(--rose)'}">${fc(sc.s.kar)}</span></div>
        <div class="sc-divider"></div>
        <div class="sc-metric"><span class="sc-metric-l">Kar Marjƒ±</span><span class="sc-metric-v">${mg}%</span></div>
        <div class="sc-metric"><span class="sc-metric-l">ROI</span><span class="sc-metric-v">${ri}%</span></div>
        <div class="sc-metric"><span class="sc-metric-l">Etkinlik Sayƒ±sƒ±</span><span class="sc-metric-v">${sc.s.count}</span></div>
      </div>
      <div class="sc-divider"></div>
      <div class="sc-delta"><span class="${vs>=0?'delta-up':'delta-dn'}">${vs>=0?'‚ñ≤':'‚ñº'} ${fc(Math.abs(vs))}</span><span style="color:var(--t3);margin-left:6px;font-size:11px">2025'e g√∂re</span></div>
    </div>`;
  }).join('');

  // Chart: scenario comparison
  dc('fscen');
  CH.fscen=new Chart(document.getElementById('cForecastScenario'),{type:'bar',data:{
    labels:['K√∂t√ºmser','Normal','ƒ∞yimser'],
    datasets:[
      {label:'Ciro',data:[pess.ciro,norm.ciro,opti.ciro],backgroundColor:['rgba(244,63,94,.55)','rgba(59,130,246,.65)','rgba(16,185,129,.55)'],borderRadius:7,order:2},
      {label:'Gider',data:[pess.gider,norm.gider,opti.gider],backgroundColor:['rgba(244,63,94,.25)','rgba(59,130,246,.25)','rgba(16,185,129,.25)'],borderRadius:7,order:2},
      {label:'Net Kar',data:[pess.kar,norm.kar,opti.kar],type:'line',borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.1)',borderWidth:2.5,pointRadius:6,pointBackgroundColor:'#f59e0b',tension:.3,order:1,fill:false},
    ]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  // Chart: 2024‚Üí2025‚Üí2026 trend
  dc('ftrend');
  CH.ftrend=new Chart(document.getElementById('cForecastTrend'),{type:'line',data:{
    labels:['2024 Ger√ßek','2025 Ger√ßek','2026 K√∂t√ºmser','2026 Normal','2026 ƒ∞yimser'],
    datasets:[
      {label:'Ciro',data:[tot24.ciro,tot25.ciro,pess.ciro,norm.ciro,opti.ciro],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.08)',borderWidth:2.5,pointRadius:5,tension:.35,fill:true,pointBackgroundColor:(ctx)=>ctx.dataIndex>=2?'rgba(59,130,246,.4)':'#3b82f6',pointBorderDash:(ctx)=>ctx.dataIndex>=2?[4,3]:[]},
      {label:'Net Kar',data:[tot24.kar,tot25.kar,pess.kar,norm.kar,opti.kar],borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.06)',borderWidth:2.5,pointRadius:5,tension:.35,fill:true,pointBackgroundColor:(ctx)=>ctx.dataIndex>=2?'rgba(16,185,129,.4)':'#10b981'},
    ]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  // City forecast table
  const cityMap={};
  [...evs2024,...evs2025].forEach(e=>{
    if(!cityMap[e.city])cityMap[e.city]={c24:0,c25:0};
    if(e.year===2024)cityMap[e.city].c24+=e.ciro;
    else cityMap[e.city].c25+=e.ciro;
  });
  document.getElementById('forecast-city-tbody').innerHTML=Object.entries(cityMap)
    .filter(([c,v])=>v.c25>0).sort((a,b)=>b[1].c25-a[1].c25)
    .map(([city,v])=>{
      const gr=v.c24>0?(v.c25-v.c24)/v.c24:0.2;
      const n26=v.c25*(1+ciroGr); const o26=n26*1.15;
      const strat=gr>0.3?'üöÄ Geni≈ület':gr>0.1?'‚úÖ S√ºrd√ºr':'‚ö†Ô∏è ƒ∞zle';
      const col=gr>0.3?'var(--green)':gr>0.1?'var(--blue2)':'var(--amber)';
      return`<tr><td class="nm">${city}</td><td class="mo">${fc(v.c25)}</td><td class="mo" style="color:var(--blue2)">${fc(n26)}</td><td class="mo" style="color:var(--green)">${fc(o26)}</td><td class="mo" style="color:${col}">${gr>=0?'+':''}${(gr*100).toFixed(0)}%</td><td>${strat}</td></tr>`;
    }).join('');

  // Monthly seasonality chart
  const mBase=Array(12).fill(0);
  evs2025.forEach(e=>{if(!e.date)return;const m=new Date(e.date).getMonth();mBase[m]+=e.ciro;});
  const mTot=mBase.reduce((a,b)=>a+b,0)||1;
  const mW=mBase.map(v=>v/mTot);
  const MN=['Oca','≈ûub','Mar','Nis','May','Haz','Tem','Aƒüu','Eyl','Eki','Kas','Ara'];
  dc('fmonthly');
  CH.fmonthly=new Chart(document.getElementById('cForecastMonthly'),{type:'bar',data:{
    labels:MN,
    datasets:[
      {label:'2025 Ger√ßek',data:mBase,backgroundColor:'rgba(59,130,246,.35)',borderRadius:4,order:2},
      {label:'2026 Normal Tahmin',data:mW.map(w=>w*norm.ciro),backgroundColor:'rgba(16,185,129,.55)',borderRadius:4,order:2},
      {label:'2026 ƒ∞yimser',type:'line',data:mW.map(w=>w*opti.ciro),borderColor:'#22d3ee',borderWidth:2,pointRadius:3,tension:.4,order:1,fill:false},
    ]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  document.getElementById('forecast-assumptions').innerHTML=`
    <div style="line-height:2;font-size:12px;color:var(--t2)">
      <div>‚Ä¢ Ciro b√ºy√ºme hƒ±zƒ±: <span class="highlight">%${(ciroGr*100).toFixed(1)}</span> (2024‚Üí2025 ge√ßmi≈ü verisi)</div>
      <div>‚Ä¢ Gider artƒ±≈ü hƒ±zƒ±: <span class="highlight-a">%${(giderGr*100).toFixed(1)}</span> (2024‚Üí2025 ge√ßmi≈ü verisi)</div>
      <div>‚Ä¢ Sezonalite daƒüƒ±lƒ±mƒ± 2025 aylƒ±k verilerinden t√ºretildi</div>
      <div>‚Ä¢ ≈ûehir b√ºy√ºme oranlarƒ± m√ºnferiden hesaplandƒ±</div>
      <div>‚Ä¢ Model; d√∂viz ≈üoklarƒ± ve siyasi belirsizlikleri kapsamamaktadƒ±r</div>
    </div>`;
  document.getElementById('forecast-risks').innerHTML=`
    <div style="line-height:2;font-size:12px;color:var(--t2)">
      <div>${giderGr>ciroGr?'‚ö†Ô∏è Gider artƒ±≈üƒ± ciro b√ºy√ºmesini <span class="highlight-r">a≈üƒ±yor</span> ‚Äî maliyet kontrol√º kritik':'‚úÖ Gider artƒ±≈üƒ± ciro b√ºy√ºmesinin <span class="highlight-g">altƒ±nda</span> ‚Äî saƒülƒ±klƒ± yapƒ±'}</div>
      <div>üéØ En b√ºy√ºk fƒ±rsat: <span class="highlight-g">ƒ∞stanbul ve Antalya</span> portf√∂y√ºn√º geni≈ületmek</div>
      <div>üìâ Risk: D√º≈ü√ºk katƒ±lƒ±mlƒ± etkinliklerde y√ºksek sabit gider y√ºk√º</div>
      <div>üí° √ñneri: Y√ºksek ROI'li ≈üehirlere aƒüƒ±rlƒ±k ver, ajans maliyetini %10 kƒ±s</div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI SCORE ENGINE ‚Äî Katƒ±l / Katƒ±lma Karar Sistemi
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AI_W={roi:0.30,participants:0.20,city:0.15,weather:0.10,agency:0.10,brand:0.15};
const FM={
  roi:{name:'Ge√ßmi≈ü ROI',icon:'üìà',wlbl:'%30',col:'var(--green)'},
  participants:{name:'Katƒ±lƒ±mcƒ± Sayƒ±sƒ±',icon:'üë•',wlbl:'%20',col:'var(--blue2)'},
  city:{name:'≈ûehir Performansƒ±',icon:'üèô',wlbl:'%15',col:'var(--violet)'},
  weather:{name:'Hava Ko≈üulu',icon:'üå§',wlbl:'%10',col:'var(--cyan)'},
  agency:{name:'Ajans Maliyeti',icon:'üíº',wlbl:'%10',col:'var(--amber)'},
  brand:{name:'Marka G√∂r√ºn√ºrl√ºƒü√º',icon:'‚≠ê',wlbl:'%15',col:'var(--rose)'},
};

function computeAiScores(){
  const evs=DB.map(e=>({...e,...calc(e)}));
  if(!evs.length)return[];

  // City avg roi
  const cityR={};
  evs.forEach(e=>{if(!cityR[e.city])cityR[e.city]=[];if(e.gider>0)cityR[e.city].push(e.roi);});
  const cityAvg={};
  Object.entries(cityR).forEach(([c,arr])=>{cityAvg[c]=arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;});

  const rois=evs.filter(e=>e.gider>0).map(e=>e.roi);
  const parts=evs.filter(e=>e.participants>0).map(e=>e.participants);
  const agencies=evs.filter(e=>e.agency>0).map(e=>e.agency);
  const maxRoi=Math.max(...rois,1);const minRoi=Math.min(...rois,0);
  const maxParts=Math.max(...parts,1);
  const maxAgency=Math.max(...agencies,1);
  const roiRange=maxRoi-minRoi||1;

  const cityVals=Object.values(cityAvg);
  const maxCity=Math.max(...cityVals,1);const minCity=Math.min(...cityVals,0);
  const cityRange=maxCity-minCity||1;

  return evs.map(e=>{
    const roiScore=e.gider>0?Math.min(100,Math.max(0,((e.roi-minRoi)/roiRange)*100)):25;
    const partScore=e.participants>0?Math.min(100,(Math.log(e.participants)/Math.log(maxParts))*100):20;
    const cAvg=cityAvg[e.city]||0;
    const cityScore=Math.min(100,Math.max(0,((cAvg-minCity)/cityRange)*100));
    const wx=parseWx(e.weather);
    let wxScore=50;
    if(wx.cond){const c=wx.cond.toLowerCase();if(c.includes('g√ºne≈ü')||c.includes('a√ßƒ±k'))wxScore=88;else if(c.includes('bulut'))wxScore=60;else if(c.includes('yaƒümur')||c.includes('fƒ±rtƒ±na'))wxScore=22;}
    const agencyScore=e.agency>0?Math.min(100,Math.max(0,(1-(e.agency/maxAgency))*100)):68;
    const brandBase=e.participants>0&&e.ciro>0?e.ciro/e.participants:0;
    const maxBrand=evs.filter(x=>x.participants>0&&x.ciro>0).reduce((a,x)=>Math.max(a,x.ciro/x.participants),1);
    const brandScore=Math.min(100,brandBase>0?(brandBase/maxBrand)*100:28);

    const comps={roi:roiScore,participants:partScore,city:cityScore,weather:wxScore,agency:agencyScore,brand:brandScore};
    const total=Object.entries(comps).reduce((sum,[k,v])=>sum+v*AI_W[k],0);
    const sorted=Object.entries(comps).sort((a,b)=>b[1]-a[1]);
    return{...e,aiScore:Math.round(total),comps,topFactor:sorted[0][0],botFactor:sorted[sorted.length-1][0]};
  });
}

function getRec(score){
  if(score>=80)return{cls:'rec-go',txt:'‚úÖ Kesin Katƒ±l',col:'var(--green)'};
  if(score>=60)return{cls:'rec-cond',txt:'‚ö° ≈ûartlƒ± Katƒ±l',col:'var(--blue2)'};
  if(score>=40)return{cls:'rec-risk',txt:'‚ö†Ô∏è Riskli',col:'var(--amber)'};
  return{cls:'rec-no',txt:'üö´ Katƒ±lma',col:'var(--rose)'};
}

function renderAiScore(){
  const scored=computeAiScores();
  if(!scored.length)return;

  // Populate year filter
  const yrs=[...new Set(scored.map(e=>e.year))].sort((a,b)=>b-a);
  const ayf=document.getElementById('ai-year-filter');
  const cur=ayf.value;
  ayf.innerHTML='<option value="all">T√ºm Yƒ±llar</option>'+yrs.map(y=>`<option value="${y}"${String(y)===cur?' selected':''}>${y}</option>`).join('');

  // Weight grid
  document.getElementById('ai-weights-grid').innerHTML=Object.entries(FM).map(([k,m])=>`
    <div class="weight-item">
      <div class="weight-icon">${m.icon}</div>
      <div class="weight-pct" style="color:${m.col}">${m.wlbl}</div>
      <div class="weight-name">${m.name}</div>
    </div>`).join('');

  // KPI row
  const goC=scored.filter(e=>e.aiScore>=80).length;
  const condC=scored.filter(e=>e.aiScore>=60&&e.aiScore<80).length;
  const riskC=scored.filter(e=>e.aiScore>=40&&e.aiScore<60).length;
  const noC=scored.filter(e=>e.aiScore<40).length;
  const avg=scored.reduce((a,b)=>a+b.aiScore,0)/scored.length;
  const topEv=[...scored].sort((a,b)=>b.aiScore-a.aiScore)[0];
  document.getElementById('ai-kpi-row').innerHTML=`
    <div class="kc gn"><div class="kl">Ortalama AI Skoru</div><div class="kv">${avg.toFixed(0)}<span style="font-size:13px">/100</span></div><div class="ks">${scored.length} etkinlik analiz edildi</div></div>
    <div class="kc bl"><div class="kl">‚úÖ Kesin Katƒ±l</div><div class="kv" style="color:var(--green)">${goC}</div><div class="ks">Skor ‚â• 80</div></div>
    <div class="kc am"><div class="kl">‚ö° ≈ûartlƒ± / ‚ö†Ô∏è Riskli</div><div class="kv" style="color:var(--amber)">${condC+riskC}</div><div class="ks">Skor 40‚Äì80</div></div>
    <div class="kc ro"><div class="kl">üö´ Katƒ±lma</div><div class="kv" style="color:var(--rose)">${noC}</div><div class="ks">Skor &lt; 40</div></div>`;

  // Exec summary
  const cityS={};
  scored.forEach(e=>{if(!cityS[e.city])cityS[e.city]=[];cityS[e.city].push(e.aiScore);});
  const topCity=Object.entries(cityS).map(([c,arr])=>({c,avg:arr.reduce((a,b)=>a+b,0)/arr.length})).sort((a,b)=>b.avg-a.avg)[0];
  const botMap={};scored.forEach(e=>{botMap[e.botFactor]=(botMap[e.botFactor]||0)+1;});
  const botKey=Object.entries(botMap).sort((a,b)=>b[1]-a[1])[0]?.[0]||'roi';
  document.getElementById('ai-exec-summary').innerHTML=`
    <div class="exec-summary-title">ü§ñ AI Analiz √ñzeti ‚Äî Y√∂netici Raporu</div>
    <div class="exec-bullet">Portf√∂y√ºn <span class="highlight-g">%${((goC/scored.length)*100).toFixed(0)}'ƒ±</span> "Kesin Katƒ±l" e≈üiƒüini ge√ßmekte, <span class="highlight-r">%${((noC/scored.length)*100).toFixed(0)}'ƒ±</span> ise "Katƒ±lma" b√∂lgesinde kalmaktadƒ±r.</div>
    <div class="exec-bullet">En y√ºksek AI skoru: <span class="highlight">${topEv.name}</span> ‚Äî Skor: <span class="highlight-g">${topEv.aiScore}/100</span>. ${getRec(topEv.aiScore).txt}</div>
    <div class="exec-bullet">Stratejik √∂ncelikli ≈üehir: <span class="highlight">${topCity?.c||'‚Äî'}</span> (Ort. Skor: <span class="highlight-g">${topCity?.avg.toFixed(0)||'‚Äî'}/100</span>). Bu ≈üehirde etkinlik sayƒ±sƒ±nƒ± artƒ±rmanƒ±z tavsiye edilir.</div>
    <div class="exec-bullet">Skoru en √ßok d√º≈ü√ºren fakt√∂r: <span class="highlight-r">${FM[botKey]?.icon} ${FM[botKey]?.name}</span> (${botMap[botKey]} etkinlikte zayƒ±f halka). Bu alanda aksiyon alƒ±nmasƒ± ROI'yi doƒürudan iyile≈ütirecektir.</div>`;

  // Score distribution chart (top 14)
  const top14=[...scored].sort((a,b)=>b.aiScore-a.aiScore).slice(0,14);
  dc('aiDist');
  CH.aiDist=new Chart(document.getElementById('cAiScoreDist'),{type:'bar',data:{
    labels:top14.map(e=>e.name.substring(0,13)+(e.name.length>13?'‚Ä¶':'')),
    datasets:[{label:'AI Skor',data:top14.map(e=>e.aiScore),
      backgroundColor:top14.map(e=>e.aiScore>=80?'rgba(16,185,129,.75)':e.aiScore>=60?'rgba(59,130,246,.75)':e.aiScore>=40?'rgba(245,158,11,.75)':'rgba(244,63,94,.75)'),
      borderRadius:5}]
  },options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),max:100},y:AX()}}});

  // Factor radar
  const factorAvg=Object.keys(AI_W).map(k=>({k,avg:scored.reduce((a,e)=>a+e.comps[k],0)/scored.length}));
  dc('aiFactors');
  CH.aiFactors=new Chart(document.getElementById('cAiFactors'),{type:'radar',data:{
    labels:factorAvg.map(f=>FM[f.k].icon+' '+FM[f.k].name),
    datasets:[{label:'Ort. Fakt√∂r Skoru',data:factorAvg.map(f=>f.avg),
      backgroundColor:'rgba(59,130,246,.12)',borderColor:'var(--blue)',borderWidth:2,
      pointBackgroundColor:factorAvg.map(f=>FM[f.k].col),pointRadius:5}]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},
    scales:{r:{min:0,max:100,ticks:{color:'#4d6080',font:{family:'DM Mono',size:9},stepSize:25},
      grid:{color:'rgba(59,130,246,.08)'},
      pointLabels:{color:'#8da0bf',font:{family:'DM Sans',size:11}}}}}});

  // City strategy grid
  document.getElementById('ai-city-grid').innerHTML=Object.entries(cityS)
    .map(([c,arr])=>({c,avg:arr.reduce((a,b)=>a+b,0)/arr.length,count:arr.length}))
    .sort((a,b)=>b.avg-a.avg)
    .map(({c,avg,count})=>{
      const col=avg>=70?'var(--green)':avg>=55?'var(--blue2)':avg>=40?'var(--amber)':'var(--rose)';
      const strat=avg>=70?'üöÄ √ñncelikli B√ºy√ºt':avg>=55?'‚úÖ S√ºrd√ºr & Geli≈ütir':avg>=40?'‚ö° Potansiyel Var':'‚ö†Ô∏è Risk Deƒüerlendirmesi';
      return`<div class="city-strat-card">
        <div class="city-strat-name">${c}</div>
        <div class="city-strat-score">${count} etkinlik</div>
        <div style="font-size:22px;font-family:'Syne',sans-serif;font-weight:800;color:${col};margin-top:6px">${avg.toFixed(0)}<span style="font-size:12px">/100</span></div>
        <div style="font-size:10px;color:${col};font-family:'DM Mono',monospace;margin-top:3px">${strat}</div>
        <div class="city-strat-bar"><div style="width:${avg}%;height:100%;background:${col};border-radius:2px"></div></div>
      </div>`;
    }).join('');

  // Cost tips
  const highAg=[...scored].filter(e=>e.agency>0&&e.comps.agency<40).sort((a,b)=>a.comps.agency-b.comps.agency).slice(0,4);
  const lowS=[...scored].filter(e=>e.aiScore<60).sort((a,b)=>a.aiScore-b.aiScore).slice(0,4);
  document.getElementById('ai-cost-tips').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div style="background:var(--bg3);border-radius:9px;padding:14px;border:1px solid rgba(245,158,11,.2)">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:1px;margin-bottom:10px">üîß Y√úKSEK AJANS MALƒ∞YETƒ∞</div>
        ${highAg.length?highAg.map(e=>`<div style="margin-bottom:8px"><div style="font-size:12px;font-weight:600;color:var(--t1)">${e.name.substring(0,22)}</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--rose)">${fc(e.agency||0)} ajans gideri</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t3)">%10 azalƒ±rsa ‚âà +${(AI_W.agency*10).toFixed(0)} puan</div></div>`).join(''):'<div style="font-size:12px;color:var(--t3)">Veri yok</div>'}
      </div>
      <div style="background:var(--bg3);border-radius:9px;padding:14px;border:1px solid rgba(59,130,246,.2)">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue2);letter-spacing:1px;margin-bottom:10px">üìä SKOR GELƒ∞≈ûTƒ∞RME FIRSATI</div>
        ${lowS.length?lowS.map(e=>{const bot=Object.entries(e.comps).sort((a,b)=>a[1]-b[1])[0];return`<div style="margin-bottom:8px"><div style="font-size:12px;font-weight:600;color:var(--t1)">${e.name.substring(0,22)}</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--amber)">Skor: ${e.aiScore}/100</div><div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t3)">${FM[bot[0]]?.icon} ${FM[bot[0]]?.name} iyile≈ütir</div></div>`;}).join(''):'<div style="font-size:12px;color:var(--t3)">Veri yok</div>'}
      </div>
      <div style="background:var(--bg3);border-radius:9px;padding:14px;border:1px solid rgba(16,185,129,.2)">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--green);letter-spacing:1px;margin-bottom:10px">‚úÖ STRATEJƒ∞K √ñNERƒ∞LER</div>
        <div style="font-size:12px;color:var(--t2);line-height:2">
          <div>‚Üí Ajans maliyeti %10 azalƒ±rsa ort. skor <span style="color:var(--green)">+${(AI_W.agency*10).toFixed(0)} puan</span></div>
          <div>‚Üí G√ºne≈üli havada ROI, yaƒümurluya g√∂re <span style="color:var(--green)">2x y√ºksek</span></div>
          <div>‚Üí 1,000+ katƒ±lƒ±mcƒ± e≈üiƒüi skor i√ßin kritik</div>
          <div>‚Üí ${topCity?.c||'‚Äî'} portf√∂y√ºn√º b√ºy√ºt</div>
        </div>
      </div>
    </div>`;

  renderAiTable();
}

function renderAiTable(){
  const scored=computeAiScores();
  const yr=document.getElementById('ai-year-filter').value;
  const srt=document.getElementById('ai-sort').value;
  let rows=yr==='all'?[...scored]:[...scored].filter(e=>String(e.year)===yr);
  if(srt==='score')rows.sort((a,b)=>b.aiScore-a.aiScore);
  else if(srt==='roi')rows.sort((a,b)=>b.roi-a.roi);
  else rows.sort((a,b)=>a.name.localeCompare(b.name,'tr'));
  document.getElementById('ai-score-list').innerHTML=rows.map(e=>{
    const rec=getRec(e.aiScore);
    const col=rec.col;
    const bars=Object.entries(e.comps).map(([k,v])=>`
      <div style="display:flex;align-items:center;gap:5px;margin-bottom:3px">
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);min-width:80px">${FM[k].icon} ${FM[k].name.substring(0,10)}</span>
        <div style="flex:1;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden"><div style="width:${v}%;height:100%;background:${FM[k].col};border-radius:2px"></div></div>
        <span style="font-family:'DM Mono',monospace;font-size:9px;min-width:22px;text-align:right;color:${FM[k].col}">${Math.round(v)}</span>
      </div>`).join('');
    return`<div style="display:flex;align-items:flex-start;gap:13px;padding:13px 17px;border-bottom:1px solid var(--b1);transition:background .13s;cursor:pointer" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background=''">
      <div style="width:56px;height:56px;border-radius:50%;border:3px solid ${col};display:flex;align-items:center;justify-content:center;flex-shrink:0;background:rgba(0,0,0,.15)">
        <span style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:${col}">${e.aiScore}</span>
      </div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:5px">
          <span style="font-size:14px;font-weight:600;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px" title="${e.name}">${e.name}</span>
          <span class="rec-badge ${rec.cls}">${rec.txt}</span>
          <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t3)">${e.city} ¬∑ ${e.year}</span>
        </div>
        <div style="font-size:11px;color:var(--t3);font-family:'DM Mono',monospace;margin-bottom:8px">
          ROI: <span style="color:${e.roi>=0?'var(--green)':'var(--rose)'}">${e.gider>0?e.roi.toFixed(0)+'%':'‚Äî'}</span>&nbsp;¬∑&nbsp;
          Katƒ±lƒ±mcƒ±: <span style="color:var(--t2)">${e.participants>0?fn(e.participants):'‚Äî'}</span>&nbsp;¬∑&nbsp;
          Net Kar: <span style="color:${e.kar>=0?'var(--green)':'var(--rose)'}">${fc(e.kar)}</span>&nbsp;¬∑&nbsp;
          üí™ G√º√ßl√º: <span style="color:${FM[e.topFactor].col}">${FM[e.topFactor].icon} ${FM[e.topFactor].name}</span>
        </div>
        <div>${bars}</div>
      </div>
    </div>`;
  }).join('');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATION ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NK_SETTINGS = 'spx:notif:settings';
const NK_SENT     = 'spx:notif:sent';    // tracks already-fired notifications

let notifSettings = {
  enabled: true,
  days: [1, 3, 7],    // remind N days before
  time: '09:00',      // daily check time
  sound: true,
  panelOpen: true,
};
let notifSent = {};   // { "eventId_daysBefore": timestamp }
let notifCheckInterval = null;
let soundEnabled = true;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initNotifications() {
  // Auto-collapse on mobile to save space
  if (window.innerWidth < 768) {
    const body = document.getElementById('notif-panel-body');
    const btn = document.querySelector('[onclick="toggleNotifPanel()"]');
    if (body) body.style.display = 'none';
    if (btn) btn.textContent = 'G√∂ster ‚Üì';
  }
  // Load settings
  try {
    const s = lGet(NK_SETTINGS);
    if (s) notifSettings = { ...notifSettings, ...JSON.parse(s) };
    const sent = lGet(NK_SENT);
    if (sent) notifSent = JSON.parse(sent);
  } catch(e) {}

  soundEnabled = notifSettings.sound !== false;
  updateNotifPermUI();
  applyReminderChips();
  applyTimeInput();
  applySoundToggle();

  // Start interval checker (every 60 seconds)
  if (notifCheckInterval) clearInterval(notifCheckInterval);
  notifCheckInterval = setInterval(checkNotifications, 60000);

  // Also check immediately after a short delay (let cal load first)
  setTimeout(checkNotifications, 2000);

  // Register Service Worker (for background notifications when tab is minimized)
  registerNotifSW();

  renderNotifLog();
}

// ‚îÄ‚îÄ SERVICE WORKER via Blob (background support) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function registerNotifSW() {
  if (!('serviceWorker' in navigator)) return;
  const swCode = `
    self.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'SHOW_NOTIFICATION') {
        self.registration.showNotification(e.data.title, {
          body: e.data.body,
          icon: e.data.icon || '',
          badge: e.data.badge || '',
          tag: e.data.tag || 'spx-reminder',
          requireInteraction: false,
          vibrate: [200, 100, 200],
          data: { url: self.location.origin }
        });
      }
    });
    self.addEventListener('notificationclick', function(e) {
      e.notification.close();
      e.waitUntil(clients.matchAll({type:'window'}).then(function(cs){
        if(cs.length>0){cs[0].focus();}
        else{clients.openWindow(e.notification.data.url||'/');}
      }));
    });
  `;
  try {
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swURL = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swURL)
      .then(reg => { window._swReg = reg; })
      .catch(() => {}); // Silently fail if blob SW not allowed
  } catch(e) {}
}

// ‚îÄ‚îÄ PERMISSION UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateNotifPermUI() {
  const banner = document.getElementById('notif-perm-banner');
  const icon   = document.getElementById('notif-perm-icon');
  const title  = document.getElementById('notif-perm-title');
  const sub    = document.getElementById('notif-perm-sub');
  const btn    = document.getElementById('notif-perm-btn');
  const ind    = document.getElementById('notif-active-indicator');
  if (!banner) return;

  const perm = Notification && Notification.permission;

  if (perm === 'granted') {
    banner.className = 'notif-perm-banner granted';
    icon.textContent = '‚úÖ';
    title.textContent = 'Bildirimler Aktif';
    sub.textContent = 'Yakla≈üan etkinlikler i√ßin uyarƒ± alacaksƒ±nƒ±z';
    btn.textContent = 'Test G√∂nder';
    btn.onclick = notifTest;
    btn.className = 'btn bg2';
    if (ind) ind.innerHTML = '<span class="notif-active-dot" style="margin-right:6px"></span>';
  } else if (perm === 'denied') {
    banner.className = 'notif-perm-banner denied';
    icon.textContent = 'üö´';
    title.textContent = 'Bildirim ƒ∞zni Reddedildi';
    sub.textContent = 'Tarayƒ±cƒ± ayarlarƒ±ndan izin veriniz: Ayarlar ‚Üí Site ƒ∞zinleri ‚Üí Bildirimler';
    btn.textContent = 'Nasƒ±l A√ßƒ±lƒ±r?';
    btn.className = 'btn bd';
    btn.onclick = showNotifHelp;
    if (ind) ind.innerHTML = '';
  } else {
    banner.className = 'notif-perm-banner ask';
    icon.textContent = 'üîî';
    title.textContent = 'Bildirim ƒ∞zni Gerekli';
    sub.textContent = 'Yakla≈üan etkinlikler i√ßin masa√ºst√º/telefon bildirimi alƒ±n';
    btn.textContent = 'ƒ∞zin Ver';
    btn.className = 'btn bp';
    btn.onclick = requestNotifPermission;
    if (ind) ind.innerHTML = '';
  }
}

async function requestNotifPermission() {
  if (!('Notification' in window)) {
    toast('Bu tarayƒ±cƒ± bildirimleri desteklemiyor', 'err');
    return;
  }
  const result = await Notification.requestPermission();
  updateNotifPermUI();
  if (result === 'granted') {
    toast('üîî Bildirimler aktif!');
    // Fire a welcome notification
    setTimeout(() => showNotification(
      'üéâ SPX Hatƒ±rlatma Aktif',
      'Artƒ±k yakla≈üan etkinlikler i√ßin bildirim alacaksƒ±nƒ±z.',
      'welcome'
    ), 500);
    checkNotifications();
  } else {
    toast('Bildirim izni reddedildi', 'err');
  }
}

function showNotifHelp() {
  alert('Bildirimleri A√ßmak ƒ∞√ßin:\n\nüì± Android Chrome:\nAyarlar ‚Üí Site Ayarlarƒ± ‚Üí Bildirimler ‚Üí sedomem.github.io ‚Üí ƒ∞zin Ver\n\nüçé iPhone Safari:\nAyarlar ‚Üí Safari ‚Üí Geli≈ümi≈ü ‚Üí Deneysel √ñzellikler ‚Üí Push API (iOS 16.4+)\n\nüíª Masa√ºst√º:\nAdres √ßubuƒüundaki kilit ikonuna tƒ±klayƒ±n ‚Üí Bildirimler ‚Üí ƒ∞zin Ver');
}

// ‚îÄ‚îÄ CORE NOTIFICATION SENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showNotification(title, body, tag) {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;

  // Try Service Worker first (works in background)
  if (window._swReg && window._swReg.active) {
    window._swReg.active.postMessage({
      type: 'SHOW_NOTIFICATION',
      title, body,
      tag: tag || 'spx-event',
      icon: ''
    });
  } else {
    // Fallback: direct Notification
    try {
      new Notification(title, {
        body,
        tag: tag || 'spx-event',
        icon: '',
        requireInteraction: false,
      });
    } catch(e) {}
  }

  // Play sound if enabled
  if (soundEnabled) playNotifSound();
}

// ‚îÄ‚îÄ CHECK NOTIFICATIONS (called every 60s) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkNotifications() {
  if (!CAL_EVENTS.length) return;
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  if (!notifSettings.enabled) return;

  const now  = new Date();
  const hhmm = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  const notifTime = notifSettings.time || '09:00';

  // Only fire during the minute window matching user's preferred time
  // (or within 5 min after - to catch missed minutes)
  const [nh, nm] = notifTime.split(':').map(Number);
  const nowMins  = now.getHours() * 60 + now.getMinutes();
  const tgtMins  = nh * 60 + nm;
  const withinWindow = Math.abs(nowMins - tgtMins) <= 5;
  if (!withinWindow) return;

  const today = new Date(); today.setHours(0,0,0,0);
  const days  = notifSettings.days || [1, 3, 7];

  CAL_EVENTS.forEach(ev => {
    if (ev.status === 'cancelled') return;
    const evDate = new Date(ev.date); evDate.setHours(0,0,0,0);
    const diffDays = Math.round((evDate - today) / 86400000);

    days.forEach(d => {
      if (diffDays !== d) return;
      const key = `${ev.id}_${d}`;
      // Check if already sent today
      const sentAt = notifSent[key];
      const sentToday = sentAt && new Date(sentAt).toDateString() === now.toDateString();
      if (sentToday) return;

      // Fire!
      const MN = ['Oca','≈ûub','Mar','Nis','May','Haz','Tem','Aƒüu','Eyl','Eki','Kas','Ara'];
      const evD = new Date(ev.date);
      const dateStr = `${evD.getDate()} ${MN[evD.getMonth()]} ${evD.getFullYear()}`;
      const title = d === 0
        ? `üìÖ BUG√úN: ${ev.name}`
        : `‚è∞ ${d} G√ºn Kaldƒ±: ${ev.name}`;
      const body = `${ev.city ? 'üìç ' + ev.city + '  ' : ''}${dateStr}${ev.type ? '  ¬∑ ' + ev.type : ''}${ev.participants > 0 ? '\nüë• ' + ev.participants.toLocaleString('tr-TR') + ' katƒ±lƒ±mcƒ±' : ''}`;

      showNotification(title, body, key);
      notifSent[key] = now.toISOString();
      lSet(NK_SENT, JSON.stringify(notifSent));
    });
  });

  renderNotifLog();
}

// ‚îÄ‚îÄ TEST NOTIFICATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function notifTest() {
  if (!('Notification' in window)) { toast('Tarayƒ±cƒ± desteklemiyor', 'err'); return; }
  if (Notification.permission !== 'granted') {
    requestNotifPermission();
    return;
  }
  const upcoming = CAL_EVENTS.filter(e => {
    const d = new Date(e.date); d.setHours(0,0,0,0);
    const t = new Date(); t.setHours(0,0,0,0);
    return d >= t && e.status !== 'cancelled';
  }).sort((a,b) => new Date(a.date) - new Date(b.date));

  if (upcoming.length) {
    const ev = upcoming[0];
    const diff = Math.round((new Date(ev.date) - new Date().setHours(0,0,0,0)) / 86400000);
    showNotification(
      `üß™ TEST: ${ev.name}`,
      `${diff === 0 ? 'BUG√úN!' : diff + ' g√ºn kaldƒ±'}  ${ev.city ? 'üìç ' + ev.city : ''}`,
      'spx-test'
    );
    toast('üîî Test bildirimi g√∂nderildi!');
  } else {
    showNotification('üß™ SPX Test Bildirimi', 'Hatƒ±rlatma sistemi √ßalƒ±≈üƒ±yor ‚úÖ', 'spx-test');
    toast('üîî Test bildirimi g√∂nderildi!');
  }
}

// ‚îÄ‚îÄ NOTIFICATION LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderNotifLog() {
  const el = document.getElementById('notif-log-list');
  if (!el) return;

  const today = new Date(); today.setHours(0,0,0,0);
  const days = notifSettings.days || [1, 3, 7];

  // Build upcoming reminder schedule
  const items = [];
  CAL_EVENTS.forEach(ev => {
    if (ev.status === 'cancelled') return;
    const evDate = new Date(ev.date); evDate.setHours(0,0,0,0);
    const diffDays = Math.round((evDate - today) / 86400000);
    if (diffDays < -1) return; // skip old events

    days.forEach(d => {
      const remindAt = new Date(evDate);
      remindAt.setDate(remindAt.getDate() - d);
      const key = `${ev.id}_${d}`;
      const sent = notifSent[key] && new Date(notifSent[key]).toDateString();
      const isPast = remindAt < today;
      const isToday = remindAt.toDateString() === today.toDateString();

      const MN = ['Oca','≈ûub','Mar','Nis','May','Haz','Tem','Aƒüu','Eyl','Eki','Kas','Ara'];
      items.push({ ev, d, remindAt, key, sent, isPast, isToday, diffDays });
    });

    // Always show "today" reminder if event is today
    if (diffDays === 0) {
      const key = `${ev.id}_0`;
      const sent = notifSent[key] && new Date(notifSent[key]).toDateString();
      if (!days.includes(0)) {
        items.push({ ev, d: 0, remindAt: today, key, sent, isPast: false, isToday: true, diffDays });
      }
    }
  });

  items.sort((a,b) => a.remindAt - b.remindAt);

  if (!items.length) {
    el.innerHTML = '<div class="empty" style="padding:18px">Planlanmƒ±≈ü etkinlik yok. Takvime etkinlik ekleyin.</div>';
    return;
  }

  const MN = ['Oca','≈ûub','Mar','Nis','May','Haz','Tem','Aƒüu','Eyl','Eki','Kas','Ara'];
  el.innerHTML = items.slice(0, 20).map(({ev, d, remindAt, key, sent, isPast, isToday, diffDays}) => {
    const remindStr = isToday ? 'Bug√ºn' :
      `${remindAt.getDate()} ${MN[remindAt.getMonth()]}`;
    const statusIcon = sent ? '‚úÖ' : isPast ? '‚è≠' : isToday ? 'üîî' : '‚è∞';
    const iconCls = sent ? 'sent' : isPast ? 'missed' : 'pending';
    const badgeCls = sent ? 'nlb-sent' : isPast ? 'nlb-pending' : isToday ? 'nlb-today' : 'nlb-pending';
    const badgeTxt = sent ? 'G√∂nderildi' : isPast ? 'Ka√ßƒ±rƒ±ldƒ±' : isToday ? 'Bug√ºn!' : remindStr;
    const evDateStr = `${new Date(ev.date).getDate()} ${MN[new Date(ev.date).getMonth()]}`;
    return `<div class="notif-log-item">
      <div class="notif-log-icon ${iconCls}">${statusIcon}</div>
      <div style="flex:1;min-width:0">
        <div class="notif-log-name" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${ev.name}</div>
        <div class="notif-log-meta">
          ${d === 0 ? 'Etkinlik g√ºn√º' : d + ' g√ºn √∂ncesi'} ¬∑ Etkinlik: ${evDateStr}
          ${ev.city ? ' ¬∑ üìç ' + ev.city : ''}
        </div>
      </div>
      <span class="notif-log-badge ${badgeCls}">${badgeTxt}</span>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ SETTINGS PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveNotifSettings() {
  notifSettings.time = document.getElementById('notif-time').value;
  notifSettings.sound = soundEnabled;
  lSet(NK_SETTINGS, JSON.stringify(notifSettings));
}

function toggleReminderDay(day, el) {
  el.classList.toggle('active');
  const active = [...document.querySelectorAll('.reminder-chip.active')].map(c => parseInt(c.dataset.days));
  notifSettings.days = active;
  saveNotifSettings();
  renderNotifLog();
}

function applyReminderChips() {
  const days = notifSettings.days || [1, 3, 7];
  document.querySelectorAll('.reminder-chip').forEach(c => {
    c.classList.toggle('active', days.includes(parseInt(c.dataset.days)));
  });
}

function applyTimeInput() {
  const el = document.getElementById('notif-time');
  if (el) el.value = notifSettings.time || '09:00';
}

function applySoundToggle() {
  const track = document.getElementById('sound-track');
  if (track) track.classList.toggle('on', soundEnabled);
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('sound-track').classList.toggle('on', soundEnabled);
  saveNotifSettings();
}

// ‚îÄ‚îÄ PANEL TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleNotifPanel() {
  const body = document.getElementById('notif-panel-body');
  const btn  = document.querySelector('[onclick="toggleNotifPanel()"]');
  const open = body.style.display !== 'none';
  body.style.display = open ? 'none' : '';
  if (btn) btn.textContent = open ? 'G√∂ster ‚Üì' : 'Gizle ‚Üë';
}

// ‚îÄ‚îÄ SOUND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function playNotifSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    // Gentle two-tone chime
    const play = (freq, start, dur) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime + start);
      gain.gain.setValueAtTime(0, ctx.currentTime + start);
      gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + start + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + start + dur);
      osc.start(ctx.currentTime + start);
      osc.stop(ctx.currentTime + start + dur);
    };
    play(880, 0, 0.35);
    play(1100, 0.2, 0.35);
    play(1320, 0.4, 0.5);
  } catch(e) {}
}


// ‚îÄ‚îÄ CALENDAR CROSS-DEVICE EXPORT / IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calExport(){
  if(!CAL_EVENTS.length){toast('Dƒ±≈üa aktarƒ±lacak etkinlik yok','err');return;}
  const json=JSON.stringify({v:1,exported:new Date().toISOString(),events:CAL_EVENTS},null,2);
  // Try native share first (mobile)
  if(navigator.share){
    navigator.share({title:'SPX Takvim Etkinlikleri',text:json}).catch(()=>calCopyExport(json));
  } else {
    calCopyExport(json);
  }
}
function calCopyExport(json){
  navigator.clipboard.writeText(json)
    .then(()=>toast('‚úì Etkinlikler kopyalandƒ±! Diƒüer cihazda "ƒ∞√ße Aktar" ile yapƒ±≈ütƒ±rƒ±n.'))
    .catch(()=>{
      // Fallback: prompt dialog with JSON
      prompt('Bu metni kopyalayƒ±n, diƒüer cihazda ƒ∞√ße Aktar ile yapƒ±≈ütƒ±rƒ±n:', json);
    });
}
async function calImport(){
  const input=prompt('Dƒ±≈üa aktarƒ±lan JSON metni yapƒ±≈ütƒ±rƒ±n:');
  if(!input)return;
  try{
    const obj=JSON.parse(input.trim());
    const evs=Array.isArray(obj)?obj:(obj.events||[]);
    if(!evs.length){toast('Ge√ßerli etkinlik bulunamadƒ±','err');return;}
    // Merge: add events not already present (by id)
    const existing=new Set(CAL_EVENTS.map(e=>e.id));
    let added=0;
    evs.forEach(e=>{if(e.id&&!existing.has(e.id)){CAL_EVENTS.push(e);added++;}});
    if(added===0){toast('T√ºm etkinlikler zaten mevcut');return;}
    await saveCalendar();
    renderCalendar();
    toast(`‚úì ${added} etkinlik eklendi!`);
  }catch(e){
    toast('Ge√ßersiz JSON formatƒ± ‚Äî l√ºtfen dƒ±≈üa aktarƒ±lan metni kopyalayƒ±n','err');
  }
}

</script>


<!-- CAL EDIT MODAL (for row edit button) -->
<div class="mo" id="modal-cal-edit" onclick="moBg(event,'modal-cal-edit')">
  <div class="cal-edit-modal">
    <div class="mt"><span>Etkinliƒüi D√ºzenle</span><span class="mc" onclick="closeModal('modal-cal-edit')">‚úï</span></div>
    <input type="hidden" id="mce-id">
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div class="fg"><label class="fl">Etkinlik Adƒ± *</label><input class="fi" id="mce-name"></div>
      <div class="fg3">
        <div class="fg"><label class="fl">Ba≈ülangƒ±√ß Tarihi *</label><input type="date" class="fi" id="mce-date"></div>
        <div class="fg"><label class="fl">Biti≈ü Tarihi</label><input type="date" class="fi" id="mce-end-date"></div>
        <div class="fg"><label class="fl">≈ûehir</label><input class="fi" id="mce-city" list="city-dl"></div>
      </div>
      <div class="fg3">
        <div class="fg"><label class="fl">T√ºr</label>
          <select class="fi" id="mce-type">
            <option>Yarƒ± Maraton</option><option>Ultra Trail</option><option>Maraton</option>
            <option>Bisiklet</option><option>Triatlon</option><option>Festival</option>
            <option>Kurumsal</option><option>Pickleball</option><option>Tenis</option><option>Diƒüer</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Tahmini Katƒ±lƒ±mcƒ±</label><input type="number" class="fi" id="mce-participants"></div>
        <div class="fg"><label class="fl">Durum</label>
          <select class="fi" id="mce-status">
            <option value="planned">Planlandƒ±</option>
            <option value="confirmed">Onaylandƒ±</option>
            <option value="tentative">Belirsiz</option>
            <option value="cancelled">ƒ∞ptal</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">Not</label><textarea class="fi" id="mce-note" rows="3" style="resize:vertical;font-size:12px"></textarea></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap">
      <button class="btn bs" onclick="closeModal('modal-cal-edit')">ƒ∞ptal</button>
      <button class="btn bp" onclick="calSaveModalEdit()">‚úì G√ºncelle</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="mo" id="modal-detail" onclick="moBg(event,'modal-detail')">
  <div class="md">
    <div class="mt">
      <span id="m-name" style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Detay</span>
      <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
        <button class="btn bsh" style="font-size:11px;padding:5px 10px" onclick="shareFromDetail()">‚¨Ü Payla≈ü</button>
        <button class="btn bg2" style="font-size:11px;padding:5px 10px" onclick="editFromDetail()">‚úé D√ºzenle</button>
        <span class="mc" onclick="closeModal('modal-detail')">‚úï</span>
      </div>
    </div>
    <div id="m-body"></div>
    <div class="modal-acts">
      <button class="btn bd" onclick="delFromDetail()">üóë Sil</button>
      <button class="btn bsh" onclick="shareFromDetail()">‚¨Ü Kartƒ± Payla≈ü</button>
      <button class="btn bg2" onclick="editFromDetail()">‚úé D√ºzenle</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="mo" id="modal-edit" onclick="moBg(event,'modal-edit')">
  <div class="edit-md">
    <div class="mt">
      <span>Etkinliƒüi D√ºzenle</span>
      <span class="mc" onclick="closeModal('modal-edit')">‚úï</span>
    </div>
    <input type="hidden" id="edit-id">
    <div class="fd">‚Äî Etkinlik Bilgileri</div>
    <div class="fg3">
      <div class="fg"><label class="fl">Etkinlik Adƒ± *</label><input class="fi" id="e-name" placeholder="Etkinlik adƒ±"></div>
      <div class="fg"><label class="fl">Tarih</label><input type="date" class="fi" id="e-date" onchange="onEditDate()"></div>
      <div class="fg"><label class="fl">≈ûehir</label><input class="fi" id="e-city" list="city-dl"></div>
    </div>
    <div class="fg3">
      <div class="fg"><label class="fl">Yƒ±l</label><select class="fi" id="e-year"></select></div>
      <div class="fg"><label class="fl">Katƒ±lƒ±mcƒ± Sayƒ±sƒ±</label><input type="number" class="fi" id="e-kat" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">√áadƒ±r Sayƒ±sƒ±</label><input type="number" class="fi" id="e-cadir"></div>
    </div>
    <div class="fd">‚Äî Gider Kalemleri</div>
    <div class="fg4">
      <div class="fg"><label class="fl">Ajans Bedeli (‚Ç∫)</label><input type="number" class="fi" id="e-ajans" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Personel Gideri (‚Ç∫)</label><input type="number" class="fi" id="e-per" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Stand Maliyeti (‚Ç∫)</label><input type="number" class="fi" id="e-stand" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Barter (‚Ç∫)</label><input type="number" class="fi" id="e-barter" oninput="calcEP()"></div>
    </div>
    <div class="fd">‚Äî Ciro Kalemleri</div>
    <div class="fg2">
      <div class="fg"><label class="fl">√áek Ciro (‚Ç∫)</label><input type="number" class="fi" id="e-cek" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">√áadƒ±r Ciro (‚Ç∫)</label><input type="number" class="fi" id="e-cciro" oninput="calcEP()"></div>
    </div>
    <div class="fd">‚Äî Anlƒ±k Hesaplama</div>
    <div class="edit-pvs">
      <div class="pvi"><div class="pvl">Ciro</div><div class="pvv cb" id="ep-ciro">‚Ç∫0</div></div>
      <div class="pvi"><div class="pvl">Gider</div><div class="pvv ca" id="ep-gider">‚Ç∫0</div></div>
      <div class="pvi"><div class="pvl">Net Kar</div><div class="pvv cg" id="ep-kar">‚Ç∫0</div></div>
      <div class="pvi"><div class="pvl">Kar Marjƒ±</div><div class="pvv cb" id="ep-margin">‚Äî</div></div>
      <div class="pvi"><div class="pvl">ROI</div><div class="pvv cg" id="ep-roi">‚Äî</div></div>
      <div class="pvi"><div class="pvl">Kat.Ba≈üƒ± Ciro</div><div class="pvv cb" id="ep-pciro">‚Äî</div></div>
      <div class="pvi"><div class="pvl">Kat.Ba≈üƒ± Mlt.</div><div class="pvv ca" id="ep-pgdr">‚Äî</div></div>
    </div>
    <div class="fd">‚Äî Hava Durumu</div>
    <div style="margin-bottom:14px">
      <textarea class="fi" id="e-wx" rows="3" style="resize:vertical;font-family:'DM Mono',monospace;font-size:11px" placeholder="Sƒ±caklƒ±k: 22¬∞C&#10;Durum: G√ºne≈üli&#10;R√ºzgar: 15 km/h"></textarea>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
      <button class="btn bs" onclick="closeModal('modal-edit')">ƒ∞ptal</button>
      <button class="btn bp" onclick="saveEdit()">‚úì G√ºncelle</button>
    </div>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="mo" id="modal-share" onclick="moBg(event,'modal-share')">
  <div class="share-md">
    <div class="sc" id="share-card-vis">
      <div class="sc-brand">
        <div class="sc-bname">SPX<span style="color:var(--blue)">.</span></div>
        <div class="sc-btag">Event Report</div>
      </div>
      <div class="sc-title" id="sct">‚Äî</div>
      <div class="sc-meta">
        <span>üìÖ <span id="scd">‚Äî</span></span>
        <span>üìç <span id="scc">‚Äî</span></span>
        <span>üë• <span id="scp">‚Äî</span></span>
      </div>
      <div class="sc-kpis">
        <div class="sc-kpi"><div class="sc-kpi-lbl">Toplam Ciro</div><div class="sc-kpi-val" id="sc-ciro" style="color:var(--blue2)">‚Ç∫0</div><div class="sc-kpi-sub" id="sc-ciro-s">‚Äî</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Net Kar</div><div class="sc-kpi-val" id="sc-kar">‚Ç∫0</div><div class="sc-kpi-sub" id="sc-kar-s">‚Äî</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">ROI</div><div class="sc-kpi-val" id="sc-roi" style="color:var(--cyan)">‚Äî</div><div class="sc-kpi-sub">Yatƒ±rƒ±m getirisi</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Kar Marjƒ±</div><div class="sc-kpi-val" id="sc-margin">‚Äî</div><div class="sc-kpi-sub">Gelirden kar payƒ±</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Toplam Gider</div><div class="sc-kpi-val" id="sc-gider" style="color:var(--amber)">‚Ç∫0</div><div class="sc-kpi-sub" id="sc-gider-s">‚Äî</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Kat. Ba≈üƒ± Ciro</div><div class="sc-kpi-val" id="sc-pciro" style="color:var(--violet)">‚Äî</div><div class="sc-kpi-sub" id="sc-pciro-s">‚Äî</div></div>
      </div>
      <div id="sc-wx-wrap" style="display:none"><div class="sc-wx" id="sc-wx-txt">‚Äî</div></div>
      <div class="sc-foot">
        <div class="sc-perf"><span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px">PERFORMANS</span><div class="sc-pbw"><div class="sc-pb" id="sc-pb"></div></div><span style="font-family:'DM Mono',monospace;font-size:10px" id="sc-pl">‚Äî</span></div>
        <div class="sc-dtag" id="sc-yr">‚Äî</div>
      </div>
    </div>
    <div class="share-acts">
      <div class="share-acts-ttl">Payla≈üƒ±m Se√ßenekleri</div>
      <div class="share-btns">
        <button class="btn bp" style="font-size:11px" onclick="copyLink()">üîó Baƒülantƒ±yƒ± Kopyala</button>
        <button class="btn bs" style="font-size:11px" onclick="copyText()">üìã Metni Kopyala</button>
        <button class="btn bg2" style="font-size:11px" onclick="shareWA()">üí¨ WhatsApp</button>
        <span class="copy-ok" id="copy-ok">‚úì Kopyalandƒ±!</span>
      </div>
      <div class="share-link" id="share-link-box">‚Äî</div>
      <div style="display:flex;justify-content:flex-end;margin-top:9px">
        <button class="btn bs" style="font-size:11px" onclick="closeModal('modal-share')">Kapat</button>
      </div>
    </div>
  </div>
</div>
<script>
// 1. ADIM: Google Apps Script URL'nizi buraya yapƒ±≈ütƒ±rƒ±n
const scriptURL = 'https://script.google.com/macros/s/AKfycbz5d14xbVA0G-ClAKy8Rq8J7Ym8bJV8Ieic326wqpNC6_cIaiuXD19nMb0KDcMeGFcN/exec';

// 2. ADIM: Verileri √ßeken fonksiyon
async function loadEventsFromGoogle() {
    try {
        const response = await fetch(scriptURL);
        const data = await response.json();
        
        // Verileri uygulamanƒ±zƒ±n anlayacaƒüƒ± formata sokuyoruz
        // Sizin takvim fonksiyonunuzun adƒ± renderEvents veya updateCalendar ise onu buraya yazmalƒ±sƒ±nƒ±z
        if (typeof renderEvents === "function") {
            renderEvents(data);
            console.log("Veriler ba≈üarƒ±yla Google Drive'dan y√ºklendi!");
        } else {
            // Eƒüer fonksiyon adƒ±nƒ±z farklƒ±ysa veriyi LocalStorage'a da yedekleyebiliriz
            localStorage.setItem('events', JSON.stringify(data));
            location.reload(); // Sayfayƒ± bir kez yenileyerek veriyi okumasƒ±nƒ± saƒülarƒ±z
        }
    } catch (error) {
        console.error("Veri √ßekme hatasƒ±:", error);
    }
}

// Sayfa y√ºklendiƒüinde √ßalƒ±≈ütƒ±r
window.addEventListener('load', loadEventsFromGoogle);
</script>
</body>
</html>
