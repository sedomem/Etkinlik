<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SPX Event Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg0:#060a12;--bg1:#0b1120;--bg2:#111827;--bg3:#1a2438;--bg4:#1e2d45;
  --blue:#3b82f6;--blue2:#60a5fa;--cyan:#22d3ee;
  --green:#10b981;--amber:#f59e0b;--rose:#f43f5e;--violet:#8b5cf6;
  --t1:#f0f4ff;--t2:#8da0bf;--t3:#4d6080;
  --b1:rgba(59,130,246,.12);--b2:rgba(59,130,246,.3);--grid:rgba(59,130,246,.05);
  --sb:220px;--r:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg0);color:var(--t1);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
.shell{position:relative;z-index:1;display:flex;min-height:100vh;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sb{width:var(--sb);min-height:100vh;background:var(--bg2);border-right:1px solid var(--b1);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:200;transition:transform .28s cubic-bezier(.4,0,.2,1);}
.sb-logo{padding:18px 18px 16px;border-bottom:1px solid var(--b1);}
.lm{font-family:'Syne',sans-serif;font-weight:800;font-size:21px;letter-spacing:-.5px;}
.ls{font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.sb-nav{padding:14px 0;flex:1;overflow-y:auto;}
.nl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:2px;text-transform:uppercase;padding:0 16px;margin:10px 0 5px;}
.ni{display:flex;align-items:center;gap:9px;padding:9px 16px;cursor:pointer;transition:all .16s;color:var(--t2);font-size:13px;border-left:2px solid transparent;user-select:none;}
.ni:hover{background:var(--bg3);color:var(--t1);}
.ni.active{background:rgba(59,130,246,.11);color:var(--blue2);border-left-color:var(--blue);}
.nx{font-size:14px;width:18px;text-align:center;flex-shrink:0;}
.sb-foot{padding:13px 16px;border-top:1px solid var(--b1);}
.ull{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;}
.ui{width:100%;background:var(--bg3);border:1px solid var(--b1);color:var(--t1);padding:7px 10px;border-radius:7px;font-size:11px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .2s;}
.ui:focus{border-color:var(--b2);}
.ui::placeholder{color:var(--t3);}
.sb-st{margin-top:9px;font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);line-height:1.9;}
.dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:4px;animation:pulse 2s infinite;}
.dot-g{background:var(--green);box-shadow:0 0 5px var(--green);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

/* â”€â”€ MOBILE â”€â”€ */
.mob-bar{display:none;position:fixed;top:0;left:0;right:0;z-index:190;background:rgba(11,17,32,.96);backdrop-filter:blur(16px);border-bottom:1px solid var(--b1);padding:0 14px;height:54px;align-items:center;justify-content:space-between;}
.mob-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;}
.hb{width:36px;height:36px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;cursor:pointer;background:var(--bg3);border-radius:7px;border:1px solid var(--b1);}
.hb span{width:18px;height:2px;background:var(--t2);border-radius:2px;transition:all .22s;}
.hb.open span:nth-child(1){transform:translateY(7px) rotate(45deg);}
.hb.open span:nth-child(2){opacity:0;}
.hb.open span:nth-child(3){transform:translateY(-7px) rotate(-45deg);}
.sb-ov{display:none;position:fixed;inset:0;background:rgba(6,10,18,.6);z-index:195;backdrop-filter:blur(2px);}
.sb-ov.open{display:block;}

/* â”€â”€ MAIN â”€â”€ */
.main{margin-left:var(--sb);flex:1;min-width:0;}
.topbar{background:rgba(11,17,32,.88);backdrop-filter:blur(20px);border-bottom:1px solid var(--b1);padding:12px 26px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;gap:8px;flex-wrap:wrap;}
.pt{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;white-space:nowrap;}
.tr{display:flex;gap:7px;align-items:center;flex-wrap:wrap;}
.flt{background:var(--bg3);border:1px solid var(--b1);color:var(--t2);padding:7px 10px;border-radius:7px;font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;outline:none;transition:border-color .2s;}
.flt:hover,.flt:focus{border-color:var(--b2);}
.btn{padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .18s;border:none;white-space:nowrap;}
.bp{background:var(--blue);color:#fff;}.bp:hover{background:var(--blue2);transform:translateY(-1px);}
.bs{background:var(--bg3);color:var(--t2);border:1px solid var(--b1);}.bs:hover{border-color:var(--b2);color:var(--t1);}
.bd{background:rgba(244,63,94,.11);color:var(--rose);border:1px solid rgba(244,63,94,.18);}.bd:hover{background:rgba(244,63,94,.2);}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none;padding:22px 26px;}
.page.active{display:block;}
.sec-l{font-family:'DM Mono',monospace;font-size:10px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;}
.sec-t{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:18px;letter-spacing:-.5px;}

/* â”€â”€ KPI â”€â”€ */
.kg{display:grid;grid-template-columns:repeat(4,1fr);gap:13px;margin-bottom:14px;}
.kc{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:17px;position:relative;overflow:hidden;transition:border-color .18s;}
.kc:hover{border-color:var(--b2);}
.kc::after{content:'';position:absolute;top:0;right:0;width:54px;height:54px;border-radius:0 var(--r) 0 100%;opacity:.09;}
.bl::after{background:var(--blue)}.gn::after{background:var(--green)}.am::after{background:var(--amber)}.ro::after{background:var(--rose)}.vi::after{background:var(--violet)}.cy::after{background:var(--cyan)}
.kl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:7px;}
.kv{font-family:'Syne',sans-serif;font-size:24px;font-weight:700;line-height:1;margin-bottom:5px;}
.ks{font-size:11px;color:var(--t3);}
.bdg{display:inline-flex;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:600;font-family:'DM Mono',monospace;}
.bg{background:rgba(16,185,129,.13);color:var(--green);}
.br{background:rgba(244,63,94,.13);color:var(--rose);}
.bb{background:rgba(59,130,246,.13);color:var(--blue2);}

/* â”€â”€ CHARTS â”€â”€ */
.cg32{display:grid;grid-template-columns:2fr 1fr;gap:13px;margin-bottom:14px;}
.cg2{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:14px;}
.cc{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:17px;}
.ch{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:13px;}
.ct{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.cs{font-size:11px;color:var(--t3);margin-top:2px;}
.cw{position:relative;height:215px;}
.cw.t{height:265px;}

/* â”€â”€ TABLE â”€â”€ */
.tc{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;margin-bottom:18px;}
.th{padding:13px 17px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--b1);flex-wrap:wrap;gap:7px;}
.tht{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.si{background:var(--bg3);border:1px solid var(--b1);color:var(--t1);padding:7px 11px;border-radius:7px;font-size:12px;font-family:'DM Sans',sans-serif;outline:none;width:185px;transition:border-color .2s;}
.si:focus{border-color:var(--b2);}
.si::placeholder{color:var(--t3);}
.tsc{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;min-width:860px;}
thead tr{background:var(--bg3);border-bottom:1px solid var(--b1);}
th{font-family:'DM Mono',monospace;font-size:9px;font-weight:500;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;padding:9px 12px;text-align:left;white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--b1);transition:background .13s;cursor:pointer;}
tbody tr:hover{background:var(--bg3);}
tbody tr:last-child{border-bottom:none;}
td{padding:8px 12px;font-size:12px;color:var(--t2);white-space:nowrap;}
td.nm{color:var(--t1);font-weight:500;max-width:185px;overflow:hidden;text-overflow:ellipsis;}
td.mo{font-family:'DM Mono',monospace;font-size:11px;}
td.pg{color:var(--green);}td.pr{color:var(--rose);}
.pl{display:inline-block;padding:2px 7px;border-radius:4px;font-family:'DM Mono',monospace;font-size:10px;font-weight:500;}
.ph{background:rgba(16,185,129,.13);color:var(--green);}
.pm{background:rgba(245,158,11,.13);color:var(--amber);}
.plo{background:rgba(244,63,94,.13);color:var(--rose);}
.pu{background:rgba(139,92,246,.13);color:var(--violet);}

/* Year group row */
.yr-row td{background:linear-gradient(90deg,rgba(59,130,246,.07),transparent);padding:9px 13px;color:var(--blue2);font-family:'Syne',sans-serif;font-weight:700;font-size:14px;border-bottom:1px solid var(--b1);border-top:2px solid var(--b2);letter-spacing:-.3px;}
.yr-stats{font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);font-weight:400;margin-left:10px;}

.del-btn{opacity:0;background:rgba(244,63,94,.11);border:none;color:var(--rose);width:22px;height:22px;border-radius:4px;cursor:pointer;font-size:11px;transition:all .18s;display:inline-flex;align-items:center;justify-content:center;}
tbody tr:hover .del-btn{opacity:1;}

/* â”€â”€ FORM â”€â”€ */
.fc2{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:20px;margin-bottom:16px;}
.fd{font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin:15px 0 11px;padding:5px 0;border-top:1px solid var(--b1);border-bottom:1px solid var(--b1);}
.fg3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;}
.fg4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;}
.fg2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px;}
.fg{display:flex;flex-direction:column;gap:5px;}
.fl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;}
.fi{background:var(--bg3);border:1px solid var(--b1);color:var(--t1);padding:9px 12px;border-radius:8px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .18s,box-shadow .18s;width:100%;}
.fi:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.1);}
.fi::placeholder{color:var(--t3);}

/* Preview strip */
.pvs{display:grid;grid-template-columns:repeat(7,1fr);gap:9px;background:var(--bg3);border:1px solid var(--b1);border-radius:9px;padding:14px;margin-bottom:14px;}
.pvi{text-align:center;}
.pvl{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;}
.pvv{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;}
.cb{color:var(--blue2);}.cg{color:var(--green);}.ca{color:var(--amber);}.cr{color:var(--rose);}

/* New year banner */
.yr-banner{background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.22);border-radius:9px;padding:11px 14px;margin-bottom:12px;font-size:12px;color:var(--blue2);font-family:'DM Mono',monospace;display:none;}

/* Weather */
.wx-box{background:var(--bg3);border:1px solid var(--b1);border-radius:9px;padding:14px;margin-bottom:14px;}
.wx-pr{background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.13);border-radius:7px;padding:11px;font-family:'DM Mono',monospace;font-size:11px;color:var(--t2);line-height:1.7;margin-top:8px;white-space:pre-line;}

/* â”€â”€ ANALYSIS â”€â”€ */
.ig{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:18px;}
.ic{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:17px;}
.ih{display:flex;align-items:center;gap:9px;margin-bottom:12px;}
.ii{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;}
.ib{background:rgba(59,130,246,.13);}
.ig2{background:rgba(16,185,129,.13);}
.ia{background:rgba(245,158,11,.13);}
.ir2{background:rgba(244,63,94,.13);}
.it{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.ins-row{display:flex;align-items:center;padding:6px 0;border-bottom:1px solid var(--b1);font-size:12px;}
.ins-row:last-child{border-bottom:none;}
.irl{color:var(--t2);min-width:85px;}
.irbw{flex:1;margin:0 9px;height:3px;background:var(--bg3);border-radius:2px;}
.irb{height:100%;border-radius:2px;}
.irv{font-family:'DM Mono',monospace;font-size:11px;color:var(--t1);min-width:75px;text-align:right;}
.dg{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-top:13px;}
.dc2{border-radius:9px;padding:14px;}

/* â”€â”€ MODAL â”€â”€ */
.mo{display:none;position:fixed;inset:0;background:rgba(6,10,18,.87);backdrop-filter:blur(8px);z-index:300;align-items:center;justify-content:center;padding:14px;}
.mo.open{display:flex;}
.md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:22px;max-width:540px;width:100%;max-height:88vh;overflow-y:auto;}
.mt{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}
.mc{cursor:pointer;color:var(--t3);font-size:18px;transition:color .18s;line-height:1;}.mc:hover{color:var(--t1);}
.mg{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px;}
.mi{background:var(--bg3);border-radius:8px;padding:10px;}
.mil{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.miv{font-weight:600;color:var(--t1);font-size:13px;}
.mkr{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:11px;}
.mk{background:var(--bg3);border-radius:8px;padding:10px;text-align:center;}
.mkl{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.mkv{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--green);color:var(--green);padding:10px 16px;border-radius:8px;font-size:12px;font-family:'DM Mono',monospace;z-index:999;opacity:0;transform:translateY(14px);transition:all .26s;max-width:280px;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.err{border-color:var(--rose);color:var(--rose);}

.empty{text-align:center;padding:34px;color:var(--t3);font-size:12px;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg1);}
::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px;}

/* â•â•â•â• RESPONSIVE â•â•â•â• */
@media(max-width:1100px){
  .kg{grid-template-columns:repeat(2,1fr);}
  .cg32,.cg2{grid-template-columns:1fr;}
  .ig{grid-template-columns:1fr;}
  .dg{grid-template-columns:1fr;}
  .pvs{grid-template-columns:repeat(4,1fr);}
  .fg4{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:768px){
  :root{--sb:264px;}
  .sb{transform:translateX(-100%);}
  .sb.open{transform:translateX(0);}
  .mob-bar{display:flex;}
  .main{margin-left:0;padding-top:54px;}
  .topbar{padding:9px 13px;top:54px;}
  .page{padding:14px 13px;}
  .kg{grid-template-columns:repeat(2,1fr);gap:9px;}
  .kv{font-size:20px;}
  .fg3{grid-template-columns:repeat(2,1fr);}
  .fg2{grid-template-columns:1fr;}
  .pvs{grid-template-columns:repeat(3,1fr);}
  .mg{grid-template-columns:1fr;}
  .mkr{grid-template-columns:repeat(2,1fr);}
  .sec-t{font-size:18px;}
  .th{flex-direction:column;align-items:flex-start;}
  .si{width:100%;}
  .tr{width:100%;justify-content:flex-end;}
}
@media(max-width:480px){
  .kg{grid-template-columns:1fr 1fr;}
  .kv{font-size:17px;}
  .kc{padding:13px;}
  .fg3,.fg4{grid-template-columns:1fr;}
  .pvs{grid-template-columns:repeat(2,1fr);}
  .pvv{font-size:14px;}
}

/* Row action buttons */
.row-acts{display:flex;gap:4px;opacity:0;transition:opacity .15s;}
tbody tr:hover .row-acts{opacity:1;}
.rab{width:26px;height:26px;border-radius:5px;border:none;cursor:pointer;font-size:12px;display:inline-flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
.rab-e{background:rgba(59,130,246,.14);color:var(--blue2);}.rab-e:hover{background:rgba(59,130,246,.28);}
.rab-s{background:rgba(139,92,246,.14);color:var(--violet);}.rab-s:hover{background:rgba(139,92,246,.28);}
.rab-d{background:rgba(244,63,94,.14);color:var(--rose);}.rab-d:hover{background:rgba(244,63,94,.28);}

/* Modal base */
.mo{display:none;position:fixed;inset:0;background:rgba(6,10,18,.88);backdrop-filter:blur(8px);z-index:300;align-items:center;justify-content:center;padding:14px;}
.mo.open{display:flex;}
/* Detail modal */
.md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:22px;max-width:580px;width:100%;max-height:90vh;overflow-y:auto;}
/* Edit modal */
.edit-md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:22px;max-width:680px;width:100%;max-height:90vh;overflow-y:auto;}
.mt{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
.mc{cursor:pointer;color:var(--t3);font-size:18px;transition:color .18s;line-height:1;flex-shrink:0;}.mc:hover{color:var(--t1);}
.mg{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px;}
.mi{background:var(--bg3);border-radius:8px;padding:10px;}
.mil{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.miv{font-weight:600;color:var(--t1);font-size:13px;}
.mkr{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:11px;}
.mk{background:var(--bg3);border-radius:8px;padding:10px;text-align:center;}
.mkl{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:1px;margin-bottom:3px;}
.mkv{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.modal-acts{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:14px;border-top:1px solid var(--b1);flex-wrap:wrap;}

/* Share modal */
.share-md{background:var(--bg2);border:1px solid var(--b2);border-radius:15px;padding:0;max-width:520px;width:100%;overflow:hidden;}
.sc{background:linear-gradient(135deg,#08142b 0%,#0d1f3c 50%,#07142a 100%);padding:26px;position:relative;overflow:hidden;border-bottom:1px solid var(--b1);}
.sc::before{content:'';position:absolute;top:-50px;right:-50px;width:220px;height:220px;background:radial-gradient(circle,rgba(59,130,246,.14) 0%,transparent 65%);pointer-events:none;}
.sc::after{content:'';position:absolute;bottom:-40px;left:-40px;width:180px;height:180px;background:radial-gradient(circle,rgba(16,185,129,.09) 0%,transparent 65%);pointer-events:none;}
.sc-brand{display:flex;align-items:center;gap:8px;margin-bottom:18px;}
.sc-bname{font-family:'Syne',sans-serif;font-weight:800;font-size:13px;color:var(--t1);}
.sc-btag{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:2px;text-transform:uppercase;margin-left:4px;}
.sc-title{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;color:var(--t1);margin-bottom:5px;letter-spacing:-.5px;line-height:1.2;position:relative;z-index:1;}
.sc-meta{font-family:'DM Mono',monospace;font-size:11px;color:var(--t3);margin-bottom:20px;display:flex;gap:14px;flex-wrap:wrap;position:relative;z-index:1;}
.sc-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;position:relative;z-index:1;}
.sc-kpi{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:9px;padding:11px;}
.sc-kpi-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.sc-kpi-val{font-family:'Syne',sans-serif;font-size:19px;font-weight:700;}
.sc-kpi-sub{font-size:10px;color:var(--t3);margin-top:2px;font-family:'DM Mono',monospace;}
.sc-foot{display:flex;align-items:center;justify-content:space-between;margin-top:15px;padding-top:13px;border-top:1px solid rgba(255,255,255,.06);position:relative;z-index:1;}
.sc-perf{display:flex;align-items:center;gap:8px;}
.sc-pbw{width:70px;height:4px;background:rgba(255,255,255,.08);border-radius:2px;}
.sc-pb{height:100%;border-radius:2px;}
.sc-dtag{font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);}
.sc-wx{background:rgba(34,211,238,.07);border:1px solid rgba(34,211,238,.15);border-radius:7px;padding:9px 12px;margin-top:11px;font-family:'DM Mono',monospace;font-size:11px;color:var(--cyan);position:relative;z-index:1;}
/* Share actions panel */
.share-acts{padding:16px 20px;}
.share-acts-ttl{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:9px;}
.share-btns{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:10px;}
.share-link{background:var(--bg3);border:1px solid var(--b1);border-radius:8px;padding:8px 11px;font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);word-break:break-all;line-height:1.5;max-height:52px;overflow:hidden;}
.copy-ok{display:inline-flex;align-items:center;gap:4px;font-family:'DM Mono',monospace;font-size:11px;color:var(--green);opacity:0;transition:opacity .3s;margin-left:6px;}
.copy-ok.show{opacity:1;}

/* Button variants */
.bg2{background:rgba(16,185,129,.11);color:var(--green);border:1px solid rgba(16,185,129,.2);}.bg2:hover{background:rgba(16,185,129,.22);}
.bsh{background:rgba(139,92,246,.11);color:var(--violet);border:1px solid rgba(139,92,246,.2);}.bsh:hover{background:rgba(139,92,246,.22);}

/* Edit preview */
.edit-pvs{display:grid;grid-template-columns:repeat(7,1fr);gap:9px;background:var(--bg3);border:1px solid var(--b1);border-radius:9px;padding:13px;margin-bottom:13px;}

@media(max-width:768px){
  .sc-kpis{grid-template-columns:repeat(2,1fr);}
  .sc-title{font-size:17px;}
  .mg{grid-template-columns:1fr;}
  .mkr{grid-template-columns:1fr 1fr;}
}
@media(max-width:480px){.sc-kpis{grid-template-columns:1fr 1fr;}}

</style>
</head>
<body>

<!-- MOBILE BAR -->
<div class="mob-bar">
  <div class="mob-logo">SPX<span style="color:var(--blue)">.</span></div>
  <div class="hb" id="hb" onclick="toggleSB()"><span></span><span></span><span></span></div>
</div>
<div class="sb-ov" id="sb-ov" onclick="closeSB()"></div>

<div class="shell">
<!-- SIDEBAR -->
<nav class="sb" id="sb">
  <div class="sb-logo">
    <div class="lm">SPX<span style="color:var(--blue)">.</span></div>
    <div class="ls">Event Intelligence</div>
  </div>
  <div class="sb-nav">
    <div class="nl">Ana MenÃ¼</div>
    <div class="ni active" onclick="goPage('dashboard',this)"><span class="nx">â—ˆ</span>Dashboard</div>
    <div class="ni" onclick="goPage('events',this)"><span class="nx">â—‰</span>Etkinlikler</div>
    <div class="ni" onclick="goPage('new-event',this)"><span class="nx">ï¼‹</span>Yeni Etkinlik</div>
    <div class="nl" style="margin-top:9px">Analiz</div>
    <div class="ni" onclick="goPage('analysis',this)"><span class="nx">â–£</span>Analiz Motoru</div>
    <div class="ni" onclick="goPage('weather',this)"><span class="nx">â—</span>Hava Durumu</div>
  </div>
  <div class="sb-foot">
    <div class="ull">KullanÄ±cÄ± AdÄ±</div>
    <input class="ui" id="username" placeholder="AdÄ±nÄ±zÄ± girinâ€¦" oninput="saveUser(this.value)">
    <div class="sb-st">
      <span class="dot dot-g"></span><span id="sync-txt">HazÄ±r</span><br>
      <span style="margin-left:10px" id="foot-count">â€” etkinlik</span><br>
      <span style="margin-left:10px" id="foot-users">â€” kullanÄ±cÄ±</span>
    </div>
  </div>
</nav>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div class="pt" id="pg-title">Dashboard</div>
    <div class="tr">
      <select class="flt" id="year-filter" onchange="applyFilters()"><option value="all">TÃ¼m YÄ±llar</option></select>
      <select class="flt" id="city-filter" onchange="applyFilters()"><option value="all">TÃ¼m Åehirler</option></select>
      <button class="btn bs" onclick="syncAll()" title="Yenile">â†»</button>
      <button class="btn bs" onclick="doExport()">â†“ CSV</button>
      <button class="btn bp" onclick="goPage('new-event',document.querySelectorAll('.ni')[2])">ï¼‹ Ekle</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="sec-l">Genel BakÄ±ÅŸ</div>
    <div class="sec-t">Finansal Performans</div>
    <div class="kg">
      <div class="kc bl"><div class="kl">Toplam Ciro</div><div class="kv" id="k-ciro">â‚º0</div><div class="ks" id="k-ciro-s">â€”</div></div>
      <div class="kc gn"><div class="kl">Toplam Net Kar</div><div class="kv" id="k-kar">â‚º0</div><div class="ks" id="k-kar-s">â€”</div></div>
      <div class="kc am"><div class="kl">Toplam Gider</div><div class="kv" id="k-gider">â‚º0</div><div class="ks" id="k-gider-s">â€”</div></div>
      <div class="kc vi"><div class="kl">Ort. Kar MarjÄ±</div><div class="kv" id="k-margin">%0</div><div class="ks" id="k-margin-s">â€”</div></div>
    </div>
    <div class="kg">
      <div class="kc cy"><div class="kl">Etkinlik SayÄ±sÄ±</div><div class="kv" id="k-count">0</div><div class="ks" id="k-count-s">â€”</div></div>
      <div class="kc gn"><div class="kl">En KarlÄ± Etkinlik</div><div class="kv" style="font-size:13px;padding-top:4px" id="k-best">â€”</div><div class="ks" id="k-best-s">â€”</div></div>
      <div class="kc ro"><div class="kl">En DÃ¼ÅŸÃ¼k Performans</div><div class="kv" style="font-size:13px;padding-top:4px" id="k-worst">â€”</div><div class="ks" id="k-worst-s">â€”</div></div>
      <div class="kc bl"><div class="kl">Ort. ROI</div><div class="kv" id="k-roi">%0</div><div class="ks" id="k-roi-s">â€”</div></div>
    </div>
    <div class="cg32">
      <div class="cc"><div class="ch"><div><div class="ct">AylÄ±k Ciro & Kar Trendi</div><div class="cs">SeÃ§ili dÃ¶nem</div></div></div><div class="cw t"><canvas id="cMonthly"></canvas></div></div>
      <div class="cc"><div class="ch"><div><div class="ct">Åehre GÃ¶re ROI</div><div class="cs">KarÅŸÄ±laÅŸtÄ±rma</div></div></div><div class="cw t"><canvas id="cCity"></canvas></div></div>
    </div>
    <div class="cg2">
      <div class="cc"><div class="ch"><div><div class="ct">Etkinlik KarlÄ±lÄ±ÄŸÄ± (Top 10)</div><div class="cs">Ciro vs Gider vs Kar</div></div></div><div class="cw"><canvas id="cEvent"></canvas></div></div>
      <div class="cc"><div class="ch"><div><div class="ct">Gider DaÄŸÄ±lÄ±mÄ±</div><div class="cs">Maliyet kalemleri</div></div></div><div class="cw"><canvas id="cExp"></canvas></div></div>
    </div>
  </div>

  <!-- EVENTS -->
  <div class="page" id="page-events">
    <div class="sec-l">Etkinlik YÃ¶netimi</div>
    <div class="sec-t">TÃ¼m Etkinlikler</div>
    <div class="tc">
      <div class="th">
        <div class="tht">Etkinlik Listesi <span id="ev-badge" style="font-size:10px;color:var(--t3);font-family:'DM Mono',monospace"></span></div>
        <div style="display:flex;gap:7px;align-items:center;flex-wrap:wrap">
          <input class="si" id="ev-srch" placeholder="Araâ€¦" oninput="renderEvents()">
          <label style="font-size:11px;color:var(--t2);display:flex;align-items:center;gap:5px;cursor:pointer;white-space:nowrap">
            <input type="checkbox" id="grp-yr" checked onchange="renderEvents()"> YÄ±la gÃ¶re grupla
          </label>
        </div>
      </div>
      <div class="tsc"><table><thead><tr>
        <th>ETKÄ°NLÄ°K</th><th>TARÄ°H</th><th>ÅEHÄ°R</th><th>YIL</th><th>KATILIMCI</th>
        <th>CÄ°RO</th><th>GÄ°DER</th><th>NET KAR</th><th>KAR MARJI</th>
        <th>ROI</th><th>KAT.BAÅI CÄ°RO</th><th>PERF.</th><th>EKLEYEN</th><th>Ä°ÅLEMLER</th>
      </tr></thead><tbody id="ev-tbody"></tbody></table></div>
    </div>
  </div>

  <!-- NEW EVENT -->
  <div class="page" id="page-new-event">
    <div class="sec-l">Veri GiriÅŸi</div>
    <div class="sec-t">Yeni Etkinlik Ekle</div>
    <div class="fc2">
      <div class="fd">â€” Etkinlik Bilgileri</div>
      <div class="fg3">
        <div class="fg"><label class="fl">Etkinlik AdÄ± *</label><input class="fi" id="f-name" placeholder="Ä°zmir Maratonu 2026"></div>
        <div class="fg"><label class="fl">Tarih *</label><input type="date" class="fi" id="f-date" onchange="onDateChange()"></div>
        <div class="fg"><label class="fl">Åehir *</label><input class="fi" id="f-city" placeholder="Ä°zmir" list="city-dl"><datalist id="city-dl"></datalist></div>
      </div>
      <div class="fg3">
        <div class="fg">
          <label class="fl">YÄ±l *</label>
          <select class="fi" id="f-year" onchange="onYearChange()"></select>
        </div>
        <div class="fg"><label class="fl">KatÄ±lÄ±mcÄ± SayÄ±sÄ±</label><input type="number" class="fi" id="f-kat" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Ã‡adÄ±r SayÄ±sÄ±</label><input type="number" class="fi" id="f-cadir" placeholder="0"></div>
      </div>

      <!-- Dynamic year banner -->
      <div class="yr-banner" id="yr-banner">
        ğŸ†• <span id="yr-banner-txt"></span> yÄ±lÄ± iÃ§in yeni etkinlik â€” sistem otomatik yÄ±l grubu oluÅŸturacak.
      </div>

      <div class="fd">â€” Gider Kalemleri</div>
      <div class="fg4">
        <div class="fg"><label class="fl">Ajans Bedeli (â‚º)</label><input type="number" class="fi" id="f-ajans" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Personel Gideri (â‚º)</label><input type="number" class="fi" id="f-per" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Stand Maliyeti (â‚º)</label><input type="number" class="fi" id="f-stand" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Barter (â‚º)</label><input type="number" class="fi" id="f-barter" placeholder="0" oninput="calcPrev()"></div>
      </div>

      <div class="fd">â€” Ciro Kalemleri</div>
      <div class="fg2">
        <div class="fg"><label class="fl">Ã‡ek Ciro (â‚º)</label><input type="number" class="fi" id="f-cek" placeholder="0" oninput="calcPrev()"></div>
        <div class="fg"><label class="fl">Ã‡adÄ±r Ciro (â‚º)</label><input type="number" class="fi" id="f-cciro" placeholder="0" oninput="calcPrev()"></div>
      </div>

      <div class="fd">â€” AnlÄ±k Hesaplama</div>
      <div class="pvs">
        <div class="pvi"><div class="pvl">Toplam Ciro</div><div class="pvv cb" id="p-ciro">â‚º0</div></div>
        <div class="pvi"><div class="pvl">Toplam Gider</div><div class="pvv ca" id="p-gider">â‚º0</div></div>
        <div class="pvi"><div class="pvl">Net Kar</div><div class="pvv cg" id="p-kar">â‚º0</div></div>
        <div class="pvi"><div class="pvl">Kar MarjÄ±</div><div class="pvv cb" id="p-margin">â€”</div></div>
        <div class="pvi"><div class="pvl">ROI</div><div class="pvv cg" id="p-roi">â€”</div></div>
        <div class="pvi"><div class="pvl">Kat.BaÅŸÄ± Ciro</div><div class="pvv cb" id="p-pciro">â€”</div></div>
        <div class="pvi"><div class="pvl">Kat.BaÅŸÄ± Mlt.</div><div class="pvv ca" id="p-pgdr">â€”</div></div>
      </div>

      <div class="fd">â€” Hava Durumu (Gemini AI)</div>
      <div class="wx-box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;flex-wrap:wrap;gap:7px">
          <span style="font-size:12px;color:var(--t2)">Gemini'ye gÃ¶nderilecek prompt:</span>
          <button class="btn bs" style="font-size:11px" onclick="buildPrompt()">âŸ³ OluÅŸtur</button>
        </div>
        <div class="wx-pr" id="wx-pr">Tarih ve ÅŸehir girerek prompt oluÅŸturunâ€¦</div>
        <div style="margin-top:11px">
          <label class="fl" style="margin-bottom:5px;display:block">Gemini yanÄ±tÄ±nÄ± buraya yapÄ±ÅŸtÄ±r</label>
          <textarea class="fi" id="f-wx" rows="4" style="resize:vertical;font-family:'DM Mono',monospace;font-size:11px" placeholder="SÄ±caklÄ±k: 22Â°C&#10;Durum: GÃ¼neÅŸli&#10;RÃ¼zgar: 15 km/h"></textarea>
        </div>
      </div>

      <div style="display:flex;gap:9px;justify-content:flex-end;flex-wrap:wrap">
        <button class="btn bs" onclick="clearForm()">Temizle</button>
        <button class="btn bp" onclick="saveEvent()">âœ“ Kaydet</button>
      </div>
    </div>
  </div>

  <!-- ANALYSIS -->
  <div class="page" id="page-analysis">
    <div class="sec-l">Karar Destek Sistemi</div>
    <div class="sec-t">Analiz Motoru</div>
    <div class="ig">
      <div class="ic"><div class="ih"><div class="ii ig2">ğŸ†</div><div class="it">Åehir BazlÄ± KarlÄ±lÄ±k</div></div><div id="city-ins"></div></div>
      <div class="ic"><div class="ih"><div class="ii ib">ğŸ“Š</div><div class="it">Ajans Maliyeti vs Kar MarjÄ±</div></div><div class="cw"><canvas id="cAgency"></canvas></div></div>
      <div class="ic"><div class="ih"><div class="ii ia">ğŸ‘¥</div><div class="it">KatÄ±lÄ±mcÄ± & ROI Ä°liÅŸkisi</div></div><div class="cw"><canvas id="cPart"></canvas></div></div>
      <div class="ic"><div class="ih"><div class="ii ir2">ğŸŒ¤</div><div class="it">Hava Durumu & Performans</div></div><div id="wx-ins"><div class="empty">Hava durumu girildikÃ§e analiz gÃ¶rÃ¼nÃ¼r.</div></div></div>
    </div>
    <div class="cc">
      <div class="ch"><div><div class="ct">Karar Destek Ã–zeti</div><div class="cs">Veri odaklÄ± Ã¶neriler</div></div></div>
      <div class="dg" id="deci-cards"></div>
    </div>
  </div>

  <!-- WEATHER -->
  <div class="page" id="page-weather">
    <div class="sec-l">Gemini AI Entegrasyonu</div>
    <div class="sec-t">Hava Durumu Rehberi</div>
    <div class="fc2" style="margin-bottom:18px">
      <div style="background:var(--bg3);border-radius:9px;padding:16px">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:1px;margin-bottom:9px">PROMPT ÅABLONU</div>
        <div style="font-family:'DM Mono',monospace;font-size:12px;line-height:2;color:var(--t2)">
          "<span style="color:var(--t1)">[TARÄ°H] tarihinde [ÅEHÄ°R]'de hava nasÄ±ldÄ±?</span><br>Sadece ÅŸu formatta cevap ver:<br>SÄ±caklÄ±k: XÂ°C<br>Durum: GÃ¼neÅŸli/YaÄŸmurlu/Bulutlu<br>RÃ¼zgar: X km/h"
        </div>
      </div>
      <div style="margin-top:11px;font-size:12px;color:var(--t3)">â„¹ï¸ YanÄ±tÄ± kopyalayÄ±p Yeni Etkinlik â†’ Hava Durumu alanÄ±na yapÄ±ÅŸtÄ±rÄ±n.</div>
    </div>
    <div class="tc">
      <div class="th"><div class="tht">Hava Durumu KayÄ±tlarÄ±</div></div>
      <div class="tsc"><table><thead><tr>
        <th>ETKÄ°NLÄ°K</th><th>TARÄ°H</th><th>ÅEHÄ°R</th><th>YIL</th><th>SICAKLIK</th><th>DURUM</th><th>RÃœZGAR</th><th>NET KAR</th><th>ETKÄ°</th>
      </tr></thead><tbody id="wx-tbody"></tbody></table></div>
    </div>
  </div>
</main>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ SEED DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEED=[
  {id:'s1',name:'Ä°zmir Maratonu',date:'2024-04-21',city:'Ä°zmir',participants:5759,tents:0,agency:47300,personnel:12910,standCost:80000,barter:0,cekCiro:0,cadirCiro:161621,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s2',name:'Merrell TahtalÄ± Run To Sky',date:'2024-11-05',city:'Antalya',participants:825,tents:0,agency:0,personnel:3651,standCost:0,barter:0,cekCiro:53683,cadirCiro:348600,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s3',name:'Spx DaÄŸyenice Ultra',date:'2024-05-24',city:'Bursa',participants:980,tents:0,agency:0,personnel:6760,standCost:0,barter:0,cekCiro:11493,cadirCiro:227000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s4',name:'Granfondo Bursa',date:'2024-05-26',city:'Bursa',participants:600,tents:0,agency:13500,personnel:500,standCost:0,barter:12000,cekCiro:13941,cadirCiro:23000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s5',name:'Wolfest',date:'2024-05-31',city:'Kocaeli',participants:0,tents:0,agency:0,personnel:0,standCost:0,barter:0,cekCiro:0,cadirCiro:236200,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s6',name:'SPX Pickleball Ä°stanbul Cup',date:'2024-06-06',city:'Ä°stanbul',participants:80,tents:0,agency:0,personnel:7500,standCost:0,barter:0,cekCiro:14424,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s7',name:'Spx UludaÄŸ Bisiklet TÄ±rmanÄ±ÅŸÄ±',date:'2024-08-03',city:'Bursa',participants:458,tents:0,agency:33500,personnel:4850,standCost:0,barter:0,cekCiro:1226,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s8',name:'UludaÄŸ Ultra Trail',date:'2024-07-13',city:'Bursa',participants:2620,tents:0,agency:38500,personnel:28000,standCost:60000,barter:0,cekCiro:0,cadirCiro:160167,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s9',name:'EskiÅŸehir YarÄ± Maratonu',date:'2024-08-25',city:'EskiÅŸehir',participants:1850,tents:5,agency:38500,personnel:11440,standCost:0,barter:50000,cekCiro:40833,cadirCiro:110266,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s10',name:'Bursa Pickleball TurnuvasÄ±',date:'2024-08-24',city:'Bursa',participants:75,tents:0,agency:28102,personnel:9500,standCost:0,barter:0,cekCiro:0,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s11',name:'Merrell Belgrad Ultra',date:'2024-07-09',city:'Ä°stanbul',participants:2590,tents:0,agency:0,personnel:27764,standCost:0,barter:0,cekCiro:0,cadirCiro:343386,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s12',name:'Kyzikos Ultra Trail',date:'2024-09-21',city:'Erdek',participants:1100,tents:0,agency:44110,personnel:35664,standCost:0,barter:0,cekCiro:0,cadirCiro:144000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s13',name:'Ankara Kahve Festivali',date:'2024-09-20',city:'Ankara',participants:35000,tents:0,agency:0,personnel:500,standCost:0,barter:50000,cekCiro:62630,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s14',name:'Spx Pickleball Ä°zmir Cup',date:'2024-10-11',city:'Ä°zmir',participants:90,tents:0,agency:0,personnel:78000,standCost:0,barter:0,cekCiro:25436,cadirCiro:0,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s15',name:'Salomon Cappadocia Ultra',date:'2024-10-19',city:'NevÅŸehir',participants:3500,tents:4,agency:48500,personnel:72000,standCost:100000,barter:0,cekCiro:0,cadirCiro:517000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s16',name:'Kurumsal KÃ¼rek YarÄ±ÅŸÄ±',date:'2024-02-11',city:'Bursa',participants:350,tents:0,agency:0,personnel:1200,standCost:0,barter:0,cekCiro:3500,cadirCiro:10000,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s17',name:'Antalya Ultra',date:'2024-12-28',city:'Antalya',participants:950,tents:0,agency:43296,personnel:15180,standCost:30000,barter:0,cekCiro:0,cadirCiro:181419,year:2024,weather:'',addedBy:'Sistem'},
  {id:'s18',name:'Efes Ultra Maratonu',date:'2025-04-04',city:'Ä°zmir',participants:2180,tents:6,agency:60000,personnel:49460,standCost:30000,barter:0,cekCiro:0,cadirCiro:658000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s19',name:'SPX Pickleball Ligi Nisan',date:'2025-04-12',city:'Ä°stanbul',participants:60,tents:0,agency:0,personnel:6039,standCost:0,barter:0,cekCiro:0,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s20',name:'Troya YarÄ± Maratonu',date:'2025-04-19',city:'Ã‡anakkale',participants:2500,tents:8,agency:140100,personnel:27996,standCost:0,barter:0,cekCiro:87011,cadirCiro:1014904,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s21',name:'TahtalÄ± Run To Sky 2025',date:'2025-05-10',city:'Antalya',participants:300,tents:0,agency:0,personnel:0,standCost:36000,barter:0,cekCiro:0,cadirCiro:126000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s22',name:'SPX Tenis TurnuvasÄ±',date:'2025-05-17',city:'Antalya',participants:600,tents:0,agency:106774,personnel:0,standCost:0,barter:0,cekCiro:111915,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s23',name:'KTSK Åenlikleri',date:'2025-05-23',city:'Ä°stanbul',participants:10000,tents:0,agency:103000,personnel:0,standCost:0,barter:0,cekCiro:0,cadirCiro:1185749,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s24',name:'Sapanca Ultra',date:'2025-06-14',city:'Sakarya',participants:1000,tents:0,agency:120000,personnel:35596,standCost:0,barter:0,cekCiro:0,cadirCiro:220733,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s25',name:'KTSK En Uzun Gece',date:'2025-06-20',city:'Ä°stanbul',participants:3000,tents:0,agency:162000,personnel:30500,standCost:0,barter:0,cekCiro:0,cadirCiro:526000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s26',name:'SPX Pickleball Ligi Finalleri',date:'2025-06-28',city:'Ä°stanbul',participants:90,tents:0,agency:145080,personnel:35000,standCost:0,barter:0,cekCiro:106000,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s27',name:'YKB Ankara Yaz Åenlikleri',date:'2025-07-05',city:'Ankara',participants:450,tents:0,agency:147912,personnel:2950,standCost:0,barter:0,cekCiro:0,cadirCiro:25000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s28',name:'YKB BankacÄ±lÄ±k ÃœssÃ¼',date:'2025-07-16',city:'Kocaeli',participants:500,tents:0,agency:90000,personnel:34371,standCost:0,barter:0,cekCiro:0,cadirCiro:261220,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s29',name:'UludaÄŸ Ultra Trail YarÄ±ÅŸÄ±',date:'2025-07-18',city:'Bursa',participants:2500,tents:0,agency:114000,personnel:44000,standCost:100000,barter:0,cekCiro:0,cadirCiro:462762,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s30',name:'EskiÅŸehir YarÄ± Maratonu 2025',date:'2025-08-02',city:'EskiÅŸehir',participants:2400,tents:0,agency:131700,personnel:29580,standCost:0,barter:54000,cekCiro:0,cadirCiro:222000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s31',name:'Gran Fondo BaÅŸkent Bisiklet',date:'2025-08-23',city:'Ankara',participants:900,tents:0,agency:0,personnel:3800,standCost:0,barter:0,cekCiro:0,cadirCiro:39000,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s32',name:'Summer Run',date:'2025-08-30',city:'Ä°stanbul',participants:1150,tents:0,agency:48000,personnel:24555,standCost:120000,barter:0,cekCiro:0,cadirCiro:70826,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s33',name:'Merrell Belgrad Ultra 2025',date:'2025-09-05',city:'Ä°stanbul',participants:3500,tents:0,agency:0,personnel:30132,standCost:0,barter:0,cekCiro:0,cadirCiro:400375,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s34',name:'Tuzla Fest Run',date:'2025-09-19',city:'Ä°stanbul',participants:1200,tents:0,agency:79200,personnel:22494,standCost:30000,barter:40000,cekCiro:0,cadirCiro:87526,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s35',name:'Runkara YarÄ± Maratonu',date:'2025-10-04',city:'Ankara',participants:3300,tents:0,agency:108000,personnel:9435,standCost:40000,barter:60000,cekCiro:0,cadirCiro:0,year:2025,weather:'',addedBy:'Sistem'},
  {id:'s36',name:'Salomon Kapadokya YarÄ±ÅŸÄ±',date:'2025-10-16',city:'NevÅŸehir',participants:3500,tents:0,agency:146400,personnel:117600,standCost:120000,barter:0,cekCiro:0,cadirCiro:738000,year:2025,weather:'',addedBy:'Sistem'},
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let DB=[];
let username='';
let CH={};
const SK='spx:events:v4';
const UK='spx:user';

// â”€â”€ STORAGE (shared via window.storage if available) â”€â”€
async function sGet(k){
  if(window.storage){try{const r=await window.storage.get(k,true);return r?r.value:null;}catch{return null;}}
  return localStorage.getItem(k);
}
async function sSet(k,v){
  if(window.storage){try{await window.storage.set(k,v,true);}catch(e){console.warn(e);}return;}
  localStorage.setItem(k,v);
}
function lGet(k){return localStorage.getItem(k);}
function lSet(k,v){localStorage.setItem(k,v);}

// â”€â”€ COMPUTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calc(e){
  const ciro=(e.cekCiro||0)+(e.cadirCiro||0);
  const gider=(e.agency||0)+(e.personnel||0)+(e.standCost||0)+(e.barter||0);
  const kar=ciro-gider;
  const margin=ciro>0?(kar/ciro)*100:0;
  const roi=gider>0?(kar/gider)*100:0;
  const perC=e.participants>0?ciro/e.participants:0;
  const perG=e.participants>0?gider/e.participants:0;
  return{ciro,gider,kar,margin,roi,perC,perG};
}

// â”€â”€ FORMAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fc(n){const a=Math.abs(n),s=n<0?'-':'';return s+'â‚º'+(a>=1e6?(a/1e6).toFixed(1)+'M':a>=1000?(a/1000).toFixed(0)+'K':Math.round(a).toLocaleString('tr-TR'));}
function fn(n){return Math.round(n).toLocaleString('tr-TR');}

// â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filtered(){
  const y=document.getElementById('year-filter').value;
  const c=document.getElementById('city-filter').value;
  return DB.filter(e=>(y==='all'||String(e.year)===y)&&(c==='all'||e.city===c));
}

function rebuildFilters(){
  const years=[...new Set(DB.map(e=>e.year))].sort((a,b)=>b-a);
  const cities=[...new Set(DB.map(e=>e.city))].sort();
  const nowY=new Date().getFullYear();

  const yf=document.getElementById('year-filter'),cy=yf.value;
  yf.innerHTML='<option value="all">TÃ¼m YÄ±llar</option>'+years.map(y=>`<option value="${y}"${String(y)===cy?' selected':''}>${y}</option>`).join('');

  const cf=document.getElementById('city-filter'),cc=cf.value;
  cf.innerHTML='<option value="all">TÃ¼m Åehirler</option>'+cities.map(c=>`<option value="${c}"${c===cc?' selected':''}>${c}</option>`).join('');

  // City datalist
  document.getElementById('city-dl').innerHTML=cities.map(c=>`<option value="${c}">`).join('');

  // Year select for form: all existing years + current + next 2
  const formYears=[...new Set([...years,nowY,nowY+1,nowY+2])].sort((a,b)=>b-a);
  const fy=document.getElementById('f-year'),fcy=fy.value||nowY;
  fy.innerHTML=formYears.map(y=>`<option value="${y}"${String(y)===String(fcy)?' selected':''}>${y} Etkinlikleri</option>`).join('');
}

// â”€â”€ LOAD / SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData(){
  setST('YÃ¼kleniyorâ€¦');
  try{
    const raw=await sGet(SK);
    let userEvs=[];
    if(raw){try{userEvs=JSON.parse(raw);}catch{}}
    const map=new Map();
    SEED.forEach(e=>map.set(e.id,e));
    userEvs.forEach(e=>map.set(e.id,e));
    DB=[...map.values()].sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
    rebuildFilters();
    setST('Senkronize');
    updateFoot();
  }catch{
    DB=[...SEED];
    rebuildFilters();
    setST('Ã‡evrimdÄ±ÅŸÄ±');
  }
}
async function saveData(){
  const toSave=DB.filter(e=>!e.id.startsWith('s')||e.weather);
  await sSet(SK,JSON.stringify(toSave));
  updateFoot();
}
async function syncAll(){await loadData();applyFilters();toast('â†» Senkronize edildi');}
function setST(t){document.getElementById('sync-txt').textContent=t;}
function updateFoot(){
  document.getElementById('foot-count').textContent=DB.length+' etkinlik';
  const u=[...new Set(DB.map(e=>e.addedBy).filter(Boolean))];
  document.getElementById('foot-users').textContent=u.length+' kullanÄ±cÄ±';
}

// â”€â”€ USER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveUser(v){username=v.trim();lSet(UK,username);}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDashboard(){
  const evs=filtered().map(e=>({...e,...calc(e)}));
  const tCiro=evs.reduce((a,b)=>a+b.ciro,0);
  const tGider=evs.reduce((a,b)=>a+b.gider,0);
  const tKar=evs.reduce((a,b)=>a+b.kar,0);
  const wC=evs.filter(e=>e.ciro>0),wG=evs.filter(e=>e.gider>0);
  const avgM=wC.length?wC.reduce((a,b)=>a+b.margin,0)/wC.length:0;
  const avgR=wG.length?wG.reduce((a,b)=>a+b.roi,0)/wG.length:0;

  sv('k-ciro',fc(tCiro));sv('k-kar',fc(tKar));sv('k-gider',fc(tGider));
  sv('k-margin',avgM.toFixed(1)+'%');sv('k-count',evs.length+'');sv('k-roi',avgR.toFixed(1)+'%');
  sv('k-ciro-s',`Ã‡ek: ${fc(evs.reduce((a,b)=>a+b.cekCiro,0))} Â· Ã‡adÄ±r: ${fc(evs.reduce((a,b)=>a+b.cadirCiro,0))}`);
  sv('k-kar-s',`Marj: ${tCiro>0?((tKar/tCiro)*100).toFixed(1):'0'}%`);

  const sorted=wC.sort((a,b)=>b.kar-a.kar);
  if(sorted.length){
    sv('k-best',sorted[0].name.substring(0,22)+(sorted[0].name.length>22?'â€¦':''));
    sv('k-best-s',fc(sorted[0].kar)+' kar');
    sv('k-worst',sorted[sorted.length-1].name.substring(0,22));
    sv('k-worst-s',fc(sorted[sorted.length-1].kar));
  }
  buildCharts(evs);
}

// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TT={backgroundColor:'#1a2438',borderColor:'rgba(59,130,246,.3)',borderWidth:1,titleColor:'#f0f4ff',bodyColor:'#8da0bf',padding:10};
const LEG={labels:{color:'#8da0bf',font:{family:'DM Mono',size:10},boxWidth:9}};
function AX(isY=false){return{grid:{color:'rgba(59,130,246,.05)'},ticks:{color:'#4d6080',font:{family:'DM Mono',size:9},callback:isY?v=>{const a=Math.abs(v);return(a>=1e6?(v/1e6).toFixed(1)+'M':a>=1000?(v/1000).toFixed(0)+'K':v)+'';}:undefined}};}
function dc(id){if(CH[id]){CH[id].destroy();delete CH[id];}}

function buildCharts(evs){
  const MN=['Oca','Åub','Mar','Nis','May','Haz','Tem','AÄŸu','Eyl','Eki','Kas','Ara'];
  const mp={};
  evs.forEach(e=>{
    if(!e.date)return;const d=new Date(e.date);if(isNaN(d))return;
    const k=e.year+'-'+String(d.getMonth()).padStart(2,'0');
    if(!mp[k])mp[k]={lbl:MN[d.getMonth()]+' '+e.year,ciro:0,kar:0};
    mp[k].ciro+=e.ciro;mp[k].kar+=e.kar;
  });
  const mk=Object.keys(mp).sort();
  dc('monthly');
  CH.monthly=new Chart(document.getElementById('cMonthly'),{type:'bar',data:{labels:mk.map(k=>mp[k].lbl),datasets:[
    {label:'Ciro',data:mk.map(k=>mp[k].ciro),backgroundColor:'rgba(59,130,246,.65)',borderRadius:4,order:2},
    {label:'Kar',data:mk.map(k=>mp[k].kar),type:'line',borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.1)',borderWidth:2,pointRadius:3,tension:.4,order:1,fill:true}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  const cm={};
  evs.forEach(e=>{if(!cm[e.city])cm[e.city]={kar:0,gider:0};cm[e.city].kar+=e.kar;cm[e.city].gider+=e.gider;});
  const cok=Object.keys(cm).filter(c=>cm[c].gider>0);
  const rois=cok.map(c=>(cm[c].kar/cm[c].gider)*100);
  dc('city');
  CH.city=new Chart(document.getElementById('cCity'),{type:'bar',data:{labels:cok,datasets:[{label:'ROI %',data:rois,backgroundColor:rois.map(r=>r>=0?'rgba(16,185,129,.7)':'rgba(244,63,94,.7)'),borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),ticks:{...AX().ticks,callback:v=>v.toFixed(0)+'%'}},y:AX()}}});

  const top=evs.filter(e=>e.ciro>0).sort((a,b)=>b.ciro-a.ciro).slice(0,10);
  dc('event');
  CH.event=new Chart(document.getElementById('cEvent'),{type:'bar',data:{labels:top.map(e=>e.name.substring(0,13)+(e.name.length>13?'â€¦':'')),datasets:[
    {label:'Ciro',data:top.map(e=>e.ciro),backgroundColor:'rgba(59,130,246,.5)',borderRadius:3},
    {label:'Gider',data:top.map(e=>e.gider),backgroundColor:'rgba(244,63,94,.5)',borderRadius:3},
    {label:'Kar',data:top.map(e=>e.kar),backgroundColor:'rgba(16,185,129,.7)',borderRadius:3}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:AX(),y:AX(true)}}});

  const tA=evs.reduce((a,b)=>a+(b.agency||0),0);
  const tP=evs.reduce((a,b)=>a+(b.personnel||0),0);
  const tS=evs.reduce((a,b)=>a+(b.standCost||0),0);
  const tB=evs.reduce((a,b)=>a+(b.barter||0),0);
  dc('exp');
  CH.exp=new Chart(document.getElementById('cExp'),{type:'doughnut',data:{labels:['Ajans','Personel','Stand','Barter'],datasets:[{data:[tA,tP,tS,tB],backgroundColor:['rgba(59,130,246,.8)','rgba(139,92,246,.8)','rgba(245,158,11,.8)','rgba(34,211,238,.8)'],borderWidth:0,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{...LEG,position:'bottom'},tooltip:TT}}});
}

// â”€â”€ EVENTS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEvents(){
  const evs=filtered();
  const q=(document.getElementById('ev-srch').value||'').toLowerCase();
  const grouped=document.getElementById('grp-yr').checked;
  const tbody=document.getElementById('ev-tbody');
  document.getElementById('ev-badge').textContent=`(${evs.length})`;

  const rows=evs.filter(e=>!q||e.name.toLowerCase().includes(q)||e.city.toLowerCase().includes(q));
  tbody.innerHTML='';
  if(!rows.length){tbody.innerHTML=`<tr><td colspan="14"><div class="empty">Etkinlik bulunamadÄ±</div></td></tr>`;return;}

  if(grouped){
    const years=[...new Set(rows.map(e=>e.year))].sort((a,b)=>b-a);
    years.forEach(yr=>{
      const yr_rows=rows.filter(e=>e.year===yr);
      const ym=yr_rows.map(e=>calc(e));
      const yC=ym.reduce((a,b)=>a+b.ciro,0),yK=ym.reduce((a,b)=>a+b.kar,0);
      // Year header
      const htr=document.createElement('tr');htr.className='yr-row';
      htr.innerHTML=`<td colspan="14">${yr} Etkinlikleri<span class="yr-stats">${yr_rows.length} etkinlik &nbsp;Â·&nbsp; Ciro: ${fc(yC)} &nbsp;Â·&nbsp; Net Kar: ${fc(yK)}</span></td>`;
      tbody.appendChild(htr);
      yr_rows.forEach(ev=>tbody.appendChild(mkRow(ev)));
    });
  } else {
    rows.forEach(ev=>tbody.appendChild(mkRow(ev)));
  }
}

function mkRow(ev){
  const m=calc(ev);
  const p=m.margin>=40?'h':m.margin>=0?'m':'l';
  const pL={h:'YÃ¼ksek',m:'Orta',l:'DÃ¼ÅŸÃ¼k'}[p];
  const tr=document.createElement('tr');
  tr.onclick=e=>{if(e.target.closest('.row-acts'))return;showDetail(ev.id);};
  tr.innerHTML=`
    <td class="nm" title="${ev.name}">${ev.name}</td>
    <td>${ev.date||'â€”'}</td><td>${ev.city}</td>
    <td class="mo">${ev.year}</td>
    <td class="mo">${ev.participants>0?fn(ev.participants):'â€”'}</td>
    <td class="mo ${m.ciro>0?'pg':''}">${fc(m.ciro)}</td>
    <td class="mo">${fc(m.gider)}</td>
    <td class="mo ${m.kar>=0?'pg':'pr'}">${fc(m.kar)}</td>
    <td class="mo ${m.margin>=0?'pg':'pr'}">${m.ciro>0?m.margin.toFixed(1)+'%':'â€”'}</td>
    <td class="mo ${m.roi>=0?'pg':'pr'}">${m.gider>0?m.roi.toFixed(0)+'%':'â€”'}</td>
    <td class="mo">${ev.participants>0&&m.ciro>0?fc(m.perC):'â€”'}</td>
    <td><span class="pl p${p}">${pL}</span></td>
    <td><span class="pl pu" style="font-size:9px">${ev.addedBy||'â€”'}</span></td>
    <td><div class="row-acts">
      <button class="rab rab-e" title="DÃ¼zenle" onclick="openEdit('${ev.id}')">âœ</button>
      <button class="rab rab-s" title="PaylaÅŸ" onclick="openShare('${ev.id}')">â¬†</button>
      <button class="rab rab-d" title="Sil" onclick="delEv('${ev.id}',event)">âœ•</button>
    </div></td>`;
  return tr;
}

async function delEv(id,e){
  e.stopPropagation();
  if(!confirm('Bu etkinliÄŸi silmek istiyor musunuz?'))return;
  DB=DB.filter(ev=>ev.id!==id);
  await saveData();rebuildFilters();applyFilters();toast('Etkinlik silindi');
}

// â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDateChange(){
  const d=document.getElementById('f-date').value;
  if(d){document.getElementById('f-year').value=new Date(d).getFullYear();onYearChange();}
  buildPrompt();calcPrev();
}

function onYearChange(){
  const yr=parseInt(document.getElementById('f-year').value);
  const existing=new Set(DB.map(e=>e.year));
  const banner=document.getElementById('yr-banner');
  if(!existing.has(yr)){
    banner.style.display='block';
    document.getElementById('yr-banner-txt').textContent=yr;
  } else {banner.style.display='none';}
}

function calcPrev(){
  const cek=nv('f-cek'),cc=nv('f-cciro'),aj=nv('f-ajans'),pe=nv('f-per'),st=nv('f-stand'),ba=nv('f-barter'),kat=nv('f-kat');
  const ciro=cek+cc,gider=aj+pe+st+ba,kar=ciro-gider;
  sv('p-ciro',fc(ciro));sv('p-gider',fc(gider));
  const pk=document.getElementById('p-kar');pk.textContent=fc(kar);pk.className='pvv '+(kar>=0?'cg':'cr');
  sv('p-margin',ciro>0?((kar/ciro)*100).toFixed(1)+'%':'â€”');
  sv('p-roi',gider>0?((kar/gider)*100).toFixed(1)+'%':'â€”');
  sv('p-pciro',kat>0&&ciro>0?fc(ciro/kat):'â€”');
  sv('p-pgdr',kat>0&&gider>0?fc(gider/kat):'â€”');
}

function buildPrompt(){
  const date=document.getElementById('f-date').value;
  const city=(document.getElementById('f-city').value||'').trim();
  if(!date||!city){document.getElementById('wx-pr').textContent='Tarih ve ÅŸehir girerek prompt oluÅŸturunâ€¦';return;}
  const d=new Date(date);
  const MN=['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
  document.getElementById('wx-pr').textContent=`${d.getDate()} ${MN[d.getMonth()]} ${d.getFullYear()} tarihinde ${city}'de hava nasÄ±ldÄ±?\nSadece ÅŸu formatta cevap ver:\nSÄ±caklÄ±k: XÂ°C\nDurum: GÃ¼neÅŸli/YaÄŸmurlu/Bulutlu\nRÃ¼zgar: X km/h`;
}

async function saveEvent(){
  const name=(document.getElementById('f-name').value||'').trim();
  const city=(document.getElementById('f-city').value||'').trim();
  const date=document.getElementById('f-date').value;
  const year=parseInt(document.getElementById('f-year').value);
  if(!name||!city){toast('Etkinlik adÄ± ve ÅŸehir zorunludur','err');return;}
  if(!username){toast('LÃ¼tfen sol menÃ¼den kullanÄ±cÄ± adÄ± girin','err');return;}

  const ev={
    id:'u'+Date.now(),name,date,city,year,
    participants:nv('f-kat'),tents:nv('f-cadir'),
    agency:nv('f-ajans'),personnel:nv('f-per'),standCost:nv('f-stand'),barter:nv('f-barter'),
    cekCiro:nv('f-cek'),cadirCiro:nv('f-cciro'),
    weather:(document.getElementById('f-wx').value||'').trim(),
    addedBy:username,addedAt:new Date().toISOString()
  };

  DB.push(ev);DB.sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
  await saveData();rebuildFilters();applyFilters();
  toast('âœ“ Kaydedildi: '+name);
  clearForm();
  goPage('events',document.querySelectorAll('.ni')[1]);
}

function clearForm(){
  ['f-name','f-date','f-city','f-kat','f-cadir','f-ajans','f-per','f-stand','f-barter','f-cek','f-cciro','f-wx'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('yr-banner').style.display='none';
  document.getElementById('wx-pr').textContent='Tarih ve ÅŸehir girerek prompt oluÅŸturunâ€¦';
  calcPrev();
}

// â”€â”€ ANALYSIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAnalysis(){
  const evs=filtered().map(e=>({...e,...calc(e)}));
  const cm={};evs.forEach(e=>{if(!cm[e.city])cm[e.city]={kar:0,gider:0,ciro:0,count:0};cm[e.city].kar+=e.kar;cm[e.city].gider+=e.gider;cm[e.city].ciro+=e.ciro;cm[e.city].count++;});
  const cities=Object.entries(cm).sort((a,b)=>b[1].kar-a[1].kar);
  const maxK=Math.max(...cities.map(c=>Math.abs(c[1].kar)))||1;
  document.getElementById('city-ins').innerHTML=cities.slice(0,8).map(([city,d])=>{
    const pct=(Math.abs(d.kar)/maxK)*100;const col=d.kar>=0?'var(--green)':'var(--rose)';
    return `<div class="ins-row"><span class="irl">${city}</span><div class="irbw"><div class="irb" style="width:${pct}%;background:${col}"></div></div><span class="irv">${fc(d.kar)}</span></div>`;
  }).join('');

  const ad=evs.filter(e=>e.agency>0&&e.ciro>0);
  dc('agency');CH.agency=new Chart(document.getElementById('cAgency'),{type:'scatter',data:{datasets:[{label:'Etkinlik',data:ad.map(e=>({x:e.agency/1000,y:e.margin})),backgroundColor:'rgba(59,130,246,.6)',pointRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),title:{display:true,text:'Ajans (Kâ‚º)',color:'#4d6080',font:{size:9}},ticks:{...AX().ticks,callback:v=>v+'K'}},y:{...AX(),title:{display:true,text:'Kar MarjÄ± %',color:'#4d6080',font:{size:9}},ticks:{...AX().ticks,callback:v=>v.toFixed(0)+'%'}}}}});

  const pd=evs.filter(e=>e.participants>0&&e.gider>0);
  dc('part');CH.part=new Chart(document.getElementById('cPart'),{type:'scatter',data:{datasets:[{label:'Etkinlik',data:pd.map(e=>({x:e.participants,y:e.roi})),backgroundColor:'rgba(245,158,11,.6)',pointRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LEG,tooltip:TT},scales:{x:{...AX(),title:{display:true,text:'KatÄ±lÄ±mcÄ±',color:'#4d6080',font:{size:9}}},y:{...AX(),title:{display:true,text:'ROI %',color:'#4d6080',font:{size:9}},ticks:{...AX().ticks,callback:v=>v.toFixed(0)+'%'}}}}});

  const wxEvs=evs.filter(e=>e.weather);
  if(wxEvs.length){
    const byC={};wxEvs.forEach(e=>{const c2=parseWx(e.weather).cond||'Bilinmiyor';if(!byC[c2])byC[c2]=[];byC[c2].push(e.roi);});
    document.getElementById('wx-ins').innerHTML=Object.entries(byC).map(([c2,r])=>{const avg=r.reduce((a,b)=>a+b,0)/r.length;return`<div class="ins-row"><span class="irl">${c2}</span><span class="irv ${avg>=0?'pg':'pr'}">${avg.toFixed(0)}% ROI</span></div>`;}).join('');
  }

  const bestCity=cities[0];
  const prof=evs.filter(e=>e.kar>0&&e.ciro>0).length;
  const total=evs.filter(e=>e.ciro>0).length;
  const avgA=evs.filter(e=>e.agency>0).reduce((a,b)=>a+b.agency,0)/Math.max(1,evs.filter(e=>e.agency>0).length);
  document.getElementById('deci-cards').innerHTML=`
    <div class="dc2" style="background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2)">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--green);letter-spacing:1px;margin-bottom:7px">ğŸ† EN KARLI ÅEHÄ°R</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700">${bestCity?bestCity[0]:'â€”'}</div>
      <div style="font-size:11px;color:var(--t3);margin-top:3px">${bestCity?fc(bestCity[1].kar)+' Â· '+bestCity[1].count+' etkinlik':'â€”'}</div>
    </div>
    <div class="dc2" style="background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.2)">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue2);letter-spacing:1px;margin-bottom:7px">ğŸ“ˆ KARLILIK ORANI</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700">${total>0?((prof/total)*100).toFixed(0)+'%':'â€”'}</div>
      <div style="font-size:11px;color:var(--t3);margin-top:3px">${prof} / ${total} etkinlik kÃ¢rlÄ±</div>
    </div>
    <div class="dc2" style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2)">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:1px;margin-bottom:7px">ğŸ’¡ ORT. AJANS MALÄ°YETÄ°</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700">${fc(avgA)}</div>
      <div style="font-size:11px;color:var(--t3);margin-top:3px">Etkinlik baÅŸÄ±na ortalama</div>
    </div>`;
}

// â”€â”€ WEATHER TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWeather(){
  const evs=DB.filter(e=>e.weather&&e.weather.trim());
  const tbody=document.getElementById('wx-tbody');
  if(!evs.length){tbody.innerHTML=`<tr><td colspan="9"><div class="empty">HenÃ¼z hava durumu verisi yok.</div></td></tr>`;return;}
  tbody.innerHTML=evs.map(ev=>{
    const m=calc(ev);const w=parseWx(ev.weather);
    const imp=!w.cond?'â€”':m.roi>80&&(w.cond.includes('GÃ¼neÅŸ')||w.cond.includes('AÃ§Ä±k'))?'<span class="pl ph">â†‘ Olumlu</span>':w.cond.includes('YaÄŸmur')&&m.roi<0?'<span class="pl plo">â†“ Olumsuz</span>':'<span class="pl pm">â†’ NÃ¶tr</span>';
    return `<tr><td class="nm">${ev.name}</td><td>${ev.date||'â€”'}</td><td>${ev.city}</td><td class="mo">${ev.year}</td><td class="mo">${w.temp||'â€”'}</td><td>${w.cond||'â€”'}</td><td class="mo">${w.wind||'â€”'}</td><td class="mo ${m.kar>=0?'pg':'pr'}">${fc(m.kar)}</td><td>${imp}</td></tr>`;
  }).join('');
}

function parseWx(s){
  if(!s)return{};
  return{
    temp:((s.match(/sÄ±caklÄ±k:\s*([\d.]+)/i)||[])[1]||null),
    cond:((s.match(/durum:\s*(\S+(?:\s+\S+)?)/i)||[])[1]||null),
    wind:((s.match(/rÃ¼zgar:\s*([\d.]+)/i)||[])[1]||null)
  };
}

// â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _curId=null;
function showDetail(id){
  const ev=DB.find(e=>e.id===id);if(!ev)return;
  _curId=id;
  const m=calc(ev);const w=parseWx(ev.weather);
  document.getElementById('m-name').textContent=ev.name;
  document.getElementById('modal-detail').classList.add('open');
  document.getElementById('m-body').innerHTML=`
    <div class="mg">
      ${[['Åehir',ev.city],['Tarih',ev.date||'â€”'],['YÄ±l',ev.year],['KatÄ±lÄ±mcÄ±',ev.participants>0?fn(ev.participants):'â€”'],['Ã‡adÄ±r',ev.tents||'â€”'],['Ekleyen',ev.addedBy||'â€”']].map(([l,v])=>`<div class="mi"><div class="mil">${l}</div><div class="miv">${v}</div></div>`).join('')}
    </div>
    <div style="background:var(--bg3);border-radius:8px;padding:12px;margin-bottom:11px">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:1px;margin-bottom:8px">GÄ°DER KALEMLERÄ°</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px">
        <div><span style="color:var(--t3)">Ajans: </span><span style="font-family:'DM Mono',monospace">${fc(ev.agency||0)}</span></div>
        <div><span style="color:var(--t3)">Personel: </span><span style="font-family:'DM Mono',monospace">${fc(ev.personnel||0)}</span></div>
        <div><span style="color:var(--t3)">Stand: </span><span style="font-family:'DM Mono',monospace">${fc(ev.standCost||0)}</span></div>
        <div><span style="color:var(--t3)">Barter: </span><span style="font-family:'DM Mono',monospace">${fc(ev.barter||0)}</span></div>
      </div>
    </div>
    <div class="mkr">
      ${[['Toplam Ciro',fc(m.ciro),'var(--blue2)'],['Toplam Gider',fc(m.gider),'var(--amber)'],['Net Kar',fc(m.kar),m.kar>=0?'var(--green)':'var(--rose)'],['Kar MarjÄ±',m.ciro>0?m.margin.toFixed(1)+'%':'â€”','var(--t1)'],['ROI',m.gider>0?m.roi.toFixed(0)+'%':'â€”',m.roi>=0?'var(--green)':'var(--rose)'],['Kat. BaÅŸÄ± Ciro',ev.participants>0?fc(m.perC):'â€”','var(--t1)']].map(([l,v,c])=>`<div class="mk"><div class="mkl">${l}</div><div class="mkv" style="color:${c}">${v}</div></div>`).join('')}
    </div>
    ${ev.weather?`<div style="background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.14);border-radius:8px;padding:11px"><div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:1px;margin-bottom:5px">HAVA DURUMU</div><div style="font-size:12px;color:var(--t2);font-family:'DM Mono',monospace;white-space:pre-line">${ev.weather}</div></div>`:''}`;
}
function shareFromDetail(){const id=_curId;closeModal('modal-detail');setTimeout(()=>openShare(id),150);}
function editFromDetail(){const id=_curId;closeModal('modal-detail');setTimeout(()=>openEdit(id),150);}
async function delFromDetail(){
  if(!_curId)return;
  if(!confirm('Bu etkinliÄŸi silmek istiyor musunuz?'))return;
  DB=DB.filter(e=>e.id!==_curId);
  closeModal('modal-detail');
  await saveData();rebuildFilters();applyFilters();toast('Etkinlik silindi');
}

// â”€â”€ EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEdit(id){
  const ev=DB.find(e=>e.id===id);if(!ev)return;
  document.getElementById('edit-id').value=ev.id;
  setv('e-name',ev.name);setv('e-date',ev.date||'');setv('e-city',ev.city);
  // Populate year dropdown
  const nowY=new Date().getFullYear();
  const years=[...new Set(DB.map(e=>e.year))];
  const allY=[...new Set([...years,nowY,nowY+1,nowY+2])].sort((a,b)=>b-a);
  const ey=document.getElementById('e-year');
  ey.innerHTML=allY.map(y=>`<option value="${y}"${y===ev.year?' selected':''}>${y} Etkinlikleri</option>`).join('');
  setv('e-kat',ev.participants||0);setv('e-cadir',ev.tents||0);
  setv('e-ajans',ev.agency||0);setv('e-per',ev.personnel||0);
  setv('e-stand',ev.standCost||0);setv('e-barter',ev.barter||0);
  setv('e-cek',ev.cekCiro||0);setv('e-cciro',ev.cadirCiro||0);
  setv('e-wx',ev.weather||'');
  calcEP();
  document.getElementById('modal-edit').classList.add('open');
}
function onEditDate(){
  const d=document.getElementById('e-date').value;
  if(d){document.getElementById('e-year').value=new Date(d).getFullYear();}
}
function calcEP(){
  const cek=nv('e-cek'),cc=nv('e-cciro'),aj=nv('e-ajans'),pe=nv('e-per'),st=nv('e-stand'),ba=nv('e-barter'),kat=nv('e-kat');
  const ciro=cek+cc,gider=aj+pe+st+ba,kar=ciro-gider;
  sv('ep-ciro',fc(ciro));sv('ep-gider',fc(gider));
  const pk=document.getElementById('ep-kar');pk.textContent=fc(kar);pk.className='pvv '+(kar>=0?'cg':'cr');
  sv('ep-margin',ciro>0?((kar/ciro)*100).toFixed(1)+'%':'â€”');
  sv('ep-roi',gider>0?((kar/gider)*100).toFixed(1)+'%':'â€”');
  sv('ep-pciro',kat>0&&ciro>0?fc(ciro/kat):'â€”');
  sv('ep-pgdr',kat>0&&gider>0?fc(gider/kat):'â€”');
}
async function saveEdit(){
  const id=document.getElementById('edit-id').value;
  const name=(document.getElementById('e-name').value||'').trim();
  const city=(document.getElementById('e-city').value||'').trim();
  if(!name||!city){toast('Ad ve ÅŸehir zorunludur','err');return;}
  const idx=DB.findIndex(e=>e.id===id);
  if(idx===-1){toast('Etkinlik bulunamadÄ±','err');return;}
  const orig=DB[idx];
  DB[idx]={...orig,name,city,
    date:document.getElementById('e-date').value||orig.date,
    year:parseInt(document.getElementById('e-year').value)||orig.year,
    participants:nv('e-kat'),tents:nv('e-cadir'),
    agency:nv('e-ajans'),personnel:nv('e-per'),standCost:nv('e-stand'),barter:nv('e-barter'),
    cekCiro:nv('e-cek'),cadirCiro:nv('e-cciro'),
    weather:(document.getElementById('e-wx').value||'').trim(),
    _edited:true,editedBy:username||orig.editedBy,editedAt:new Date().toISOString()
  };
  DB.sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
  await saveData();rebuildFilters();applyFilters();
  closeModal('modal-edit');toast('âœ“ GÃ¼ncellendi: '+name);
}

// â”€â”€ SHARE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openShare(id){
  const ev=DB.find(e=>e.id===id);if(!ev)return;
  const m=calc(ev);const w=parseWx(ev.weather);
  const perfPct=Math.min(100,Math.max(0,(m.margin+20)*2));
  const pColor=m.margin>=40?'var(--green)':m.margin>=0?'var(--amber)':'var(--rose)';
  const pLbl=m.margin>=40?'YÃ¼ksek Performans':m.margin>=0?'Orta Performans':'DÃ¼ÅŸÃ¼k Performans';
  sv('sct',ev.name);sv('scd',ev.date||'â€”');sv('scc',ev.city);
  sv('scp',ev.participants>0?fn(ev.participants)+' katÄ±lÄ±mcÄ±':'â€”');
  sv('sc-yr',ev.year+' Â· SPX');
  const scCiro=document.getElementById('sc-ciro');scCiro.textContent=fc(m.ciro);scCiro.style.color='var(--blue2)';
  sv('sc-ciro-s',`Ã‡ek: ${fc(ev.cekCiro||0)} Â· Ã‡adÄ±r: ${fc(ev.cadirCiro||0)}`);
  const scKar=document.getElementById('sc-kar');scKar.textContent=fc(m.kar);scKar.style.color=m.kar>=0?'var(--green)':'var(--rose)';
  sv('sc-kar-s',`Gider: ${fc(m.gider)}`);
  const scRoi=document.getElementById('sc-roi');scRoi.textContent=m.gider>0?m.roi.toFixed(0)+'%':'â€”';scRoi.style.color=m.roi>=0?'var(--cyan)':'var(--rose)';
  const scM=document.getElementById('sc-margin');scM.textContent=m.ciro>0?m.margin.toFixed(1)+'%':'â€”';scM.style.color=m.margin>=0?'var(--green)':'var(--rose)';
  sv('sc-gider',fc(m.gider));sv('sc-gider-s',`Ajans: ${fc(ev.agency||0)} Â· Pers: ${fc(ev.personnel||0)}`);
  sv('sc-pciro',ev.participants>0&&m.ciro>0?fc(m.perC):'â€”');sv('sc-pciro-s',ev.participants>0?fn(ev.participants)+' kiÅŸi':'â€”');
  document.getElementById('sc-pb').style.width=perfPct+'%';document.getElementById('sc-pb').style.background=pColor;sv('sc-pl',pLbl);
  const wxw=document.getElementById('sc-wx-wrap');
  if(w.temp||w.cond){wxw.style.display='block';sv('sc-wx-txt',`ğŸŒ¡ ${w.temp||'â€”'}  â›… ${w.cond||'â€”'}${w.wind?'  ğŸ’¨ '+w.wind:''}`);}
  else{wxw.style.display='none';}
  // Share link
  const sd={id:ev.id,name:ev.name,city:ev.city,date:ev.date,year:ev.year,participants:ev.participants,ciro:m.ciro,gider:m.gider,kar:m.kar,margin:m.margin,roi:m.roi};
  const enc=btoa(unescape(encodeURIComponent(JSON.stringify(sd))));
  const url=(window.location.href.split('#')[0])+'#ev='+enc;
  document.getElementById('share-link-box').textContent=url;
  document.getElementById('modal-share').classList.add('open');
}
function copyLink(){
  const url=document.getElementById('share-link-box').textContent;
  _copy(url);
}
function copyText(){
  const ev=DB.find(e=>e.id===_shareId)||{};
  const n=document.getElementById('sct').textContent;
  const d=document.getElementById('scd').textContent;
  const c=document.getElementById('scc').textContent;
  const ciro=document.getElementById('sc-ciro').textContent;
  const kar=document.getElementById('sc-kar').textContent;
  const roi=document.getElementById('sc-roi').textContent;
  const margin=document.getElementById('sc-margin').textContent;
  const gider=document.getElementById('sc-gider').textContent;
  const wxLine=document.getElementById('sc-wx-wrap').style.display!=='none'?'\nğŸŒ¤ '+document.getElementById('sc-wx-txt').textContent:'';
  const t=`ğŸ“Š SPX ETKÄ°NLÄ°K RAPORU\n${'â”€'.repeat(30)}\nğŸ¯ ${n}\nğŸ“… ${d}  ğŸ“ ${c}\n${'â”€'.repeat(30)}\nğŸ’° Toplam Ciro: ${ciro}\nğŸ“‰ Toplam Gider: ${gider}\nâœ… Net Kar: ${kar}\nğŸ“ˆ ROI: ${roi}\nğŸ“Š Kar MarjÄ±: ${margin}${wxLine}\n${'â”€'.repeat(30)}\nSPX Event Intelligence`;
  _copy(t);
}
function shareWA(){
  const n=document.getElementById('sct').textContent;
  const d=document.getElementById('scd').textContent;
  const c=document.getElementById('scc').textContent;
  const ciro=document.getElementById('sc-ciro').textContent;
  const kar=document.getElementById('sc-kar').textContent;
  const roi=document.getElementById('sc-roi').textContent;
  const url=document.getElementById('share-link-box').textContent;
  const t=`*ğŸ“Š ${n}*\nğŸ“… ${d} Â· ğŸ“ ${c}\n\nğŸ’° Ciro: *${ciro}*\nâœ… Net Kar: *${kar}*\nğŸ“ˆ ROI: *${roi}*\n\nğŸ”— ${url}`;
  window.open('https://wa.me/?text='+encodeURIComponent(t),'_blank');
}
function _copy(t){
  navigator.clipboard.writeText(t).then(showCopyOk).catch(()=>{const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showCopyOk();});
}
function showCopyOk(){const el=document.getElementById('copy-ok');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2200);}
let _shareId=null;
const _origOpenShare=openShare;

// â”€â”€ GENERIC MODAL HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModal(id){document.getElementById(id).classList.remove('open');}
function moBg(e,id){if(e.target===document.getElementById(id))closeModal(id);}
function setv(id,v){const el=document.getElementById(id);if(el)el.value=v;}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TITLES={dashboard:'Dashboard',events:'Etkinlikler','new-event':'Yeni Etkinlik Ekle',analysis:'Analiz Motoru',weather:'Hava Durumu'};
function goPage(id,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  document.getElementById('pg-title').textContent=TITLES[id]||'';
  if(id==='events')renderEvents();
  if(id==='analysis')renderAnalysis();
  if(id==='weather')renderWeather();
  closeSB();
}

// â”€â”€ SIDEBAR MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSB(){const sb=document.getElementById('sb'),hb=document.getElementById('hb'),ov=document.getElementById('sb-ov');const o=sb.classList.toggle('open');hb.classList.toggle('open',o);ov.classList.toggle('open',o);}
function closeSB(){document.getElementById('sb').classList.remove('open');document.getElementById('hb').classList.remove('open');document.getElementById('sb-ov').classList.remove('open');}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let TT2;
function toast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type==='err'?'err':'');clearTimeout(TT2);TT2=setTimeout(()=>t.classList.remove('show'),3200);}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doExport(){
  const evs=filtered();
  const cols=['Etkinlik','YÄ±l','Tarih','Åehir','KatÄ±lÄ±mcÄ±','Ajans','Personel','Stand','Barter','Ã‡ekCiro','Ã‡adÄ±rCiro','ToplamCiro','ToplamGider','NetKar','KarMarjÄ±%','ROI%','KatBaÅŸÄ±Ciro','Ekleyen'];
  const rows=evs.map(e=>{const m=calc(e);return[e.name,e.year,e.date,e.city,e.participants,e.agency,e.personnel,e.standCost,e.barter,e.cekCiro,e.cadirCiro,m.ciro.toFixed(0),m.gider.toFixed(0),m.kar.toFixed(0),m.margin.toFixed(1),m.roi.toFixed(1),m.perC.toFixed(0),e.addedBy||''].join(',');});
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+[cols.join(','),...rows].join('\n')],{type:'text/csv;charset=utf-8;'}));a.download='spx_etkinlikler.csv';a.click();
  toast('CSV indirildi');
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nv(id){return parseFloat(document.getElementById(id).value)||0;}
function sv(id,v){const el=document.getElementById(id);if(el)el.textContent=v;}
function applyFilters(){updateDashboard();renderEvents();}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init(){
  const u=lGet(UK)||'';if(u){document.getElementById('username').value=u;username=u;}
  document.getElementById('f-date').valueAsDate=new Date();
  onDateChange();
  await loadData();
  updateDashboard();renderEvents();
  // Auto-sync every 30s
  setInterval(async()=>{await loadData();applyFilters();},30000);
  window.addEventListener('resize',()=>{if(window.innerWidth>768)closeSB();});
}

init();
</script>

<!-- DETAIL MODAL -->
<div class="mo" id="modal-detail" onclick="moBg(event,'modal-detail')">
  <div class="md">
    <div class="mt">
      <span id="m-name" style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Detay</span>
      <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
        <button class="btn bsh" style="font-size:11px;padding:5px 10px" onclick="shareFromDetail()">â¬† PaylaÅŸ</button>
        <button class="btn bg2" style="font-size:11px;padding:5px 10px" onclick="editFromDetail()">âœ DÃ¼zenle</button>
        <span class="mc" onclick="closeModal('modal-detail')">âœ•</span>
      </div>
    </div>
    <div id="m-body"></div>
    <div class="modal-acts">
      <button class="btn bd" onclick="delFromDetail()">ğŸ—‘ Sil</button>
      <button class="btn bsh" onclick="shareFromDetail()">â¬† KartÄ± PaylaÅŸ</button>
      <button class="btn bg2" onclick="editFromDetail()">âœ DÃ¼zenle</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="mo" id="modal-edit" onclick="moBg(event,'modal-edit')">
  <div class="edit-md">
    <div class="mt">
      <span>EtkinliÄŸi DÃ¼zenle</span>
      <span class="mc" onclick="closeModal('modal-edit')">âœ•</span>
    </div>
    <input type="hidden" id="edit-id">
    <div class="fd">â€” Etkinlik Bilgileri</div>
    <div class="fg3">
      <div class="fg"><label class="fl">Etkinlik AdÄ± *</label><input class="fi" id="e-name" placeholder="Etkinlik adÄ±"></div>
      <div class="fg"><label class="fl">Tarih</label><input type="date" class="fi" id="e-date" onchange="onEditDate()"></div>
      <div class="fg"><label class="fl">Åehir</label><input class="fi" id="e-city" list="city-dl"></div>
    </div>
    <div class="fg3">
      <div class="fg"><label class="fl">YÄ±l</label><select class="fi" id="e-year"></select></div>
      <div class="fg"><label class="fl">KatÄ±lÄ±mcÄ± SayÄ±sÄ±</label><input type="number" class="fi" id="e-kat" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Ã‡adÄ±r SayÄ±sÄ±</label><input type="number" class="fi" id="e-cadir"></div>
    </div>
    <div class="fd">â€” Gider Kalemleri</div>
    <div class="fg4">
      <div class="fg"><label class="fl">Ajans Bedeli (â‚º)</label><input type="number" class="fi" id="e-ajans" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Personel Gideri (â‚º)</label><input type="number" class="fi" id="e-per" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Stand Maliyeti (â‚º)</label><input type="number" class="fi" id="e-stand" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Barter (â‚º)</label><input type="number" class="fi" id="e-barter" oninput="calcEP()"></div>
    </div>
    <div class="fd">â€” Ciro Kalemleri</div>
    <div class="fg2">
      <div class="fg"><label class="fl">Ã‡ek Ciro (â‚º)</label><input type="number" class="fi" id="e-cek" oninput="calcEP()"></div>
      <div class="fg"><label class="fl">Ã‡adÄ±r Ciro (â‚º)</label><input type="number" class="fi" id="e-cciro" oninput="calcEP()"></div>
    </div>
    <div class="fd">â€” AnlÄ±k Hesaplama</div>
    <div class="edit-pvs">
      <div class="pvi"><div class="pvl">Ciro</div><div class="pvv cb" id="ep-ciro">â‚º0</div></div>
      <div class="pvi"><div class="pvl">Gider</div><div class="pvv ca" id="ep-gider">â‚º0</div></div>
      <div class="pvi"><div class="pvl">Net Kar</div><div class="pvv cg" id="ep-kar">â‚º0</div></div>
      <div class="pvi"><div class="pvl">Kar MarjÄ±</div><div class="pvv cb" id="ep-margin">â€”</div></div>
      <div class="pvi"><div class="pvl">ROI</div><div class="pvv cg" id="ep-roi">â€”</div></div>
      <div class="pvi"><div class="pvl">Kat.BaÅŸÄ± Ciro</div><div class="pvv cb" id="ep-pciro">â€”</div></div>
      <div class="pvi"><div class="pvl">Kat.BaÅŸÄ± Mlt.</div><div class="pvv ca" id="ep-pgdr">â€”</div></div>
    </div>
    <div class="fd">â€” Hava Durumu</div>
    <div style="margin-bottom:14px">
      <textarea class="fi" id="e-wx" rows="3" style="resize:vertical;font-family:'DM Mono',monospace;font-size:11px" placeholder="SÄ±caklÄ±k: 22Â°C&#10;Durum: GÃ¼neÅŸli&#10;RÃ¼zgar: 15 km/h"></textarea>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
      <button class="btn bs" onclick="closeModal('modal-edit')">Ä°ptal</button>
      <button class="btn bp" onclick="saveEdit()">âœ“ GÃ¼ncelle</button>
    </div>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="mo" id="modal-share" onclick="moBg(event,'modal-share')">
  <div class="share-md">
    <div class="sc" id="share-card-vis">
      <div class="sc-brand">
        <div class="sc-bname">SPX<span style="color:var(--blue)">.</span></div>
        <div class="sc-btag">Event Report</div>
      </div>
      <div class="sc-title" id="sct">â€”</div>
      <div class="sc-meta">
        <span>ğŸ“… <span id="scd">â€”</span></span>
        <span>ğŸ“ <span id="scc">â€”</span></span>
        <span>ğŸ‘¥ <span id="scp">â€”</span></span>
      </div>
      <div class="sc-kpis">
        <div class="sc-kpi"><div class="sc-kpi-lbl">Toplam Ciro</div><div class="sc-kpi-val" id="sc-ciro" style="color:var(--blue2)">â‚º0</div><div class="sc-kpi-sub" id="sc-ciro-s">â€”</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Net Kar</div><div class="sc-kpi-val" id="sc-kar">â‚º0</div><div class="sc-kpi-sub" id="sc-kar-s">â€”</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">ROI</div><div class="sc-kpi-val" id="sc-roi" style="color:var(--cyan)">â€”</div><div class="sc-kpi-sub">YatÄ±rÄ±m getirisi</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Kar MarjÄ±</div><div class="sc-kpi-val" id="sc-margin">â€”</div><div class="sc-kpi-sub">Gelirden kar payÄ±</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Toplam Gider</div><div class="sc-kpi-val" id="sc-gider" style="color:var(--amber)">â‚º0</div><div class="sc-kpi-sub" id="sc-gider-s">â€”</div></div>
        <div class="sc-kpi"><div class="sc-kpi-lbl">Kat. BaÅŸÄ± Ciro</div><div class="sc-kpi-val" id="sc-pciro" style="color:var(--violet)">â€”</div><div class="sc-kpi-sub" id="sc-pciro-s">â€”</div></div>
      </div>
      <div id="sc-wx-wrap" style="display:none"><div class="sc-wx" id="sc-wx-txt">â€”</div></div>
      <div class="sc-foot">
        <div class="sc-perf"><span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:1px">PERFORMANS</span><div class="sc-pbw"><div class="sc-pb" id="sc-pb"></div></div><span style="font-family:'DM Mono',monospace;font-size:10px" id="sc-pl">â€”</span></div>
        <div class="sc-dtag" id="sc-yr">â€”</div>
      </div>
    </div>
    <div class="share-acts">
      <div class="share-acts-ttl">PaylaÅŸÄ±m SeÃ§enekleri</div>
      <div class="share-btns">
        <button class="btn bp" style="font-size:11px" onclick="copyLink()">ğŸ”— BaÄŸlantÄ±yÄ± Kopyala</button>
        <button class="btn bs" style="font-size:11px" onclick="copyText()">ğŸ“‹ Metni Kopyala</button>
        <button class="btn bg2" style="font-size:11px" onclick="shareWA()">ğŸ’¬ WhatsApp</button>
        <span class="copy-ok" id="copy-ok">âœ“ KopyalandÄ±!</span>
      </div>
      <div class="share-link" id="share-link-box">â€”</div>
      <div style="display:flex;justify-content:flex-end;margin-top:9px">
        <button class="btn bs" style="font-size:11px" onclick="closeModal('modal-share')">Kapat</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
